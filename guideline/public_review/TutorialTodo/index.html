<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>3. チュートリアル(Todoアプリケーション) &mdash; TERASOLUNA Global Framework Development Guideline 1.0.0.publicreview documentation</title>
    
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0.publicreview',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="TERASOLUNA Global Framework Development Guideline 1.0.0.publicreview documentation" href="../index.html" />
    <link rel="next" title="4. TERASOLUNA Global Frameworkによるアプリケーション開発" href="../ImplementationAtEachLayer/index.html" />
    <link rel="prev" title="2.4. アプリケーションのレイヤ化" href="../Overview/ApplicationLayering.html" /><script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../ImplementationAtEachLayer/index.html" title="4. TERASOLUNA Global Frameworkによるアプリケーション開発"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../Overview/ApplicationLayering.html" title="2.4. アプリケーションのレイヤ化"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.0.publicreview documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">3. チュートリアル(Todoアプリケーション)</a><ul>
<li><a class="reference internal" href="#id2">3.1. はじめに</a><ul>
<li><a class="reference internal" href="#id3">3.1.1. このチュートリアルで学ぶこと</a></li>
<li><a class="reference internal" href="#id4">3.1.2. 対象読者</a></li>
<li><a class="reference internal" href="#id5">3.1.3. 検証環境</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">3.2. 作成するアプリケーションの説明</a><ul>
<li><a class="reference internal" href="#id7">3.2.1. アプリケーションの概要</a></li>
<li><a class="reference internal" href="#app-requirement">3.2.2. アプリケーションの業務要件</a></li>
<li><a class="reference internal" href="#id9">3.2.3. アプリケーションの画面遷移</a><ul>
<li><a class="reference internal" href="#show-all-todo">3.2.3.1. Show all TODO</a></li>
<li><a class="reference internal" href="#create-todo">3.2.3.2. Create TODO</a></li>
<li><a class="reference internal" href="#finish-todo">3.2.3.3. Finish TODO</a></li>
<li><a class="reference internal" href="#delete-todo">3.2.3.4. Delete TODO</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id10">3.2.4. エラーメッセージ一覧</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11">3.3. 環境構築</a><ul>
<li><a class="reference internal" href="#id12">3.3.1. プロジェクトの作成</a></li>
<li><a class="reference internal" href="#maven">3.3.2. Mavenの設定</a></li>
<li><a class="reference internal" href="#id13">3.3.3. プロジェクト構成</a></li>
<li><a class="reference internal" href="#id14">3.3.4. 設定ファイルの作成</a><ul>
<li><a class="reference internal" href="#web-xml">3.3.4.1. web.xmlの設定</a></li>
<li><a class="reference internal" href="#jsp">3.3.4.2. 共通JSPの設定</a></li>
<li><a class="reference internal" href="#bean">3.3.4.3. Bean定義ファイルの設定</a><ul>
<li><a class="reference internal" href="#applicationcontext-xml">3.3.4.3.1. applicationContext.xml</a></li>
<li><a class="reference internal" href="#todo-domain-xml">3.3.4.3.2. todo-domain.xml</a></li>
<li><a class="reference internal" href="#todo-infra-xml">3.3.4.3.3. todo-infra.xml</a></li>
<li><a class="reference internal" href="#spring-mvc-xml">3.3.4.3.4. spring-mvc.xml</a></li>
</ul>
</li>
<li><a class="reference internal" href="#logback-xml">3.3.4.4. logback.xmlの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id17">3.3.5. 動作確認</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id18">3.4. Todoアプリケーションの作成</a><ul>
<li><a class="reference internal" href="#id19">3.4.1. ドメイン層の作成</a><ul>
<li><a class="reference internal" href="#domain-object">3.4.1.1. Domain Objectの作成</a></li>
<li><a class="reference internal" href="#repository">3.4.1.2. Repositoryの作成</a></li>
<li><a class="reference internal" href="#repositoryimpl">3.4.1.3. RepositoryImplの作成(インフラストラクチャ層)</a></li>
<li><a class="reference internal" href="#service">3.4.1.4. Serviceの作成</a></li>
<li><a class="reference internal" href="#servicejunit">3.4.1.5. ServiceのJUnit作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id20">3.4.2. アプリケーション層の作成</a><ul>
<li><a class="reference internal" href="#controller">3.4.2.1. Controllerの作成</a><ul>
<li><a class="reference internal" href="#id21">3.4.2.1.1. Show all TODO</a><ul>
<li><a class="reference internal" href="#form">3.4.2.1.1.1. Formの作成</a></li>
<li><a class="reference internal" href="#id22">3.4.2.1.1.2. Controllerの実装</a></li>
<li><a class="reference internal" href="#id23">3.4.2.1.1.3. JSPの作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id24">3.4.2.1.2. Create TODO</a><ul>
<li><a class="reference internal" href="#id25">3.4.2.1.2.1. Controllerの修正</a></li>
<li><a class="reference internal" href="#id26">3.4.2.1.2.2. Formの修正</a></li>
<li><a class="reference internal" href="#id27">3.4.2.1.2.3. JSPの修正</a></li>
<li><a class="reference internal" href="#id28">3.4.2.1.2.4. メッセージ表示のカスタマイズ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id29">3.4.2.1.3. Finish TODO</a><ul>
<li><a class="reference internal" href="#id30">3.4.2.1.3.1. JSPの修正</a></li>
<li><a class="reference internal" href="#id31">3.4.2.1.3.2. Formの修正</a></li>
<li><a class="reference internal" href="#id32">3.4.2.1.3.3. Controllerの修正</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id33">3.4.2.1.4. Delete TODO</a><ul>
<li><a class="reference internal" href="#id34">3.4.2.1.4.1. JSPの修正</a></li>
<li><a class="reference internal" href="#id35">3.4.2.1.4.2. Formの修正</a></li>
<li><a class="reference internal" href="#id36">3.4.2.1.4.3. Controllerの修正</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#tutorial-todo-infra">3.5. インフラストラクチャ層の変更</a><ul>
<li><a class="reference internal" href="#id38">3.5.1. 共通設定</a><ul>
<li><a class="reference internal" href="#pom-xml">3.5.1.1. pom.xmlの修正</a></li>
<li><a class="reference internal" href="#id39">3.5.1.2. データソースの定義</a><ul>
<li><a class="reference internal" href="#id40">3.5.1.2.1. todo-infra.xmlの修正</a></li>
<li><a class="reference internal" href="#todo-env-xml">3.5.1.2.2. todo-env.xmlの作成</a></li>
<li><a class="reference internal" href="#todo-infra-properties">3.5.1.2.3. todo-infra.properties</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id41">3.5.1.3. todo-domain.xmlの修正</a></li>
<li><a class="reference internal" href="#todoserviceimpl">3.5.1.4. TodoServiceImplの修正</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spring-data-jpa">3.5.2. Spring Data JPAを使用する</a><ul>
<li><a class="reference internal" href="#id43">3.5.2.1. Spring Data JPAを使用するための設定ファイルの修正</a><ul>
<li><a class="reference internal" href="#id44">3.5.2.1.1. pom.xmlの修正</a></li>
<li><a class="reference internal" href="#id45">3.5.2.1.2. todo-infra.xmlの修正</a></li>
<li><a class="reference internal" href="#id46">3.5.2.1.3. todo-env.xmlの修正</a></li>
<li><a class="reference internal" href="#id47">3.5.2.1.4. spring-mvc.xml</a></li>
<li><a class="reference internal" href="#id48">3.5.2.1.5. logback.xmlの修正</a></li>
</ul>
</li>
<li><a class="reference internal" href="#entity">3.5.2.2. Entityの設定</a></li>
<li><a class="reference internal" href="#todorepository">3.5.2.3. TodoRepositoryの修正</a></li>
<li><a class="reference internal" href="#todorepositoryimpl">3.5.2.4. TodoRepositoryImplの修正</a></li>
</ul>
</li>
<li><a class="reference internal" href="#terasoluna-dao">3.5.3. TERASOLUNA DAOを使用する</a><ul>
<li><a class="reference internal" href="#id49">3.5.3.1. TERASOLUNA DAOを使用するための設定</a><ul>
<li><a class="reference internal" href="#id50">3.5.3.1.1. pom.xmlの修正</a></li>
<li><a class="reference internal" href="#id51">3.5.3.1.2. todo-infra.xmlの修正</a></li>
<li><a class="reference internal" href="#id54">3.5.3.1.3. todo-env.xmlの修正</a></li>
<li><a class="reference internal" href="#id55">3.5.3.1.4. logback.xmlの修正</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sqlmapconfig">3.5.3.2. sqlMapConfigの作成</a></li>
<li><a class="reference internal" href="#id56">3.5.3.3. RepositoryImplの修正</a></li>
<li><a class="reference internal" href="#sqlmap">3.5.3.4. SQLMapファイルの作成</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id57">3.6. おわりに</a></li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="../Overview/ApplicationLayering.html"
                        title="previous chapter">2.4. アプリケーションのレイヤ化</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../ImplementationAtEachLayer/index.html"
                        title="next chapter">4. TERASOLUNA Global Frameworkによるアプリケーション開発</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/TutorialTodo/index.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="todo">
<div class="admonition caution">
  <p class="first admonition-title">Caution</p>
  <p><strong>本バージョンの内容は既に古くなっています</strong>。最新のガイドラインは<a href="http://terasolunaorg.github.io/guideline/">こちら</a>からご参照ください。</p>
</div>
<h1>3. チュートリアル(Todoアプリケーション)<a class="headerlink" href="#todo" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id1">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#id2" id="id58">はじめに</a><ul>
<li><a class="reference internal" href="#id3" id="id59">このチュートリアルで学ぶこと</a></li>
<li><a class="reference internal" href="#id4" id="id60">対象読者</a></li>
<li><a class="reference internal" href="#id5" id="id61">検証環境</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6" id="id62">作成するアプリケーションの説明</a><ul>
<li><a class="reference internal" href="#id7" id="id63">アプリケーションの概要</a></li>
<li><a class="reference internal" href="#app-requirement" id="id64">アプリケーションの業務要件</a></li>
<li><a class="reference internal" href="#id9" id="id65">アプリケーションの画面遷移</a><ul>
<li><a class="reference internal" href="#show-all-todo" id="id66">Show all TODO</a></li>
<li><a class="reference internal" href="#create-todo" id="id67">Create TODO</a></li>
<li><a class="reference internal" href="#finish-todo" id="id68">Finish TODO</a></li>
<li><a class="reference internal" href="#delete-todo" id="id69">Delete TODO</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id10" id="id70">エラーメッセージ一覧</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11" id="id71">環境構築</a><ul>
<li><a class="reference internal" href="#id12" id="id72">プロジェクトの作成</a></li>
<li><a class="reference internal" href="#maven" id="id73">Mavenの設定</a></li>
<li><a class="reference internal" href="#id13" id="id74">プロジェクト構成</a></li>
<li><a class="reference internal" href="#id14" id="id75">設定ファイルの作成</a><ul>
<li><a class="reference internal" href="#web-xml" id="id76">web.xmlの設定</a></li>
<li><a class="reference internal" href="#jsp" id="id77">共通JSPの設定</a></li>
<li><a class="reference internal" href="#bean" id="id78">Bean定義ファイルの設定</a></li>
<li><a class="reference internal" href="#logback-xml" id="id79">logback.xmlの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id17" id="id80">動作確認</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id18" id="id81">Todoアプリケーションの作成</a><ul>
<li><a class="reference internal" href="#id19" id="id82">ドメイン層の作成</a><ul>
<li><a class="reference internal" href="#domain-object" id="id83">Domain Objectの作成</a></li>
<li><a class="reference internal" href="#repository" id="id84">Repositoryの作成</a></li>
<li><a class="reference internal" href="#repositoryimpl" id="id85">RepositoryImplの作成(インフラストラクチャ層)</a></li>
<li><a class="reference internal" href="#service" id="id86">Serviceの作成</a></li>
<li><a class="reference internal" href="#servicejunit" id="id87">ServiceのJUnit作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id20" id="id88">アプリケーション層の作成</a><ul>
<li><a class="reference internal" href="#controller" id="id89">Controllerの作成</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#tutorial-todo-infra" id="id90">インフラストラクチャ層の変更</a><ul>
<li><a class="reference internal" href="#id38" id="id91">共通設定</a><ul>
<li><a class="reference internal" href="#pom-xml" id="id92">pom.xmlの修正</a></li>
<li><a class="reference internal" href="#id39" id="id93">データソースの定義</a></li>
<li><a class="reference internal" href="#id41" id="id94">todo-domain.xmlの修正</a></li>
<li><a class="reference internal" href="#todoserviceimpl" id="id95">TodoServiceImplの修正</a></li>
</ul>
</li>
<li><a class="reference internal" href="#spring-data-jpa" id="id96">Spring Data JPAを使用する</a><ul>
<li><a class="reference internal" href="#id43" id="id97">Spring Data JPAを使用するための設定ファイルの修正</a></li>
<li><a class="reference internal" href="#entity" id="id98">Entityの設定</a></li>
<li><a class="reference internal" href="#todorepository" id="id99">TodoRepositoryの修正</a></li>
<li><a class="reference internal" href="#todorepositoryimpl" id="id100">TodoRepositoryImplの修正</a></li>
</ul>
</li>
<li><a class="reference internal" href="#terasoluna-dao" id="id101">TERASOLUNA DAOを使用する</a><ul>
<li><a class="reference internal" href="#id49" id="id102">TERASOLUNA DAOを使用するための設定</a></li>
<li><a class="reference internal" href="#sqlmapconfig" id="id103">sqlMapConfigの作成</a></li>
<li><a class="reference internal" href="#id56" id="id104">RepositoryImplの修正</a></li>
<li><a class="reference internal" href="#sqlmap" id="id105">SQLMapファイルの作成</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id57" id="id106">おわりに</a></li>
</ul>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id58">3.1. はじめに</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id59">3.1.1. このチュートリアルで学ぶこと</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>TERASOLUNA Global Frameworkによる基本的なアプリケーションの開発方法およびEclipseプロジェクトの構築方法</li>
<li>TERASOLUNA Global Frameworkの <a class="reference internal" href="../Overview/ApplicationLayering.html"><em>アプリケーションのレイヤ化</em></a> に従った開発方法</li>
</ul>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id60">3.1.2. 対象読者</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>SpringのDIやAOPに関する基礎的な知識がある</li>
<li>Servlet/JSPを使用してWebアプリケーションを開発したことがある</li>
<li>SQLに関する知識がある</li>
</ul>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id61">3.1.3. 検証環境</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>このチュートリアルは以下の環境で動作確認している。他の環境で実施する際は本書をベースに適宜読み替えて設定していくこと。</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">種別</th>
<th class="head">名前</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>OS</td>
<td>Windows7 64bit</td>
</tr>
<tr class="row-odd"><td>JVM</td>
<td>Java 1.6</td>
</tr>
<tr class="row-even"><td>IDE</td>
<td>Spring Tool Suite Version: 3.2.0.RELEASE, Build Id: 201303060821 (以下STS) Build   Maven 3.0.4 (STS付属)</td>
</tr>
<tr class="row-odd"><td>Application Server</td>
<td>VMWare vFabric tc Server Developer Edition v2.8 (STS付属)</td>
</tr>
<tr class="row-even"><td>Web Browser</td>
<td>Google Chrome 27.0.1453.94 m</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id62">3.2. 作成するアプリケーションの説明</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id63">3.2.1. アプリケーションの概要</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>TODOを管理するアプリケーションを作成する。TODOの一覧表示、TODOの登録、TODOの完了、TODOの削除を行える。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image001.png"><img alt="../_images/image001.png" src="../_images/image001.png" style="width: 60%;" /></a>
</div>
</div>
<div class="section" id="app-requirement">
<span id="id8"></span><h3><a class="toc-backref" href="#id64">3.2.2. アプリケーションの業務要件</a><a class="headerlink" href="#app-requirement" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ルールID</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>B01</td>
<td>未完のTODOは5件までしか登録できない</td>
</tr>
<tr class="row-odd"><td>B02</td>
<td>完了済みのTODOは完了できない</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">本要件は学習のためのもので、現実的なTODO管理アプリケーションとしては適切ではない。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id65">3.2.3. アプリケーションの画面遷移</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image002.png"><img alt="../_images/image002.png" src="../_images/image002.png" style="width: 60%;" /></a>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="15%" />
<col width="15%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">プロセス名</th>
<th class="head">HTTPメソッド</th>
<th class="head">URL</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>Show all TODO</td>
<td>GET</td>
<td>/todo/list</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>Create TODO</td>
<td>POST</td>
<td>/todo/create</td>
<td>作成完了後1へリダイレクト</td>
</tr>
<tr class="row-even"><td>3</td>
<td>Finish TODO</td>
<td>POST</td>
<td>/todo/finish</td>
<td>作成完了後1へリダイレクト</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>Delete TODO</td>
<td>POST</td>
<td>/todo/delete</td>
<td>作成完了後1へリダイレクト</td>
</tr>
</tbody>
</table>
<div class="section" id="show-all-todo">
<h4><a class="toc-backref" href="#id66">3.2.3.1. Show all TODO</a><a class="headerlink" href="#show-all-todo" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>TODOを全件表示する</li>
<li>未完了のTODOに対しては”Finish”と”Delete”用のボタンが付く</li>
<li>完了のTODOは打ち消し線で装飾する</li>
<li>TODOの件名のみ</li>
</ul>
</div>
<div class="section" id="create-todo">
<h4><a class="toc-backref" href="#id67">3.2.3.2. Create TODO</a><a class="headerlink" href="#create-todo" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>フォームから送信されたTODOを保存する</li>
<li>TODOの件名は1文字以上30文字以下であること</li>
<li><a class="reference internal" href="#app-requirement"><em>アプリケーションの業務要件</em></a> のB01を満たさない場合はエラーコードE001でビジネス例外をスローする</li>
</ul>
</div>
<div class="section" id="finish-todo">
<h4><a class="toc-backref" href="#id68">3.2.3.3. Finish TODO</a><a class="headerlink" href="#finish-todo" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>フォームから送信されたtodoIdに対応するTODOを完了済みにする</li>
<li><a class="reference internal" href="#app-requirement"><em>アプリケーションの業務要件</em></a> のB02を満たさない場合はエラーコードE002でビジネス例外をスローする</li>
<li>該当するTODOが存在しない場合はエラーコードE404でビジネス例外をスローする</li>
</ul>
</div>
<div class="section" id="delete-todo">
<h4><a class="toc-backref" href="#id69">3.2.3.4. Delete TODO</a><a class="headerlink" href="#delete-todo" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>フォームから送信されたtodoIdに対応するTODOを削除する</li>
<li>該当するTODOが存在しない場合はエラーコードE404でビジネス例外をスローする</li>
</ul>
</div>
</div>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id70">3.2.4. エラーメッセージ一覧</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="45%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">エラーコード</th>
<th class="head">メッセージ</th>
<th class="head">置換パラメータ</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>E001</td>
<td>[E001] The count of un-finished Todo must not be over {0}.</td>
<td>{0}… max unfinished count</td>
</tr>
<tr class="row-odd"><td>E002</td>
<td>[E002] The requested Todo is already finished. (id={0})</td>
<td>{0}… todoId</td>
</tr>
<tr class="row-even"><td>E404</td>
<td>[E404] The requested Todo is not found. (id={0})</td>
<td>{0}… todoId</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id11">
<h2><a class="toc-backref" href="#id71">3.3. 環境構築</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#id72">3.3.1. プロジェクトの作成</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>「File」-&gt;「Other」-&gt;「Maven」-&gt;「Maven Project」を選択して「Next」。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image004.jpg"><img alt="../_images/image004.jpg" src="../_images/image004.jpg" style="width: 60%;" /></a>
</div>
<p>「Create a simple project」にチェックを入れて「Next」。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image006.jpg"><img alt="../_images/image006.jpg" src="../_images/image006.jpg" style="width: 60%;" /></a>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><th class="stub">Group Id:</th>
<td>org.terasoluna.tutorial</td>
</tr>
<tr class="row-even"><th class="stub">Artifact Id:</th>
<td>todo</td>
</tr>
<tr class="row-odd"><th class="stub">Packaging:</th>
<td>war</td>
</tr>
</tbody>
</table>
<p>で「Finish」</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image008.jpg"><img alt="../_images/image008.jpg" src="../_images/image008.jpg" style="width: 60%;" /></a>
</div>
<p>以下のようなプロジェクトが作成される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image009.png"><img alt="../_images/image009.png" src="../_images/image009.png" style="width: 40%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>パッケージ構成上、Package PresentaionをHierarchicalにしたほうが見通しがよい。</p>
<div class="last figure">
<a class="reference internal image-reference" href="../_images/presentation-hierarchical.png"><img alt="../_images/presentation-hierarchical.png" src="../_images/presentation-hierarchical.png" style="width: 80%;" /></a>
</div>
</div>
</div>
<div class="section" id="maven">
<h3><a class="toc-backref" href="#id73">3.3.2. Mavenの設定</a><a class="headerlink" href="#maven" title="Permalink to this headline">¶</a></h3>
<p>pom.xmlを以下のように変更する。
Mavenの知識がない場合は、pom.xmlをコピーするだけで、解説は読み飛ばしてよい。</p>
<div class="highlight-xml"><div class="highlight"><pre> <span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
     <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

     <span class="nt">&lt;groupId&gt;</span>org.terasoluna.tutorial<span class="nt">&lt;/groupId&gt;</span>
     <span class="nt">&lt;artifactId&gt;</span>todo<span class="nt">&lt;/artifactId&gt;</span>
     <span class="nt">&lt;version&gt;</span>0.0.1-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
     <span class="nt">&lt;packaging&gt;</span>war<span class="nt">&lt;/packaging&gt;</span>
<span class="hll">     <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">     <span class="nt">&lt;parent&gt;</span>
</span><span class="hll">         <span class="nt">&lt;groupId&gt;</span>org.terasoluna.gfw<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll">         <span class="nt">&lt;artifactId&gt;</span>terasoluna-gfw-parent<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll">         <span class="nt">&lt;version&gt;</span>1.0.0.RELEASE<span class="nt">&lt;/version&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/parent&gt;</span>
</span><span class="hll">
</span><span class="hll">     <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">     <span class="nt">&lt;repositories&gt;</span>
</span><span class="hll">         <span class="nt">&lt;repository&gt;</span>
</span><span class="hll">             <span class="nt">&lt;releases&gt;</span>
</span><span class="hll">                 <span class="nt">&lt;enabled&gt;</span>true<span class="nt">&lt;/enabled&gt;</span>
</span><span class="hll">             <span class="nt">&lt;/releases&gt;</span>
</span><span class="hll">             <span class="nt">&lt;snapshots&gt;</span>
</span><span class="hll">                 <span class="nt">&lt;enabled&gt;</span>false<span class="nt">&lt;/enabled&gt;</span>
</span><span class="hll">             <span class="nt">&lt;/snapshots&gt;</span>
</span><span class="hll">             <span class="nt">&lt;id&gt;</span>terasoluna-gfw-releases<span class="nt">&lt;/id&gt;</span>
</span><span class="hll">             <span class="nt">&lt;url&gt;</span>http://repo.terasoluna.org/nexus/content/repositories/terasoluna-gfw-releases/<span class="nt">&lt;/url&gt;</span>
</span><span class="hll">         <span class="nt">&lt;/repository&gt;</span>
</span><span class="hll">         <span class="nt">&lt;repository&gt;</span>
</span><span class="hll">             <span class="nt">&lt;releases&gt;</span>
</span><span class="hll">                 <span class="nt">&lt;enabled&gt;</span>false<span class="nt">&lt;/enabled&gt;</span>
</span><span class="hll">             <span class="nt">&lt;/releases&gt;</span>
</span><span class="hll">             <span class="nt">&lt;snapshots&gt;</span>
</span><span class="hll">                 <span class="nt">&lt;enabled&gt;</span>true<span class="nt">&lt;/enabled&gt;</span>
</span><span class="hll">             <span class="nt">&lt;/snapshots&gt;</span>
</span><span class="hll">             <span class="nt">&lt;id&gt;</span>terasoluna-gfw-snapshots<span class="nt">&lt;/id&gt;</span>
</span><span class="hll">             <span class="nt">&lt;url&gt;</span>http://repo.terasoluna.org/nexus/content/repositories/terasoluna-gfw-snapshots/<span class="nt">&lt;/url&gt;</span>
</span><span class="hll">         <span class="nt">&lt;/repository&gt;</span>
</span><span class="hll">         <span class="nt">&lt;repository&gt;</span>
</span><span class="hll">             <span class="nt">&lt;releases&gt;</span>
</span><span class="hll">                 <span class="nt">&lt;enabled&gt;</span>true<span class="nt">&lt;/enabled&gt;</span>
</span><span class="hll">             <span class="nt">&lt;/releases&gt;</span>
</span><span class="hll">             <span class="nt">&lt;snapshots&gt;</span>
</span><span class="hll">                 <span class="nt">&lt;enabled&gt;</span>false<span class="nt">&lt;/enabled&gt;</span>
</span><span class="hll">             <span class="nt">&lt;/snapshots&gt;</span>
</span><span class="hll">             <span class="nt">&lt;id&gt;</span>terasoluna-gfw-3rdparty<span class="nt">&lt;/id&gt;</span>
</span><span class="hll">             <span class="nt">&lt;url&gt;</span>http://repo.terasoluna.org/nexus/content/repositories/terasoluna-gfw-3rdparty/<span class="nt">&lt;/url&gt;</span>
</span><span class="hll">         <span class="nt">&lt;/repository&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/repositories&gt;</span>
</span><span class="hll">
</span><span class="hll">     <span class="nt">&lt;dependencies&gt;</span>
</span><span class="hll">         <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">         <span class="c">&lt;!-- TERASOLUNA --&gt;</span>
</span><span class="hll">         <span class="nt">&lt;dependency&gt;</span>
</span><span class="hll">             <span class="nt">&lt;groupId&gt;</span>org.terasoluna.gfw<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll">             <span class="nt">&lt;artifactId&gt;</span>terasoluna-gfw-web<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll">         <span class="nt">&lt;/dependency&gt;</span>
</span><span class="hll">         <span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="hll">         <span class="nt">&lt;dependency&gt;</span>
</span><span class="hll">             <span class="nt">&lt;groupId&gt;</span>org.terasoluna.gfw<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll">             <span class="nt">&lt;artifactId&gt;</span>terasoluna-gfw-security-web<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll">         <span class="nt">&lt;/dependency&gt;</span>
</span><span class="hll">         <span class="c">&lt;!-- (5) --&gt;</span>
</span><span class="hll">         <span class="nt">&lt;dependency&gt;</span>
</span><span class="hll">             <span class="nt">&lt;groupId&gt;</span>org.terasoluna.gfw<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll">             <span class="nt">&lt;artifactId&gt;</span>terasoluna-gfw-recommended-dependencies<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll">             <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
</span><span class="hll">         <span class="nt">&lt;/dependency&gt;</span>
</span><span class="hll">
</span><span class="hll">         <span class="c">&lt;!-- (6) --&gt;</span>
</span><span class="hll">         <span class="c">&lt;!-- Servlet API/ JSP API --&gt;</span>
</span><span class="hll">         <span class="nt">&lt;dependency&gt;</span>
</span><span class="hll">             <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll">             <span class="nt">&lt;artifactId&gt;</span>tomcat-servlet-api<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll">             <span class="nt">&lt;version&gt;</span>7.0.40<span class="nt">&lt;/version&gt;</span>
</span><span class="hll">             <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
</span><span class="hll">         <span class="nt">&lt;/dependency&gt;</span>
</span><span class="hll">         <span class="nt">&lt;dependency&gt;</span>
</span><span class="hll">             <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll">             <span class="nt">&lt;artifactId&gt;</span>tomcat-jsp-api<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll">             <span class="nt">&lt;version&gt;</span>7.0.40<span class="nt">&lt;/version&gt;</span>
</span><span class="hll">             <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
</span><span class="hll">         <span class="nt">&lt;/dependency&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/dependencies&gt;</span>
</span> <span class="nt">&lt;/project&gt;</span>
</pre></div>
</div>
<p>pom.xmlを編集した後、プロジェクト名を右クリックし、「Maven」-&gt;「Update Project」をクリックし、</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/update-project.png"><img alt="../_images/update-project.png" src="../_images/update-project.png" style="width: 60%;" /></a>
</div>
<p>「OK」ボタンをクリックする。</p>
<p>以下のように&#8221;JRE System Library&#8221;のバージョンが&#8221;[JavaSE-1.6]&#8221;になっていることを確認する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/check-jre.jpg"><img alt="../_images/check-jre.jpg" src="../_images/check-jre.jpg" style="width: 30%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>JDKのバージョンを7に変更したい場合は、pom.xmlの <tt class="docutils literal"><span class="pre">&lt;properties&gt;</span></tt> に <tt class="docutils literal"><span class="pre">&lt;java-version&gt;1.7&lt;/java-version&gt;</span></tt> を設定した後、
「Update Project」を実施すること。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre> <span class="nt">&lt;project&gt;</span>
     <span class="c">&lt;!-- omitted --&gt;</span>

<span class="hll">     <span class="nt">&lt;properties&gt;</span>
</span><span class="hll">         <span class="nt">&lt;java-version&gt;</span>1.7<span class="nt">&lt;/java-version&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/properties&gt;</span>
</span> <span class="nt">&lt;/project&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
<p>Mavenの知識がある場合は、以下の解説を確認すること。</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">TERASOLUNA Global Frameworkの親pomファイルを指定する。</div>
<div class="line">これにより、terasoluna-parentで定義されているライブラリは、versionを指定しなくても、dependencyに追加することができる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">TERASOLUNA Global Frameworkを使うためのMavenレポジトリのURLを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">TERASOLUNA Global Frameworkの共通ライブラリ(Web用)をdependencyに追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">TERASOLUNA Global Frameworkの共通ライブラリ(セキュリティWeb用)をdependencyに追加する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">TERASOLUNA Global Frameworkで推奨されるライブラリ群を追加する。</div>
<div class="line">terasoluna-gfw-recommended-dependenciesはただのpomファイルであるため <tt class="docutils literal"><span class="pre">&lt;type&gt;pom&lt;/type&gt;</span></tt> を記述する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Servlet/JSP APIをdependencyに追加する。Servlet3に対応する必要がある。</div>
<div class="line">これらはscope=provided(本来APサーバーから提供される)であり、warには含まれないが、eclipse上でコンパイルするためには明示的にdependencyに追加する必要がある。</div>
<div class="line">（尚、dependency名がtomcat-xxxとなっているが、内包するクラスのパッケージはjavax.servletであるためtomcatに依存しているわけではない。）</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Proxyサーバーを介してインターネットアクセスする必要がある場合は、
&lt;HOME&gt;/.m2/settings.xmlに以下のような設定を行う。
(Windows7の場合C:\Users\&lt;YourName&gt;\.m2settings.xml)</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;settings&gt;</span>
  <span class="nt">&lt;proxies&gt;</span>
    <span class="nt">&lt;proxy&gt;</span>
      <span class="nt">&lt;active&gt;</span>true<span class="nt">&lt;/active&gt;</span>
      <span class="nt">&lt;protocol&gt;</span>[Proxy Server Protocol (http)]<span class="nt">&lt;/protocol&gt;</span>
      <span class="nt">&lt;port&gt;</span>[Proxy Server Port]<span class="nt">&lt;/port&gt;</span>
      <span class="nt">&lt;host&gt;</span>[Proxy Server Host]<span class="nt">&lt;/host&gt;</span>
      <span class="nt">&lt;username&gt;</span>[Username]<span class="nt">&lt;/username&gt;</span>
      <span class="nt">&lt;password&gt;</span>[Password]<span class="nt">&lt;/password&gt;</span>
    <span class="nt">&lt;/proxy&gt;</span>
  <span class="nt">&lt;/proxies&gt;</span>
<span class="nt">&lt;/settings&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id13">
<h3><a class="toc-backref" href="#id74">3.3.3. プロジェクト構成</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>今後作成していくプロジェクトの構成について、以下に示す。</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">src</span>
<span class="go">  └main</span>
<span class="go">      ├java</span>
<span class="go">      │  └todo</span>
<span class="go">      │    ├ app ... アプリケーション層を格納</span>
<span class="go">      │    │   └todo ... todo管理業務に関わるクラスを格納</span>
<span class="go">      │    └domain ... ドメイン層を格納</span>
<span class="go">      │        ├model ... Domain Objectを格納</span>
<span class="go">      │        ├repository ... Repositoryを格納</span>
<span class="go">      │        │   └todo ... Todo用Repository</span>
<span class="go">      │        └service ... Serviceを格納</span>
<span class="go">      │            └todo ... TODO業務Service</span>
<span class="go">      ├resources</span>
<span class="go">      │  └META-INF</span>
<span class="go">      │      └spring ... spring関連の設定ファイルを格納</span>
<span class="go">      └wepapp</span>
<span class="go">          └WEB-INF</span>
<span class="go">              └views ... jspを格納</span>
</pre></div>
</div>
<p>順番に作成していくので、最初に上記構成を用意する必要はない。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference internal" href="../Overview/ApplicationLayering.html#application-layering-project-structure"><em>前節の「プロジェクト構成」</em></a> ではマルチプロジェクトにすることを推奨していたが、
本チュートリアルでは、学習容易性を重視しているためシングルプロジェクト構成にしている。ただし、実プロジェクトで適用する場合は、
マルチプロジェクト構成を強く推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id14">
<h3><a class="toc-backref" href="#id75">3.3.4. 設定ファイルの作成</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<div class="section" id="web-xml">
<h4><a class="toc-backref" href="#id76">3.3.4.1. web.xmlの設定</a><a class="headerlink" href="#web-xml" title="Permalink to this headline">¶</a></h4>
<p>src/main/webapp/WEB-INF/web.xmlを作成して、サーブレットやフィルタの定義を行う。
WEB-INFフォルダは「New」-&gt;「Folder」で新規作成すること。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image010.jpg"><img alt="../_images/image010.jpg" src="../_images/image010.jpg" style="width: 40%;" /></a>
</div>
<p>「New」-&gt;「File」でweb.xmlを作成し、</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image011.jpg"><img alt="../_images/image011.jpg" src="../_images/image011.jpg" style="width: 40%;" /></a>
</div>
<p>内容は以下のように記述する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
    <span class="na">version=</span><span class="s">&quot;3.0&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
    <span class="nt">&lt;context-param&gt;</span>
        <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
        <span class="c">&lt;!-- Root ApplicationContext --&gt;</span>
        <span class="nt">&lt;param-value&gt;</span>
            classpath*:META-INF/spring/applicationContext.xml
        <span class="nt">&lt;/param-value&gt;</span>
    <span class="nt">&lt;/context-param&gt;</span>

    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>CharacterEncodingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="nt">&lt;/filter-class&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>encoding<span class="nt">&lt;/param-name&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>UTF-8<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>forceEncoding<span class="nt">&lt;/param-name&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>true<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>CharacterEncodingFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>

    <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>appServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
            <span class="c">&lt;!-- ApplicationContext for Spring MVC --&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>classpath*:META-INF/spring/spring-mvc.xml<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>

    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>appServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>

    <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;jsp-config&gt;</span>
        <span class="nt">&lt;jsp-property-group&gt;</span>
            <span class="nt">&lt;url-pattern&gt;</span>*.jsp<span class="nt">&lt;/url-pattern&gt;</span>
            <span class="nt">&lt;el-ignored&gt;</span>false<span class="nt">&lt;/el-ignored&gt;</span>
            <span class="nt">&lt;page-encoding&gt;</span>UTF-8<span class="nt">&lt;/page-encoding&gt;</span>
            <span class="nt">&lt;scripting-invalid&gt;</span>false<span class="nt">&lt;/scripting-invalid&gt;</span>
            <span class="nt">&lt;include-prelude&gt;</span>/WEB-INF/views/common/include.jsp<span class="nt">&lt;/include-prelude&gt;</span>
        <span class="nt">&lt;/jsp-property-group&gt;</span>
    <span class="nt">&lt;/jsp-config&gt;</span>
<span class="nt">&lt;/web-app&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Servlet3.0を使用するための宣言。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">ContextLoaderListener</span></tt> の定義。このリスナーが作成する <tt class="docutils literal"><span class="pre">ApplicationContext</span></tt> がルートコンテキストとなる。</div>
<div class="line">Bean定義ファイルのパスをclasspath直下のMETA-INF/spring/applicationContext.xmlとする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">CharacterEncodingFilter</span></tt> の定義。リクエストとレスポンスの文字コードをUTF-8にするための設定。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCのエントリポイントとなるDispatcherServletの定義。</div>
<div class="line">Spring MVCで使用するBean定義ファイルのパスをclasspath直下のMETA-INF/spring/spring-mvc.xmlとする。</div>
<div class="line">ここで作成される <tt class="docutils literal"><span class="pre">ApplicationContext</span></tt> は(2)で作成される <tt class="docutils literal"><span class="pre">ApplicatnionContext</span></tt> の子となる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JSP共通でincludeするJSPの定義。任意のJSP(<a href="#id15"><span class="problematic" id="id16">*</span></a>.jsp)に対して、/WEB-INF/views/common/include.jspをincludeする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image013.png"><img alt="../_images/image013.png" src="../_images/image013.png" style="width: 40%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="jsp">
<h4><a class="toc-backref" href="#id77">3.3.4.2. 共通JSPの設定</a><a class="headerlink" href="#jsp" title="Permalink to this headline">¶</a></h4>
<p>src/main/webapp/WEB-INF/views/common/include.jspに各JSP共通でincludeする内容を記述する。taglibの定義を共通的に行う。
views/commonフォルダ、include.jspファイルを作成し、以下のように記述する。</p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="k">&lt;%@</span> <span class="n">page</span> <span class="n">session</span><span class="o">=</span><span class="s">&quot;false&quot;</span><span class="k">%&gt;</span>
<span class="c">&lt;!-- (1) --&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://java.sun.com/jsp/jstl/core&quot;</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;c&quot;</span><span class="k">%&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://java.sun.com/jsp/jstl/fmt&quot;</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;fmt&quot;</span><span class="k">%&gt;</span>
<span class="c">&lt;!-- (2)  --&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/tags&quot;</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;spring&quot;</span><span class="k">%&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/tags/form&quot;</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;form&quot;</span><span class="k">%&gt;</span>
<span class="c">&lt;!-- (3) --&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/security/tags&quot;</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;sec&quot;</span><span class="k">%&gt;</span>
<span class="c">&lt;!-- (4) --&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://terasoluna.org/functions&quot;</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;f&quot;</span><span class="k">%&gt;</span>
<span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://terasoluna.org/tags&quot;</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;t&quot;</span><span class="k">%&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">標準タグライブラリを定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVC用タグライブラリを定義する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Security用タグライブラリを定義する。(ただし本チュートリアルでは使用しない。)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">共通ライブラリで提供されている、EL関数、タグライブラリを定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image014.png"><img alt="../_images/image014.png" src="../_images/image014.png" style="width: 40%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="bean">
<h4><a class="toc-backref" href="#id78">3.3.4.3. Bean定義ファイルの設定</a><a class="headerlink" href="#bean" title="Permalink to this headline">¶</a></h4>
<p>Bean定義ファイルは、以下4種類のファイルを作成する。</p>
<ul class="simple">
<li>applicationContext.xml</li>
<li>todo-domain.xml</li>
<li>todo-infra.xml</li>
<li>spring-mvc.xml</li>
</ul>
<p>上から順に説明する。</p>
<div class="section" id="applicationcontext-xml">
<h5>3.3.4.3.1. applicationContext.xml<a class="headerlink" href="#applicationcontext-xml" title="Permalink to this headline">¶</a></h5>
<p>src/main/resources/META-INF/spring/applicationContext.xmlに、Todoアプリ全体に関わる設定を行う。</p>
<p>META-INF/springフォルダを作成し、「New」-&gt;「Spring Bean Configuration File」でapplicationContext.xmlを作成する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image016.jpg"><img alt="../_images/image016.jpg" src="../_images/image016.jpg" style="width: 40%;" /></a>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;import</span> <span class="na">resource=</span><span class="s">&quot;classpath:/META-INF/spring/todo-domain.xml&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;context:property-placeholder</span>
        <span class="na">location=</span><span class="s">&quot;classpath*:/META-INF/spring/*.properties&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.dozer.spring.DozerBeanMapperFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mappingFiles&quot;</span>
            <span class="na">value=</span><span class="s">&quot;classpath*:/META-INF/dozer/**/*-mapping.xml&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">次に説明する、ドメイン層に関するBean定義ファイルをimportする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">プロパティファイルの読み込み設定を行う。</div>
<div class="line">src/main/resources/META-INF/spring直下の任意のプロパティファイルを読み込む。</div>
<div class="line">この設定により、プロパティファイルの値をBean定義ファイル内で${propertyName}形式で埋め込んだり、Javaクラスに&#64;Value(&#8220;${propertyName}&#8221;)でインジェクションすることができる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Bean変換用ライブラリDozerのMapperを定義する。</div>
<div class="line">(今回は使用しないが、マッピング用XMLファイルを定義する場合はsrc/main/resources/META-INF/dozer/xxx-mapping.xmlという形式でマッピングファイルを作成すること。</div>
<div class="line">マッピングファイルに関して <a class="reference external" href="http://dozer.sourceforge.net/documentation/mappings.html">Dozerマニュアル</a> を参照されたい。)</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image018.png"><img alt="../_images/image018.png" src="../_images/image018.png" style="width: 40%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>上記内容をコピーせず手入力を行う場合は、「namespace」タブを開き、「Configure Namspecse」で「beans」と「context」にチェックを入れること。
また「Namespace Versions」でバージョンなしのxsdファイルを選択することを推奨する。</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/image021.jpg"><img alt="../_images/image021.jpg" src="../_images/image021.jpg" style="width: 60%;" /></a>
</div>
<p>これにより、XML編集時にCtrl+Spaceを使用して入力を補完することができる。</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/image023.png"><img alt="../_images/image023.png" src="../_images/image023.png" style="width: 60%;" /></a>
</div>
<p class="last">またバージョンを指定しないことにより、常にjarに含まれる最新のxsdが使用される。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="todo-domain-xml">
<h5>3.3.4.3.2. todo-domain.xml<a class="headerlink" href="#todo-domain-xml" title="Permalink to this headline">¶</a></h5>
<p>src/main/resources/META-INF/spring/todo-domain.xmlに、ドメイン層に関わる設定を行う。</p>
<p>META-INF/spring直下において、「New」-&gt;「Spring Bean Configuration File」でtodo-domain.xmlを作成する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;import</span> <span class="na">resource=</span><span class="s">&quot;classpath:META-INF/spring/todo-infra.xml&quot;</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&quot;todo.domain&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">次に説明する、インフラストラクチャ層に関するBean定義ファイルをimportする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ドメイン層のクラスを管理するtodo.domainパッケージ配下をcomponent-scan対象とする。</div>
<div class="line">これにより、todo.domainパッケージ配下のクラスに <tt class="docutils literal"><span class="pre">&#64;Repository</span></tt> , <tt class="docutils literal"><span class="pre">&#64;Service</span></tt> , <tt class="docutils literal"><span class="pre">&#64;Controller</span></tt>, <tt class="docutils literal"><span class="pre">&#64;Component</span></tt> などのアノテーションを付けることで、DI対象にできる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image024.png"><img alt="../_images/image024.png" src="../_images/image024.png" style="width: 40%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="todo-infra-xml">
<h5>3.3.4.3.3. todo-infra.xml<a class="headerlink" href="#todo-infra-xml" title="Permalink to this headline">¶</a></h5>
<p>src/main/resources/META-INF/spring/todo-infra.xmlに、インフラストラクチャ層に関するBean定義を行う。
ここではDBの設定などを行うが、本節ではDBを使用しないため、以下のように空定義で良い。次節でBean定義を行う。</p>
<p>META-INF/spring直下において、「New」-&gt;「Spring Bean Configuration File」でtodo-infra.xmlを作成する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image025.png"><img alt="../_images/image025.png" src="../_images/image025.png" style="width: 40%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">todo-domain.xml, todo-infra.xmlの内容もすべてapplicationContext.xmlに記述すればよいように思えるかもしれないが、
役割(層)ごとにファイルを分割することを推奨する。どこに何が定義されているか想像しやすく、メンテナンス性が向上するからである。
今回のチュートリアルのような小さなアプリケーションでは効果がない。しかし、アプリケーションの規模が大きくなるにつれ、効果が大きくなる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="spring-mvc-xml">
<h5>3.3.4.3.4. spring-mvc.xml<a class="headerlink" href="#spring-mvc-xml" title="Permalink to this headline">¶</a></h5>
<p>src/main/resources/META-INF/spring/spring-mvc.xmlに、Spring MVCに関する定義を行う。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
    <span class="na">xmlns:mvc=</span><span class="s">&quot;http://www.springframework.org/schema/mvc&quot;</span> <span class="na">xmlns:util=</span><span class="s">&quot;http://www.springframework.org/schema/util&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd</span>
<span class="s">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;mvc:annotation-driven&gt;&lt;/mvc:annotation-driven&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&quot;todo.app&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;mvc:resources</span> <span class="na">mapping=</span><span class="s">&quot;/resources/**&quot;</span>
        <span class="na">location=</span><span class="s">&quot;/resources/,classpath:META-INF/resources/&quot;</span>
        <span class="na">cache-period=</span><span class="s">&quot;#{60 * 60}&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;mvc:interceptors&gt;</span>
        <span class="c">&lt;!-- (4) --&gt;</span>
        <span class="nt">&lt;mvc:interceptor&gt;</span>
            <span class="nt">&lt;mvc:mapping</span> <span class="na">path=</span><span class="s">&quot;/**&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/resources/**&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;bean</span>
                <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.logging.TraceLoggingInterceptor&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/mvc:interceptor&gt;</span>
    <span class="nt">&lt;/mvc:interceptors&gt;</span>

    <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;viewResolver&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;prefix&quot;</span> <span class="na">value=</span><span class="s">&quot;/WEB-INF/views/&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;suffix&quot;</span> <span class="na">value=</span><span class="s">&quot;.jsp&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring MVCのアノテーションベースのデフォルト設定を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アプリケーション層のクラスを管理するtodo.appパッケージ配下をcomponent-scan対象とする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">静的リソース(css, images, jsなど)アクセスのための設定を行う。</div>
<div class="line">mapping属性にURLのパスを、location属性に物理的なパスの設定を行う。</div>
<div class="line">この設定の場合&lt;contextPath&gt;/rerources/css/styles.cssに対してリクエストが来た場合、WEB-INF/resources/css/styles.cssを探し、見つからなければクラスパス上(src/main/resourcesやjar内)のresources/css/style.cssを探す。</div>
<div class="line">WEB-INF/resources/css/styles.cssが見つからなければ、404エラーを返す。</div>
<div class="line">ここではcache-period属性で静的リソースのキャッシュ時間(3600秒=60分)も設定している。</div>
<div class="line"><tt class="docutils literal"><span class="pre">cache-period=&quot;3600&quot;</span></tt> と設定しても良いが、60分であることを明示するために <a class="reference external" href="http://static.springsource.org/spring/docs/3.2.x/spring-framework-reference/html/expressions.html#expressions-beandef-xml-based">SpEL</a> を使用して <tt class="docutils literal"><span class="pre">cache-period=&quot;#{60</span> <span class="pre">*</span> <span class="pre">60}&quot;</span></tt> と書く方が分かりやすい。</div>
<div class="line">尚、本チュートリアルでは静的リソースは使用しない。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コントローラ処理のTraceログを出力するインターセプタを設定する。/resources以下を除く任意のパスに適用されるように設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ViewResolverの設定を行う。この設定により、例えばコントローラからview名”hello”が返却された場合には/WEB-INF/views/hello.jspが実行される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image026.png"><img alt="../_images/image026.png" src="../_images/image026.png" style="width: 40%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>上記内容をコピーせず手入力を行う場合は、todo-domain.xmlで説明した操作に加え、「mvc」と「util」にもチェックを入れること。</p>
<div class="last figure align-center">
<a class="reference internal image-reference" href="../_images/image028.png"><img alt="../_images/image028.png" src="../_images/image028.png" style="width: 60%;" /></a>
</div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="logback-xml">
<h4><a class="toc-backref" href="#id79">3.3.4.4. logback.xmlの設定</a><a class="headerlink" href="#logback-xml" title="Permalink to this headline">¶</a></h4>
<p>src/main/resources/logback.xmlに、logbackによるログの出力設定を行う。</p>
<p>src/main/resources/直下において、「New」-&gt;「File」でlogback.xmlを作成する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE logback&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">&quot;STDOUT&quot;</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;encoder&gt;</span>
            <span class="nt">&lt;pattern&gt;</span><span class="cp">&lt;![CDATA[%d{yyyy-MM-dd HH:mm:ss} [%thread] [%-5level] [%-48logger{48}] - %msg%n]]&gt;</span><span class="nt">&lt;/pattern&gt;</span>
        <span class="nt">&lt;/encoder&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>

    <span class="c">&lt;!-- Application Loggers --&gt;</span>
    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;todo&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;debug&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/logger&gt;</span>

    <span class="c">&lt;!-- TERASOLUNA --&gt;</span>
    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.terasoluna.gfw&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;info&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/logger&gt;</span>
    <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.terasoluna.gfw.web.logging.TraceLoggingInterceptor&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;trace&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/logger&gt;</span>

    <span class="c">&lt;!-- 3rdparty Loggers --&gt;</span>
    <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.springframework&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;warn&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/logger&gt;</span>

    <span class="c">&lt;!-- (6) --&gt;</span>
    <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.springframework.web.servlet&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;info&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/logger&gt;</span>

    <span class="c">&lt;!-- (7) --&gt;</span>
    <span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">&quot;WARN&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&quot;STDOUT&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/root&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">標準出力でログを出力するアペンダを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">todoパッケージ以下はdebugレベル以上を出力するように設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">共通ライブラリのログレベルをinfoにする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">spring-mvc.xmlに設定した <tt class="docutils literal"><span class="pre">TraceLoggingInterceptor</span></tt> に出力されるようにtraceレベルで設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Springframeworkのログはwarnレベル以上を出力するように設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Springframeworkのログの中でもorg.springframework.web.servlet以下は開発中に有益なログを出力するためinfoレベル以上で設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">デフォルトはwarnレベル以上を出力するように設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image029.png"><img alt="../_images/image029.png" src="../_images/image029.png" style="width: 40%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id17">
<h3><a class="toc-backref" href="#id80">3.3.5. 動作確認</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p>Todoアプリケーションの開発を始める前に、SpringMVCのHelloWorldアプリケーションを作成して、動作確認を行う。「New」-&gt;「Class」で</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><th class="stub">Package:</th>
<td>todo.app.hello</td>
</tr>
<tr class="row-even"><th class="stub">Name:</th>
<td>HelloController</td>
</tr>
</tbody>
</table>
<p>でtodo.app.hello.HelloControllerを作成する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image030.jpg"><img alt="../_images/image030.jpg" src="../_images/image030.jpg" style="width: 40%;" /></a>
</div>
<p>HelloControllerを以下のように編集する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">hello</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>

<span class="c1">// (1)</span>
<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloController</span> <span class="o">{</span>
    <span class="c1">// (2)</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span>
            <span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">HelloController</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="c1">// (3)</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">hello</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Date</span> <span class="n">now</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>
        <span class="c1">// (4)</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;hello {}&quot;</span><span class="o">,</span> <span class="n">now</span><span class="o">);</span>
        <span class="c1">// (5)</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;now&quot;</span><span class="o">,</span> <span class="n">now</span><span class="o">);</span>
        <span class="c1">// (6)</span>
        <span class="k">return</span> <span class="s">&quot;hello&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Controllerとしてcomponent-scanの対象とするため、クラスレベルに <tt class="docutils literal"><span class="pre">&#64;Controller</span></tt> アノテーションをつける。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ロガーの生成を行う。ロガーの実装はlogbackのものであるが、APIはSLF4Jのものであるため、<tt class="docutils literal"><span class="pre">org.slf4j.Logger</span></tt> を使用すること。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&#64;RequestMapping</span></tt> で”/”(ルート)へのアクセスに対するメソッドのマッピングを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">debugログを出力する。”{}”はプレースホルダである。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">画面へ日付を渡すためにModelに”now”という名前でDateオブジェクトを追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">view名としてhelloを返す。ViewResolverの設定により、WEB-INF/views/hello.jspが出力される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>次にview(jsp)を作成する。src/main/webapp/WEB-INF/views/hello.jspを作成して、以下のように記述する。</p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Hello World!<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Hello World!<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
        Today is
        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;fmt:formatDate</span> <span class="na">value=</span><span class="s">&quot;${now}&quot;</span> <span class="na">pattern=</span><span class="s">&quot;yyyy-MM-dd HH:mm:ss&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Controllerから渡された”now”を表示する。ここでは <tt class="docutils literal"><span class="pre">&lt;fmt:formatDate&gt;</span></tt> タグを用いて日付フォーマットを行っている。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>パッケージプロジェクト名”todo”を右クリックして「Run As」-&gt;「Run on Server」</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image031.jpg"><img alt="../_images/image031.jpg" src="../_images/image031.jpg" style="width: 40%;" /></a>
</div>
<p>実行したいAPサーバー(ここではVMWare vFabric tc Server Developer Edition v2.8)を選び
「Next」をクリック</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image032.jpg"><img alt="../_images/image032.jpg" src="../_images/image032.jpg" style="width: 40%;" /></a>
</div>
<p>todoが「Configured」に含まれていることを確認して「Finish」をクリックしてサーバーを起動する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image033.jpg"><img alt="../_images/image033.jpg" src="../_images/image033.jpg" style="width: 40%;" /></a>
</div>
<p>起動すると以下のようなログが出力される。”/”というパスに対して <tt class="docutils literal"><span class="pre">todo.app.hello.HelloController</span></tt> のhelloメソッドがマッピングされていることが分かる。</p>
<div class="highlight-guess"><div class="highlight"><pre> <span class="mi">2013</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">14</span> <span class="mi">14</span><span class="o">:</span><span class="mi">26</span><span class="o">:</span><span class="mi">54</span> <span class="p">[</span><span class="n">localhost</span><span class="o">-</span><span class="n">startStop</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="n">WARN</span> <span class="p">]</span> <span class="p">[</span><span class="n">org</span><span class="p">.</span><span class="n">dozer</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">GlobalSettings</span>                 <span class="p">]</span> <span class="o">-</span> <span class="n">Dozer</span> <span class="n">configuration</span> <span class="n">file</span> <span class="n">not</span> <span class="n">found</span><span class="o">:</span> <span class="n">dozer</span><span class="p">.</span><span class="n">properties</span><span class="p">.</span>  <span class="n">Using</span> <span class="n">defaults</span> <span class="k">for</span> <span class="n">all</span> <span class="n">Dozer</span> <span class="n">global</span> <span class="n">properties</span><span class="p">.</span>
 <span class="mi">2013</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">14</span> <span class="mi">14</span><span class="o">:</span><span class="mi">26</span><span class="o">:</span><span class="mi">54</span> <span class="p">[</span><span class="n">localhost</span><span class="o">-</span><span class="n">startStop</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span> <span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">springframework</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">servlet</span><span class="p">.</span><span class="n">DispatcherServlet</span> <span class="p">]</span> <span class="o">-</span> <span class="n">FrameworkServlet</span> <span class="err">&#39;</span><span class="n">appServlet</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">initialization</span> <span class="n">started</span>
<span class="hll"> <span class="mi">2013</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">14</span> <span class="mi">14</span><span class="o">:</span><span class="mi">26</span><span class="o">:</span><span class="mi">54</span> <span class="p">[</span><span class="n">localhost</span><span class="o">-</span><span class="n">startStop</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span> <span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">m</span><span class="p">.</span><span class="n">m</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">RequestMappingHandlerMapping</span>      <span class="p">]</span> <span class="o">-</span> <span class="n">Mapped</span> <span class="s">&quot;{[/],methods=[],params=[],headers=[],consumes=[],produces=[],custom=[]}&quot;</span> <span class="n">onto</span> <span class="n">public</span> <span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">String</span> <span class="n">todo</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">hello</span><span class="p">.</span><span class="n">HelloController</span><span class="p">.</span><span class="n">hello</span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="n">springframework</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">Model</span><span class="p">)</span>
</span> <span class="mi">2013</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">14</span> <span class="mi">14</span><span class="o">:</span><span class="mi">26</span><span class="o">:</span><span class="mi">55</span> <span class="p">[</span><span class="n">localhost</span><span class="o">-</span><span class="n">startStop</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span> <span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">servlet</span><span class="p">.</span><span class="n">handler</span><span class="p">.</span><span class="n">SimpleUrlHandlerMapping</span> <span class="p">]</span> <span class="o">-</span> <span class="n">Mapped</span> <span class="n">URL</span> <span class="n">path</span> <span class="p">[</span><span class="o">/</span><span class="n">resources</span><span class="o">/**</span><span class="p">]</span> <span class="n">onto</span> <span class="n">handler</span> <span class="err">&#39;</span><span class="n">org</span><span class="p">.</span><span class="n">springframework</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">servlet</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">ResourceHttpRequestHandler</span><span class="err">#</span><span class="mi">0</span><span class="err">&#39;</span>
 <span class="mi">2013</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">14</span> <span class="mi">14</span><span class="o">:</span><span class="mi">26</span><span class="o">:</span><span class="mi">55</span> <span class="p">[</span><span class="n">localhost</span><span class="o">-</span><span class="n">startStop</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span> <span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">springframework</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">servlet</span><span class="p">.</span><span class="n">DispatcherServlet</span> <span class="p">]</span> <span class="o">-</span> <span class="n">FrameworkServlet</span> <span class="err">&#39;</span><span class="n">appServlet</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">initialization</span> <span class="n">completed</span> <span class="n">in</span> <span class="mi">986</span> <span class="n">ms</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">一行目のWARNログは無視しても良い。抑止したい場合はsrc/main/resourcesに空のdozer.propertiesを作成すること。</p>
</div>
</div></blockquote>
<p>ブラウザでhttp://localhost:8080/todo
にアクセスすると、以下のように表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image034.png"><img alt="../_images/image034.png" src="../_images/image034.png" style="width: 40%;" /></a>
</div>
<p>コンソールを見ると <tt class="docutils literal"><span class="pre">TraceLoggingInterceptor</span></tt> によるTRACEログとControllerで実装したdebugログが出力されていることがわかる。</p>
<div class="highlight-guess"><div class="highlight"><pre><span class="mi">2013</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">14</span> <span class="mi">15</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">59</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">TRACE</span><span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">gfw</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">logging</span><span class="p">.</span><span class="n">TraceLoggingInterceptor</span>     <span class="p">]</span> <span class="o">-</span> <span class="p">[</span><span class="n">START</span> <span class="n">CONTROLLER</span><span class="p">]</span> <span class="n">HelloController</span><span class="p">.</span><span class="n">hello</span><span class="p">(</span><span class="n">Model</span><span class="p">)</span>
<span class="mi">2013</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">14</span> <span class="mi">15</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">59</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">[</span><span class="n">todo</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">hello</span><span class="p">.</span><span class="n">HelloController</span>                  <span class="p">]</span> <span class="o">-</span> <span class="n">hello</span> <span class="n">Fri</span> <span class="n">Jun</span> <span class="mi">14</span> <span class="mi">15</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">59</span> <span class="n">JST</span> <span class="mi">2013</span>
<span class="mi">2013</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">14</span> <span class="mi">15</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">59</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">TRACE</span><span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">gfw</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">logging</span><span class="p">.</span><span class="n">TraceLoggingInterceptor</span>     <span class="p">]</span> <span class="o">-</span> <span class="p">[</span><span class="n">END</span> <span class="n">CONTROLLER</span>  <span class="p">]</span> <span class="n">HelloController</span><span class="p">.</span><span class="n">hello</span><span class="p">(</span><span class="n">Model</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">view</span><span class="o">=</span><span class="n">hello</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="p">{</span><span class="n">now</span><span class="o">=</span><span class="n">Fri</span> <span class="n">Jun</span> <span class="mi">14</span> <span class="mi">15</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">59</span> <span class="n">JST</span> <span class="mi">2013</span><span class="p">}</span>
<span class="mi">2013</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">14</span> <span class="mi">15</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mi">59</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">TRACE</span><span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">gfw</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">logging</span><span class="p">.</span><span class="n">TraceLoggingInterceptor</span>     <span class="p">]</span> <span class="o">-</span> <span class="p">[</span><span class="n">HANDLING</span> <span class="n">TIME</span>   <span class="p">]</span> <span class="n">HelloController</span><span class="p">.</span><span class="n">hello</span><span class="p">(</span><span class="n">Model</span><span class="p">)</span><span class="o">-&gt;</span> <span class="mi">15</span><span class="p">,</span><span class="mo">043</span><span class="p">,</span><span class="mi">704</span> <span class="n">ns</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal"><span class="pre">TraceLoggingInterceptor</span></tt> はControllerの開始、終了でログを出力する。終了時にはViewとModelの情報および処理時間を出力する。</p>
</div>
</div></blockquote>
<p>ログの確認後は、HelloController, hello.jspの2ファイルを削除しても構わない。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id18">
<h2><a class="toc-backref" href="#id81">3.4. Todoアプリケーションの作成</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">Todoアプリケーションを作成する。作成する順は、以下の通りである。</div>
</div>
<ul class="simple">
<li>ドメイン層(+ インフラストラクチャ層)</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>Domain Object作成</li>
<li>Repository作成</li>
<li>Service作成</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>アプリケーション層</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>Controller作成</li>
<li>Form作成</li>
<li>View作成</li>
</ul>
</div></blockquote>
<p>なお、本節では、Todoの保存にDBを使用しない。DBを使用するRepositoryの作成は、<a class="reference internal" href="#tutorial-todo-infra"><em>インフラストラクチャ層の変更</em></a>で行う。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id19">
<h3><a class="toc-backref" href="#id82">3.4.1. ドメイン層の作成</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<div class="section" id="domain-object">
<h4><a class="toc-backref" href="#id83">3.4.1.1. Domain Objectの作成</a><a class="headerlink" href="#domain-object" title="Permalink to this headline">¶</a></h4>
<p>ドメインオブジェクトに必要なプロパティは、</p>
<ol class="arabic simple">
<li>ID</li>
<li>タイトル</li>
<li>完了フラグ</li>
<li>作成日</li>
</ol>
<p>である。</p>
<p>以下の、Domainオブジェクトを作成する。
FQCNは、todo.domain.model.Todoとする。JavaBeanとして実装すればよい。</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><th class="stub">Package:</th>
<td>todo.domain.model</td>
</tr>
<tr class="row-even"><th class="stub">Name:</th>
<td>Todo</td>
</tr>
<tr class="row-odd"><th class="stub">Interfaces:</th>
<td>java.io.Serializable</td>
</tr>
</tbody>
</table>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image057.png"><img alt="../_images/image057.png" src="../_images/image057.png" style="width: 40%;" /></a>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">model</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>


    <span class="kd">private</span> <span class="n">String</span> <span class="n">todoId</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">todoTitle</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">finished</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">Date</span> <span class="n">createdAt</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">todoId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoId</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">todoId</span> <span class="o">=</span> <span class="n">todoId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoTitle</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">todoTitle</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoTitle</span><span class="o">(</span><span class="n">String</span> <span class="n">todoTitle</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">todoTitle</span> <span class="o">=</span> <span class="n">todoTitle</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFinished</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">finished</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFinished</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">finished</span> <span class="o">=</span> <span class="n">finished</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getCreatedAt</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">createdAt</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreatedAt</span><span class="o">(</span><span class="n">Date</span> <span class="n">createdAt</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">createdAt</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image058.png"><img alt="../_images/image058.png" src="../_images/image058.png" style="width: 40%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Getter/Setterは自動生成できる。フィールドを定義した後、右クリックで「Source」-&gt;「Generate Getter and Setters…」</p>
<blockquote>
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/image059.png"><img alt="../_images/image059.png" src="../_images/image059.png" style="width: 40%;" /></a>
</div>
</div></blockquote>
<p>serialVersionUID以外を選択して「OK」</p>
<blockquote class="last">
<div><div class="figure">
<a class="reference internal image-reference" href="../_images/image060.png"><img alt="../_images/image060.png" src="../_images/image060.png" style="width: 40%;" /></a>
</div>
</div></blockquote>
</div>
</div></blockquote>
</div>
<div class="section" id="repository">
<h4><a class="toc-backref" href="#id84">3.4.1.2. Repositoryの作成</a><a class="headerlink" href="#repository" title="Permalink to this headline">¶</a></h4>
<p>今回のアプリケーションで、必要なTODOオブジェクトに対するCRUD系操作は、</p>
<ul class="simple">
<li>TODOの1件取得</li>
<li>TODOの全件取得</li>
<li>TODOの1件削除</li>
<li>TODOの1件更新</li>
<li>完了済みTODO件数の取得</li>
</ul>
<p>である。これらの操作を定義するインタフェースTodoRepositoryを作成する。
FQCNは、todo.domain.repository.todo.TodoRepositoryとする。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>
    <span class="n">Todo</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">);</span>

    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>

    <span class="n">Todo</span> <span class="nf">save</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">);</span>

    <span class="kt">long</span> <span class="nf">countByFinished</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image061.png"><img alt="../_images/image061.png" src="../_images/image061.png" style="width: 40%;" /></a>
</div>
<dl class="docutils">
<dt></dt>
<dd><div class="first last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ここで、TodoRepositoryの汎用性を上げるため、「完了済み件数の取得」ではなく、「完了状態がxである件数」を取得するメソッドとして定義した。</p>
</div>
</dd>
</dl>
</div>
<div class="section" id="repositoryimpl">
<h4><a class="toc-backref" href="#id85">3.4.1.3. RepositoryImplの作成(インフラストラクチャ層)</a><a class="headerlink" href="#repositoryimpl" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">説明を単純化するため、Repositotyの実装は、Mapを使ったインメモリ実装とする。</div>
<div class="line">DBを使用したRepositoryの実装は、<a class="reference internal" href="#tutorial-todo-infra"><em>インフラストラクチャ層の変更</em></a>で説明する。</div>
<div class="line">FQCNはtodo.domain.repository.todo.TodoRepositoryImplとする。クラスレベルに、<tt class="docutils literal"><span class="pre">&#64;Repository</span></tt>アノテーションをつけること。</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>

<span class="nd">@Repository</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRepositoryImpl</span> <span class="kd">implements</span> <span class="n">TodoRepository</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Todo</span><span class="o">&gt;</span> <span class="n">TODO_MAP</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Todo</span><span class="o">&gt;();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">TODO_MAP</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">TODO_MAP</span><span class="o">.</span><span class="na">values</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">save</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">TODO_MAP</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">getTodoId</span><span class="o">(),</span> <span class="n">todo</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">TODO_MAP</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">getTodoId</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">countByFinished</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Todo</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">:</span> <span class="n">TODO_MAP</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">finished</span> <span class="o">==</span> <span class="n">todo</span><span class="o">.</span><span class="na">isFinished</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">count</span><span class="o">++;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">count</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Repositoryとして、component-scan対象とするため、クラスレベルに<tt class="docutils literal"><span class="pre">&#64;Repository</span></tt>アノテーションをつける。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Repositoryは、業務ルールを含まないので、保存先(この場合は、Map)への出し入れに終始することに注意する。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image062.png"><img alt="../_images/image062.png" src="../_images/image062.png" style="width: 40%;" /></a>
</div>
<dl class="docutils">
<dt></dt>
<dd><div class="first last admonition note">
<p class="first admonition-title">Note</p>
<p>完全に層別パッケージを分けるのであれば、インフラストラクチャ層のクラスは、todo.infrastructure以下に作成した方が良い。</p>
<p class="last">ただし、通常のプロジェクトでは、インフラストラクチャ層が変更されることを前提としていない(そのような前提で進めるプロジェクトは、少ない)。
そこで、作業効率向上のために、ドメイン層のrepositotyと同じ階層に、RepositoryImplを作成しても良い。</p>
</div>
</dd>
</dl>
</div>
<div class="section" id="service">
<h4><a class="toc-backref" href="#id86">3.4.1.4. Serviceの作成</a><a class="headerlink" href="#service" title="Permalink to this headline">¶</a></h4>
<p>業務処理を実装する。必要な処理は、</p>
<ul class="simple">
<li>Todoの全件取得</li>
<li>Todoの新規作成</li>
<li>Todoの完了</li>
<li>Todoの削除</li>
</ul>
<p>である。まずは、TodoServiceインタフェースを作成して、これらを定義する。
FQCNは、todo.domain.serivce.todo.TodoServiceとする。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoService</span> <span class="o">{</span>
    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>

    <span class="n">Todo</span> <span class="nf">create</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">);</span>

    <span class="n">Todo</span> <span class="nf">finish</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<p>必要な処理と、実装するメソッドの対応は、以下の通りである。</p>
<ul class="simple">
<li>Todoの全件取得→findAllメソッド</li>
<li>Todoの新規作成→createメソッド</li>
<li>Todoの完了→finishメソッド</li>
<li>Todoの削除→deleteメソッド</li>
</ul>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image063.png"><img alt="../_images/image063.png" src="../_images/image063.png" style="width: 40%;" /></a>
</div>
<p>実装クラスのFQCNを、todo.domain.service.TodoServiceImplとする。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="c1">//import org.springframework.transaction.annotation.Transactional;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">todo.domain.repository.todo.TodoRepository</span><span class="o">;</span>

<span class="nd">@Service</span><span class="c1">// (1)</span>
<span class="c1">// @Transactional // (2)l</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>
    <span class="nd">@Inject</span><span class="c1">// (3)</span>
    <span class="kd">protected</span> <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">MAX_UNFINISHED_COUNT</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>

    <span class="c1">// (4)</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">todo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// (5)</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">();</span>
            <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ResultMessage</span>
                    <span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;[E404] The requested Todo is not found. (id=&quot;</span>
                            <span class="o">+</span> <span class="n">todoId</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="o">));</span>
            <span class="c1">// (6)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ResourceNotFoundException</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">create</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">unfinishedCount</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">countByFinished</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">unfinishedCount</span> <span class="o">&gt;=</span> <span class="n">MAX_UNFINISHED_COUNT</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">();</span>
            <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ResultMessage</span>
                    <span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;[E001] The count of un-finished Todo must not be over &quot;</span>
                            <span class="o">+</span> <span class="n">MAX_UNFINISHED_COUNT</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span><span class="o">));</span>
            <span class="c1">// (7)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// (8)</span>
        <span class="n">String</span> <span class="n">todoId</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">Date</span> <span class="n">createdAt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>

        <span class="n">todo</span><span class="o">.</span><span class="na">setTodoId</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="n">todo</span><span class="o">.</span><span class="na">setCreatedAt</span><span class="o">(</span><span class="n">createdAt</span><span class="o">);</span>
        <span class="n">todo</span><span class="o">.</span><span class="na">setFinished</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

        <span class="n">todoRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">finish</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">isFinished</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">();</span>
            <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ResultMessage</span>
                    <span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;[E002] The requested Todo is already finished. (id=&quot;</span>
                            <span class="o">+</span> <span class="n">todoId</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="o">));</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">todo</span><span class="o">.</span><span class="na">setFinished</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">todoRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="n">todoRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Serviceとしてcomponent-scanの対象とするため、クラスレベルに<tt class="docutils literal"><span class="pre">&#64;Service</span></tt>アノテーションをつける。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">今回の実装では、DBを使用しないため、トランザクション管理は不要であるが、DBを使用する場合は、クラスレベルに<tt class="docutils literal"><span class="pre">&#64;Transactional</span></tt>アノテーションをつけること。</div>
<div class="line">詳しくは、<a class="reference internal" href="#tutorial-todo-infra"><em>インフラストラクチャ層の変更</em></a>で説明する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&#64;Inject</span></tt>アノテーションで、TodoRepositoryの実装をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1件取得は、finishメソッドでもdeleteメソッドでも使用するため、メソッドとして用意しておく(interfaceに公開しても良い)。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">結果メッセージを格納するクラスとして、共通ライブラリで用意されているorg.terasoluna.gfw.common.message.ResultMessageを用いる。</div>
<div class="line">今回は、Errorメッセージをスローするために、ResultMessages.error()でメッセージ種別を指定して、ResultMessageを追加している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">対象のデータが存在しない場合、共通ライブラリで用意されているorg.terasoluna.gfw.common.exception.ResourceNotFoundExceptionをスローする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">業務エラーが発生した場合、共通ライブラリで用意されているorg.terasoluna.gfw.common.exception.BusinessExceptionをスローする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">一意性のある値を生成するために、UUIDを使用している。DBのシーケンスを用いてもよい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<dl class="docutils">
<dt></dt>
<dd><div class="first last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">本節では、説明を単純化するため、エラーメッセージをハードコードしているが、メンテナンスの観点で本来は好ましくない。
通常、メッセージは、プロパティファイルに外部化することが推奨される。
プロパティファイルに外部化する方法は、<a class="reference internal" href="../ArchitectureInDetail/PropertyManagement.html"><em>プロパティ管理</em></a>を参照されたい。</p>
</div>
</dd>
</dl>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image064.png"><img alt="../_images/image064.png" src="../_images/image064.png" style="width: 40%;" /></a>
</div>
</div>
<div class="section" id="servicejunit">
<h4><a class="toc-backref" href="#id87">3.4.1.5. ServiceのJUnit作成</a><a class="headerlink" href="#servicejunit" title="Permalink to this headline">¶</a></h4>
<p>TBD</p>
</div>
</div>
<div class="section" id="id20">
<h3><a class="toc-backref" href="#id88">3.4.2. アプリケーション層の作成</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<p>ドメイン層の実装が完了したので、次はドメイン層を利用して、アプリケーション層の作成に取り掛かる。</p>
<div class="section" id="controller">
<h4><a class="toc-backref" href="#id89">3.4.2.1. Controllerの作成</a><a class="headerlink" href="#controller" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">まずは、todo管理業務にかかわる画面遷移を、制御するTodoControllerを作成する。</div>
<div class="line">FQCNはtodo.app.todo.TodoControllerとする。上位パッケージがドメイン層とは異なるので注意すること。</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>

<span class="nd">@Controller</span> <span class="c1">// (1)</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;todo&quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoController</span> <span class="o">{</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Controllerとしてcomponent-scanの対象とするため、クラスレベルに、<tt class="docutils literal"><span class="pre">&#64;Controller</span></tt>アノテーションをつける。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">TodoControllerが扱う画面遷移のパスを、すべて&lt;contextPath&gt;/todo配下にするため、クラスレベルに&#64;RequestMapping(“todo”)を設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image065.png"><img alt="../_images/image065.png" src="../_images/image065.png" style="width: 40%;" /></a>
</div>
<div class="section" id="id21">
<h5>3.4.2.1.1. Show all TODO<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h5>
<p>この画面では、</p>
<ul class="simple">
<li>新規作成フォームの表示</li>
<li>TODOの全件表示</li>
</ul>
<p>を行う。</p>
<div class="section" id="form">
<h6>3.4.2.1.1.1. Formの作成<a class="headerlink" href="#form" title="Permalink to this headline">¶</a></h6>
<p>Formには、タイトル情報があればよいので、次のようなJavaBeanになる。FQCNは、todo.app.todo.TodoFormとする。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">todoTitle</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoTitle</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">todoTitle</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoTitle</span><span class="o">(</span><span class="n">String</span> <span class="n">todoTitle</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">todoTitle</span> <span class="o">=</span> <span class="n">todoTitle</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image066.png"><img alt="../_images/image066.png" src="../_images/image066.png" style="width: 40%;" /></a>
</div>
</div>
<div class="section" id="id22">
<h6>3.4.2.1.1.2. Controllerの実装<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h6>
<p>TodoControllerに、setUpFormメソッドと、listメソッドを実装する。</p>
<div class="highlight-java"><div class="highlight"><pre> <span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">todo.domain.service.todo.TodoService</span><span class="o">;</span>

 <span class="nd">@Controller</span>
 <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;todo&quot;</span><span class="o">)</span>
 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoController</span> <span class="o">{</span>
<span class="hll">     <span class="nd">@Inject</span> <span class="c1">// (3)</span>
</span><span class="hll">     <span class="kd">protected</span> <span class="n">TodoService</span> <span class="n">todoService</span><span class="o">;</span>
</span><span class="hll">
</span><span class="hll">     <span class="nd">@ModelAttribute</span> <span class="c1">// (4)</span>
</span><span class="hll">     <span class="kd">public</span> <span class="n">TodoForm</span> <span class="nf">setUpForm</span><span class="o">()</span> <span class="o">{</span>
</span><span class="hll">         <span class="n">TodoForm</span> <span class="n">form</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TodoForm</span><span class="o">();</span>
</span><span class="hll">         <span class="k">return</span> <span class="n">form</span><span class="o">;</span>
</span><span class="hll">     <span class="o">}</span>
</span><span class="hll">
</span><span class="hll">     <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;list&quot;</span><span class="o">)</span> <span class="c1">// (5)</span>
</span><span class="hll">     <span class="kd">public</span> <span class="n">String</span> <span class="nf">list</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">         <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
</span><span class="hll">         <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;todos&quot;</span><span class="o">,</span> <span class="n">todos</span><span class="o">);</span> <span class="c1">// (6</span>
</span><span class="hll">         <span class="k">return</span> <span class="s">&quot;todo/list&quot;</span><span class="o">;</span> <span class="c1">// (7)</span>
</span><span class="hll">     <span class="o">}</span>
</span> <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">TodoServiceを、DIコンテナによってインジェクションさせるために、<tt class="docutils literal"><span class="pre">&#64;Inject</span></tt>アノテーションをつける。</div>
<div class="line">DIコンテナの管理するTodoSerivce型インスタンスがインジェクションされるため、結果として、TodoServiceImplインスタンスがインジェクションされる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Formを初期化する。<tt class="docutils literal"><span class="pre">&#64;ModelAttribute</span></tt>アノテーションをつけることで、このメソッドの返り値のformオブジェクトが、”todoForm”という名前でModelに追加される。</div>
<div class="line">TodoControllerの各処理で、model.addAttribute(“todoForm”, form)が実行されるのと同義。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">listメソッドを”&lt;contextPath&gt;/todo/list”にマッピングされるための設定。クラスレベルで&#64;RequestMapping(“todo”)が設定されているため、ここでは&#64;RequestMapping(value = “list”)だけで良い。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ModelにTodoのリストを追加して、Viewに渡す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">View名として”todo/list”を返すと、spring-mvc.xmlに定義したInternalResourceViewResolverによって、WEB-INF/views/todo/list.jspがレンダリングされることになる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id23">
<h6>3.4.2.1.1.3. JSPの作成<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h6>
<p>WEB-INF/views/todo/list.jspで、Controllerから渡されたModelを表示する。
まずは、”Finish”,”Delete”ボタン以外を作成する。</p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;title&gt;</span>Todo List<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;style</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
.strike {
    text-decoration: line-through;
}
<span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Todo List<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;todoForm&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;form:form</span>
           <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/todo/create&quot;</span>
            <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">modelAttribute=</span><span class="s">&quot;todoForm&quot;</span><span class="nt">&gt;</span>
            <span class="c">&lt;!-- (2) --&gt;</span>
            <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;todoTitle&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Create Todo&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;hr</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;todoList&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul&gt;</span>
            <span class="c">&lt;!-- (3) --&gt;</span>
            <span class="nt">&lt;c:forEach</span> <span class="na">items=</span><span class="s">&quot;${todos}&quot;</span> <span class="na">var=</span><span class="s">&quot;todo&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;&lt;c:choose&gt;</span>
                        <span class="nt">&lt;c:when</span> <span class="na">test=</span><span class="s">&quot;${todo.finished}&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (4) --&gt;</span>
                            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;strike&quot;</span><span class="nt">&gt;</span>
                            <span class="c">&lt;!-- (5) --&gt;</span>
                            ${f:h(todo.todoTitle)}
                            <span class="nt">&lt;/span&gt;</span>
                        <span class="nt">&lt;/c:when&gt;</span>
                        <span class="nt">&lt;c:otherwise&gt;</span>
                            ${f:h(todo.todoTitle)}
                         <span class="nt">&lt;/c:otherwise&gt;</span>
                    <span class="nt">&lt;/c:choose&gt;&lt;/li&gt;</span>
            <span class="nt">&lt;/c:forEach&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&lt;form:form&gt;タグでフォームを表示する。modelAttribute属性に、ControllerでModelに追加したformの名前を指定する。</div>
<div class="line">action属性に指定するcontextPathは、${pageContext.request.contextPath}で取得できる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&lt;form:input&gt;タグでフォームのプロパティをバインドする。modelAttribute属性に指定したformのプロパティ名と、path属性の値が一致している必要がある。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&lt;c:forEach&gt;タグを用いて、Todoのリストを全て表示する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">完了かどうか(finished)で、打ち消し線(text-decoration: line-through;)を装飾するかどうかを判断する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><strong>文字列値を出力する際は、XSS対策のため、必ずf:h()関数を使用してHTMLエスケープを行うこと。</strong></div>
<div class="line">XSS対策についての詳細は、<a class="reference internal" href="../Security/XSS.html"><em>XSS対策</em></a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">STSで「todo」プロジェクトを右クリックし、「Run As」→「Run on Server」でWebアプリケーションを起動する。</div>
<div class="line">ブラウザで”<a class="reference external" href="http://localhost:8080/todo/todo/list">http://localhost:8080/todo/todo/list</a>”にアクセスすると、以下のような画面が表示される。</div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image067.png"><img alt="../_images/image067.png" src="../_images/image067.png" style="width: 40%;" /></a>
</div>
</div>
</div>
<div class="section" id="id24">
<h5>3.4.2.1.2. Create TODO<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h5>
<p>次に、一覧表示画面から”Create TODO”ボタンを押した後の、新規作成処理を実装する。</p>
<div class="section" id="id25">
<h6>3.4.2.1.2.1. Controllerの修正<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h6>
<p>TodoControllerに、createメソッドを追加する。</p>
<div class="highlight-java"><div class="highlight"><pre> <span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">javax.validation.Valid</span><span class="o">;</span>

<span class="hll"> <span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="o">;</span>
</span> <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.support.RedirectAttributes</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessage</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">todo.domain.service.todo.TodoService</span><span class="o">;</span>

 <span class="nd">@Controller</span>
 <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;todo&quot;</span><span class="o">)</span>
 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoController</span> <span class="o">{</span>
     <span class="nd">@Inject</span>
     <span class="kd">protected</span> <span class="n">TodoService</span> <span class="n">todoService</span><span class="o">;</span>

<span class="hll">     <span class="c1">// (8)</span>
</span><span class="hll">     <span class="nd">@Inject</span>
</span><span class="hll">     <span class="kd">protected</span> <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="o">;</span>
</span>
     <span class="nd">@ModelAttribute</span>
     <span class="kd">public</span> <span class="n">TodoForm</span> <span class="nf">setUpForm</span><span class="o">()</span> <span class="o">{</span>
         <span class="n">TodoForm</span> <span class="n">form</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TodoForm</span><span class="o">();</span>
         <span class="k">return</span> <span class="n">form</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;list&quot;</span><span class="o">)</span>
     <span class="kd">public</span> <span class="n">String</span> <span class="nf">list</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
         <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;todos&quot;</span><span class="o">,</span> <span class="n">todos</span><span class="o">);</span>
         <span class="k">return</span> <span class="s">&quot;todo/list&quot;</span><span class="o">;</span>
     <span class="o">}</span>

<span class="hll">     <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span> <span class="c1">// (9)</span>
</span><span class="hll">     <span class="kd">public</span> <span class="n">String</span> <span class="nf">create</span><span class="o">(</span><span class="nd">@Valid</span> <span class="n">TodoForm</span> <span class="n">todoForm</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="c1">// (10)</span>
</span><span class="hll">             <span class="n">Model</span> <span class="n">model</span><span class="o">,</span> <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (11)</span>
</span><span class="hll">
</span><span class="hll">         <span class="c1">// (12)</span>
</span><span class="hll">         <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
</span><span class="hll">             <span class="k">return</span> <span class="nf">list</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
</span><span class="hll">         <span class="o">}</span>
</span><span class="hll">
</span><span class="hll">         <span class="c1">// (13)</span>
</span><span class="hll">         <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">todoForm</span><span class="o">,</span> <span class="n">Todo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="hll">
</span><span class="hll">         <span class="k">try</span> <span class="o">{</span>
</span><span class="hll">             <span class="n">todoService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
</span><span class="hll">         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">             <span class="c1">// (14)</span>
</span><span class="hll">             <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getResultMessages</span><span class="o">());</span>
</span><span class="hll">             <span class="k">return</span> <span class="nf">list</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
</span><span class="hll">         <span class="o">}</span>
</span><span class="hll">
</span><span class="hll">         <span class="c1">// (15)</span>
</span><span class="hll">         <span class="n">attributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">success</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
</span><span class="hll">                 <span class="n">ResultMessage</span><span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;Created successfully!&quot;</span><span class="o">)));</span>
</span><span class="hll">         <span class="k">return</span> <span class="s">&quot;redirect:/todo/list&quot;</span><span class="o">;</span>
</span><span class="hll">     <span class="o">}</span>
</span>
 <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Formオブジェクトを、DomainObjectに変換する際に、有用なMapperをインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスが/todo/createで、HTTPメソッドがPOSTに対応するように、<tt class="docutils literal"><span class="pre">&#64;RequestMapping</span></tt>アノテーションを設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォームの入力チェックを行うため、Formの引数に<tt class="docutils literal"><span class="pre">&#64;Valid</span></tt>アノテーションをつける。入力チェック結果は、その直後の引数BindingResultに格納される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">正常に作成が完了した後、リダイレクトで一覧画面に戻る。リダイレクト先への情報を格納するために、引数にRedirectAttributesを加える。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力エラーがあった場合、一覧画面に戻る。Todo全件取得を再度行う必要があるので、listメソッドを再実行する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Mapperを用いて、TodoFormからTodoオブジェクトを作成する。変換元と変換先のプロパティ名が同じ場合は、設定不要である。</div>
<div class="line">今回は、todoTitleプロパティのみ変換するため、Mapperを使用するメリットはほとんどない。プロパティの数が多い場合には、非常に便利である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">業務処理を実行して、BusinessExceptionが発生した場合、結果メッセージをModelに追加して、一覧画面に戻る。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">正常に作成が完了したので、結果メッセージをflashスコープに追加して、一覧画面でリダイレクトする。</div>
<div class="line">リダイレクトすることにより、ブラウザを再読み込みして、再び新規登録処理がPOSTされることがなくなる。なお、今回は成功メッセージであるため、ResultMessages.success()を使用している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id26">
<h6>3.4.2.1.2.2. Formの修正<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h6>
<p>入力チェックのルールを定義するため、Formオブジェクトにアノテーションを追加する。</p>
<div class="highlight-java"><div class="highlight"><pre> <span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="hll"> <span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
</span><span class="hll"> <span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>
</span>
 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoForm</span> <span class="o">{</span>

<span class="hll">     <span class="nd">@NotNull</span> <span class="c1">// (1)</span>
</span><span class="hll">     <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">30</span><span class="o">)</span> <span class="c1">// (2)</span>
</span>     <span class="kd">private</span> <span class="n">String</span> <span class="n">todoTitle</span><span class="o">;</span>

     <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoTitle</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">todoTitle</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoTitle</span><span class="o">(</span><span class="n">String</span> <span class="n">todoTitle</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">todoTitle</span> <span class="o">=</span> <span class="n">todoTitle</span><span class="o">;</span>
     <span class="o">}</span>
 <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">必須項目であるので、<tt class="docutils literal"><span class="pre">&#64;NotNull</span></tt>アノテーションを付ける。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">1文字以上30文字以下であるので、<tt class="docutils literal"><span class="pre">&#64;Size</span></tt>アノテーションで、範囲を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id27">
<h6>3.4.2.1.2.3. JSPの修正<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h6>
<p>結果メッセージ表示用のタグを追加する。</p>
<div class="highlight-jsp"><div class="highlight"><pre> <span class="cp">&lt;!DOCTYPE html&gt;</span>
 <span class="nt">&lt;html&gt;</span>
 <span class="nt">&lt;head&gt;</span>
 <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;title&gt;</span>Todo List<span class="nt">&lt;/title&gt;</span>
 <span class="nt">&lt;style</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
 .strike {
     text-decoration: line-through;
 }
 <span class="nt">&lt;/style&gt;</span>
 <span class="nt">&lt;/head&gt;</span>
 <span class="nt">&lt;body&gt;</span>
     <span class="nt">&lt;h1&gt;</span>Todo List<span class="nt">&lt;/h1&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;todoForm&quot;</span><span class="nt">&gt;</span>
         <span class="c">&lt;!-- (6) --&gt;</span>
<span class="hll">         <span class="nt">&lt;t:messagesPanel</span> <span class="nt">/&gt;</span>
</span>
         <span class="nt">&lt;form:form</span>
            <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/todo/create&quot;</span>
             <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">modelAttribute=</span><span class="s">&quot;todoForm&quot;</span><span class="nt">&gt;</span>
             <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;todoTitle&quot;</span> <span class="nt">/&gt;</span>
<span class="hll">             <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;todoTitle&quot;</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- (7) --&gt;</span>
</span>             <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Create Todo&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;/form:form&gt;</span>
     <span class="nt">&lt;/div&gt;</span>
     <span class="nt">&lt;hr</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;todoList&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;ul&gt;</span>
             <span class="nt">&lt;c:forEach</span> <span class="na">items=</span><span class="s">&quot;${todos}&quot;</span> <span class="na">var=</span><span class="s">&quot;todo&quot;</span><span class="nt">&gt;</span>
                 <span class="nt">&lt;li&gt;&lt;c:choose&gt;</span>
                         <span class="nt">&lt;c:when</span> <span class="na">test=</span><span class="s">&quot;${todo.finished}&quot;</span><span class="nt">&gt;</span>
                             <span class="nt">&lt;span</span> <span class="na">style=</span><span class="s">&quot;text-decoration: line-through;&quot;</span><span class="nt">&gt;</span>
                             ${f:h(todo.todoTitle)}
                             <span class="nt">&lt;/span&gt;</span>
                         <span class="nt">&lt;/c:when&gt;</span>
                         <span class="nt">&lt;c:otherwise&gt;</span>
                             ${f:h(todo.todoTitle)}
                          <span class="nt">&lt;/c:otherwise&gt;</span>
                     <span class="nt">&lt;/c:choose&gt;&lt;/li&gt;</span>
             <span class="nt">&lt;/c:forEach&gt;</span>
         <span class="nt">&lt;/ul&gt;</span>
     <span class="nt">&lt;/div&gt;</span>
 <span class="nt">&lt;/body&gt;</span>
 <span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&lt;t:messagesPanel&gt;タグで、結果メッセージを表示する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&lt;form:errors&gt;タグで、入力エラーがあった場合に表示する。path属性の値は、&lt;form:input&gt;タグと合わせる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>フォームに適切な値を入力してsubmitすると、以下のように、成功メッセージが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image068.png"><img alt="../_images/image068.png" src="../_images/image068.png" style="width: 40%;" /></a>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image069.png"><img alt="../_images/image069.png" src="../_images/image069.png" style="width: 40%;" /></a>
</div>
<p>6件以上登録した場合は、業務エラーとなり、エラーメッセージが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image070.png"><img alt="../_images/image070.png" src="../_images/image070.png" style="width: 40%;" /></a>
</div>
<p>入力フォームを、空文字にしてsubmitすると、以下のように、エラーメッセージが表示される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image071.png"><img alt="../_images/image071.png" src="../_images/image071.png" style="width: 40%;" /></a>
</div>
</div>
<div class="section" id="id28">
<h6>3.4.2.1.2.4. メッセージ表示のカスタマイズ<a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h6>
<p>&lt;t:messagesPanel&gt;の結果はデフォルトで、</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-success&quot;</span><span class="nt">&gt;&lt;ul&gt;&lt;li&gt;</span>Created successfully!<span class="nt">&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;</span>
</pre></div>
</div>
<p>と出力される。
スタイルシート(list.jspの&lt;style&gt;タグ内)に、以下の修正を加えて、結果メッセージの見た目をカスタマイズする。</p>
<div class="highlight-css"><div class="highlight"><pre><span class="nc">.alert</span> <span class="p">{</span>
    <span class="k">border</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.alert-error</span> <span class="p">{</span>
    <span class="k">background-color</span><span class="o">:</span> <span class="m">#c60f13</span><span class="p">;</span>
    <span class="k">border-color</span><span class="o">:</span> <span class="m">#970b0e</span><span class="p">;</span>
    <span class="k">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.alert-success</span> <span class="p">{</span>
    <span class="k">background-color</span><span class="o">:</span> <span class="m">#5da423</span><span class="p">;</span>
    <span class="k">border-color</span><span class="o">:</span> <span class="m">#457a1a</span><span class="p">;</span>
    <span class="k">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>メッセージは、以下のように装飾される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image072.png"><img alt="../_images/image072.png" src="../_images/image072.png" style="width: 40%;" /></a>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image073.png"><img alt="../_images/image073.png" src="../_images/image073.png" style="width: 40%;" /></a>
</div>
<p>また、&lt;form:errors&gt;タグのcssClass属性で、入力エラーメッセージのclassを指定できる。JSPを次のように修正し、</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;todoTitle&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;text-error&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>スタイルシートに、以下を追加する。</p>
<div class="highlight-css"><div class="highlight"><pre><span class="nc">.text-error</span> <span class="p">{</span>
    <span class="k">color</span><span class="o">:</span> <span class="m">#c60f13</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>入力エラーは、以下のように装飾される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image074.png"><img alt="../_images/image074.png" src="../_images/image074.png" style="width: 40%;" /></a>
</div>
</div>
</div>
<div class="section" id="id29">
<h5>3.4.2.1.3. Finish TODO<a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h5>
<p>一覧表示画面に”Finish”ボタンを追加して、ボタンをsubmitすると、hiddenで対象のtodoIdが送られ、Todoを完了するように実装する。</p>
<div class="section" id="id30">
<h6>3.4.2.1.3.1. JSPの修正<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h6>
<p>完了用のformを追加する。</p>
<div class="highlight-jsp"><div class="highlight"><pre> <span class="cp">&lt;!DOCTYPE html&gt;</span>
 <span class="nt">&lt;html&gt;</span>
 <span class="nt">&lt;head&gt;</span>
 <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;title&gt;</span>Todo List<span class="nt">&lt;/title&gt;</span>
 <span class="nt">&lt;/head&gt;</span>
 <span class="nt">&lt;style</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
 .strike {
     text-decoration: line-through;
 }

 .alert {
     border: 1px solid;
 }

 .alert-error {
     background-color: #c60f13;
     border-color: #970b0e;
     color: white;
 }

 .alert-success {
     background-color: #5da423;
     border-color: #457a1a;
     color: white;
 }

 .text-error {
     color: #c60f13;
 }
 <span class="nt">&lt;/style&gt;</span>
 <span class="nt">&lt;body&gt;</span>
     <span class="nt">&lt;h1&gt;</span>Todo List<span class="nt">&lt;/h1&gt;</span>

     <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;todoForm&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;t:messagesPanel</span> <span class="nt">/&gt;</span>

         <span class="nt">&lt;form:form</span>
             <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/todo/create&quot;</span>
             <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">modelAttribute=</span><span class="s">&quot;todoForm&quot;</span><span class="nt">&gt;</span>
             <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;todoTitle&quot;</span> <span class="nt">/&gt;</span>
             <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;todoTitle&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;text-error&quot;</span> <span class="nt">/&gt;</span>
             <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Create Todo&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;/form:form&gt;</span>
     <span class="nt">&lt;/div&gt;</span>
     <span class="nt">&lt;hr</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;todoList&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;ul&gt;</span>
             <span class="nt">&lt;c:forEach</span> <span class="na">items=</span><span class="s">&quot;${todos}&quot;</span> <span class="na">var=</span><span class="s">&quot;todo&quot;</span><span class="nt">&gt;</span>
                 <span class="nt">&lt;li&gt;&lt;c:choose&gt;</span>
                         <span class="nt">&lt;c:when</span> <span class="na">test=</span><span class="s">&quot;${todo.finished}&quot;</span><span class="nt">&gt;</span>
                             <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;strike&quot;</span><span class="nt">&gt;</span>${f:h(todo.todoTitle)}<span class="nt">&lt;/span&gt;</span>
                         <span class="nt">&lt;/c:when&gt;</span>
                         <span class="nt">&lt;c:otherwise&gt;</span>
                             ${f:h(todo.todoTitle)}
<span class="hll">                             <span class="c">&lt;!-- (8) --&gt;</span>
</span><span class="hll">                             <span class="nt">&lt;form:form</span>
</span><span class="hll">                                 <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/todo/finish&quot;</span>
</span><span class="hll">                                 <span class="na">method=</span><span class="s">&quot;post&quot;</span>
</span><span class="hll">                                 <span class="na">modelAttribute=</span><span class="s">&quot;todoForm&quot;</span>
</span><span class="hll">                                 <span class="na">cssStyle=</span><span class="s">&quot;display: inline-block;&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">                                 <span class="c">&lt;!-- (9) --&gt;</span>
</span><span class="hll">                                 <span class="nt">&lt;form:hidden</span> <span class="na">path=</span><span class="s">&quot;todoId&quot;</span>
</span><span class="hll">                                     <span class="na">value=</span><span class="s">&quot;${f:h(todo.todoId)}&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                                 <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;finish&quot;</span>
</span><span class="hll">                                     <span class="na">value=</span><span class="s">&quot;Finish&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                             <span class="nt">&lt;/form:form&gt;</span>
</span>                         <span class="nt">&lt;/c:otherwise&gt;</span>
                     <span class="nt">&lt;/c:choose&gt;&lt;/li&gt;</span>
             <span class="nt">&lt;/c:forEach&gt;</span>
         <span class="nt">&lt;/ul&gt;</span>
     <span class="nt">&lt;/div&gt;</span>
 <span class="nt">&lt;/body&gt;</span>
 <span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">未完了の場合に、完了用のformを表示する。&lt;contextPath&gt;/todo/finishに対して、POSTでtodoIdを送信する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&lt;form:hidden&gt;タグでtodoIdを渡す。value属性に値を設定する場合も、 <strong>必ずf:h()関数でHTMLエスケープすること。</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id31">
<h6>3.4.2.1.3.2. Formの修正<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h6>
<p>完了用のフォームも、TodoFormを用いる。
TodoFormに、todoIdプロパティを追加する必要があるが、そのままだと、新規作成用の入力チェックルールが適用されてしまう。
一つのFormに、新規作成用と完了用で、別々のルールを指定するために、group属性を設定する。</p>
<div class="highlight-java"><div class="highlight"><pre> <span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoForm</span> <span class="o">{</span>
     <span class="c1">// (3)</span>
<span class="hll">     <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">TodoCreate</span> <span class="o">{</span>
</span><span class="hll">     <span class="o">};</span>
</span>
<span class="hll">     <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">TodoFinish</span> <span class="o">{</span>
</span><span class="hll">     <span class="o">};</span>
</span>
     <span class="c1">// (4)</span>
<span class="hll">     <span class="nd">@NotNull</span><span class="o">(</span><span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">TodoFinish</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
</span><span class="hll">     <span class="kd">private</span> <span class="n">String</span> <span class="n">todoId</span><span class="o">;</span>
</span>
     <span class="c1">// (5)</span>
<span class="hll">     <span class="nd">@NotNull</span><span class="o">(</span><span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">TodoCreate</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
</span>     <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">30</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">TodoCreate</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
     <span class="kd">private</span> <span class="n">String</span> <span class="n">todoTitle</span><span class="o">;</span>

<span class="hll">     <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoId</span><span class="o">()</span> <span class="o">{</span>
</span><span class="hll">         <span class="k">return</span> <span class="n">todoId</span><span class="o">;</span>
</span><span class="hll">     <span class="o">}</span>
</span><span class="hll">
</span><span class="hll">     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoId</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">         <span class="k">this</span><span class="o">.</span><span class="na">todoId</span> <span class="o">=</span> <span class="n">todoId</span><span class="o">;</span>
</span><span class="hll">     <span class="o">}</span>
</span>
     <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoTitle</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">todoTitle</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoTitle</span><span class="o">(</span><span class="n">String</span> <span class="n">todoTitle</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">todoTitle</span> <span class="o">=</span> <span class="n">todoTitle</span><span class="o">;</span>
     <span class="o">}</span>

 <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グループ化したバリデーションを行うためのグループ名となるクラスを作成する。クラスは空でよいため、ここでは、インタフェースを定義する。</div>
<div class="line">グループ化バリデーションについては、<a class="reference internal" href="../ArchitectureInDetail/Validation.html"><em>入力チェック</em></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">todoIdは、完了処理には必須であるため、<tt class="docutils literal"><span class="pre">&#64;NotNull</span></tt>アノテーションをつける。完了時にのみ必要なルールであるので、group属性にTodoFinish.classを設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">新規作成用のルールは、完了処理には不要であるので、<tt class="docutils literal"><span class="pre">&#64;NotNull</span></tt>アノテーション、<tt class="docutils literal"><span class="pre">&#64;Size</span></tt>アノテーション、それぞれのgroup属性にTodoCreate.classを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id32">
<h6>3.4.2.1.3.3. Controllerの修正<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h6>
<p>完了処理をTodoControllerに追加する。
グループ化したバリデーションを実行するために、<strong>&#64;Valid アノテーションの代わりに、&#64;Validated アノテーションを使用すること</strong>に注意する。</p>
<div class="highlight-java"><div class="highlight"><pre> <span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
<span class="hll"> <span class="kn">import</span> <span class="nn">javax.validation.groups.Default</span><span class="o">;</span>
</span>
 <span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
<span class="hll"> <span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
</span> <span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.support.RedirectAttributes</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessage</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">todo.app.todo.TodoForm.TodoCreate</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">todo.app.todo.TodoForm.TodoFinish</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">todo.domain.service.todo.TodoService</span><span class="o">;</span>

 <span class="nd">@Controller</span>
 <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;todo&quot;</span><span class="o">)</span>
 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoController</span> <span class="o">{</span>
     <span class="nd">@Inject</span>
     <span class="kd">protected</span> <span class="n">TodoService</span> <span class="n">todoService</span><span class="o">;</span>

     <span class="nd">@Inject</span>
     <span class="kd">protected</span> <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="o">;</span>

     <span class="nd">@ModelAttribute</span>
     <span class="kd">public</span> <span class="n">TodoForm</span> <span class="nf">setUpForm</span><span class="o">()</span> <span class="o">{</span>
         <span class="n">TodoForm</span> <span class="n">form</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TodoForm</span><span class="o">();</span>
         <span class="k">return</span> <span class="n">form</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;list&quot;</span><span class="o">)</span>
     <span class="kd">public</span> <span class="n">String</span> <span class="nf">list</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
         <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;todos&quot;</span><span class="o">,</span> <span class="n">todos</span><span class="o">);</span>
         <span class="k">return</span> <span class="s">&quot;todo/list&quot;</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
     <span class="kd">public</span> <span class="n">String</span> <span class="nf">create</span><span class="o">(</span>
<span class="hll">             <span class="nd">@Validated</span><span class="o">({</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">TodoCreate</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="n">TodoForm</span> <span class="n">todoForm</span><span class="o">,</span> <span class="c1">// (16)</span>
</span>             <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span>
             <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>

         <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
             <span class="k">return</span> <span class="nf">list</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
         <span class="o">}</span>

         <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">todoForm</span><span class="o">,</span> <span class="n">Todo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

         <span class="k">try</span> <span class="o">{</span>
             <span class="n">todoService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getResultMessages</span><span class="o">());</span>
             <span class="k">return</span> <span class="nf">list</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
         <span class="o">}</span>

         <span class="n">attributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">success</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
                 <span class="n">ResultMessage</span><span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;Created successfully!&quot;</span><span class="o">)));</span>
         <span class="k">return</span> <span class="s">&quot;redirect:/todo/list&quot;</span><span class="o">;</span>
     <span class="o">}</span>

<span class="hll">     <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;finish&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span> <span class="c1">// (17)</span>
</span><span class="hll">     <span class="kd">public</span> <span class="n">String</span> <span class="nf">finish</span><span class="o">(</span>
</span><span class="hll">             <span class="nd">@Validated</span><span class="o">({</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">TodoFinish</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="n">TodoForm</span> <span class="n">form</span><span class="o">,</span> <span class="c1">// (18)</span>
</span><span class="hll">             <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span>
</span><span class="hll">             <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">         <span class="c1">// (19)</span>
</span><span class="hll">         <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
</span><span class="hll">             <span class="k">return</span> <span class="nf">list</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
</span><span class="hll">         <span class="o">}</span>
</span><span class="hll">
</span><span class="hll">         <span class="k">try</span> <span class="o">{</span>
</span><span class="hll">             <span class="n">todoService</span><span class="o">.</span><span class="na">finish</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getTodoId</span><span class="o">());</span>
</span><span class="hll">         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">             <span class="c1">// (20)</span>
</span><span class="hll">             <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getResultMessages</span><span class="o">());</span>
</span><span class="hll">             <span class="k">return</span> <span class="nf">list</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
</span><span class="hll">         <span class="o">}</span>
</span><span class="hll">
</span><span class="hll">         <span class="c1">// (21)</span>
</span><span class="hll">         <span class="n">attributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">success</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
</span><span class="hll">                 <span class="n">ResultMessage</span><span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;Finished successfully!&quot;</span><span class="o">)));</span>
</span><span class="hll">         <span class="k">return</span> <span class="s">&quot;redirect:/todo/list&quot;</span><span class="o">;</span>
</span><span class="hll">     <span class="o">}</span>
</span> <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(16)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">グループ化したバリデーションを実施するために、<tt class="docutils literal"><span class="pre">&#64;Valid</span></tt>アノテーションから<tt class="docutils literal"><span class="pre">&#64;Validated</span></tt>アノテーションに変更する。</div>
<div class="line">valueには、対象のグループクラスを複数指定できる。Default.classはバリデーションルールにgroupが指定されていない場合のグループである。</div>
<div class="line"><tt class="docutils literal"><span class="pre">&#64;Validated</span></tt>アノテーションを使用する際は、Default.classも指定しておくのがよい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(17)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスが、/todo/finishで、HTTPメソッドがPOSTに対応するように、<tt class="docutils literal"><span class="pre">&#64;RequestMapping</span></tt>アノテーションを設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(18)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Finish用のグループとして、TodoFinish.classを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(19)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力エラーがあった場合、一覧画面に戻る。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(20)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">業務処理を実行して、BusinessExceptionが発生した場合は、結果メッセージをModelに追加して、一覧画面に戻る。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(21)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">正常に作成が完了したので、結果メッセージをflashスコープに追加して、一覧画面でリダイレクトする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<dl class="docutils">
<dt></dt>
<dd><div class="first last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Create用、Finish用に、別々のFormを作成しても良い。その場合は、必要なパラメータだけが、Formのプロパティになる。
ただし、クラス数が増え、プロパティも重複することが多いので、仕様変更が発生した場合に、修正コストが高くなる。
また、同一のController内で、複数のFormオブジェクトを、 <tt class="docutils literal"><span class="pre">&#64;ModelAttribute</span></tt> メソッドによって初期化すると、
毎回すべてのFormが初期化されてしまうので、不要なインスタンスが生成されてしまう。そのため、
基本的に、一つのControllerで利用するFormは、できるだけ集約し、グループ化したバリデーションの設定を行うことを推奨する。</p>
</div>
</dd>
</dl>
<p>Todoを新規作成した後に、FinishボタンをSubmitすると、以下のように打ち消し線が入り、完了したことがわかる。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image075.png"><img alt="../_images/image075.png" src="../_images/image075.png" style="width: 40%;" /></a>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image076.png"><img alt="../_images/image076.png" src="../_images/image076.png" style="width: 40%;" /></a>
</div>
</div>
</div>
<div class="section" id="id33">
<h5>3.4.2.1.4. Delete TODO<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h5>
<p>一覧表示画面に&#8221;Delete&#8221;ボタンを追加して、ボタンをsubmitすると、hiddenで対象のtodoIdが送られ、Todoを完了するように実装する。</p>
<div class="section" id="id34">
<h6>3.4.2.1.4.1. JSPの修正<a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h6>
<p>削除用のformを追加する。</p>
<div class="highlight-jsp"><div class="highlight"><pre> <span class="cp">&lt;!DOCTYPE html&gt;</span>
 <span class="nt">&lt;html&gt;</span>
 <span class="nt">&lt;head&gt;</span>
 <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;title&gt;</span>Todo List<span class="nt">&lt;/title&gt;</span>
 <span class="nt">&lt;/head&gt;</span>
 <span class="nt">&lt;style</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
 .strike {
     text-decoration: line-through;
 }

 .alert {
     border: 1px solid;
 }

 .alert-error {
     background-color: #c60f13;
     border-color: #970b0e;
     color: white;
 }

 .alert-success {
     background-color: #5da423;
     border-color: #457a1a;
     color: white;
 }

 .text-error {
     color: #c60f13;
 }
 <span class="nt">&lt;/style&gt;</span>
 <span class="nt">&lt;body&gt;</span>
     <span class="nt">&lt;h1&gt;</span>Todo List<span class="nt">&lt;/h1&gt;</span>

     <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;todoForm&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;t:messagesPanel</span> <span class="nt">/&gt;</span>

         <span class="nt">&lt;form:form</span>
             <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/todo/create&quot;</span>
             <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">modelAttribute=</span><span class="s">&quot;todoForm&quot;</span><span class="nt">&gt;</span>
             <span class="nt">&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;todoTitle&quot;</span> <span class="nt">/&gt;</span>
             <span class="nt">&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;todoTitle&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;text-error&quot;</span> <span class="nt">/&gt;</span>
             <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Create Todo&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;/form:form&gt;</span>
     <span class="nt">&lt;/div&gt;</span>
     <span class="nt">&lt;hr</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;todoList&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;ul&gt;</span>
             <span class="nt">&lt;c:forEach</span> <span class="na">items=</span><span class="s">&quot;${todos}&quot;</span> <span class="na">var=</span><span class="s">&quot;todo&quot;</span><span class="nt">&gt;</span>
                 <span class="nt">&lt;li&gt;&lt;c:choose&gt;</span>
                         <span class="nt">&lt;c:when</span> <span class="na">test=</span><span class="s">&quot;${todo.finished}&quot;</span><span class="nt">&gt;</span>
                             <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;strike&quot;</span><span class="nt">&gt;</span>${f:h(todo.todoTitle)}<span class="nt">&lt;/span&gt;</span>
                         <span class="nt">&lt;/c:when&gt;</span>
                         <span class="nt">&lt;c:otherwise&gt;</span>
                             ${f:h(todo.todoTitle)}
                             <span class="nt">&lt;form:form</span>
                                 <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/todo/finish&quot;</span>
                                 <span class="na">method=</span><span class="s">&quot;post&quot;</span>
                                 <span class="na">modelAttribute=</span><span class="s">&quot;todoForm&quot;</span>
                                 <span class="na">cssStyle=</span><span class="s">&quot;display: inline-block;&quot;</span><span class="nt">&gt;</span>
                                 <span class="nt">&lt;form:hidden</span> <span class="na">path=</span><span class="s">&quot;todoId&quot;</span>
                                     <span class="na">value=</span><span class="s">&quot;${f:h(todo.todoId)}&quot;</span> <span class="nt">/&gt;</span>
                                 <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;finish&quot;</span>
                                     <span class="na">value=</span><span class="s">&quot;Finish&quot;</span> <span class="nt">/&gt;</span>
                             <span class="nt">&lt;/form:form&gt;</span>
                         <span class="nt">&lt;/c:otherwise&gt;</span>
                     <span class="nt">&lt;/c:choose&gt;</span>
<span class="hll">                     <span class="c">&lt;!-- (10) --&gt;</span>
</span><span class="hll">                     <span class="nt">&lt;form:form</span>
</span><span class="hll">                         <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/todo/delete&quot;</span>
</span><span class="hll">                         <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">modelAttribute=</span><span class="s">&quot;todoForm&quot;</span>
</span><span class="hll">                         <span class="na">cssStyle=</span><span class="s">&quot;display: inline-block;&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">                         <span class="c">&lt;!-- (11) --&gt;</span>
</span><span class="hll">                         <span class="nt">&lt;form:hidden</span> <span class="na">path=</span><span class="s">&quot;todoId&quot;</span>
</span><span class="hll">                             <span class="na">value=</span><span class="s">&quot;${f:h(todo.todoId)}&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                         <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Delete&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                     <span class="nt">&lt;/form:form&gt;</span>
</span>                 <span class="nt">&lt;/li&gt;</span>
             <span class="nt">&lt;/c:forEach&gt;</span>
         <span class="nt">&lt;/ul&gt;</span>
     <span class="nt">&lt;/div&gt;</span>
 <span class="nt">&lt;/body&gt;</span>
 <span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">削除用のformを表示する。&lt;contextPath&gt;/todo/deleteに対して、POSTでtodoIdを送信する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&lt;form:hidden&gt;タグで、todoIdを渡す。value属性に値を設定する場合も、<strong>必ずf:h()関数でHTMLエスケープすること。</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id35">
<h6>3.4.2.1.4.2. Formの修正<a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h6>
<p>Delete用のグループを、TodoFormに追加する。ルールは、Finish用と同じである。</p>
<div class="highlight-java"><div class="highlight"><pre> <span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">javax.validation.constraints.NotNull</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">javax.validation.constraints.Size</span><span class="o">;</span>

 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoForm</span> <span class="o">{</span>
     <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">TodoCreate</span> <span class="o">{</span>
     <span class="o">};</span>

     <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">TodoFinish</span> <span class="o">{</span>
     <span class="o">};</span>

     <span class="c1">// (6)</span>
<span class="hll">     <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">TodoDelete</span> <span class="o">{</span>
</span><span class="hll">     <span class="o">}</span>
</span>
     <span class="c1">// (7)</span>
<span class="hll">     <span class="nd">@NotNull</span><span class="o">(</span><span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">TodoFinish</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">TodoDelete</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
</span>     <span class="kd">private</span> <span class="n">String</span> <span class="n">todoId</span><span class="o">;</span>

     <span class="nd">@NotNull</span><span class="o">(</span><span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">TodoCreate</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
     <span class="nd">@Size</span><span class="o">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">30</span><span class="o">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="o">{</span> <span class="n">TodoCreate</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
     <span class="kd">private</span> <span class="n">String</span> <span class="n">todoTitle</span><span class="o">;</span>

     <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoId</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">todoId</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoId</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">todoId</span> <span class="o">=</span> <span class="n">todoId</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoTitle</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">todoTitle</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoTitle</span><span class="o">(</span><span class="n">String</span> <span class="n">todoTitle</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">todoTitle</span> <span class="o">=</span> <span class="n">todoTitle</span><span class="o">;</span>
     <span class="o">}</span>

 <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Delete用のグループTodoDeleteを定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">todoIdプロパティに対して、TodoDeleteグループのバリデーションを行うように設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id36">
<h6>3.4.2.1.4.3. Controllerの修正<a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h6>
<p>削除処理を、TodoControllerに追加する。完了処理とほぼ同じである。</p>
<div class="highlight-java"><div class="highlight"><pre> <span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">javax.validation.groups.Default</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">org.dozer.Mapper</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.validation.BindingResult</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.validation.annotation.Validated</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ModelAttribute</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.support.RedirectAttributes</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessage</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">todo.app.todo.TodoForm.TodoDelete</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">todo.app.todo.TodoForm.TodoCreate</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">todo.app.todo.TodoForm.TodoFinish</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">todo.domain.service.todo.TodoService</span><span class="o">;</span>

 <span class="nd">@Controller</span>
 <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;todo&quot;</span><span class="o">)</span>
 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoController</span> <span class="o">{</span>
     <span class="nd">@Inject</span>
     <span class="kd">protected</span> <span class="n">TodoService</span> <span class="n">todoService</span><span class="o">;</span>

     <span class="nd">@Inject</span>
     <span class="kd">protected</span> <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="o">;</span>

     <span class="nd">@ModelAttribute</span>
     <span class="kd">public</span> <span class="n">TodoForm</span> <span class="nf">setUpForm</span><span class="o">()</span> <span class="o">{</span>
         <span class="n">TodoForm</span> <span class="n">form</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TodoForm</span><span class="o">();</span>
         <span class="k">return</span> <span class="n">form</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;list&quot;</span><span class="o">)</span>
     <span class="kd">public</span> <span class="n">String</span> <span class="nf">list</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoService</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
         <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;todos&quot;</span><span class="o">,</span> <span class="n">todos</span><span class="o">);</span>
         <span class="k">return</span> <span class="s">&quot;todo/list&quot;</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
     <span class="kd">public</span> <span class="n">String</span> <span class="nf">create</span><span class="o">(</span>
             <span class="nd">@Validated</span><span class="o">({</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">TodoCreate</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="n">TodoForm</span> <span class="n">todoForm</span><span class="o">,</span>
             <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span>
             <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>

         <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
             <span class="k">return</span> <span class="nf">list</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
         <span class="o">}</span>

         <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">todoForm</span><span class="o">,</span> <span class="n">Todo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

         <span class="k">try</span> <span class="o">{</span>
             <span class="n">todoService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getResultMessages</span><span class="o">());</span>
             <span class="k">return</span> <span class="nf">list</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
         <span class="o">}</span>

         <span class="n">attributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">success</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
                 <span class="n">ResultMessage</span><span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;Created successfully!&quot;</span><span class="o">)));</span>
         <span class="k">return</span> <span class="s">&quot;redirect:/todo/list&quot;</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;finish&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
     <span class="kd">public</span> <span class="n">String</span> <span class="nf">finish</span><span class="o">(</span>
             <span class="nd">@Validated</span><span class="o">({</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">TodoFinish</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="n">TodoForm</span> <span class="n">form</span><span class="o">,</span>
             <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span>
             <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
             <span class="k">return</span> <span class="nf">list</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
         <span class="o">}</span>

         <span class="k">try</span> <span class="o">{</span>
             <span class="n">todoService</span><span class="o">.</span><span class="na">finish</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getTodoId</span><span class="o">());</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getResultMessages</span><span class="o">());</span>
             <span class="k">return</span> <span class="nf">list</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
         <span class="o">}</span>

         <span class="n">attributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">success</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
                 <span class="n">ResultMessage</span><span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;Finished successfully!&quot;</span><span class="o">)));</span>
         <span class="k">return</span> <span class="s">&quot;redirect:/todo/list&quot;</span><span class="o">;</span>
     <span class="o">}</span>

<span class="hll">     <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;delete&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
</span><span class="hll">     <span class="kd">public</span> <span class="n">String</span> <span class="nf">delete</span><span class="o">(</span>
</span><span class="hll">             <span class="nd">@Validated</span><span class="o">({</span> <span class="n">Default</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">TodoDelete</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="n">TodoForm</span> <span class="n">form</span><span class="o">,</span>
</span><span class="hll">             <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span>
</span><span class="hll">             <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">
</span><span class="hll">         <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
</span><span class="hll">             <span class="k">return</span> <span class="nf">list</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
</span><span class="hll">         <span class="o">}</span>
</span><span class="hll">
</span><span class="hll">         <span class="k">try</span> <span class="o">{</span>
</span><span class="hll">             <span class="n">todoService</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getTodoId</span><span class="o">());</span>
</span><span class="hll">         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">             <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getResultMessages</span><span class="o">());</span>
</span><span class="hll">             <span class="k">return</span> <span class="nf">list</span><span class="o">(</span><span class="n">model</span><span class="o">);</span>
</span><span class="hll">         <span class="o">}</span>
</span><span class="hll">
</span><span class="hll">         <span class="n">attributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">success</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
</span><span class="hll">                 <span class="n">ResultMessage</span><span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;Deleted successfully!&quot;</span><span class="o">)));</span>
</span><span class="hll">         <span class="k">return</span> <span class="s">&quot;redirect:/todo/list&quot;</span><span class="o">;</span>
</span><span class="hll">     <span class="o">}</span>
</span>
 <span class="o">}</span>
</pre></div>
</div>
<p>Todoに対して、”Delete”ボタンをsubmitすると、以下のように、対象のTODOが削除される。</p>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image077.png"><img alt="../_images/image077.png" src="../_images/image077.png" style="width: 40%;" /></a>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/image078.png"><img alt="../_images/image078.png" src="../_images/image078.png" style="width: 40%;" /></a>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="tutorial-todo-infra">
<span id="id37"></span><h2><a class="toc-backref" href="#id90">3.5. インフラストラクチャ層の変更</a><a class="headerlink" href="#tutorial-todo-infra" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">前節までは、インフラストラクチャ層はメモリによる実装であった。</div>
<div class="line">本節では、DBに永続化する実装を行う。DBアクセスするためにO/R Mapperを使用するが、</div>
<div class="line">ここで、Spring Data JPAによる方法と、TERASOLUNA DAOによる方法の2通りについて、説明する。</div>
</div>
<div class="section" id="id38">
<h3><a class="toc-backref" href="#id91">3.5.1. 共通設定</a><a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">まずは、Spring Data JPA版、TERASOLUNA Dao版の両方に共通して適用する設定を行う。</div>
<div class="line">今回は、DBセットアップの手間を省くため、H2Databaseを使用する。</div>
</div>
<div class="section" id="pom-xml">
<h4><a class="toc-backref" href="#id92">3.5.1.1. pom.xmlの修正</a><a class="headerlink" href="#pom-xml" title="Permalink to this headline">¶</a></h4>
<p>pom.xmlに、H2Databaseを使用するためのdependencyを定義する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.h2database<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>h2<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.3.172<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>この設定用は<strong>サンプルアプリケーションを簡単試すためのもの</strong>であり、実際の開発で使用されることを想定していない。実際のプロジェクトでは削除すること。</p>
<p class="last">また、JDBCドライバの<tt class="docutils literal"><span class="pre">&lt;scope&gt;</span></tt>は<tt class="docutils literal"><span class="pre">provided</span></tt>にすべきである。</p>
</div>
</div>
<div class="section" id="id39">
<h4><a class="toc-backref" href="#id93">3.5.1.2. データソースの定義</a><a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id40">
<h5>3.5.1.2.1. todo-infra.xmlの修正<a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h5>
<p>データソースの定義は、インフラストラクチャ層に関わるので、todo-infra.xmlに定義すべきであるが、
データベースのユーザー名や、パスワードなど、環境に依存する情報を含む定義は、別のBean定義ファイル(todo-env.xml)に定義することを推奨する。</p>
<p>ここでは、todo-env.xmlのインポートのみ行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;import</span> <span class="na">resource=</span><span class="s">&quot;classpath:/META-INF/spring/todo-env.xml&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">xxx-env.xmlを別ファイルにし、Mavenなどのビルドツールでこのファイルだけ差し替えることにより、環境ごと(開発環境、テスト環境など)で異なる設定値を管理できる。
また、特定の環境だけに対して、データソースをJNDIから取得するような設定ファイルの管理もできる。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="todo-env-xml">
<h5>3.5.1.2.2. todo-env.xmlの作成<a class="headerlink" href="#todo-env-xml" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">src/main/resources/META-INF/spring/todo-env.xmlを作成し、以下のように設定する。</div>
<div class="line">このファイルに対して、環境に依存する設定(ここでは、DataSource)を含む定義をする。</div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>
        <span class="na">destroy-method=</span><span class="s">&quot;close&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;driverClassName&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.driverClassName}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.url}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.username}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.password}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultAutoCommit&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxActive&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.maxActive}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxIdle&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.maxIdle}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;minIdle&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.minIdle}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxWait&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.maxWait}&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<p>メンテナンス性向上のため、プロパティ値は外部化し、プロパティファイルに定義する。
</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">環境(Application Server)によっては、DataSourceをJNDIで取得したほうがよい。
その場合は&lt;jee:jndi-lookup id=&#8221;dataSource&#8221; jndi-name=&#8221;JNDI名&#8221; /&gt;という定義を行う。
ビルド時に開発環境ではcommons-dbcpを使用し、テスト環境ではJNDIを使用する、というような切り替えができるように、envファイルを作成している。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="todo-infra-properties">
<h5>3.5.1.2.3. todo-infra.properties<a class="headerlink" href="#todo-infra-properties" title="Permalink to this headline">¶</a></h5>
<p>src/main/resources/META-INF/spring/todo-infra.propertiesに、インフラストラクチャ層に関するプロパティ値を定義する。</p>
<div class="highlight-properties"><div class="highlight"><pre><span class="na">database</span><span class="o">=</span><span class="s">H2</span>
<span class="c">## (1)</span>
<span class="na">database.url</span><span class="o">=</span><span class="s">jdbc:h2:mem:todo;DB_CLOSE_DELAY=-1;INIT=create table if not exists todo(todo_id varchar(36) primary key, todo_title varchar(30), finished boolean, created_at timestamp)</span>
<span class="na">database.username</span><span class="o">=</span><span class="s">sa</span>
<span class="na">database.password</span><span class="o">=</span>
<span class="na">database.driverClassName</span><span class="o">=</span><span class="s">org.h2.Driver</span>
<span class="c"># connection pool</span>
<span class="c">## (2)</span>
<span class="na">cp.maxActive</span><span class="o">=</span><span class="s">96</span>
<span class="na">cp.maxIdle</span><span class="o">=</span><span class="s">16</span>
<span class="na">cp.minIdle</span><span class="o">=</span><span class="s">0</span>
<span class="na">cp.maxWait</span><span class="o">=</span><span class="s">60000</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">データベースに関する設定を行う。H2のURL,ドライバを設定する。</div>
<div class="line">ここでは、説明を単純化するため、インメモリDBを使用して、APサーバーが起動するたびに初期化DDLが実行されるように設定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">コネクションプールに関する設定。ここでは、サンプルの値を設定している。実際の値は、サーバーの性能によって異なることに注意する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="id41">
<h4><a class="toc-backref" href="#id94">3.5.1.3. todo-domain.xmlの修正</a><a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">&#64;Transactional</span></tt>アノテーションによるトランザクション管理を有効にするために、&lt;tx:annotation-driven&gt;タグを設定する。</p>
<div class="highlight-xml"><div class="highlight"><pre> <span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
 <span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
     <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
     <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
<span class="hll">     <span class="na">xmlns:tx=</span><span class="s">&quot;http://www.springframework.org/schema/tx&quot;</span>
</span>     <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="hll"><span class="s">         http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd</span>
</span><span class="s">         http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">&quot;todo.domain&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;import</span> <span class="na">resource=</span><span class="s">&quot;classpath:META-INF/spring/todo-infra.xml&quot;</span><span class="nt">/&gt;</span>
<span class="hll">     <span class="nt">&lt;tx:annotation-driven/&gt;</span>
</span> <span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="todoserviceimpl">
<h4><a class="toc-backref" href="#id95">3.5.1.4. TodoServiceImplの修正</a><a class="headerlink" href="#todoserviceimpl" title="Permalink to this headline">¶</a></h4>
<div class="highlight-java"><div class="highlight"><pre> <span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="hll"> <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>
</span> <span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.BusinessException</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessage</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.message.ResultMessages</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">todo.domain.repository.todo.TodoRepository</span><span class="o">;</span>

 <span class="nd">@Service</span>
<span class="hll"> <span class="nd">@Transactional</span> <span class="c1">// (9)</span>
</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>
     <span class="nd">@Inject</span>
     <span class="kd">protected</span> <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="o">;</span>

     <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">MAX_UNFINISHED_COUNT</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>

     <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">todo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">();</span>
             <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ResultMessage</span>
                     <span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;[E404] The requested Todo is not found. (id=&quot;</span>
                             <span class="o">+</span> <span class="n">todoId</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="o">));</span>
             <span class="k">throw</span> <span class="k">new</span> <span class="nf">ResourceNotFoundException</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="nd">@Override</span>
<span class="hll">     <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// (10)</span>
</span>     <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
     <span class="o">}</span>

     <span class="nd">@Override</span>
     <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">create</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>
         <span class="kt">long</span> <span class="n">unfinishedCount</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">countByFinished</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">unfinishedCount</span> <span class="o">&gt;=</span> <span class="n">MAX_UNFINISHED_COUNT</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">();</span>
             <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ResultMessage</span>
                     <span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;[E001] The count of un-finished Todo must not be over &quot;</span>
                             <span class="o">+</span> <span class="n">MAX_UNFINISHED_COUNT</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span><span class="o">));</span>

             <span class="k">throw</span> <span class="k">new</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
         <span class="o">}</span>

         <span class="n">String</span> <span class="n">todoId</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
         <span class="n">Date</span> <span class="n">createdAt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>

         <span class="n">todo</span><span class="o">.</span><span class="na">setTodoId</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
         <span class="n">todo</span><span class="o">.</span><span class="na">setCreatedAt</span><span class="o">(</span><span class="n">createdAt</span><span class="o">);</span>
         <span class="n">todo</span><span class="o">.</span><span class="na">setFinished</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

         <span class="n">todoRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>

         <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="nd">@Override</span>
     <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">finish</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">isFinished</span><span class="o">())</span> <span class="o">{</span>
             <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">();</span>
             <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ResultMessage</span>
                     <span class="o">.</span><span class="na">fromText</span><span class="o">(</span><span class="s">&quot;[E002] The requested Todo is already finished. (id=&quot;</span>
                             <span class="o">+</span> <span class="n">todoId</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="o">));</span>
             <span class="k">throw</span> <span class="k">new</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="n">todo</span><span class="o">.</span><span class="na">setFinished</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
         <span class="n">todoRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
         <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="nd">@Override</span>
     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
         <span class="n">todoRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
     <span class="o">}</span>
 <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クラスレベルに、<tt class="docutils literal"><span class="pre">&#64;Transactional</span></tt>アノテーションをつけることで、公開メソッドをすべてトランザクション管理する。</div>
<div class="line">これにより、メソッド開始時にトランザクションを開始し、メソッド正常終了時に、トランザクションをコミットする。</div>
<div class="line">途中で非検査例外が発生した場合は、トランザクションをロールバックする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">参照のみ行う処理に関しては、readOnly=trueをつける。</div>
<div class="line">O/R Mapperによっては、この設定により、参照時に最適化が行われる(JPAを使用する場合、効果はない)。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="spring-data-jpa">
<h3><a class="toc-backref" href="#id96">3.5.2. Spring Data JPAを使用する</a><a class="headerlink" href="#spring-data-jpa" title="Permalink to this headline">¶</a></h3>
<p>本節では、インフラストラクチャ層において、 <a class="reference external" href="http://www.springsource.org/spring-data/jpa">Spring Data JPA</a> を使用する場合の設定方法について、説明する。
TERASOLUNA DAOを使用する場合は、本節を読み飛ばして、<a class="reference internal" href="#using-terasolunadao"><em>TERASOLUNA DAOを使用する</em></a>に進んでよい。</p>
<div class="section" id="id43">
<h4><a class="toc-backref" href="#id97">3.5.2.1. Spring Data JPAを使用するための設定ファイルの修正</a><a class="headerlink" href="#id43" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id44">
<h5>3.5.2.1.1. pom.xmlの修正<a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h5>
<p>Spring Data JPAに関する依存ライブラリを追加するために、pom.xmlに、以下を追加する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.terasoluna.gfw<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>terasoluna-gfw-jpa<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id45">
<h5>3.5.2.1.2. todo-infra.xmlの修正<a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h5>
<p>todo-infra.xmlに、JPA、およびSpring Data JPAを使用するための設定を行う。JPAのEntityManagerFactoryは、ここで定義する。</p>
<div class="highlight-xml"><div class="highlight"><pre> <span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
     <span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
     <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<span class="hll">     <span class="na">xmlns:jpa=</span><span class="s">&quot;http://www.springframework.org/schema/data/jpa&quot;</span>
</span><span class="hll">     <span class="na">xmlns:util=</span><span class="s">&quot;http://www.springframework.org/schema/util&quot;</span>
</span>     <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="hll"><span class="s">             http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd</span>
</span><span class="hll"><span class="s">             http://www.springframework.org/schema/data/jpa http://www.springframework.org/schema/data/jpa/spring-jpa.xsd&quot;</span><span class="nt">&gt;</span>
</span>
     <span class="nt">&lt;import</span> <span class="na">resource=</span><span class="s">&quot;classpath:/META-INF/spring/todo-env.xml&quot;</span> <span class="nt">/&gt;</span>

<span class="hll">     <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">     <span class="nt">&lt;jpa:repositories</span> <span class="na">base-package=</span><span class="s">&quot;todo.domain.repository&quot;</span><span class="nt">&gt;&lt;/jpa:repositories&gt;</span>
</span><span class="hll">
</span><span class="hll">     <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">     <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jpaVendorAdapter&quot;</span>
</span><span class="hll">         <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;showSql&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;database&quot;</span> <span class="na">value=</span><span class="s">&quot;${database}&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/bean&gt;</span>
</span><span class="hll">
</span><span class="hll">     <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">     <span class="nt">&lt;bean</span>
</span><span class="hll">         <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;</span>
</span><span class="hll">         <span class="na">id=</span><span class="s">&quot;entityManagerFactory&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">         <span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="hll">         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;packagesToScan&quot;</span> <span class="na">value=</span><span class="s">&quot;todo.domain.model&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jpaVendorAdapter&quot;</span> <span class="na">ref=</span><span class="s">&quot;jpaVendorAdapter&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">         <span class="c">&lt;!-- (5) --&gt;</span>
</span><span class="hll">         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jpaPropertyMap&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">             <span class="nt">&lt;util:map&gt;</span>
</span><span class="hll">                 <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="na">value=</span><span class="s">&quot;none&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                 <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.ejb.naming_strategy&quot;</span>
</span><span class="hll">                     <span class="na">value=</span><span class="s">&quot;org.hibernate.cfg.ImprovedNamingStrategy&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                 <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.connection.charSet&quot;</span> <span class="na">value=</span><span class="s">&quot;UTF-8&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                 <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.show_sql&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                 <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.format_sql&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                 <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.use_sql_comments&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                 <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.jdbc.batch_size&quot;</span> <span class="na">value=</span><span class="s">&quot;30&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">                 <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;hibernate.jdbc.fetch_size&quot;</span> <span class="na">value=</span><span class="s">&quot;100&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">             <span class="nt">&lt;/util:map&gt;</span>
</span><span class="hll">         <span class="nt">&lt;/property&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/bean&gt;</span>
</span>
 <span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring Data JPAを使用すると、Repositoryインタフェースから実装クラスを自動生成する。</div>
<div class="line">&lt;jpa:repository&gt;タグのbase-package属性で、対象のRepositoryを含むパッケージを指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JPAの実装ベンダの設定を行う。JPA実装として、Hibernateを使うため、HibernateJpaVendorAdapterを定義する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">EntityManagerの定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エンティティのパッケージ名を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Hibernateに関する詳細な設定を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id46">
<h5>3.5.2.1.3. todo-env.xmlの修正<a class="headerlink" href="#id46" title="Permalink to this headline">¶</a></h5>
<p>トランザクションマネージャに関連するBean定義を追加する。</p>
<div class="highlight-xml"><div class="highlight"><pre> <span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
 <span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
     <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
     <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

     <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>
         <span class="na">destroy-method=</span><span class="s">&quot;close&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;driverClassName&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.driverClassName}&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.url}&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.username}&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.password}&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultAutoCommit&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxActive&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.maxActive}&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxIdle&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.maxIdle}&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;minIdle&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.minIdle}&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxWait&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.maxWait}&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/bean&gt;</span>

     <span class="c">&lt;!-- (6) --&gt;</span>
<span class="hll">     <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.JpaTransactionManager&quot;</span>
</span><span class="hll">         <span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;entityManagerFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;entityManagerFactory&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/bean&gt;</span>
</span><span class="hll">
</span>
 <span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">トランザクションマネージャの設定。idは、transactionManagerにすること。</div>
<div class="line">別の名前を指定する場合は、todo-domain.xmlの&lt;tx:annotation-driven&gt;タグと、todo-infra.xmlの&lt;jpa:repository&gt;タグにもトランザクションマネージャ名を指定する必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
<dl class="docutils">
<dt></dt>
<dd><div class="first last admonition note">
<p class="first admonition-title">Note</p>
<p>JavaEEコンテナ上で、トランザクションマネージャは、JtaTransactionManagerを使用したほうがよい。この場合、&lt;tx:jta-transaction-manager /&gt;でトランザクションマネージャの定義を行う。</p>
<p class="last">これらの設定が、環境によって変わらないプロジェクト(例えば、Tomcatを使用する場合など)は、todo-infra.xmlに定義してもよい。</p>
</div>
</dd>
</dl>
</div>
<div class="section" id="id47">
<h5>3.5.2.1.4. spring-mvc.xml<a class="headerlink" href="#id47" title="Permalink to this headline">¶</a></h5>
<p>spring-mvc.xmlにOpenEntityManagerInViewInterceptorを追加し、Interceptorで、EntityManagerのライフサイクルの開始と終了を行う。
この設定を追加することで、アプリケーション層(Contollerや、Viewクラス)でのLazy Loadが、サポートされる。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;mvc:interceptors&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

    <span class="c">&lt;!-- (6) --&gt;</span>
    <span class="nt">&lt;mvc:interceptor&gt;</span>
        <span class="nt">&lt;mvc:mapping</span> <span class="na">path=</span><span class="s">&quot;/**&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/resources/**&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;bean</span>
            <span class="na">class=</span><span class="s">&quot;org.springframework.orm.jpa.support.OpenEntityManagerInViewInterceptor&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/mvc:interceptor&gt;</span>

<span class="nt">&lt;/mvc:interceptors&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">静的リソース(css, js, imageなど)へのアクセス(<tt class="docutils literal"><span class="pre">/resources/**</span></tt>)の場合は、データアクセスが確実に発生しないため、Interceptorの適用対象外としている。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id48">
<h5>3.5.2.1.5. logback.xmlの修正<a class="headerlink" href="#id48" title="Permalink to this headline">¶</a></h5>
<div class="highlight-xml"><div class="highlight"><pre> <span class="cp">&lt;!DOCTYPE logback&gt;</span>
 <span class="nt">&lt;configuration&gt;</span>
     <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">&quot;STDOUT&quot;</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;encoder&gt;</span>
             <span class="nt">&lt;pattern&gt;</span><span class="cp">&lt;![CDATA[%d{yyyy-MM-dd HH:mm:ss} [%thread] [%-5level] [%-48logger{48}] - %msg%n]]&gt;</span><span class="nt">&lt;/pattern&gt;</span>
         <span class="nt">&lt;/encoder&gt;</span>
     <span class="nt">&lt;/appender&gt;</span>

     <span class="c">&lt;!-- Application Loggers --&gt;</span>
     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;todo&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;debug&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/logger&gt;</span>

     <span class="c">&lt;!-- TERASOLUNA --&gt;</span>
     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.terasoluna.gfw&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;info&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/logger&gt;</span>

     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.terasoluna.gfw.web.logging.TraceLoggingInterceptor&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;trace&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/logger&gt;</span>

     <span class="c">&lt;!-- 3rdparty Loggers --&gt;</span>
     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.springframework&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;warn&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/logger&gt;</span>

     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.springframework.web.servlet&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;info&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/logger&gt;</span>

<span class="hll">     <span class="c">&lt;!-- (8) --&gt;</span>
</span><span class="hll">     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.hibernate.SQL&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;debug&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/logger&gt;</span>
</span><span class="hll">
</span><span class="hll">     <span class="c">&lt;!-- (9) --&gt;</span>
</span><span class="hll">     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.hibernate.type.descriptor.sql.BasicBinder&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;trace&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/logger&gt;</span>
</span><span class="hll">
</span><span class="hll">     <span class="c">&lt;!-- (10) --&gt;</span>
</span><span class="hll">     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.hibernate.engine.transaction&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;debug&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/logger&gt;</span>
</span>
     <span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">&quot;WARN&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&quot;STDOUT&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/root&gt;</span>
 <span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HibernateによるSQLログを、出力するための設定。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HibernateによるSQLのバインド変数を、出力するための設定。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Hibernateによるトランザクションのログを、出力するための設定。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="entity">
<h4><a class="toc-backref" href="#id98">3.5.2.2. Entityの設定</a><a class="headerlink" href="#entity" title="Permalink to this headline">¶</a></h4>
<p>Todoクラスを、データベースとマッピングするために、JPAのアノテーションを設定する。</p>
<div class="highlight-java"><div class="highlight"><pre> <span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">model</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
 <span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="hll"> <span class="kn">import</span> <span class="nn">javax.persistence.Column</span><span class="o">;</span>
</span><span class="hll"> <span class="kn">import</span> <span class="nn">javax.persistence.Entity</span><span class="o">;</span>
</span><span class="hll"> <span class="kn">import</span> <span class="nn">javax.persistence.Id</span><span class="o">;</span>
</span><span class="hll"> <span class="kn">import</span> <span class="nn">javax.persistence.Table</span><span class="o">;</span>
</span><span class="hll"> <span class="kn">import</span> <span class="nn">javax.persistence.Temporal</span><span class="o">;</span>
</span><span class="hll"> <span class="kn">import</span> <span class="nn">javax.persistence.TemporalType</span><span class="o">;</span>
</span>
<span class="hll"> <span class="c1">// (1)</span>
</span><span class="hll"> <span class="nd">@Entity</span>
</span><span class="hll"> <span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;todo&quot;</span><span class="o">)</span>
</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
     <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

<span class="hll">     <span class="c1">// (2)</span>
</span><span class="hll">     <span class="nd">@Id</span>
</span><span class="hll">     <span class="c1">// (3)</span>
</span><span class="hll">     <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;todo_id&quot;</span><span class="o">)</span>
</span>     <span class="kd">private</span> <span class="n">String</span> <span class="n">todoId</span><span class="o">;</span>

<span class="hll">     <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;todo_title&quot;</span><span class="o">)</span>
</span>     <span class="kd">private</span> <span class="n">String</span> <span class="n">todoTitle</span><span class="o">;</span>

<span class="hll">     <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;finished&quot;</span><span class="o">)</span>
</span>     <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">finished</span><span class="o">;</span>

<span class="hll">     <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;created_at&quot;</span><span class="o">)</span>
</span>     <span class="c1">// (4)</span>
<span class="hll">     <span class="nd">@Temporal</span><span class="o">(</span><span class="n">TemporalType</span><span class="o">.</span><span class="na">TIMESTAMP</span><span class="o">)</span>
</span>     <span class="kd">private</span> <span class="n">Date</span> <span class="n">createdAt</span><span class="o">;</span>

     <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoId</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">todoId</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoId</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">todoId</span> <span class="o">=</span> <span class="n">todoId</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoTitle</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">todoTitle</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoTitle</span><span class="o">(</span><span class="n">String</span> <span class="n">todoTitle</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">todoTitle</span> <span class="o">=</span> <span class="n">todoTitle</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFinished</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">finished</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFinished</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">finished</span> <span class="o">=</span> <span class="n">finished</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getCreatedAt</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">createdAt</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreatedAt</span><span class="o">(</span><span class="n">Date</span> <span class="n">createdAt</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">createdAt</span><span class="o">;</span>
     <span class="o">}</span>
 <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JPAのエンティティであることを示す<tt class="docutils literal"><span class="pre">&#64;Entity</span></tt>アノテーションを付け、対応するテーブル名を<tt class="docutils literal"><span class="pre">&#64;Table</span></tt>アノテーションで設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">主キーとなるカラムに対応するフィールドに、<tt class="docutils literal"><span class="pre">&#64;Id</span></tt>アノテーションをつける。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&#64;Column</span></tt>アノテーションで、対応するカラム名を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Date型は、java.sql.Date, java.sql.Time, java.sql.Timestampのどれに対応するか、明示的に指定する必要がある。ここでは、Timestampを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="todorepository">
<h4><a class="toc-backref" href="#id99">3.5.2.3. TodoRepositoryの修正</a><a class="headerlink" href="#todorepository" title="Permalink to this headline">¶</a></h4>
<div class="highlight-java"><div class="highlight"><pre> <span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="hll"> <span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>
</span><span class="hll"> <span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.Query</span><span class="o">;</span>
</span><span class="hll"> <span class="kn">import</span> <span class="nn">org.springframework.data.repository.query.Param</span><span class="o">;</span>
</span>
 <span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>

 <span class="c1">// (1)</span>
<span class="hll"> <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class="hll">     <span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;SELECT COUNT(x) FROM Todo x WHERE x.finished = :finished&quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
</span><span class="hll">     <span class="kt">long</span> <span class="nf">countByFinished</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;finished&quot;</span><span class="o">)</span> <span class="kt">boolean</span> <span class="n">finished</span><span class="o">);</span> <span class="c1">// (3)</span>
</span> <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JpaRepositoryを拡張したインタフェースにする。Genericsのパラメータには、順にEntityのクラス(Todo)、主キーのクラス(String)を指定する。</div>
<div class="line">基本的なCRUD操作(findOne, findAll, save, deleteなど)は、上位のインタフェースに定義済みであるため、TodoRepositoryでは、countByFinishedのみ定義すればよい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">countByFinishedを呼び出した際に、実行されるJPQLを、<tt class="docutils literal"><span class="pre">&#64;Query</span></tt>アノテーションで指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(2)で指定したJPQLのバインド変数を<tt class="docutils literal"><span class="pre">&#64;Param</span></tt>アノテーションで設定する。</div>
<div class="line">ここでは、JPQL中の<tt class="docutils literal"><span class="pre">”:finished”</span></tt>を埋めるためのメソッド引数に、&#64;Param(“finished”)を付けている。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="todorepositoryimpl">
<h4><a class="toc-backref" href="#id100">3.5.2.4. TodoRepositoryImplの修正</a><a class="headerlink" href="#todorepositoryimpl" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Spring Data JPAを使用した場合、RepositoryImplは、インタフェースから自動生成される。</div>
<div class="line">TodoRepositoryImplは、不要であるため、削除する。</div>
</div>
<div class="line-block">
<div class="line">以上で、Spring Data JPAを使う対応が完了した。</div>
<div class="line">APサーバーを起動し、Todoの表示や、新規作成を行うと、以下のようなSQLログや、トランザクションログが出力される。</div>
</div>
</div>
</div>
<div class="section" id="terasoluna-dao">
<span id="using-terasolunadao"></span><h3><a class="toc-backref" href="#id101">3.5.3. TERASOLUNA DAOを使用する</a><a class="headerlink" href="#terasoluna-dao" title="Permalink to this headline">¶</a></h3>
<p>本節では、インフラストラクチャ層において、TERASOLUNA DAOを使用する場合の設定方法について説明する。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>TERASOLUNA DAOとは、MyBatis2.3.5とSpringの連携クラスであるorg.springframework.orm.ibatis.support.SqlMapClientDaoSupportを、用途別に拡張した簡易SQLマッパーを提供するライブラリである。
以下4つのインタフェースをもつDAOが、提供されている。</p>
<blockquote>
<div><ol class="arabic simple">
<li>jp.terasoluna.fw.dao.QueryDAO</li>
<li>jp.terasoluna.fw.dao.UpdateDAO</li>
<li>jp.terasoluna.fw.dao.StoredProcedureDAO</li>
<li>jp.terasoluna.fw.dao.QueryRowHandleDAO</li>
</ol>
</div></blockquote>
<p class="last">それぞれのインタフェースに対して、<tt class="docutils literal"><span class="pre">jp.terasoluna.fw.dao.ibatis.XxxDAOiBatisImpl</span></tt>という実装を持つ。</p>
</div>
</div></blockquote>
<div class="section" id="id49">
<h4><a class="toc-backref" href="#id102">3.5.3.1. TERASOLUNA DAOを使用するための設定</a><a class="headerlink" href="#id49" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id50">
<h5>3.5.3.1.1. pom.xmlの修正<a class="headerlink" href="#id50" title="Permalink to this headline">¶</a></h5>
<p>TERASOLUNA DAOに関する依存ライブラリを追加するために、pom.xmlに、以下の内容を追加する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.terasoluna.gfw<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>terasoluna-gfw-mybatis2<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id51">
<h5>3.5.3.1.2. todo-infra.xmlの修正<a class="headerlink" href="#id51" title="Permalink to this headline">¶</a></h5>
<p>todo-infra.xmlに、TERASOLUNA DAOを使用するための設定を行う。</p>
<div class="highlight-xml"><div class="highlight"><pre> <span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
 <span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
     <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
     <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

     <span class="nt">&lt;import</span> <span class="na">resource=</span><span class="s">&quot;classpath:/META-INF/spring/todo-env.xml&quot;</span> <span class="nt">/&gt;</span>

<span class="hll">     <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">     <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlMapClient&quot;</span>
</span><span class="hll">         <span class="na">class=</span><span class="s">&quot;org.springframework.orm.ibatis.SqlMapClientFactoryBean&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">         <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configLocations&quot;</span>
</span><span class="hll">             <span class="na">value=</span><span class="s">&quot;classpath*:/META-INF/mybatis/config/*sqlMapConfig.xml&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">         <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mappingLocations&quot;</span>
</span><span class="hll">             <span class="na">value=</span><span class="s">&quot;classpath*:/META-INF/mybatis/sql/**/*-sqlmap.xml&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/bean&gt;</span>
</span><span class="hll">
</span><span class="hll">     <span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="hll">     <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;queryDAO&quot;</span> <span class="na">class=</span><span class="s">&quot;jp.terasoluna.fw.dao.ibatis.QueryDAOiBatisImpl&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/bean&gt;</span>
</span><span class="hll">
</span><span class="hll">     <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;updateDAO&quot;</span> <span class="na">class=</span><span class="s">&quot;jp.terasoluna.fw.dao.ibatis.UpdateDAOiBatisImpl&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/bean&gt;</span>
</span><span class="hll">
</span><span class="hll">     <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;spDAO&quot;</span>
</span><span class="hll">         <span class="na">class=</span><span class="s">&quot;jp.terasoluna.fw.dao.ibatis.StoredProcedureDAOiBatisImpl&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/bean&gt;</span>
</span><span class="hll">
</span><span class="hll">     <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;queryRowHandleDAO&quot;</span>
</span><span class="hll">         <span class="na">class=</span><span class="s">&quot;jp.terasoluna.fw.dao.ibatis.QueryRowHandleDAOiBatisImpl&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlMapClient&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/bean&gt;</span>
</span> <span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SqlMapClientの定義を行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SqlMap設定ファイルのパスを設定する。ここでは、META-INF/mybatis/config以下の、<a href="#id52"><span class="problematic" id="id53">*</span></a>sqlMapConfig.xmlを読み込む。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SqlMapファイルのパスを設定する。ここでは、META-INF/mybatis/sql以下の、任意のフォルダの*-sqlmap.xmlを読み込む。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">TERASOLUNA DAOの定義を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id54">
<h5>3.5.3.1.3. todo-env.xmlの修正<a class="headerlink" href="#id54" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">トランザクションマネージャの定義を追加する。</div>
<div class="line">JavaEEコンテナ上で、トランザクションマネージャは、JtaTransactionManagerを使用することもあるため、環境依存設定ファイルに定義する。</div>
</div>
<div class="highlight-xml"><div class="highlight"><pre> <span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
 <span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
     <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
     <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

     <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>
         <span class="na">destroy-method=</span><span class="s">&quot;close&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;driverClassName&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.driverClassName}&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.url}&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.username}&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.password}&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultAutoCommit&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxActive&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.maxActive}&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxIdle&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.maxIdle}&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;minIdle&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.minIdle}&quot;</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxWait&quot;</span> <span class="na">value=</span><span class="s">&quot;${cp.maxWait}&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/bean&gt;</span>

<span class="hll">     <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">     <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span>
</span><span class="hll">         <span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/bean&gt;</span>
</span>
 <span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">トランザクションマネージャの設定。idは、transactionManagerにすること。</div>
<div class="line">別の名前を指定する場合は、&lt;tx:annotation-driven&gt;タグにも、トランザクションマネージャ名を指定する必要がある。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id55">
<h5>3.5.3.1.4. logback.xmlの修正<a class="headerlink" href="#id55" title="Permalink to this headline">¶</a></h5>
<div class="highlight-xml"><div class="highlight"><pre> <span class="cp">&lt;!DOCTYPE logback&gt;</span>
 <span class="nt">&lt;configuration&gt;</span>
     <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">&quot;STDOUT&quot;</span> <span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;encoder&gt;</span>
             <span class="nt">&lt;pattern&gt;</span><span class="cp">&lt;![CDATA[%d{yyyy-MM-dd HH:mm:ss} [%thread] [%-5level] [%-48logger{48}] - %msg%n]]&gt;</span><span class="nt">&lt;/pattern&gt;</span>
         <span class="nt">&lt;/encoder&gt;</span>
     <span class="nt">&lt;/appender&gt;</span>

     <span class="c">&lt;!-- Application Loggers --&gt;</span>
     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;todo&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;debug&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/logger&gt;</span>

     <span class="c">&lt;!-- TERASOLUNA --&gt;</span>
     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.terasoluna.gfw&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;info&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/logger&gt;</span>

     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.terasoluna.gfw.web.logging.TraceLoggingInterceptor&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;trace&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/logger&gt;</span>

     <span class="c">&lt;!-- 3rdparty Loggers --&gt;</span>
     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.springframework&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;warn&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/logger&gt;</span>

     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.springframework.web.servlet&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;info&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/logger&gt;</span>

<span class="hll">     <span class="c">&lt;!-- (8) --&gt;</span>
</span><span class="hll">     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;debug&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/logger&gt;</span>
</span><span class="hll">
</span><span class="hll">     <span class="c">&lt;!-- (9) --&gt;</span>
</span><span class="hll">     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;java.sql.Connection&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;trace&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/logger&gt;</span>
</span><span class="hll">     <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;java.sql.PreparedStatement&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">         <span class="nt">&lt;level</span> <span class="na">value=</span><span class="s">&quot;debug&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">     <span class="nt">&lt;/logger&gt;</span>
</span>
     <span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">&quot;WARN&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&quot;STDOUT&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;/root&gt;</span>
 <span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">DataSourceTransactionManagerによる、トランザクションのログを出力するための設定。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SQLログを出力するための設定。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="sqlmapconfig">
<h4><a class="toc-backref" href="#id103">3.5.3.2. sqlMapConfigの作成</a><a class="headerlink" href="#sqlmapconfig" title="Permalink to this headline">¶</a></h4>
<p>src/main/resources/META-INF/mybatis/config/sqlMapConfig.xmlを作成し、以下のように記述する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE sqlMapConfig</span>
<span class="cp">            PUBLIC &quot;-//ibatis.apache.org//DTD SQL Map Config 2.0//EN&quot;</span>
<span class="cp">            &quot;http://ibatis.apache.org/dtd/sql-map-config-2.dtd&quot;&gt;</span>
<span class="nt">&lt;sqlMapConfig&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;settings</span> <span class="na">useStatementNamespaces=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/sqlMapConfig&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">SQLIDに、名前空間を与える設定を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id56">
<h4><a class="toc-backref" href="#id104">3.5.3.3. RepositoryImplの修正</a><a class="headerlink" href="#id56" title="Permalink to this headline">¶</a></h4>
<div class="highlight-java"><div class="highlight"><pre> <span class="kn">package</span> <span class="n">todo</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

 <span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

<span class="hll"> <span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
</span>
<span class="hll"> <span class="kn">import</span> <span class="nn">jp.terasoluna.fw.dao.QueryDAO</span><span class="o">;</span>
</span><span class="hll"> <span class="kn">import</span> <span class="nn">jp.terasoluna.fw.dao.UpdateDAO</span><span class="o">;</span>
</span>
 <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Repository</span><span class="o">;</span>
<span class="hll"> <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>
</span>
 <span class="kn">import</span> <span class="nn">todo.domain.model.Todo</span><span class="o">;</span>

 <span class="nd">@Repository</span>
<span class="hll"> <span class="c1">// (1)</span>
</span><span class="hll"> <span class="nd">@Transactional</span>
</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoRepositoryImpl</span> <span class="kd">implements</span> <span class="n">TodoRepository</span> <span class="o">{</span>
<span class="hll">     <span class="c1">// (2)</span>
</span><span class="hll">     <span class="nd">@Inject</span>
</span><span class="hll">     <span class="kd">protected</span> <span class="n">QueryDAO</span> <span class="n">queryDAO</span><span class="o">;</span>
</span>
<span class="hll">     <span class="nd">@Inject</span>
</span><span class="hll">     <span class="kd">protected</span> <span class="n">UpdateDAO</span> <span class="n">updateDAO</span><span class="o">;</span>
</span>
     <span class="c1">// (3)</span>
     <span class="nd">@Override</span>
<span class="hll">     <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span>     <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
<span class="hll">         <span class="k">return</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObject</span><span class="o">(</span><span class="s">&quot;todo.findOne&quot;</span><span class="o">,</span> <span class="n">todoId</span><span class="o">,</span> <span class="n">Todo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span>     <span class="o">}</span>

     <span class="nd">@Override</span>
<span class="hll">     <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span>     <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">()</span> <span class="o">{</span>
<span class="hll">         <span class="k">return</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObjectList</span><span class="o">(</span><span class="s">&quot;todo.findAll&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span>     <span class="o">}</span>

     <span class="nd">@Override</span>
     <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">save</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>
<span class="hll">         <span class="c1">// (4)</span>
</span><span class="hll">         <span class="k">if</span> <span class="o">(</span><span class="n">exists</span><span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">getTodoId</span><span class="o">()))</span> <span class="o">{</span>
</span><span class="hll">             <span class="n">updateDAO</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;todo.update&quot;</span><span class="o">,</span> <span class="n">todo</span><span class="o">);</span>
</span><span class="hll">         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="hll">             <span class="n">updateDAO</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;todo.create&quot;</span><span class="o">,</span> <span class="n">todo</span><span class="o">);</span>
</span><span class="hll">         <span class="o">}</span>
</span><span class="hll">         <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
</span>     <span class="o">}</span>

<span class="hll">     <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span>     <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">exists</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
<span class="hll">         <span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObject</span><span class="o">(</span><span class="s">&quot;todo.exists&quot;</span><span class="o">,</span> <span class="n">todoId</span><span class="o">,</span>
</span>                 <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
         <span class="k">return</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="nd">@Override</span>
     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">updateDAO</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;todo.delete&quot;</span><span class="o">,</span> <span class="n">todo</span><span class="o">);</span>
     <span class="o">}</span>

     <span class="nd">@Override</span>
<span class="hll">     <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span>     <span class="kd">public</span> <span class="kt">long</span> <span class="nf">countByFinished</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="o">)</span> <span class="o">{</span>
<span class="hll">         <span class="k">return</span> <span class="n">queryDAO</span><span class="o">.</span><span class="na">executeForObject</span><span class="o">(</span><span class="s">&quot;todo.countByFinished&quot;</span><span class="o">,</span> <span class="n">finished</span><span class="o">,</span>
</span>                 <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
     <span class="o">}</span>
 <span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">クラスレベルに、<tt class="docutils literal"><span class="pre">&#64;Transactional</span></tt>アノテーションをつけることで、公開メソッドをすべてトランザクション管理する。</div>
<div class="line">Repositoryを呼び出すService側でも設定しているため、<tt class="docutils literal"><span class="pre">&#64;Transactional</span></tt>をつけなくともトランザクション管理になるが、propagation属性は、デフォルトのREQUIREDであるため、トランザクションがネストした場合、内側(Repository側)のトランザクションは、外側(Service側)のトランザクションに参加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&#64;Inject</span></tt>アノテーションで、QueryDAO, UpdateDAOをインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Repositoryのメソッド実装は、基本的には、TERASOLUNA DAOにSQLIDと、パラメータを渡すことになる。</div>
<div class="line">参照系の場合はQueryDAO、更新系の場合はUpdateDAOを使用する。SQLIDに対応するSQLの設定は、次に行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">saveメソッドで新規作成と、更新の両方を実装している。</div>
<div class="line">どちらの処理を行うか判断するために、existsメソッドを作成する。</div>
<div class="line">このメソッドでは、対象のtodoIdの件数を取得し、件数が0より大きいかどうかで存在を確認する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<dl class="docutils">
<dt></dt>
<dd><div class="first last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">saveメソッドは、新規作成でも更新でも利用できるメリットがある。
しかしながら、2回SQLが実行されるという性能面でのデメリットもある。
性能を重視する場合は、新規作成用にcreateメソッドを、更新用にupdateメソッドを作成すること。</p>
</div>
</dd>
</dl>
</div>
<div class="section" id="sqlmap">
<h4><a class="toc-backref" href="#id105">3.5.3.4. SQLMapファイルの作成</a><a class="headerlink" href="#sqlmap" title="Permalink to this headline">¶</a></h4>
<p>src/main/resources/META-INF/mybatis/sql/todo-sqlmap.xmlを作成し、TodoRepositoryImplで使用したSQLIDに対応するsqlを、以下のように記述する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE sqlMap</span>
<span class="cp">            PUBLIC &quot;-//ibatis.apache.org//DTD SQL Map 2.0//EN&quot;</span>
<span class="cp">            &quot;http://ibatis.apache.org/dtd/sql-map-2.dtd&quot;&gt;</span>
<span class="nt">&lt;sqlMap</span> <span class="na">namespace=</span><span class="s">&quot;todo&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;todo&quot;</span> <span class="na">class=</span><span class="s">&quot;todo.domain.model.Todo&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;todoId&quot;</span> <span class="na">column=</span><span class="s">&quot;todo_id&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;todoTitle&quot;</span> <span class="na">column=</span><span class="s">&quot;todo_title&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;finished&quot;</span> <span class="na">column=</span><span class="s">&quot;finished&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;createdAt&quot;</span> <span class="na">column=</span><span class="s">&quot;created_at&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;java.lang.String&quot;</span>
        <span class="na">resultMap=</span><span class="s">&quot;todo&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">SELECT todo_id,</span>
<span class="cp">       todo_title,</span>
<span class="cp">       finished,</span>
<span class="cp">       created_at</span>
<span class="cp">FROM   todo</span>
<span class="cp">WHERE  todo_id = #value#</span>
<span class="cp">]]&gt;</span><span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAll&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;todo&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">SELECT todo_id,</span>
<span class="cp">       todo_title,</span>
<span class="cp">       finished,</span>
<span class="cp">       created_at</span>
<span class="cp">FROM   todo</span>
<span class="cp">]]&gt;</span><span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;todo.domain.model.Todo&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">INSERT INTO todo</span>
<span class="cp">            (todo_id,</span>
<span class="cp">             todo_title,</span>
<span class="cp">             finished,</span>
<span class="cp">             created_at)</span>
<span class="cp">VALUES      ( #todoId#,</span>
<span class="cp">             #todoTitle#,</span>
<span class="cp">             #finished#,</span>
<span class="cp">             #createdAt# )</span>
<span class="cp">]]&gt;</span><span class="nt">&lt;/insert&gt;</span>

    <span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&quot;update&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;todo.domain.model.Todo&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">UPDATE todo</span>
<span class="cp">SET    todo_title = #todoTitle#,</span>
<span class="cp">       finished = #finished#,</span>
<span class="cp">       created_at = #createdAt#</span>
<span class="cp">WHERE  todo_id = #todoId#</span>
<span class="cp">]]&gt;</span><span class="nt">&lt;/update&gt;</span>

    <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&quot;delete&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;todo.domain.model.Todo&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">DELETE FROM todo</span>
<span class="cp">WHERE  todo_id = #todoId#</span>
<span class="cp">]]&gt;</span><span class="nt">&lt;/delete&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;countByFinished&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;java.lang.Boolean&quot;</span>
        <span class="na">resultClass=</span><span class="s">&quot;java.lang.Long&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">SELECT COUNT(*)</span>
<span class="cp">FROM   todo</span>
<span class="cp">WHERE  finished = #value#</span>
<span class="cp">]]&gt;</span><span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;exists&quot;</span> <span class="na">parameterClass=</span><span class="s">&quot;java.lang.String&quot;</span>
        <span class="na">resultClass=</span><span class="s">&quot;java.lang.Long&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">SELECT COUNT(*)</span>
<span class="cp">FROM   todo</span>
<span class="cp">WHERE  todo_id = #value#</span>
<span class="cp">]]&gt;</span><span class="nt">&lt;/select&gt;</span>
<span class="nt">&lt;/sqlMap&gt;</span>
</pre></div>
</div>
<p>以上で、TERASOLUNA DAOを使う対応が完了した。APサーバーを起動し、
Todoの表示や、新規作成を行うと、以下のようなSQLログやトランザクションログが出力される。</p>
<div class="highlight-guess"><div class="highlight"><pre> <span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">TRACE</span><span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">gfw</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">logging</span><span class="p">.</span><span class="n">TraceLoggingInterceptor</span>     <span class="p">]</span> <span class="o">-</span> <span class="p">[</span><span class="n">START</span> <span class="n">CONTROLLER</span><span class="p">]</span> <span class="n">TodoController</span><span class="p">.</span><span class="n">list</span><span class="p">(</span><span class="n">Model</span><span class="p">)</span>
<span class="hll"> <span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">datasource</span><span class="p">.</span><span class="n">DataSourceTransactionManager</span><span class="p">]</span> <span class="o">-</span> <span class="n">Creating</span> <span class="n">new</span> <span class="n">transaction</span> <span class="n">with</span> <span class="n">name</span> <span class="p">[</span><span class="n">todo</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">serivce</span><span class="p">.</span><span class="n">todo</span><span class="p">.</span><span class="n">TodoServiceImpl</span><span class="p">.</span><span class="n">findAll</span><span class="p">]</span><span class="o">:</span> <span class="n">PROPAGATION_REQUIRED</span><span class="p">,</span><span class="n">ISOLATION_DEFAULT</span><span class="p">,</span><span class="n">readOnly</span><span class="p">;</span> <span class="err">&#39;&#39;</span>
</span><span class="hll"> <span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">datasource</span><span class="p">.</span><span class="n">DataSourceTransactionManager</span><span class="p">]</span> <span class="o">-</span> <span class="n">Acquired</span> <span class="n">Connection</span> <span class="p">[</span><span class="n">jdbc</span><span class="o">:</span><span class="n">h2</span><span class="o">:</span><span class="n">mem</span><span class="o">:</span><span class="n">todo</span><span class="p">,</span> <span class="n">UserName</span><span class="o">=</span><span class="n">SA</span><span class="p">,</span> <span class="n">H2</span> <span class="n">JDBC</span> <span class="n">Driver</span><span class="p">]</span> <span class="k">for</span> <span class="n">JDBC</span> <span class="n">transaction</span>
</span><span class="hll"> <span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">datasource</span><span class="p">.</span><span class="n">DataSourceTransactionManager</span><span class="p">]</span> <span class="o">-</span> <span class="n">Participating</span> <span class="k">in</span> <span class="n">existing</span> <span class="n">transaction</span>
</span><span class="hll"> <span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">[</span><span class="n">java</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">Connection</span>                             <span class="p">]</span> <span class="o">-</span> <span class="p">{</span><span class="n">conn</span><span class="o">-</span><span class="mi">100014</span><span class="p">}</span> <span class="n">Connection</span>
</span><span class="hll"> <span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">[</span><span class="n">java</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">Connection</span>                             <span class="p">]</span> <span class="o">-</span> <span class="p">{</span><span class="n">conn</span><span class="o">-</span><span class="mi">100014</span><span class="p">}</span> <span class="n">Preparing</span> <span class="n">Statement</span><span class="o">:</span>  <span class="n">SELECT</span> <span class="n">todo_id</span><span class="p">,</span>        <span class="n">todo_title</span><span class="p">,</span>        <span class="n">finished</span><span class="p">,</span>        <span class="n">created_at</span> <span class="n">FROM</span>   <span class="n">todo</span>
</span><span class="hll"> <span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">[</span><span class="n">java</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">PreparedStatement</span>                      <span class="p">]</span> <span class="o">-</span> <span class="p">{</span><span class="n">pstm</span><span class="o">-</span><span class="mi">100015</span><span class="p">}</span> <span class="n">Executing</span> <span class="n">Statement</span><span class="o">:</span>  <span class="n">SELECT</span> <span class="n">todo_id</span><span class="p">,</span>        <span class="n">todo_title</span><span class="p">,</span>        <span class="n">finished</span><span class="p">,</span>        <span class="n">created_at</span> <span class="n">FROM</span>   <span class="n">todo</span>
</span><span class="hll"> <span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">[</span><span class="n">java</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">PreparedStatement</span>                      <span class="p">]</span> <span class="o">-</span> <span class="p">{</span><span class="n">pstm</span><span class="o">-</span><span class="mi">100015</span><span class="p">}</span> <span class="n">Parameters</span><span class="o">:</span> <span class="p">[]</span>
</span><span class="hll"> <span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">[</span><span class="n">java</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">PreparedStatement</span>                      <span class="p">]</span> <span class="o">-</span> <span class="p">{</span><span class="n">pstm</span><span class="o">-</span><span class="mi">100015</span><span class="p">}</span> <span class="n">Types</span><span class="o">:</span> <span class="p">[]</span>
</span><span class="hll"> <span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">datasource</span><span class="p">.</span><span class="n">DataSourceTransactionManager</span><span class="p">]</span> <span class="o">-</span> <span class="n">Initiating</span> <span class="n">transaction</span> <span class="n">commit</span>
</span><span class="hll"> <span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">datasource</span><span class="p">.</span><span class="n">DataSourceTransactionManager</span><span class="p">]</span> <span class="o">-</span> <span class="n">Committing</span> <span class="n">JDBC</span> <span class="n">transaction</span> <span class="n">on</span> <span class="n">Connection</span> <span class="p">[</span><span class="n">jdbc</span><span class="o">:</span><span class="n">h2</span><span class="o">:</span><span class="n">mem</span><span class="o">:</span><span class="n">todo</span><span class="p">,</span> <span class="n">UserName</span><span class="o">=</span><span class="n">SA</span><span class="p">,</span> <span class="n">H2</span> <span class="n">JDBC</span> <span class="n">Driver</span><span class="p">]</span>
</span><span class="hll"> <span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">datasource</span><span class="p">.</span><span class="n">DataSourceTransactionManager</span><span class="p">]</span> <span class="o">-</span> <span class="n">Releasing</span> <span class="n">JDBC</span> <span class="n">Connection</span> <span class="p">[</span><span class="n">jdbc</span><span class="o">:</span><span class="n">h2</span><span class="o">:</span><span class="n">mem</span><span class="o">:</span><span class="n">todo</span><span class="p">,</span> <span class="n">UserName</span><span class="o">=</span><span class="n">SA</span><span class="p">,</span> <span class="n">H2</span> <span class="n">JDBC</span> <span class="n">Driver</span><span class="p">]</span> <span class="n">after</span> <span class="n">transaction</span>
</span> <span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">TRACE</span><span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">gfw</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">logging</span><span class="p">.</span><span class="n">TraceLoggingInterceptor</span>     <span class="p">]</span> <span class="o">-</span> <span class="p">[</span><span class="n">END</span> <span class="n">CONTROLLER</span>  <span class="p">]</span> <span class="n">TodoController</span><span class="p">.</span><span class="n">list</span><span class="p">(</span><span class="n">Model</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">view</span><span class="o">=</span><span class="n">todo</span><span class="o">/</span><span class="n">list</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="p">{</span><span class="n">todoForm</span><span class="o">=</span><span class="n">todo</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">todo</span><span class="p">.</span><span class="n">TodoForm</span><span class="mi">@1386751</span><span class="p">,</span> <span class="n">todos</span><span class="o">=</span><span class="p">[</span><span class="n">todo</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">Todo</span><span class="mi">@72</span><span class="n">edc</span><span class="p">],</span> <span class="n">org</span><span class="p">.</span><span class="n">springframework</span><span class="p">.</span><span class="n">validation</span><span class="p">.</span><span class="n">BindingResult</span><span class="p">.</span><span class="n">todoForm</span><span class="o">=</span><span class="n">org</span><span class="p">.</span><span class="n">springframework</span><span class="p">.</span><span class="n">validation</span><span class="p">.</span><span class="n">BeanPropertyBindingResult</span><span class="o">:</span> <span class="mi">0</span> <span class="n">errors</span><span class="p">}</span>
 <span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">37</span> <span class="p">[</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="n">TRACE</span><span class="p">]</span> <span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">gfw</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">logging</span><span class="p">.</span><span class="n">TraceLoggingInterceptor</span>     <span class="p">]</span> <span class="o">-</span> <span class="p">[</span><span class="n">HANDLING</span> <span class="n">TIME</span>   <span class="p">]</span> <span class="n">TodoController</span><span class="p">.</span><span class="n">list</span><span class="p">(</span><span class="n">Model</span><span class="p">)</span><span class="o">-&gt;</span> <span class="mi">2</span><span class="p">,</span><span class="mi">461</span><span class="p">,</span><span class="mi">131</span> <span class="n">ns</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="id57">
<h2><a class="toc-backref" href="#id106">3.6. おわりに</a><a class="headerlink" href="#id57" title="Permalink to this headline">¶</a></h2>
<p>このチュートリアルでは、以下の内容を学習した。</p>
<ul class="simple">
<li>TERASOLUNA Global Frameworkによる基本的なアプリケーションの開発方法、およびEclipseプロジェクトの構築方法</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>STSの使用方法</li>
<li>MavenでTERASOLUNA Global Frameworkを使用する方法</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>TERASOLUNA Global Frameworkのアプリケーションのレイヤ化に従った開発方法</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>POJO(+ Spring)によるドメイン層の実装</li>
<li>Spring MVCとJSPタグライブラリを使用したアプリケーション層の実装</li>
<li>Spring Data JPAによるインフラストラクチャ層の実装</li>
<li>MyBatis2によるインフラストラクチャ層の実装</li>
</ul>
</div></blockquote>
<p>ここで作成したTODO管理アプリケーションには、以下の改善点がある。
アプリケーションの修正を学習課題として、ガイドライン中の該当する説明を参照されたい。</p>
<ul class="simple">
<li>プロパティを外部化する → <a class="reference internal" href="../ArchitectureInDetail/PropertyManagement.html"><em>プロパティ管理</em></a></li>
<li>メッセージを外部化する → <a class="reference internal" href="../ArchitectureInDetail/MessageManagement.html"><em>メッセージ管理</em></a></li>
<li>ページング処理を追加する → <a class="reference internal" href="../ArchitectureInDetail/Pagination.html"><em>ページネーション</em></a></li>
<li>例外ハンドリングを加える → <a class="reference internal" href="../ArchitectureInDetail/ExceptionHandling.html"><em>例外ハンドリング</em></a></li>
<li>CSRF対策を追加する → <a class="reference internal" href="../Security/CSRF.html"><em>CSRF対策</em></a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../ImplementationAtEachLayer/index.html" title="4. TERASOLUNA Global Frameworkによるアプリケーション開発"
             >next</a> |</li>
        <li class="right" >
          <a href="../Overview/ApplicationLayering.html" title="2.4. アプリケーションのレイヤ化"
             >previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.0.publicreview documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
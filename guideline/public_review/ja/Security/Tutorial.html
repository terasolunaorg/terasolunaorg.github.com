<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>6.2. Spring Securtityチュートリアル &#8212; TERASOLUNA Global Framework Development Guideline 1.0.0.publicreview documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/solar.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6.3. 認証" href="Authentication.html" />
    <link rel="prev" title="6.1. Spring Security概要" href="SpringSecurity.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Authentication.html" title="6.3. 認証"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="SpringSecurity.html" title="6.1. Spring Security概要"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.0.publicreview documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">6. </span>TERASOLUNA Global Frameworkによるセキュリティ対策</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">6.2. </span>Spring Securtityチュートリアル</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">6.2. Spring Securtityチュートリアル</a><ul>
<li><a class="reference internal" href="#id2">6.2.1. はじめに</a><ul>
<li><a class="reference internal" href="#id3">6.2.1.1. このチュートリアルで学ぶこと</a></li>
<li><a class="reference internal" href="#id4">6.2.1.2. 対象読者</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5">6.2.2. 作成するアプリケーションの説明</a><ul>
<li><a class="reference internal" href="#id6">6.2.2.1. アプリケーションの概要</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id7">6.2.3. 環境構築</a><ul>
<li><a class="reference internal" href="#id8">6.2.3.1. プロジェクトの作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id9">6.2.4. アプリケーションの作成</a><ul>
<li><a class="reference internal" href="#id10">6.2.4.1. ドメイン層の実装</a><ul>
<li><a class="reference internal" href="#domain-object">6.2.4.1.1. Domain Objectの作成</a></li>
<li><a class="reference internal" href="#accountrepository">6.2.4.1.2. AccountRepositoryの作成</a></li>
<li><a class="reference internal" href="#accountservice">6.2.4.1.3. AccountServiceの作成</a></li>
<li><a class="reference internal" href="#id11">6.2.4.1.4. 認証サービスの作成</a></li>
<li><a class="reference internal" href="#id12">6.2.4.1.5. ドメイン層の作成後のパッケージエクスプローラー</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id13">6.2.4.2. アプリケーション層の実装</a><ul>
<li><a class="reference internal" href="#spring-security">6.2.4.2.1. Spring Securityの設定</a></li>
<li><a class="reference internal" href="#sql">6.2.4.2.2. 起動時に実行されるSQLスクリプトの設定</a></li>
<li><a class="reference internal" href="#id14">6.2.4.2.3. ログイン画面の作成</a></li>
<li><a class="reference internal" href="#jsp">6.2.4.2.4. JSPからログインアカウント情報にアクセスする</a></li>
<li><a class="reference internal" href="#id15">6.2.4.2.5. ログインアカウント情報表示ページの作成</a></li>
<li><a class="reference internal" href="#id16">6.2.4.2.6. アプリケーション層の作成後のパッケージエクスプローラー</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id17">6.2.5. おわりに</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="SpringSecurity.html"
                          title="previous chapter"><span class="section-number">6.1. </span>Spring Security概要</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="Authentication.html"
                          title="next chapter"><span class="section-number">6.3. </span>認証</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Security/Tutorial.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="spring-securtity">
<h1><span class="section-number">6.2. </span>Spring Securtityチュートリアル<a class="headerlink" href="#spring-securtity" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="id1">
<p class="topic-title">目次</p>
<ul class="simple">
<li><p><a class="reference internal" href="#id2" id="id18">はじめに</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id19">このチュートリアルで学ぶこと</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id20">対象読者</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id5" id="id21">作成するアプリケーションの説明</a></p>
<ul>
<li><p><a class="reference internal" href="#id6" id="id22">アプリケーションの概要</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id7" id="id23">環境構築</a></p>
<ul>
<li><p><a class="reference internal" href="#id8" id="id24">プロジェクトの作成</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id9" id="id25">アプリケーションの作成</a></p>
<ul>
<li><p><a class="reference internal" href="#id10" id="id26">ドメイン層の実装</a></p>
<ul>
<li><p><a class="reference internal" href="#domain-object" id="id27">Domain Objectの作成</a></p></li>
<li><p><a class="reference internal" href="#accountrepository" id="id28">AccountRepositoryの作成</a></p></li>
<li><p><a class="reference internal" href="#accountservice" id="id29">AccountServiceの作成</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id30">認証サービスの作成</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id31">ドメイン層の作成後のパッケージエクスプローラー</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id13" id="id32">アプリケーション層の実装</a></p>
<ul>
<li><p><a class="reference internal" href="#spring-security" id="id33">Spring Securityの設定</a></p></li>
<li><p><a class="reference internal" href="#sql" id="id34">起動時に実行されるSQLスクリプトの設定</a></p></li>
<li><p><a class="reference internal" href="#id14" id="id35">ログイン画面の作成</a></p></li>
<li><p><a class="reference internal" href="#jsp" id="id36">JSPからログインアカウント情報にアクセスする</a></p></li>
<li><p><a class="reference internal" href="#id15" id="id37">ログインアカウント情報表示ページの作成</a></p></li>
<li><p><a class="reference internal" href="#id16" id="id38">アプリケーション層の作成後のパッケージエクスプローラー</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#id17" id="id39">おわりに</a></p></li>
</ul>
</nav>
<section id="id2">
<h2><a class="toc-backref" href="#id18" role="doc-backlink"><span class="section-number">6.2.1. </span>はじめに</a><a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h2>
<section id="id3">
<h3><a class="toc-backref" href="#id19" role="doc-backlink"><span class="section-number">6.2.1.1. </span>このチュートリアルで学ぶこと</a><a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>Spring Securityによる基本的な認証・認可</p></li>
<li><p>データベース上のアカウント情報を使用したログイン</p></li>
<li><p>認証済みアカウントオブジェクトの取得方法</p></li>
</ul>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id20" role="doc-backlink"><span class="section-number">6.2.1.2. </span>対象読者</a><a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p><a class="reference internal" href="../TutorialTodo/index.html"><span class="doc">チュートリアル(Todoアプリケーション)</span></a>を実施ずみ</p></li>
<li><p>Mavenの基本的な操作を理解している</p></li>
</ul>
</section>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id21" role="doc-backlink"><span class="section-number">6.2.2. </span>作成するアプリケーションの説明</a><a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h2>
<section id="id6">
<h3><a class="toc-backref" href="#id22" role="doc-backlink"><span class="section-number">6.2.2.1. </span>アプリケーションの概要</a><a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>ログインできる。ログインのためのアカウント情報はデータベース上に格納されている。</p></li>
<li><p>Welcome画面、アカウント情報表示画面があり、ログインしないと閲覧できない。</p></li>
<li><p>ログアウトできる。</p></li>
</ul>
<p>アプリケーションの概要を以下の図で示す。</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/security_tutorial_applicatioin_overview.png"><img alt="../_images/security_tutorial_applicatioin_overview.png" src="../_images/security_tutorial_applicatioin_overview.png" style="width: 80%;" /></a>
</figure>
<p>URL一覧を以下に示す。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 20%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>プロセス名</p></th>
<th class="head"><p>HTTPメソッド</p></th>
<th class="head"><p>URL</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>ログインフォーム表示</p></td>
<td><p>GET</p></td>
<td><p>/login.jsp</p></td>
<td><p>ログインフォームを表示する</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>ログイン</p></td>
<td><p>POST</p></td>
<td><p>/authentication</p></td>
<td><p>ログインフォームから入力されたユーザ名、パスワードを使って認証する(Spring Securityが行う)</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>ウェルカムページ表示</p></td>
<td><p>GET</p></td>
<td><p>/</p></td>
<td><p>ウェルカムページを表示する</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>アカウント情報表示</p></td>
<td><p>GET</p></td>
<td><p>/account</p></td>
<td><p>ログイン中のアカウント情報を表示する</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>ログアウト</p></td>
<td><p>GET</p></td>
<td><p>/logout</p></td>
<td><p>ログアウトする(Spring Securityが行う)</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="id7">
<h2><a class="toc-backref" href="#id23" role="doc-backlink"><span class="section-number">6.2.3. </span>環境構築</a><a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h2>
<section id="id8">
<h3><a class="toc-backref" href="#id24" role="doc-backlink"><span class="section-number">6.2.3.1. </span>プロジェクトの作成</a><a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">Mavenのアーキタイプを利用し、<a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-blank">TERASOLUNA Global Frameworkの雛形</a>を作成する。</div>
<div class="line">Spring tool suiteへのインポート方法やアプリケーションサーバの起動方法は、<span class="xref std std-ref">CreateProjectFromBlank_create-new-project</span>を参照されたい。</div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mvn<span class="w"> </span>archetype:generate<span class="w"> </span>-DarchetypeCatalog<span class="o">=</span>http://repo.terasoluna.org/nexus/content/repositories/terasoluna-gfw-releases
<span class="go">[INFO] Scanning for projects...</span>
<span class="go">[INFO]</span>
<span class="go">[INFO] ------------------------------------------------------------------------</span>
<span class="go">[INFO] Building Maven Stub Project (No POM) 1</span>
<span class="go">[INFO] ------------------------------------------------------------------------</span>
<span class="go">[INFO]</span>
<span class="go">[INFO] &gt;&gt;&gt; maven-archetype-plugin:2.2:generate (default-cli) @ standalone-pom &gt;&gt;&gt;</span>
<span class="go">[INFO]</span>
<span class="go">[INFO] &lt;&lt;&lt; maven-archetype-plugin:2.2:generate (default-cli) @ standalone-pom &lt;&lt;&lt;</span>
<span class="go">[INFO]</span>
<span class="go">[INFO] --- maven-archetype-plugin:2.2:generate (default-cli) @ standalone-pom ---</span>
<span class="go">[INFO] Generating project in Interactive mode</span>
<span class="go">[INFO] No archetype defined. Using maven-archetype-quickstart (org.apache.maven.archetypes:maven-archetype-quickstart:1.0)</span>
<span class="go">Choose archetype:</span>
<span class="go">1: http://repo.terasoluna.org/nexus/content/repositories/terasoluna-gfw-releases -&gt; org.terasoluna.gfw.blank:terasoluna-gfw-web-blank-archetype (Blank project using TERASOLUNA Global Framework)</span>
<span class="go">2: http://repo.terasoluna.org/nexus/content/repositories/terasoluna-gfw-releases -&gt; org.terasoluna.gfw.blank:terasoluna-gfw-web-blank-jpa-archetype (Blank project using TERASOLUNA Global Framework (JPA))</span>
<span class="go">3: http://repo.terasoluna.org/nexus/content/repositories/terasoluna-gfw-releases -&gt; org.terasoluna.gfw.blank:terasoluna-gfw-web-blank-mybatis2-archetype (Blank project using TERASOLUNA Global Framework (MyBatis2))</span>
</pre></div>
</div>
<p>どのタイプを選ぶか問われる。今回はデータアクセスにMyBatis2を使用する”3”を選択する。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Choose a number or apply filter (format: [groupId:]artifactId, case sensitive contains): : 3</span>
</pre></div>
</div>
<p>groupId, artifactId, version, pacakgeは以下の通り</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<tbody>
<tr class="row-odd"><th class="stub"><p>groupId</p></th>
<td><p>com.example.security</p></td>
</tr>
<tr class="row-even"><th class="stub"><p>artifactId</p></th>
<td><p>first-springsecurity</p></td>
</tr>
<tr class="row-odd"><th class="stub"><p>version</p></th>
<td><p>1.0-SNAPSHOT</p></td>
</tr>
<tr class="row-even"><th class="stub"><p>package</p></th>
<td><p>com.example.security</p></td>
</tr>
</tbody>
</table>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Define value for property &#39;groupId&#39;: : com.example.security</span>
<span class="go">Define value for property &#39;artifactId&#39;: : first-springsecurity</span>
<span class="go">Define value for property &#39;version&#39;:  1.0-SNAPSHOT: :</span>
<span class="go">Define value for property &#39;package&#39;:  com.example.security: :</span>
<span class="go">Confirm properties configuration:</span>
<span class="go">groupId: com.example.security</span>
<span class="go">artifactId: first-springsecurity</span>
<span class="go">version: 1.0-SNAPSHOT</span>
<span class="go">package: com.example.security</span>
<span class="go"> Y: :</span>
<span class="go">[INFO] ----------------------------------------------------------------------------</span>
<span class="go">[INFO] Using following parameters for creating project from Archetype: terasoluna-gfw-web-blank-mybatis2-archetype:1.0.0.RELEASE</span>
<span class="go">[INFO] ----------------------------------------------------------------------------</span>
<span class="go">[INFO] Parameter: groupId, Value: com.example.security</span>
<span class="go">[INFO] Parameter: artifactId, Value: first-springsecurity</span>
<span class="go">[INFO] Parameter: version, Value: 1.0-SNAPSHOT</span>
<span class="go">[INFO] Parameter: package, Value: com.example.security</span>
<span class="go">[INFO] Parameter: packageInPathFormat, Value: com/example/security</span>
<span class="go">[INFO] Parameter: package, Value: com.example.security</span>
<span class="go">[INFO] Parameter: version, Value: 1.0-SNAPSHOT</span>
<span class="go">[INFO] Parameter: groupId, Value: com.example.security</span>
<span class="go">[INFO] Parameter: artifactId, Value: first-springsecurity</span>
<span class="go">[INFO] project created from Archetype in dir: /Users/xxx/first-springsecurity</span>
<span class="go">[INFO] ------------------------------------------------------------------------</span>
<span class="go">[INFO] BUILD SUCCESS</span>
<span class="go">[INFO] ------------------------------------------------------------------------</span>
<span class="go">[INFO] Total time: 51.891s</span>
<span class="go">[INFO] Finished at: Mon Dec 02 14:03:11 JST 2013</span>
<span class="go">[INFO] Final Memory: 13M/116M</span>
<span class="go">[INFO] ------------------------------------------------------------------------</span>
</pre></div>
</div>
</section>
</section>
<section id="id9">
<h2><a class="toc-backref" href="#id25" role="doc-backlink"><span class="section-number">6.2.4. </span>アプリケーションの作成</a><a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h2>
<section id="id10">
<h3><a class="toc-backref" href="#id26" role="doc-backlink"><span class="section-number">6.2.4.1. </span>ドメイン層の実装</a><a class="headerlink" href="#id10" title="Permalink to this heading">¶</a></h3>
<p>Spring Securityの認証処理は基本的に以下の流れになる。</p>
<ol class="arabic simple">
<li><p>入力された<code class="docutils literal notranslate"><span class="pre">username</span></code>からユーザー情報を検索する。</p></li>
<li><p>ユーザー情報が存在する場合、そのユーザー情報がもつパスワードと入力されたパスワードをハッシュ化したものを比較する。</p></li>
<li><p>比較結果が一致する場合、認証成功とみなす。</p></li>
</ol>
<p>ユーザー情報が見つからない場合やパスワードの比較結果が一致しない場合は認証失敗である。</p>
<p>ドメイン層ではユーザー名からAccountオブジェクトを取得する処理が必要となる。以下の順に進める。</p>
<ol class="arabic simple">
<li><p>Domain Object(Account)の作成</p></li>
<li><p>AccountRepositoryの作成</p></li>
<li><p>AccountServiceの作成</p></li>
</ol>
<p>Accountテーブルは次のものを使用する(DDLスクリプトは後程作成する)。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">account</span><span class="p">(</span>
<span class="w">    </span><span class="n">username</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<span class="w">    </span><span class="n">password</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<span class="w">    </span><span class="n">first_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<span class="w">    </span><span class="n">last_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<span class="w">    </span><span class="k">constraint</span><span class="w"> </span><span class="n">pk_tbl_account</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<section id="domain-object">
<h4><a class="toc-backref" href="#id27" role="doc-backlink"><span class="section-number">6.2.4.1.1. </span>Domain Objectの作成</a><a class="headerlink" href="#domain-object" title="Permalink to this heading">¶</a></h4>
<p>次の<code class="docutils literal notranslate"><span class="pre">Account</span></code>クラスを用意する。このクラスが認証情報(ユーザー名とパスワード)を持つ。</p>
<ul>
<li><p>src/main/java/com/example/security/domain/model/Account.java</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.security.domain.model</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.io.Serializable</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Account</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">serialVersionUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1L</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">firstName</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">lastName</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getUsername</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setUsername</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getPassword</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setPassword</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getFirstName</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">firstName</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFirstName</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">firstName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">firstName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">firstName</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getLastName</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">lastName</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setLastName</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">lastName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">lastName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lastName</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">toString</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Account [username=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, password=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">password</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, firstName=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">firstName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;, lastName=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lastName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;]&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="accountrepository">
<h4><a class="toc-backref" href="#id28" role="doc-backlink"><span class="section-number">6.2.4.1.2. </span>AccountRepositoryの作成</a><a class="headerlink" href="#accountrepository" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">AccountRepository</span></code>にはユーザー名からAccountオブジェクトを取得するデータアクセス処理を実装する。</p>
<ul>
<li><p>src/main/java/com/example/security/domain/repository/account/AccountRepository.java</p>
<p>まずはインタフェースを定義する。ユーザー名からAccountオブジェクトを取得する<code class="docutils literal notranslate"><span class="pre">findOne(username)</span></code>を定義する。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.security.domain.repository.account</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.security.domain.model.Account</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">AccountRepository</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Account</span><span class="w"> </span><span class="nf">findOne</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>src/main/java/com/example/security/domain/repository/account/AccountRepositoryImpl.java</p>
<p>データアクセス処理を<code class="docutils literal notranslate"><span class="pre">AccountRepositoryImpl</span></code>に実装する。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.security.domain.repository.account</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Repository</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">jp.terasoluna.fw.dao.QueryDAO</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.security.domain.model.Account</span><span class="p">;</span>

<span class="nd">@Repository</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AccountRepositoryImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">AccountRepository</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Inject</span>
<span class="w">    </span><span class="n">QueryDAO</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="nf">findOne</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queryDAO</span><span class="p">.</span><span class="na">executeForObject</span><span class="p">(</span><span class="s">&quot;account.findOne&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">Account</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">account</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>src/main/resources/META-INF/mybatis/sql/account-sqlmap.xml</p>
<p><code class="docutils literal notranslate"><span class="pre">Account</span></code>を1件取得するためのSQLID<code class="docutils literal notranslate"><span class="pre">&quot;account.findOne&quot;</span></code>に対応するSQLをSQLMapファイルに定義する。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE sqlMap</span>
<span class="cp">            PUBLIC &quot;-//ibatis.apache.org//DTD SQL Map 2.0//EN&quot;</span>
<span class="cp">            &quot;http://ibatis.apache.org/dtd/sql-map-2.dtd&quot;&gt;</span>

<span class="nt">&lt;sqlMap</span><span class="w"> </span><span class="na">namespace=</span><span class="s">&quot;account&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;account&quot;</span>
<span class="w">        </span><span class="na">class=</span><span class="s">&quot;com.example.security.domain.model.Account&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;username&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;username&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;password&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;password&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;firstName&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;first_name&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;lastName&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;last_name&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/resultMap&gt;</span>


<span class="w">    </span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findOne&quot;</span><span class="w"> </span><span class="na">parameterClass=</span><span class="s">&quot;java.lang.String&quot;</span>
<span class="w">        </span><span class="na">resultMap=</span><span class="s">&quot;account&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">SELECT username,</span>
<span class="cp">       password,</span>
<span class="cp">       first_name,</span>
<span class="cp">       last_name</span>
<span class="cp">FROM   account</span>
<span class="cp">WHERE  username = #value#</span>
<span class="cp">]]&gt;</span><span class="nt">&lt;/select&gt;</span>
<span class="nt">&lt;/sqlMap&gt;</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="accountservice">
<h4><a class="toc-backref" href="#id29" role="doc-backlink"><span class="section-number">6.2.4.1.3. </span>AccountServiceの作成</a><a class="headerlink" href="#accountservice" title="Permalink to this heading">¶</a></h4>
<ul>
<li><p>src/main/java/com/example/security/domain/service/account/AccountService.java</p>
<p><code class="docutils literal notranslate"><span class="pre">AccountService</span></code>にはユーザー名から<code class="docutils literal notranslate"><span class="pre">Account</span></code>オブジェクトを取得する業務処理を実装する。</p>
<p>この処理は後ほどSpring Securityの認証サービスから利用されるので、クラス名は<code class="docutils literal notranslate"><span class="pre">AccountSharedService</span></code>とする。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.security.domain.service.account</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.security.domain.model.Account</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">AccountSharedService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Account</span><span class="w"> </span><span class="nf">findOne</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>src/main/java/com/example/security/domain/service/account/AccountServiceImpl.java</p>
<p>データアクセスの結果、該当する<code class="docutils literal notranslate"><span class="pre">Account</span></code>が存在しない場合は、<code class="docutils literal notranslate"><span class="pre">ResourceNotFoundException</span></code>をスローする。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.security.domain.service.account</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.security.domain.model.Account</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.security.domain.repository.account.AccountRepository</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AccountSharedServiceImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">AccountSharedService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Inject</span>
<span class="w">    </span><span class="n">AccountRepository</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="nf">findOne</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">account</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ResourceNotFoundException</span><span class="p">(</span><span class="s">&quot;The given account is not found! username=&quot;</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">username</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">account</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id11">
<h4><a class="toc-backref" href="#id30" role="doc-backlink"><span class="section-number">6.2.4.1.4. </span>認証サービスの作成</a><a class="headerlink" href="#id11" title="Permalink to this heading">¶</a></h4>
<p>Spring Securityで使用する認証ユーザー情報は<code class="docutils literal notranslate"><span class="pre">org.springframework.security.core.userdetails.UserDetails</span></code>インタフェースを実装する。
ここでは<code class="docutils literal notranslate"><span class="pre">UserDetails</span></code>を実装した<code class="docutils literal notranslate"><span class="pre">org.springframework.security.core.userdetails.User</span></code> クラスを継承し、本プロジェクト用の<code class="docutils literal notranslate"><span class="pre">UserDetails</span></code>クラスを実装する。</p>
<ul>
<li><p>src/main/java/com/example/security/domain/service/userdetails/SampleUserDetails.java</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.security.domain.service.userdetails</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collection</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collections</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.GrantedAuthority</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.authority.SimpleGrantedAuthority</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.userdetails.User</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.security.domain.model.Account</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SampleUserDetails</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">serialVersionUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1L</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="p">;</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">SampleUserDetails</span><span class="p">(</span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="na">getPassword</span><span class="p">(),</span><span class="w"> </span><span class="n">createRole</span><span class="p">(</span><span class="n">account</span><span class="p">));</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">account</span><span class="p">;</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Collection</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">GrantedAuthority</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">createRole</span><span class="p">(</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// sample role</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Collections</span>
<span class="w">                </span><span class="p">.</span><span class="na">singletonList</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SimpleGrantedAuthority</span><span class="p">(</span><span class="s">&quot;ROLE_USER&quot;</span><span class="p">));</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="nf">getAccount</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (4)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">account</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Springの認証ユーザークラスに、本プロジェクトのアカウント情報を保持させる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">User</span></code>クラスのコンストラクタを呼び出す。第1引数はユーザー名、第2引数はパスワード、第3引数は権限リストである。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">簡易実装として、<code class="docutils literal notranslate"><span class="pre">&quot;ROLE_USER&quot;</span></code>というロールのみ持つ権限を作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">アカウント情報のgetterを用意する。これにより、ログイン中の<code class="docutils literal notranslate"><span class="pre">Account</span></code>オブジェクトを取得することができる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p>src/main/java/com/example/security/domain/service/userdetails/SampleUserDetailsService.java</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.security.domain.service.userdetails</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">javax.inject.Inject</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.userdetails.UserDetails</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.userdetails.UserDetailsService</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.userdetails.UsernameNotFoundException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.terasoluna.gfw.common.exception.ResourceNotFoundException</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.security.domain.model.Account</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.security.domain.service.account.AccountSharedService</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SampleUserDetailsService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserDetailsService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Inject</span>
<span class="w">    </span><span class="n">AccountSharedService</span><span class="w"> </span><span class="n">accountSharedService</span><span class="p">;</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">UserDetails</span><span class="w"> </span><span class="nf">loadUserByUsername</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">UsernameNotFoundException</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountSharedService</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">username</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SampleUserDetails</span><span class="p">(</span><span class="n">account</span><span class="p">);</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceNotFoundException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UsernameNotFoundException</span><span class="p">(</span><span class="s">&quot;user not found&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"> </span><span class="c1">// (4)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">AccountSharedService</span></code>をインジェクションする。</div>
<div class="line">本ガイドラインでは、ServiceからはServiceの呼び出しは非推奨であり、<code class="docutils literal notranslate"><span class="pre">AccountService</span></code>ではなく、<code class="docutils literal notranslate"><span class="pre">AccountSharedService</span></code>という名前にしている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">username</span></code>から<code class="docutils literal notranslate"><span class="pre">Account</span></code>オブジェクトを取得する処理を<code class="docutils literal notranslate"><span class="pre">AccountSharedService</span></code>に委譲する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">取得した<code class="docutils literal notranslate"><span class="pre">Account</span></code>オブジェクトを使用して、本プロジェクト用の<code class="docutils literal notranslate"><span class="pre">UserDetails</span></code>オブジェクトを作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code>は対象のユーザーが見つからない場合には<code class="docutils literal notranslate"><span class="pre">UsernameNotFoundException</span></code>がスローされる仕様となっている。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</section>
<section id="id12">
<h4><a class="toc-backref" href="#id31" role="doc-backlink"><span class="section-number">6.2.4.1.5. </span>ドメイン層の作成後のパッケージエクスプローラー</a><a class="headerlink" href="#id12" title="Permalink to this heading">¶</a></h4>
<p>Package ExplorerのPackage PresentationはHierarchicalを使用している。</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/security_tutorial-domain-layer-package-explorer.png"><img alt="security tutorial domain layer package explorer" src="../_images/security_tutorial-domain-layer-package-explorer.png" style="width: 40%;" /></a>
</figure>
</section>
</section>
<section id="id13">
<h3><a class="toc-backref" href="#id32" role="doc-backlink"><span class="section-number">6.2.4.2. </span>アプリケーション層の実装</a><a class="headerlink" href="#id13" title="Permalink to this heading">¶</a></h3>
<section id="spring-security">
<h4><a class="toc-backref" href="#id33" role="doc-backlink"><span class="section-number">6.2.4.2.1. </span>Spring Securityの設定</a><a class="headerlink" href="#spring-security" title="Permalink to this heading">¶</a></h4>
<p>spring-security.xmlにSpring Securityによる認証・認可の設定を行う。</p>
<p>特にURLに関する設定項目を以下に再掲する。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 70%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">設定項目名</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">設定値</div>
</div>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">ログインフォームのURL</div>
</div>
</td>
<td><div class="line-block">
<div class="line">/login.jsp</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">認証失敗時に遷移するURL</div>
</div>
</td>
<td><div class="line-block">
<div class="line">/login.jsp?error=true</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">認証処理のURL</div>
</div>
</td>
<td><div class="line-block">
<div class="line">/authenticate</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">ログアウトのURL</div>
</div>
</td>
<td><div class="line-block">
<div class="line">/logout</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">ログアウト後に遷移するURL</div>
</div>
</td>
<td><div class="line-block">
<div class="line">/</div>
</div>
</td>
</tr>
</tbody>
</table>
<p id="tutorial-setting-spring-security">blankプロジェクトからの差分のみ説明する。</p>
<ul>
<li><p>src/main/resources/META-INF/spring/spring-security.xml</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="w"> </span><span class="nt">&lt;beans</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
<span class="w">     </span><span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="w"> </span><span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
<span class="w">     </span><span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
<span class="w">     </span><span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">         http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">         http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span><span class="nt">&gt;</span>

<span class="w">     </span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/resources/**&quot;</span><span class="w"> </span><span class="na">security=</span><span class="s">&quot;none&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">     </span><span class="nt">&lt;sec:http</span><span class="w"> </span><span class="na">auto-config=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<span class="hll"><span class="w">         </span><span class="nt">&lt;sec:form-login</span><span class="w"> </span><span class="na">login-page=</span><span class="s">&quot;/login.jsp&quot;</span>
</span><span class="hll"><span class="w">             </span><span class="na">authentication-failure-url=</span><span class="s">&quot;/login.jsp?error=true&quot;</span>
</span><span class="hll"><span class="w">             </span><span class="na">login-processing-url=</span><span class="s">&quot;/authenticate&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="w">         </span><span class="nt">&lt;sec:logout</span><span class="w"> </span><span class="na">logout-url=</span><span class="s">&quot;/logout&quot;</span><span class="w"> </span><span class="na">logout-success-url=</span><span class="s">&quot;/&quot;</span>
</span><span class="hll"><span class="w">             </span><span class="na">delete-cookies=</span><span class="s">&quot;JSESSIONID&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (2) --&gt;</span>
</span><span class="hll">
</span><span class="hll"><span class="w">         </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/login.jsp&quot;</span>
</span><span class="hll"><span class="w">             </span><span class="na">access=</span><span class="s">&quot;permitAll&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (3) --&gt;</span>
</span><span class="hll"><span class="w">         </span><span class="nt">&lt;sec:intercept-url</span><span class="w"> </span><span class="na">pattern=</span><span class="s">&quot;/**&quot;</span><span class="w"> </span><span class="na">access=</span><span class="s">&quot;isAuthenticated()&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (4) --&gt;</span>
</span>
<span class="w">         </span><span class="nt">&lt;sec:custom-filter</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;csrfFilter&quot;</span><span class="w"> </span><span class="na">before=</span><span class="s">&quot;LOGOUT_FILTER&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">         </span><span class="nt">&lt;sec:custom-filter</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span>
<span class="w">             </span><span class="na">after=</span><span class="s">&quot;ANONYMOUS_FILTER&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">         </span><span class="nt">&lt;sec:session-management</span>
<span class="w">             </span><span class="na">session-authentication-strategy-ref=</span><span class="s">&quot;sessionAuthenticationStrategy&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">     </span><span class="nt">&lt;/sec:http&gt;</span>


<span class="w">     </span><span class="nt">&lt;sec:authentication-manager&gt;</span>
<span class="w">         </span><span class="cm">&lt;!-- com.example.security.domain.service.userdetails.SampleUserDetails</span>
<span class="cm">             is scaned by component scan with @Service --&gt;</span>
<span class="hll"><span class="w">         </span><span class="nt">&lt;sec:authentication-provider</span>
</span><span class="hll"><span class="w">             </span><span class="na">user-service-ref=</span><span class="s">&quot;sampleUserDetailsService&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (5) --&gt;</span>
</span><span class="hll"><span class="w">             </span><span class="nt">&lt;sec:password-encoder</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (6) --&gt;</span>
</span><span class="hll"><span class="w">         </span><span class="nt">&lt;/sec:authentication-provider&gt;</span>
</span><span class="w">     </span><span class="nt">&lt;/sec:authentication-manager&gt;</span>

<span class="w">     </span><span class="cm">&lt;!-- CSRF Protection --&gt;</span>
<span class="w">     </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;csrfTokenRepository&quot;</span>
<span class="w">         </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.csrf.HttpSessionCsrfTokenRepository&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>

<span class="w">     </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;csrfFilter&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.csrf.CsrfFilter&quot;</span><span class="nt">&gt;</span>
<span class="w">         </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;csrfTokenRepository&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">         </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;accessDeniedHandler&quot;</span><span class="nt">&gt;</span>
<span class="w">             </span><span class="nt">&lt;bean</span>
<span class="w">                 </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.access.AccessDeniedHandlerImpl&quot;</span><span class="nt">&gt;</span>
<span class="w">                 </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;errorPage&quot;</span>
<span class="w">                     </span><span class="na">value=</span><span class="s">&quot;/WEB-INF/views/common/error/csrfTokenError.jsp&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">             </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">         </span><span class="nt">&lt;/property&gt;</span>
<span class="w">     </span><span class="nt">&lt;/bean&gt;</span>

<span class="w">     </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;sessionAuthenticationStrategy&quot;</span>
<span class="w">         </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.session.CompositeSessionAuthenticationStrategy&quot;</span><span class="nt">&gt;</span>
<span class="w">         </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">             </span><span class="nt">&lt;list&gt;</span>
<span class="w">                 </span><span class="nt">&lt;bean</span>
<span class="w">                     </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.session.SessionFixationProtectionStrategy&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">                 </span><span class="nt">&lt;bean</span>
<span class="w">                     </span><span class="na">class=</span><span class="s">&quot;org.springframework.security.web.csrf.CsrfAuthenticationStrategy&quot;</span><span class="nt">&gt;</span>
<span class="w">                     </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">index=</span><span class="s">&quot;0&quot;</span>
<span class="w">                         </span><span class="na">ref=</span><span class="s">&quot;csrfTokenRepository&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">                 </span><span class="nt">&lt;/bean&gt;</span>
<span class="w">             </span><span class="nt">&lt;/list&gt;</span>
<span class="w">         </span><span class="nt">&lt;/constructor-arg&gt;</span>
<span class="w">     </span><span class="nt">&lt;/bean&gt;</span>

<span class="w">     </span><span class="cm">&lt;!-- Put UserID into MDC --&gt;</span>
<span class="w">     </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;userIdMDCPutFilter&quot;</span>
<span class="w">         </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.security.web.logging.UserIdMDCPutFilter&quot;</span><span class="nt">&gt;</span>
<span class="w">         </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;removeValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">     </span><span class="nt">&lt;/bean&gt;</span>

<span class="w"> </span><span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;sec:form-login&gt;</span></code>タグでログインフォームに関する設定を行う。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">login-page</span></code>属性にログインフォームのURL、<code class="docutils literal notranslate"><span class="pre">authentication-failure-url</span></code>属性に認証失敗時に遷移するURL、<code class="docutils literal notranslate"><span class="pre">login-processing-url</span></code>属性に認証処理のURLを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;sec:logout&gt;</span></code>タグでログアウトに関する設定を行う。<code class="docutils literal notranslate"><span class="pre">logout-url</span></code>属性にログアウトのURL、<code class="docutils literal notranslate"><span class="pre">logout-success-url</span></code>属性にログアウト後に遷移するURLを設定する。</div>
<div class="line">また<code class="docutils literal notranslate"><span class="pre">delete-cookies</span></code>属性にログアウト時に削除するCookie名を指定できる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;sec:intercept-url&gt;</span></code>タグでURLレベルでの認可設定を行う。ログインフォームは全ユーザーのアクセスを許可する<code class="docutils literal notranslate"><span class="pre">permitAll</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">この設定より上に設定されている<code class="docutils literal notranslate"><span class="pre">/resources/**</span></code>、<code class="docutils literal notranslate"><span class="pre">/login.jsp</span></code>を除くすべてのURLに対し、認証済みユーザーのみアクセスを許可する<code class="docutils literal notranslate"><span class="pre">isAuthenticated()</span></code>を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;sec:authentication-provider&gt;</span></code>タグで認証処理を実施する<code class="docutils literal notranslate"><span class="pre">org.springframework.security.authentication.AuthenticationProvider</span></code>の設定を行う。</div>
<div class="line">デフォルトでは、<code class="docutils literal notranslate"><span class="pre">UserDetailsService</span></code>を使用して<code class="docutils literal notranslate"><span class="pre">UserDetails</span></code>を取得し、その<code class="docutils literal notranslate"><span class="pre">UserDetails</span></code>が持つハッシュ化済みパスワードと、フォームから入力されたパスワードを<code class="docutils literal notranslate"><span class="pre">org.springframework.security.crypto.password.PasswordEncoder</span></code>を使用してハッシュ化したものを比較してユーザー認証を行う<code class="docutils literal notranslate"><span class="pre">org.springframework.security.authentication.dao.DaoAuthenticationProvider</span></code>が使用される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">PasswordEncoder</span></code>の設定を行う。ここではapplicationContext.xmlに定義されている<code class="docutils literal notranslate"><span class="pre">org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</span></code>を参照する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</section>
<section id="sql">
<h4><a class="toc-backref" href="#id34" role="doc-backlink"><span class="section-number">6.2.4.2.2. </span>起動時に実行されるSQLスクリプトの設定</a><a class="headerlink" href="#sql" title="Permalink to this heading">¶</a></h4>
<ul>
<li><p>src/main/resources/META-INF/spring/first-springsecurity-env.xml</p>
<p>SQLスクリプトの設定を追加する。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="w"> </span><span class="nt">&lt;beans</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
<span class="hll"><span class="w">     </span><span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="w"> </span><span class="na">xmlns:jdbc=</span><span class="s">&quot;http://www.springframework.org/schema/jdbc&quot;</span>
</span><span class="hll"><span class="w">     </span><span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd</span>
</span><span class="s">         http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

<span class="w">     </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;dateFactory&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.common.date.DefaultDateFactory&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>

<span class="w">     </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;realDataSource&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>
<span class="w">         </span><span class="na">destroy-method=</span><span class="s">&quot;close&quot;</span><span class="nt">&gt;</span>
<span class="w">         </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;driverClassName&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${database.driverClassName}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">         </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;url&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${database.url}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">         </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;username&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${database.username}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">         </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;password&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${database.password}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">         </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;defaultAutoCommit&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;false&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">         </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;maxActive&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${cp.maxActive}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">         </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;maxIdle&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${cp.maxIdle}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">         </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;minIdle&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${cp.minIdle}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">         </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;maxWait&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${cp.maxWait}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">     </span><span class="nt">&lt;/bean&gt;</span>

<span class="w">     </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;net.sf.log4jdbc.Log4jdbcProxyDataSource&quot;</span><span class="nt">&gt;</span>
<span class="w">         </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;realDataSource&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">     </span><span class="nt">&lt;/bean&gt;</span>

<span class="w">     </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span>
<span class="w">         </span><span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span><span class="nt">&gt;</span>
<span class="w">         </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">     </span><span class="nt">&lt;/bean&gt;</span>

<span class="hll"><span class="w">     </span><span class="nt">&lt;jdbc:initialize-database</span><span class="w"> </span><span class="na">data-source=</span><span class="s">&quot;dataSource&quot;</span>
</span><span class="hll"><span class="w">         </span><span class="na">ignore-failures=</span><span class="s">&quot;ALL&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="w">         </span><span class="nt">&lt;jdbc:script</span><span class="w"> </span><span class="na">location=</span><span class="s">&quot;classpath:/database/${database}-schema.sql&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (2) --&gt;</span>
</span><span class="hll"><span class="w">         </span><span class="nt">&lt;jdbc:script</span><span class="w"> </span><span class="na">location=</span><span class="s">&quot;classpath:/database/${database}-dataload.sql&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (3) --&gt;</span>
</span><span class="hll"><span class="w">     </span><span class="nt">&lt;/jdbc:initialize-database&gt;</span>
</span><span class="w"> </span><span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;jdbc:initialize-database&gt;</span></code>タグで初期化SQLスクリプトの設定を行う。</div>
<div class="line">この設定は通常、開発中のみでしか使用しないため、xxx-env.xmlに定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">DDLを設定する。雛形の設定ではxxx-infra.propertiesに<code class="docutils literal notranslate"><span class="pre">database=H2</span></code>と定義されているため、H2-schema.sqlが実行される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">DMLを設定する。雛形の設定ではxxx-infra.propertiesに<code class="docutils literal notranslate"><span class="pre">database=H2</span></code>と定義されているため、H2-dataload.sqlが実行される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>今回はインメモリのH2データベースを利用する。DDLとDMLを以下のように用意する。</p>
<ul>
<li><p>src/main/resources/database/H2-schema.sql</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">account</span><span class="p">(</span>
<span class="w">    </span><span class="n">username</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<span class="w">    </span><span class="n">password</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<span class="w">    </span><span class="n">first_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<span class="w">    </span><span class="n">last_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<span class="w">    </span><span class="k">constraint</span><span class="w"> </span><span class="n">pk_tbl_account</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>src/main/resources/database/H2-dataload.sql</p>
<blockquote>
<div><p>username=demo、passowrd=demoでログインできるテストユーザーを追加する。</p>
</div></blockquote>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">account</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">,</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="n">last_name</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;demo&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;$2a$10$oxSJl.keBwxmsMLkcT9lPeAIxfNTPNQxpeywMrF7A3kVszwUTqfTK&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Taro&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Yamada&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">-- (1)</span>
<span class="k">COMMIT</span><span class="p">;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">雛形の設定ではapplicationContext.xmlにパスワードハッシュ化のために<code class="docutils literal notranslate"><span class="pre">org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</span></code>が設定されている。</div>
<div class="line">テストデータとして、BCryptアルゴリズムでハッシュ化された”demo”という文字列を投入する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</section>
<section id="id14">
<h4><a class="toc-backref" href="#id35" role="doc-backlink"><span class="section-number">6.2.4.2.3. </span>ログイン画面の作成</a><a class="headerlink" href="#id14" title="Permalink to this heading">¶</a></h4>
<ul>
<li><p>src/main/webapp/login.jsp</p>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Login<span class="w"> </span>Page<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span><span class="w"> </span><span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
<span class="w">    </span><span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/css/styles.css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="w">    </span><span class="nt">&lt;div</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;h3&gt;</span>Login<span class="w"> </span>with<span class="w"> </span>Username<span class="w"> </span>and<span class="w"> </span>Password<span class="nt">&lt;/h3&gt;</span>

<span class="w">        </span><span class="nt">&lt;c:if</span><span class="w"> </span><span class="na">test=</span><span class="s">&quot;${param.error}&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">            </span><span class="nt">&lt;t:messagesPanel</span><span class="w"> </span><span class="na">messagesType=</span><span class="s">&quot;error&quot;</span>
<span class="w">                </span><span class="na">messagesAttributeName=</span><span class="s">&quot;SPRING_SECURITY_LAST_EXCEPTION&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">        </span><span class="nt">&lt;/c:if&gt;</span>

<span class="w">        </span><span class="nt">&lt;form</span><span class="w"> </span><span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/authenticate&quot;</span>
<span class="w">            </span><span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">            </span><span class="nt">&lt;table&gt;</span>
<span class="w">                </span><span class="nt">&lt;tr&gt;</span>
<span class="w">                    </span><span class="nt">&lt;td&gt;&lt;label</span><span class="w"> </span><span class="na">for=</span><span class="s">&quot;j_username&quot;</span><span class="nt">&gt;</span>User:<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
<span class="w">                    </span><span class="nt">&lt;td&gt;&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;j_username&quot;</span>
<span class="w">                        </span><span class="na">name=</span><span class="s">&quot;j_username&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&#39;demo&#39;</span><span class="nt">&gt;</span>(demo)<span class="nt">&lt;/td&gt;</span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="w">                </span><span class="nt">&lt;/tr&gt;</span>
<span class="w">                </span><span class="nt">&lt;tr&gt;</span>
<span class="w">                    </span><span class="nt">&lt;td&gt;&lt;label</span><span class="w"> </span><span class="na">for=</span><span class="s">&quot;j_password&quot;</span><span class="nt">&gt;</span>Password:<span class="nt">&lt;/label&gt;&lt;/td&gt;</span>
<span class="w">                    </span><span class="nt">&lt;td&gt;&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;password&quot;</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;j_password&quot;</span>
<span class="w">                        </span><span class="na">name=</span><span class="s">&quot;j_password&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;demo&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>(demo)<span class="nt">&lt;/td&gt;</span><span class="cm">&lt;!-- (5) --&gt;</span>
<span class="w">                </span><span class="nt">&lt;/tr&gt;</span>
<span class="w">                </span><span class="nt">&lt;tr&gt;</span>
<span class="w">                    </span><span class="nt">&lt;td&gt;</span><span class="ni">&amp;nbsp;</span><span class="nt">&lt;/td&gt;</span>
<span class="w">                    </span><span class="nt">&lt;td&gt;&lt;input</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;hidden&quot;</span>
<span class="w">                        </span><span class="na">name=</span><span class="s">&quot;${f:h(_csrf.parameterName)}&quot;</span>
<span class="w">                        </span><span class="na">value=</span><span class="s">&quot;${f:h(_csrf.token)}&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="nt">&lt;input</span>
<span class="w">                        </span><span class="na">name=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;Login&quot;</span><span class="w"> </span><span class="nt">/&gt;&lt;/td&gt;</span><span class="cm">&lt;!-- (6) --&gt;</span>
<span class="w">                </span><span class="nt">&lt;/tr&gt;</span>
<span class="w">            </span><span class="nt">&lt;/table&gt;</span>
<span class="w">        </span><span class="nt">&lt;/form&gt;</span>
<span class="w">    </span><span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">認証が失敗した場合は”/login.jsp?error=true”が呼ばれるように設定した。この場合にのみエラーメッセージが表示されるように<code class="docutils literal notranslate"><span class="pre">&lt;c:if&gt;</span></code>タグを使用する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">認証が失敗した場合はセッションスコープに例外オブジェクトが属性名<code class="docutils literal notranslate"><span class="pre">&quot;SPRING_SECURITY_LAST_EXCEPTION&quot;</span></code>で格納される。</div>
<div class="line">ここでは<code class="docutils literal notranslate"><span class="pre">&lt;t:messagesPanel&gt;</span></code>タグを使用してエラーメッセージを表示する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">認証処理のURLを”/authenticate”と設定した。認証するためのこのURLでユーザー名とパスワードをPOSTする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ユーザー名のリクエストパラメータ名はデフォルトで<code class="docutils literal notranslate"><span class="pre">j_username</span></code>である。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">パスワードのリクエストパラメータ名はデフォルトで<code class="docutils literal notranslate"><span class="pre">j_password</span></code>である。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ブラウザのアドレスバーにhttp://localhost:8080/first-springsecurity/を入力し、表示しようとすると未ログイン状態のため、 <a class="reference internal" href="#tutorial-setting-spring-security"><span class="std std-ref">Spring Securityの設定</span></a> の(1)の定義によりhttp://localhost:8080/first-springsecurity/login.jspにアクセスとなり、下の画面が表示される。</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/security_tutorial_login_page.png"><img alt="../_images/security_tutorial_login_page.png" src="../_images/security_tutorial_login_page.png" style="width: 80%;" /></a>
</figure>
</section>
<section id="jsp">
<h4><a class="toc-backref" href="#id36" role="doc-backlink"><span class="section-number">6.2.4.2.4. </span>JSPからログインアカウント情報にアクセスする</a><a class="headerlink" href="#jsp" title="Permalink to this heading">¶</a></h4>
<ul>
<li><p>src/main/webapp/WEB-INF/views/welcome/home.jsp</p>
<p>以下のコードを追加する。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="w"> </span><span class="nt">&lt;html&gt;</span>
<span class="w"> </span><span class="nt">&lt;head&gt;</span>
<span class="w"> </span><span class="nt">&lt;meta</span><span class="w"> </span><span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<span class="w"> </span><span class="nt">&lt;title&gt;</span>Home<span class="nt">&lt;/title&gt;</span>
<span class="w"> </span><span class="nt">&lt;link</span><span class="w"> </span><span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
<span class="w">     </span><span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/css/styles.css&quot;</span><span class="nt">&gt;</span>
<span class="w"> </span><span class="nt">&lt;/head&gt;</span>
<span class="w"> </span><span class="nt">&lt;body&gt;</span>
<span class="w">     </span><span class="nt">&lt;div</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
<span class="hll"><span class="w">         </span><span class="nt">&lt;sec:authentication</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;principal.account&quot;</span><span class="w"> </span><span class="na">var=</span><span class="s">&quot;account&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="cm">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="w">         </span><span class="nt">&lt;h1&gt;</span>Hello<span class="w"> </span>world!<span class="nt">&lt;/h1&gt;</span>
</span><span class="hll"><span class="w">         </span><span class="nt">&lt;p&gt;</span>Welcome<span class="w"> </span>${f:h(account.firstName)}<span class="w"> </span>${f:h(account.lastName)}<span class="nt">&lt;/p&gt;</span><span class="cm">&lt;!-- (2) --&gt;</span>
</span><span class="hll">
</span><span class="hll"><span class="w">         </span><span class="nt">&lt;ul&gt;</span>
</span><span class="hll"><span class="w">             </span><span class="nt">&lt;li&gt;&lt;a</span><span class="w"> </span><span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/account&quot;</span><span class="nt">&gt;</span>view<span class="w"> </span>account<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class="hll"><span class="w">             </span><span class="nt">&lt;li&gt;&lt;a</span><span class="w"> </span><span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/logout&quot;</span><span class="nt">&gt;</span>logout<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class="hll"><span class="w">         </span><span class="nt">&lt;/ul&gt;</span>
</span><span class="w">     </span><span class="nt">&lt;/div&gt;</span>
<span class="w"> </span><span class="nt">&lt;/body&gt;</span>
<span class="w"> </span><span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;sec:authentication&gt;</span></code>タグで、ログイン中の<code class="docutils literal notranslate"><span class="pre">org.springframework.security.core.Authentication</span></code>オブジェクトにアクセスできる。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">property</span></code>属性で<code class="docutils literal notranslate"><span class="pre">.Authentication</span></code>オブジェクトの任意のプロパティにアクセスでき、<code class="docutils literal notranslate"><span class="pre">var</span></code>属性で任意のスコープに設定できる。デフォルトではpageスコープの設定され、このJSP内のみで参照可能である。</div>
<div class="line">ここではログイン中の<code class="docutils literal notranslate"><span class="pre">Account</span></code>オブジェクトを変数名<code class="docutils literal notranslate"><span class="pre">account</span></code>に格納する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ログイン中の<code class="docutils literal notranslate"><span class="pre">Account</span></code>オブジェクトにアクセスして<code class="docutils literal notranslate"><span class="pre">firstName</span></code>と<code class="docutils literal notranslate"><span class="pre">lastName</span></code>を表示する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>LoginページのLoginボタンを押下することにより、Webcomeページが表示される。</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/security_tutorial_welcome_page.png"><img alt="../_images/security_tutorial_welcome_page.png" src="../_images/security_tutorial_welcome_page.png" style="width: 80%;" /></a>
</figure>
</section>
<section id="id15">
<h4><a class="toc-backref" href="#id37" role="doc-backlink"><span class="section-number">6.2.4.2.5. </span>ログインアカウント情報表示ページの作成</a><a class="headerlink" href="#id15" title="Permalink to this heading">¶</a></h4>
<ul>
<li><p>src/main/java/com/example/security/app/account/AccountController.java</p>
<p>ログイン済みの<code class="docutils literal notranslate"><span class="pre">UserDetails</span></code>オブジェクトは<code class="docutils literal notranslate"><span class="pre">java.security.Principal</span></code>オブジェクト内に格納されている。Controllerの処理メソッドの引数で<code class="docutils literal notranslate"><span class="pre">Principal</span></code>オブジェクトを受け取ることにより、Controller内でログイン済みの<code class="docutils literal notranslate"><span class="pre">UserDetails</span></code>オブジェクトにアクセスすることができる。</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.security.app.account</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.security.Principal</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.Authentication</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Controller</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.ui.Model</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.security.domain.model.Account</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.security.domain.service.userdetails.SampleUserDetails</span><span class="p">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;account&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AccountController</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">view</span><span class="p">(</span><span class="cm">/* (1) */</span><span class="w"> </span><span class="n">Principal</span><span class="w"> </span><span class="n">principal</span><span class="p">,</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="n">model</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// get login user information</span>
<span class="w">        </span><span class="n">Authentication</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Authentication</span><span class="p">)</span><span class="w"> </span><span class="n">principal</span><span class="p">;</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="c1">// get UserDetails</span>
<span class="w">        </span><span class="n">SampleUserDetails</span><span class="w"> </span><span class="n">userDetails</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SampleUserDetails</span><span class="p">)</span><span class="w"> </span><span class="n">authentication</span>
<span class="w">                </span><span class="p">.</span><span class="na">getPrincipal</span><span class="p">();</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">        </span><span class="c1">// get account object</span>
<span class="w">        </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getAccount</span><span class="p">();</span><span class="w"> </span><span class="c1">// (4)</span>
<span class="w">        </span><span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;account/view&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ログイン中の<code class="docutils literal notranslate"><span class="pre">UserDetails</span></code>オブジェクトを格納した<code class="docutils literal notranslate"><span class="pre">Principal</span></code>オブジェクトを受け取る。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">org.springframework.security.core.Authentication</span></code>は<code class="docutils literal notranslate"><span class="pre">Principal</span></code>インタフェースでもあり、コントローラに渡る<code class="docutils literal notranslate"><span class="pre">Principal</span></code>オブジェクトは実際は<code class="docutils literal notranslate"><span class="pre">Authentication</span></code>オブジェクトである。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">UserDetails</span></code>オブジェクトにアクセスするために、<code class="docutils literal notranslate"><span class="pre">Authentication</span></code>クラスにキャストする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Authentication.getPrincipal()</span></code>メソッドにより、ログイン中の<code class="docutils literal notranslate"><span class="pre">UserDetails</span></code>オブジェクトを取得できる。ここでは、本プロジェクト用の<code class="docutils literal notranslate"><span class="pre">SampleUserDetails</span></code>クラスにキャストする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">SampleUserDetails</span></code>オブジェクトからログイン中の<code class="docutils literal notranslate"><span class="pre">Account</span></code>オブジェクトを取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p>src/main/webapp/WEB-INF/views/account/view.jsp</p>
<p>Modelに設定された<code class="docutils literal notranslate"><span class="pre">Account</span></code>オブジェクトの各プロパティを出力するだけであるので説明は省略する。</p>
<div class="highlight-jsp notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span><span class="w"> </span><span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;title&gt;</span>Home<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;link</span><span class="w"> </span><span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
<span class="w">    </span><span class="na">href=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/app/css/styles.css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="w">    </span><span class="nt">&lt;div</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;h1&gt;</span>Account<span class="w"> </span>Information<span class="nt">&lt;/h1&gt;</span>
<span class="w">        </span><span class="nt">&lt;table&gt;</span>
<span class="w">            </span><span class="nt">&lt;tr&gt;</span>
<span class="w">                </span><span class="nt">&lt;th&gt;</span>Username<span class="nt">&lt;/th&gt;</span>
<span class="w">                </span><span class="nt">&lt;td&gt;</span>${f:h(account.username)}<span class="nt">&lt;/td&gt;</span>
<span class="w">            </span><span class="nt">&lt;/tr&gt;</span>
<span class="w">            </span><span class="nt">&lt;tr&gt;</span>
<span class="w">                </span><span class="nt">&lt;th&gt;</span>First<span class="w"> </span>name<span class="nt">&lt;/th&gt;</span>
<span class="w">                </span><span class="nt">&lt;td&gt;</span>${f:h(account.firstName)}<span class="nt">&lt;/td&gt;</span>
<span class="w">            </span><span class="nt">&lt;/tr&gt;</span>
<span class="w">            </span><span class="nt">&lt;tr&gt;</span>
<span class="w">                </span><span class="nt">&lt;th&gt;</span>Last<span class="w"> </span>name<span class="nt">&lt;/th&gt;</span>
<span class="w">                </span><span class="nt">&lt;td&gt;</span>${f:h(account.lastName)}<span class="nt">&lt;/td&gt;</span>
<span class="w">            </span><span class="nt">&lt;/tr&gt;</span>
<span class="w">        </span><span class="nt">&lt;/table&gt;</span>
<span class="w">    </span><span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Welcomeページのview accountリンクを押下することにより、Account Informationページが表示される。</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/security_tutorial_account_information_page.png"><img alt="../_images/security_tutorial_account_information_page.png" src="../_images/security_tutorial_account_information_page.png" style="width: 80%;" /></a>
</figure>
</section>
<section id="id16">
<h4><a class="toc-backref" href="#id38" role="doc-backlink"><span class="section-number">6.2.4.2.6. </span>アプリケーション層の作成後のパッケージエクスプローラー</a><a class="headerlink" href="#id16" title="Permalink to this heading">¶</a></h4>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/security_tutorial-application-layer-package-explorer.png"><img alt="security tutorial application layer package explorer" src="../_images/security_tutorial-application-layer-package-explorer.png" style="width: 40%;" /></a>
</figure>
</section>
</section>
</section>
<section id="id17">
<h2><a class="toc-backref" href="#id39" role="doc-backlink"><span class="section-number">6.2.5. </span>おわりに</a><a class="headerlink" href="#id17" title="Permalink to this heading">¶</a></h2>
<p>本チュートリアルでは以下の内容を学習した。</p>
<ul class="simple">
<li><p>Spring Securityによる基本的な認証・認可</p></li>
<li><p>認証ユーザーオブジェクトのカスタマイズ方法</p></li>
<li><p>RepositoryおよびServiceクラスを用いた認証処理の設定</p></li>
<li><p>JSPでログイン済みアカウント情報にアクセスする方法</p></li>
<li><p>Controllerでログイン済みアカウント情報にアクセスする方法</p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="Authentication.html" title="6.3. 認証"
             >next</a> |</li>
        <li class="right" >
          <a href="SpringSecurity.html" title="6.1. Spring Security概要"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.0.publicreview documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">6. </span>TERASOLUNA Global Frameworkによるセキュリティ対策</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">6.2. </span>Spring Securtityチュートリアル</a></li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 5.3.0.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>5.7. 例外ハンドリング &#8212; TERASOLUNA Global Framework Development Guideline 1.0.3.RELEASE documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/solar.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5.8. セッション管理" href="SessionManagement.html" />
    <link rel="prev" title="5.6. ロギング" href="Logging.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="SessionManagement.html" title="5.8. セッション管理"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Logging.html" title="5.6. ロギング"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.3.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">5. </span>TERASOLUNA Global Frameworkの機能詳細</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">5.7. </span>例外ハンドリング</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">5.7. 例外ハンドリング</a><ul>
<li><a class="reference internal" href="#overview">5.7.1. Overview</a><ul>
<li><a class="reference internal" href="#exception-handling-class-label">5.7.1.1. 例外の分類</a></li>
<li><a class="reference internal" href="#exception-handling-method-label">5.7.1.2. 例外のハンドリング方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#detail">5.7.2. Detail</a><ul>
<li><a class="reference internal" href="#exception-handling-exception-type-label">5.7.2.1. 例外の種類</a><ul>
<li><a class="reference internal" href="#exception-handling-exception-type-businessexception-label">5.7.2.1.1. ビジネス例外</a></li>
<li><a class="reference internal" href="#exception-handling-exception-type-libraryexception-label">5.7.2.1.2. 正常稼働時に発生するライブラリ例外</a></li>
<li><a class="reference internal" href="#exception-handling-exception-type-systemexception-label">5.7.2.1.3. システム例外</a></li>
<li><a class="reference internal" href="#exception-handling-exception-type-unexpectedexception-label">5.7.2.1.4. 予期しないシステム例外</a></li>
<li><a class="reference internal" href="#exception-handling-exception-type-error-label">5.7.2.1.5. 致命的なエラー</a></li>
<li><a class="reference internal" href="#exception-handling-exception-type-request-label">5.7.2.1.6. リクエスト不正時に発生するフレームワーク例外</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exception-handling-pattern-label">5.7.2.2. 例外ハンドリングのパターン</a><ul>
<li><a class="reference internal" href="#exception-handling-class-from-middle-label">5.7.2.2.1. ユースケースの一部やり直し(途中からのやり直し)を促す場合</a></li>
<li><a class="reference internal" href="#exception-handling-class-from-first-label">5.7.2.2.2. ユースケースのやり直し(先頭からのやり直し)を促す場合</a></li>
<li><a class="reference internal" href="#exception-handling-class-systemerror-label">5.7.2.2.3. システム、またはアプリケーションが、正常な状態でない事を通知する場合</a></li>
<li><a class="reference internal" href="#exception-handling-class-requesterror-label">5.7.2.2.4. リクエスト内容が、不正であることを通知する場合</a></li>
<li><a class="reference internal" href="#exception-handling-class-fatalerror-label">5.7.2.2.5. 致命的なエラーが発生したことを検知する場合</a></li>
<li><a class="reference internal" href="#jsp">5.7.2.2.6. プレゼンテーション層(JSPなど)で、例外が発生したことを通知する場合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exception-handling-basic-flow-label">5.7.2.3. 例外ハンドリングの基本フロー</a><ul>
<li><a class="reference internal" href="#controller">5.7.2.3.1. リクエスト単位でControllerクラスがハンドリングする場合の基本フロー</a></li>
<li><a class="reference internal" href="#exception-handling-basic-flow-annotation-label">5.7.2.3.2. ユースケース単位でControllerクラスがハンドリングする場合の基本フロー</a></li>
<li><a class="reference internal" href="#exception-handling-basic-flow-resolver-label">5.7.2.3.3. サーブレット単位でフレームワークがハンドリングする場合の基本フロー</a></li>
<li><a class="reference internal" href="#web">5.7.2.3.4. Webアプリケーション単位でサーブレットコンテナがハンドリングする場合の基本フロー</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">5.7.3. How to use</a><ul>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-label">5.7.3.1. アプリケーションの設定</a><ul>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-common-label">5.7.3.1.1. 共通設定</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-domain-label">5.7.3.1.2. ドメイン層の設定</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-app-label">5.7.3.1.3. アプリケーション層の設定</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-container-label">5.7.3.1.4. サーブレットコンテナの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#service">5.7.3.2. コーディングポイント（Service編）</a><ul>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-business-label">5.7.3.2.1. ビジネス例外を発生させる</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-system-label">5.7.3.2.2. システム例外を発生させる</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-continue-label">5.7.3.2.3. 例外をキャッチして、処理を継続させる</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-contoller-label">5.7.3.3. コーディングポイント（Controller編）</a><ul>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-contoller-request-label">5.7.3.3.1. リクエスト単位で例外をハンドリングする方法</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-contoller-usecase-label">5.7.3.3.2. ユースケース単位で例外をハンドリングする方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-jsp-label">5.7.3.4. コーディングポイント（JSP編）</a><ul>
<li><a class="reference internal" href="#messagespaneltag">5.7.3.4.1. MessagesPanelTagを使用して、メッセージを画面表示する方法</a></li>
<li><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-jsp-exceptioncode-label">5.7.3.4.2. システム例外の例外コードを、画面表示する方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use-ajax">5.7.4. How to use (Ajax)</a></li>
<li><a class="reference internal" href="#appendix">5.7.5. Appendix</a><ul>
<li><a class="reference internal" href="#exception-handling-about-classes-of-library-label">5.7.5.1. 共通ライブラリから提供している例外ハンドリング用のクラスについて</a></li>
<li><a class="reference internal" href="#systemexceptionresolver">5.7.5.2. SystemExceptionResolverの設定項目について</a><ul>
<li><a class="reference internal" href="#id36">5.7.5.2.1. 結果メッセージの属性名</a></li>
<li><a class="reference internal" href="#id">5.7.5.2.2. 例外コード(メッセージID)の属性名</a></li>
<li><a class="reference internal" href="#id37">5.7.5.2.3. 例外コード(メッセージID)のヘッダー名</a></li>
<li><a class="reference internal" href="#id38">5.7.5.2.4. 例外オブジェクトの属性名</a></li>
<li><a class="reference internal" href="#http">5.7.5.2.5. HTTPレスポンスのキャッシュ制御有無</a></li>
</ul>
</li>
<li><a class="reference internal" href="#handlerexceptionresolverlogginginterceptor">5.7.5.3. HandlerExceptionResolverLoggingInterceptorの設定項目について</a><ul>
<li><a class="reference internal" href="#id39">5.7.5.3.1. ログ出力対象から除外する例外クラスの一覧</a></li>
</ul>
</li>
<li><a class="reference internal" href="#defaulthandlerexceptionresolverhttp">5.7.5.4. DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="Logging.html"
                          title="previous chapter"><span class="section-number">5.6. </span>ロギング</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="SessionManagement.html"
                          title="next chapter"><span class="section-number">5.8. </span>セッション管理</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/ArchitectureInDetail/ExceptionHandling.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="id1">
<h1><span class="section-number">5.7. </span>例外ハンドリング<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="id2">
<p class="topic-title">目次</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id60">Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#exception-handling-class-label" id="id61">例外の分類</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-method-label" id="id62">例外のハンドリング方法</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#detail" id="id63">Detail</a></p>
<ul>
<li><p><a class="reference internal" href="#exception-handling-exception-type-label" id="id64">例外の種類</a></p>
<ul>
<li><p><a class="reference internal" href="#exception-handling-exception-type-businessexception-label" id="id65">ビジネス例外</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-exception-type-libraryexception-label" id="id66">正常稼働時に発生するライブラリ例外</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-exception-type-systemexception-label" id="id67">システム例外</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-exception-type-unexpectedexception-label" id="id68">予期しないシステム例外</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-exception-type-error-label" id="id69">致命的なエラー</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-exception-type-request-label" id="id70">リクエスト不正時に発生するフレームワーク例外</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#exception-handling-pattern-label" id="id71">例外ハンドリングのパターン</a></p>
<ul>
<li><p><a class="reference internal" href="#exception-handling-class-from-middle-label" id="id72">ユースケースの一部やり直し(途中からのやり直し)を促す場合</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-class-from-first-label" id="id73">ユースケースのやり直し(先頭からのやり直し)を促す場合</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-class-systemerror-label" id="id74">システム、またはアプリケーションが、正常な状態でない事を通知する場合</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-class-requesterror-label" id="id75">リクエスト内容が、不正であることを通知する場合</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-class-fatalerror-label" id="id76">致命的なエラーが発生したことを検知する場合</a></p></li>
<li><p><a class="reference internal" href="#jsp" id="id77">プレゼンテーション層(JSPなど)で、例外が発生したことを通知する場合</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#exception-handling-basic-flow-label" id="id78">例外ハンドリングの基本フロー</a></p>
<ul>
<li><p><a class="reference internal" href="#controller" id="id79">リクエスト単位でControllerクラスがハンドリングする場合の基本フロー</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-basic-flow-annotation-label" id="id80">ユースケース単位でControllerクラスがハンドリングする場合の基本フロー</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-basic-flow-resolver-label" id="id81">サーブレット単位でフレームワークがハンドリングする場合の基本フロー</a></p></li>
<li><p><a class="reference internal" href="#web" id="id82">Webアプリケーション単位でサーブレットコンテナがハンドリングする場合の基本フロー</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-use" id="id83">How to use</a></p>
<ul>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-label" id="id84">アプリケーションの設定</a></p>
<ul>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-common-label" id="id85">共通設定</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-domain-label" id="id86">ドメイン層の設定</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-app-label" id="id87">アプリケーション層の設定</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-container-label" id="id88">サーブレットコンテナの設定</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#service" id="id89">コーディングポイント（Service編）</a></p>
<ul>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-business-label" id="id90">ビジネス例外を発生させる</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-system-label" id="id91">システム例外を発生させる</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-continue-label" id="id92">例外をキャッチして、処理を継続させる</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-contoller-label" id="id93">コーディングポイント（Controller編）</a></p>
<ul>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-contoller-request-label" id="id94">リクエスト単位で例外をハンドリングする方法</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-contoller-usecase-label" id="id95">ユースケース単位で例外をハンドリングする方法</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-jsp-label" id="id96">コーディングポイント（JSP編）</a></p>
<ul>
<li><p><a class="reference internal" href="#messagespaneltag" id="id97">MessagesPanelTagを使用して、メッセージを画面表示する方法</a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-jsp-exceptioncode-label" id="id98">システム例外の例外コードを、画面表示する方法</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-use-ajax" id="id99">How to use (Ajax)</a></p></li>
<li><p><a class="reference internal" href="#appendix" id="id100">Appendix</a></p>
<ul>
<li><p><a class="reference internal" href="#exception-handling-about-classes-of-library-label" id="id101">共通ライブラリから提供している例外ハンドリング用のクラスについて</a></p></li>
<li><p><a class="reference internal" href="#systemexceptionresolver" id="id102">SystemExceptionResolverの設定項目について</a></p>
<ul>
<li><p><a class="reference internal" href="#id36" id="id103">結果メッセージの属性名</a></p></li>
<li><p><a class="reference internal" href="#id" id="id104">例外コード(メッセージID)の属性名</a></p></li>
<li><p><a class="reference internal" href="#id37" id="id105">例外コード(メッセージID)のヘッダー名</a></p></li>
<li><p><a class="reference internal" href="#id38" id="id106">例外オブジェクトの属性名</a></p></li>
<li><p><a class="reference internal" href="#http" id="id107">HTTPレスポンスのキャッシュ制御有無</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#handlerexceptionresolverlogginginterceptor" id="id108">HandlerExceptionResolverLoggingInterceptorの設定項目について</a></p>
<ul>
<li><p><a class="reference internal" href="#id39" id="id109">ログ出力対象から除外する例外クラスの一覧</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#defaulthandlerexceptionresolverhttp" id="id110">DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</a></p></li>
</ul>
</li>
</ul>
</nav>
<p>本ガイドラインで作成する、Webアプリケーションの例外ハンドリング指針について説明する。</p>
<section id="overview">
<h2><a class="toc-backref" href="#id60" role="doc-backlink"><span class="section-number">5.7.1. </span>Overview</a><a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h2>
<p>本節では、Spring MVC配下の処理で発生する例外のハンドリングについて説明する。説明対象は、以下の通りである。</p>
<figure class="align-center" id="id40">
<a class="reference internal image-reference" href="../_images/exception-handling-description-target.png"><img alt="description target" src="../_images/exception-handling-description-target.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>図-説明対象</strong></span><a class="headerlink" href="#id40" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#exception-handling-class-label"><span class="std std-ref">例外の分類</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-method-label"><span class="std std-ref">例外のハンドリング方法</span></a></p></li>
</ol>
<section id="exception-handling-class-label">
<span id="id3"></span><h3><a class="toc-backref" href="#id61" role="doc-backlink"><span class="section-number">5.7.1.1. </span>例外の分類</a><a class="headerlink" href="#exception-handling-class-label" title="Permalink to this heading">¶</a></h3>
<p>アプリケーション実行時に発生する例外は、以下3つに分類される。</p>
<table class="docutils align-default" id="id41">
<caption><span class="caption-text"><strong>表-アプリケーション実行時に発生する例外の分類</strong></span><a class="headerlink" href="#id41" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 30%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>分類</p></th>
<th class="head"><p>説明</p></th>
<th class="head"><p><a class="reference internal" href="#exception-handling-exception-type-label"><span class="std std-ref">例外の種類</span></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">オペレータの再操作(入力値の変更など)によって、発生原因が解消できる例外</div>
</div>
</td>
<td><div class="line-block">
<div class="line">オペレータの再操作によって、発生原因が解消できる例外は、アプリケーションコードで例外をハンドリングし、例外処理を行う。</div>
</div>
</td>
<td><div class="line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-businessexception-label"><span class="std std-ref">ビジネス例外</span></a></div>
<div class="line">2. <a class="reference internal" href="#exception-handling-exception-type-libraryexception-label"><span class="std std-ref">正常稼働時に発生するライブラリ例外</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">オペレータの再操作によって、発生原因が解消できない例外</div>
</div>
</td>
<td><div class="line-block">
<div class="line">オペレータの再操作によって、発生原因が解消できない例外は、フレームワークで例外をハンドリングし、例外処理を行う。</div>
</div>
</td>
<td><div class="line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-systemexception-label"><span class="std std-ref">システム例外</span></a></div>
<div class="line">2. <a class="reference internal" href="#exception-handling-exception-type-unexpectedexception-label"><span class="std std-ref">予期しないシステム例外</span></a></div>
<div class="line">3. <a class="reference internal" href="#exception-handling-exception-type-error-label"><span class="std std-ref">致命的なエラー</span></a></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">クライアントからの不正リクエストにより発生する例外</div>
</div>
</td>
<td><div class="line-block">
<div class="line">クライアントからの不正リクエストにより発生する例外は、フレームワークで例外をハンドリングし、例外処理を行う。</div>
</div>
</td>
<td><div class="line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-request-label"><span class="std std-ref">リクエスト不正時に発生するフレームワーク例外</span></a></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>誰が、例外を意識する必要があるのか？</strong></p>
<ul class="simple">
<li><p>(1)はアプリケーション開発者が意識する例外となる。</p></li>
<li><p>(2)と(3)はアプリケーションアーキテクトが意識する例外となる。</p></li>
</ul>
</div>
</section>
<section id="exception-handling-method-label">
<span id="id4"></span><h3><a class="toc-backref" href="#id62" role="doc-backlink"><span class="section-number">5.7.1.2. </span>例外のハンドリング方法</a><a class="headerlink" href="#exception-handling-method-label" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">アプリケーション実行時に発生する例外は、以下4つの方法でハンドリングを行う。</div>
<div class="line">ハンドリング方法毎のハンドリングフローの詳細は、<a class="reference internal" href="#exception-handling-basic-flow-label"><span class="std std-ref">例外ハンドリングの基本フロー</span></a>を参照されたい。</div>
</div>
<table class="docutils align-default" id="id42">
<caption><span class="caption-text"><strong>表-例外のハンドリング方法</strong></span><a class="headerlink" href="#id42" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 10%" />
<col style="width: 30%" />
<col style="width: 35%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>ハンドリング方法</p></th>
<th class="head"><p>説明</p></th>
<th class="head"><p><a class="reference internal" href="#exception-handling-pattern-label"><span class="std std-ref">例外ハンドリングのパターン</span></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">アプリケーションコードにて、<code class="docutils literal notranslate"><span class="pre">try-catch</span></code>を使い、例外ハンドリングを行う。</div>
</div>
</td>
<td><div class="line-block">
<div class="line">リクエスト(Controllerのメソッド)単位に、例外をハンドリングする場合に使用する。</div>
<div class="line">詳細は、<a class="reference internal" href="#exception-handling-basic-flow-catch-label"><span class="std std-ref">リクエスト単位でControllerクラスがハンドリングする場合の基本フロー</span></a>を参照されたい。</div>
</div>
</td>
<td><div class="line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-class-from-middle-label"><span class="std std-ref">ユースケースの一部やり直し(途中からのやり直し)を促す場合</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションを使い、アプリケーションコードで例外ハンドリングを行う。</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ユースケース(Controller)単位に、例外をハンドリングする場合に使用する。</div>
<div class="line">詳細は、<a class="reference internal" href="#exception-handling-basic-flow-annotation-label"><span class="std std-ref">ユースケース単位でControllerクラスがハンドリングする場合の基本フロー</span></a>を参照されたい。</div>
</div>
</td>
<td><div class="line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-class-from-first-label"><span class="std std-ref">ユースケースのやり直し(先頭からのやり直し)を促す場合</span></a></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">フレームワークから提供されているHanlderExceptionResolverの仕組みを使い、例外ハンドリングを行う。</div>
</div>
</td>
<td><div class="line-block">
<div class="line">サーブレット単位に、例外をハンドリングする場合に使用する。</div>
<div class="line">HanlderExceptionResolverは、<code class="docutils literal notranslate"><span class="pre">&lt;mvc:annotation-driven&gt;</span></code>を指定した際に、自動的に、<a class="reference internal" href="#exceptionhandling-annotation-driven"><span class="std std-ref">登録されるクラス</span></a>と、共通ライブラリから提供している<code class="docutils literal notranslate"><span class="pre">SystemExceptionResolver</span></code>を使用する。</div>
<div class="line">詳細は、<a class="reference internal" href="#exception-handling-basic-flow-resolver-label"><span class="std std-ref">サーブレット単位でフレームワークがハンドリングする場合の基本フロー</span></a>を参照されたい。</div>
</div>
</td>
<td><div class="line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-class-systemerror-label"><span class="std std-ref">システム、またはアプリケーションが、正常な状態でない事を通知する場合</span></a></div>
<div class="line"><br /></div>
<div class="line">2. <a class="reference internal" href="#exception-handling-class-requesterror-label"><span class="std std-ref">リクエスト内容が、不正であることを通知する場合</span></a></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">サーブレットコンテナのerror-page機能を使い、例外ハンドリングを行う。</div>
</div>
</td>
<td><div class="line-block">
<div class="line">致命的なエラー、Spring MVC管理外で発生する例外をハンドリングする場合に使用する。</div>
<div class="line">詳細は、<a class="reference internal" href="#exception-handling-basic-flow-container-label"><span class="std std-ref">Webアプリケーション単位でサーブレットコンテナがハンドリングする場合の基本フロー</span></a>を参照されたい。</div>
</div>
</td>
<td><div class="line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-class-fatalerror-label"><span class="std std-ref">致命的なエラーが発生したことを検知する場合</span></a></div>
<div class="line"><br /></div>
<div class="line">2. <a class="reference internal" href="#exception-handling-class-viewerror-label"><span class="std std-ref">プレゼンテーション層(JSPなど)で、例外が発生したことを通知する場合</span></a></div>
</div>
</td>
</tr>
</tbody>
</table>
<figure class="align-center" id="id43">
<a class="reference internal image-reference" href="../_images/exception-handling-method.png"><img alt="handling method" src="../_images/exception-handling-method.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>図-例外のハンドリング方法</strong></span><a class="headerlink" href="#id43" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>誰が例外ハンドリングを行うのか？</strong></p>
<ul class="simple">
<li><p>(1)と(2)はアプリケーション開発者が設計・実装する。</p></li>
<li><p>(3)と(4)はアプリケーションアーキテクトが設計・設定する。</p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>自動的に登録されるHanlderExceptionResolverについて</strong></p>
<p>&lt;mvc:annotation-driven&gt; を指定した際に、自動的に登録されるHanlderExceptionResolverの役割は、以下の通りである。</p>
<p>優先順は、以下の並び順の通りとなる。</p>
<blockquote id="exceptionhandling-annotation-driven">
<div><table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 32%" />
<col style="width: 58%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>クラス(優先順位)</p></th>
<th class="head"><p>役割</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ExceptionHandlerExceptionResolver</div>
<div class="line">(order=0)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションが付与されているControllerクラスのメソッドを呼び出し、例外ハンドリングを行うためのクラス。</div>
<div class="line">No.2のハンドリング方法を実現するために必要なクラス。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ResponseStatusExceptionResolver</div>
<div class="line">(order=1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">クラスアノテーションとして、<code class="docutils literal notranslate"><span class="pre">&#64;ResponseStatus</span></code>が付与されている例外をハンドリングするためのクラス。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">&#64;ResponseStatus</span></code>に指定されている値で、<code class="docutils literal notranslate"><span class="pre">HttpServletResponse#sendError(int</span> <span class="pre">sc,</span> <span class="pre">String</span> <span class="pre">msg)</span></code>が呼び出される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">DefaultHandlerExceptionResolver</div>
<div class="line">(order=2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Spring MVC内で発生するフレームワーク例外を、ハンドリングするためのクラス。</div>
<div class="line">フレームワーク例外に対応するHTTPレスポンスコードの値で、<code class="docutils literal notranslate"><span class="pre">HttpServletResponse#sendError(int</span> <span class="pre">sc)</span></code>が呼び出される。</div>
<div class="line">設定されるHTTPレスポンスコードの詳細は、<a class="reference internal" href="#exception-handling-appendix-defaulthandlerexceptionresolver-label"><span class="std std-ref">DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</span></a>を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>共通ライブラリから提供している SystemExceptionResolver の役割は？</strong></p>
<p>&lt;mvc:annotation-driven&gt; を指定した際に、自動的に登録されるHanlderExceptionResolverによって、
ハンドリングされない例外をハンドリングするためのクラスである。
そのため優先順は、DefaultHandlerExceptionResolverの後になるように設定する。</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Spring Framework 3.2 より追加された&#64;ControllerAdviceアノテーションについて</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">&#64;ControllerAdvice</span></code>の登場により、サーブレット単位で、<code class="docutils literal notranslate"><span class="pre">&#64;ExceptionHandler</span></code>を使った例外ハンドリングを行えるようになった。
<code class="docutils literal notranslate"><span class="pre">&#64;ControllerAdvice</span></code>アノテーションが付与されたクラスで、<code class="docutils literal notranslate"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションを付与したメソッドを定義すると、サーブレット内のすべてのControllerに適用される。
以前のバージョンで同じことを実現する場合、<code class="docutils literal notranslate"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションが付与されたメソッドを、Controllerのベースクラスのメソッドとして定義し、
各Controllerでベースクラスを継承する必要があった。</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>&#64;ControllerAdviceアノテーションの使いどころ</strong></p>
<ol class="arabic simple">
<li><p>サーブレット単位で行う例外ハンドリングに対して、View名と、HTTPレスポンスコードの解決以外の処理が必要な場合。
（View名とHTTPレスポンスコードの解決のみでよい場合は、<code class="docutils literal notranslate"><span class="pre">SystemExceptionResolver</span></code>で対応できる ）</p></li>
<li><p>サーブレット単位で行う例外ハンドリングに対して、エラー応答用のレスポンスデータをJSPなどのテンプレートエンジンを使わずに、
エラー用のモデル（JavaBeans）を、JSONやXML形式にシリアライズして生成したい場合
（AJAXや、REST用のControllerを作成する際の、エラーハンドリングとして使用する）。</p></li>
</ol>
</div>
</section>
</section>
<section id="detail">
<h2><a class="toc-backref" href="#id63" role="doc-backlink"><span class="section-number">5.7.2. </span>Detail</a><a class="headerlink" href="#detail" title="Permalink to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#exception-handling-exception-type-label"><span class="std std-ref">例外の種類</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-pattern-label"><span class="std std-ref">例外ハンドリングのパターン</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-basic-flow-label"><span class="std std-ref">例外ハンドリングの基本フロー</span></a></p></li>
</ol>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="exception-handling-exception-type-label">
<span id="id5"></span><h3><a class="toc-backref" href="#id64" role="doc-backlink"><span class="section-number">5.7.2.1. </span>例外の種類</a><a class="headerlink" href="#exception-handling-exception-type-label" title="Permalink to this heading">¶</a></h3>
<p>アプリケーション実行時に発生する例外は、以下6種類に分類される。</p>
<table class="docutils align-default" id="id44">
<caption><span class="caption-text"><strong>表-例外の種類</strong></span><a class="headerlink" href="#id44" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 17%" />
<col style="width: 33%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>例外の種類</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference internal" href="#exception-handling-exception-type-businessexception-label"><span class="std std-ref">ビジネス例外</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">ビジネスルールの違反を検知したことを通知する例外</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference internal" href="#exception-handling-exception-type-libraryexception-label"><span class="std std-ref">正常稼働時に発生するライブラリ例外</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">フレームワーク、およびライブラリ内で発生する例外のうち、システムが、正常稼働している時に発生する可能性のある例外</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference internal" href="#exception-handling-exception-type-systemexception-label"><span class="std std-ref">システム例外</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">システムが、正常稼働している時に、発生してはいけない状態を検知したことを通知する例外</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference internal" href="#exception-handling-exception-type-unexpectedexception-label"><span class="std std-ref">予期しないシステム例外</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">システムが、正常稼働している時には発生しない非検査例外</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference internal" href="#exception-handling-exception-type-error-label"><span class="std std-ref">致命的なエラー</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">システム(アプリケーション)全体に影響を及ぼす、致命的な問題が発生していることを通知するエラー</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference internal" href="#exception-handling-exception-type-request-label"><span class="std std-ref">リクエスト不正時に発生するフレームワーク例外</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">フレームワークが、リクエスト内容の不正を検知したことを通知する例外</div>
</div>
</td>
</tr>
</tbody>
</table>
<section id="exception-handling-exception-type-businessexception-label">
<span id="id6"></span><h4><a class="toc-backref" href="#id65" role="doc-backlink"><span class="section-number">5.7.2.1.1. </span>ビジネス例外</a><a class="headerlink" href="#exception-handling-exception-type-businessexception-label" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line"><strong>ビジネスルールの違反を検知したことを通知する例外</strong> 。</div>
<div class="line">本例外は、ドメイン層のロジック内で発生させる。</div>
<div class="line">アプリケーションとして想定される状態なので、システム運用者による対処は、不要である。</div>
</div>
<ul class="simple">
<li><p>旅行を予約する際に予約日が期限を過ぎている場合</p></li>
<li><p>商品を注文する際に在庫切れの場合</p></li>
<li><p>etc …</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>該当する例外クラス</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.common.exception.BusinessException</span></code> (共通ライブラリから提供しているクラス)。</p></li>
<li><p>細かくハンドリングする必要がある場合は、BusinessExceptionを継承した例外クラスを作成すること。</p></li>
<li><p>共通ライブラリで用意しているビジネス例外クラスで、要件を満たせない場合は、プロジェクト毎にビジネス例外クラスを作成すること。</p></li>
</ul>
</div>
</section>
<section id="exception-handling-exception-type-libraryexception-label">
<span id="id7"></span><h4><a class="toc-backref" href="#id66" role="doc-backlink"><span class="section-number">5.7.2.1.2. </span>正常稼働時に発生するライブラリ例外</a><a class="headerlink" href="#exception-handling-exception-type-libraryexception-label" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">フレームワーク、およびライブラリ内で発生する例外のうち、 <strong>システムが、正常稼働している時に発生する可能性のある例外。</strong></div>
<div class="line">フレームワーク、およびライブラリ内で発生する例外とは、Spring Frameworkや、その他のライブラリ内で発生する例外クラスを対象とする。</div>
<div class="line">アプリケーションとして想定される状態なので、システム運用者による対処は、不要である。</div>
</div>
<ul class="simple">
<li><p>複数のオペレータによって、同じデータを同時に更新しようとした場合に、発生する楽観排他例外や、悲観排他例外。</p></li>
<li><p>複数のオペレータによって、同じデータを同時に登録しようとした場合に、発生する一意制約違反例外。</p></li>
<li><p>etc …</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>該当する例外クラスの例</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.dao.OptimisticLockingFailureException</span></code> (楽観排他でエラーが発生した場合に発生する例外)。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.dao.PessimisticLockingFailureException</span></code> (悲観排他でエラーが発生した場合に発生する例外)。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.dao.DuplicateKeyException</span></code> (一意制約違反となった場合に発生する例外)。</p></li>
<li><p>etc …</p></li>
</ul>
</div>
<div class="admonition-todo admonition" id="id8">
<p class="admonition-title">Todo</p>
<p><strong>JPA(Hibernate)を使用すると、現状意図しないエラーとなることが発覚している。</strong></p>
<ul class="simple">
<li><p>一意制約違反が発生した場合、<code class="docutils literal notranslate"><span class="pre">DuplicateKeyException</span></code>ではなく、<code class="docutils literal notranslate"><span class="pre">org.springframework.dao.DataIntegrityViolationException</span></code>が発生する。</p></li>
<li><p>悲観ロックに失敗した場合、<code class="docutils literal notranslate"><span class="pre">PessimisticLockingFailureException</span></code>ではなく、<code class="docutils literal notranslate"><span class="pre">org.springframework.dao.UncategorizedDataAccessException</span></code>の子クラスが発生する。</p></li>
</ul>
<p>悲観エラー時に発生する<code class="docutils literal notranslate"><span class="pre">UncategorizedDataAccessException</span></code>は、システムエラーに分類される例外なので、
アプリケーションでハンドリングすることは推奨しない。
しかしながら、最悪ハンドリングを行う必要があるかもしれない。
原因例外には、悲観ロックエラーが発生したことを通知する例外が格納されているので、ハンドリングできる。</p>
<p>⇒継続調査。</p>
<p><strong>現状以下の動作となる。</strong></p>
<ul class="simple">
<li><p>PostgreSQL + for update nowait</p>
<ul>
<li><p>org.springframework.orm.hibernate3.HibernateJdbcException</p></li>
<li><p>Caused by: org.hibernate.PessimisticLockException</p></li>
</ul>
</li>
<li><p>Oracle + for update</p>
<ul>
<li><p>org.springframework.orm.hibernate3.HibernateSystemException</p></li>
<li><p>Caused by: Caused by: org.hibernate.dialect.lock.PessimisticEntityLockException</p></li>
<li><p>Caused by: org.hibernate.exception.LockTimeoutException</p></li>
</ul>
</li>
<li><p>Oracle / PostgreSQL + 一意制約</p>
<ul>
<li><p>org.springframework.dao.DataIntegrityViolationException</p></li>
<li><p>Caused by: org.hibernate.exception.ConstraintViolationException</p></li>
</ul>
</li>
</ul>
</div>
</section>
<section id="exception-handling-exception-type-systemexception-label">
<span id="id9"></span><h4><a class="toc-backref" href="#id67" role="doc-backlink"><span class="section-number">5.7.2.1.3. </span>システム例外</a><a class="headerlink" href="#exception-handling-exception-type-systemexception-label" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line"><strong>システムが、正常稼働している時に、発生してはいけない状態を検知したことを通知する例外</strong> 。</div>
<div class="line">本例外は、アプリケーション層、およびドメイン層のロジックで発生させる。</div>
<div class="line">システム運用者による対処が必要となる。</div>
</div>
<ul class="simple">
<li><p>事前に存在しているはずのマスタデータ、ディレクトリ、ファイルなどが存在しない場合。</p></li>
<li><p>フレームワーク、ライブラリ内で発生する検査例外のうち、システム異常に分類される例外を捕捉した場合(ファイル操作時のIOExceptionなど)。</p></li>
<li><p>etc …</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>該当する例外クラス</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.common.exception.SystemException</span></code> (共通ライブラリから提供しているクラス)。</p></li>
<li><p>遷移先のエラー画面や、HTTPレスポンスコードを細かく分ける場合は、SystemExceptionを継承した例外クラスを作成すること。</p></li>
<li><p>共通ライブラリで用意しているシステム例外クラスだと要件を満たせない場合は、プロジェクト毎にシステム例外クラスを作成すること。</p></li>
</ul>
</div>
</section>
<section id="exception-handling-exception-type-unexpectedexception-label">
<span id="id10"></span><h4><a class="toc-backref" href="#id68" role="doc-backlink"><span class="section-number">5.7.2.1.4. </span>予期しないシステム例外</a><a class="headerlink" href="#exception-handling-exception-type-unexpectedexception-label" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line"><strong>システムが、正常稼働している時には発生しない非検査例外。</strong></div>
<div class="line">システム運用者による対処、またはシステム開発者による解析が必要となる。</div>
<div class="line"><strong>予期しないシステム例外は、アプリケーションコードでハンドリング(try-catch)すべきでない。</strong></div>
</div>
<ul class="simple">
<li><p>アプリケーション、フレームワーク、ライブラリにバグが潜んでいる場合。</p></li>
<li><p>DBサーバなどがダウンしている場合。</p></li>
<li><p>etc …</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>該当する例外クラスの例</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">java.lang.NullPointerException</span></code>(バグ起因で発生する例外)。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.dao.DataAccessResourceFailureException</span></code>(DBサーバがダウンしている場合に発生する例外)。</p></li>
<li><p>etc …</p></li>
</ul>
</div>
</section>
<section id="exception-handling-exception-type-error-label">
<span id="id11"></span><h4><a class="toc-backref" href="#id69" role="doc-backlink"><span class="section-number">5.7.2.1.5. </span>致命的なエラー</a><a class="headerlink" href="#exception-handling-exception-type-error-label" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line"><strong>システム(アプリケーション)全体に影響を及ぼす、致命的な問題が発生している事を通知するエラー</strong> 。</div>
<div class="line">システム運用者、またはシステム開発者による対処・リカバリが必要となる。</div>
<div class="line"><strong>致命的なエラー（java.lang.Errorを継承しているエラーオブジェクト）は、アプリケーションコードでハンドリング(try-catch)してはいけない。</strong></div>
</div>
<ul class="simple">
<li><p>Java仮想マシンで使用できるメモリが不足している場合。</p></li>
<li><p>etc …</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>該当するエラークラスの例</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">java.lang.OutOfMemoryError</span></code>(メモリ不足時に発生するエラー)。</p></li>
<li><p>etc …</p></li>
</ul>
</div>
</section>
<section id="exception-handling-exception-type-request-label">
<span id="id12"></span><h4><a class="toc-backref" href="#id70" role="doc-backlink"><span class="section-number">5.7.2.1.6. </span>リクエスト不正時に発生するフレームワーク例外</a><a class="headerlink" href="#exception-handling-exception-type-request-label" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line"><strong>フレームワークが、リクエスト内容の不正を検知したことを通知する例外</strong> 。</div>
<div class="line">本例外は、フレームワーク(Spring MVC)内で発生する。</div>
<div class="line">原因は、クライアント側に存在するため、システム運用者による対処は、不要である。</div>
</div>
<ul class="simple">
<li><p>POSTメソッドのみ許容しているリクエストパスに対して、GETメソッドでアクセスした場合に発生する例外。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;PathVariable</span></code>アノテーションを使って、URIから値を抽出する際に、URIに型変換できない値が、指定された場合に発生する例外。</p></li>
<li><p>etc …</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>該当する例外クラスの例</strong></p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.web.HttpRequestMethodNotSupportedException</span></code>(サポート外のメソッドでアクセスされた場合に発生する例外)。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">org.springframework.beans.TypeMismatchException</span></code>(URIに型変換できない値が指定された場合に発生する例外)。</p></li>
<li><p>etc …</p></li>
</ul>
</div></blockquote>
<p><a class="reference internal" href="#exception-handling-appendix-defaulthandlerexceptionresolver-label"><span class="std std-ref">DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</span></a>の中の、HTTPステータスコードが「4XX」の例外が該当するクラス。</p>
</div>
</section>
</section>
<section id="exception-handling-pattern-label">
<span id="id13"></span><h3><a class="toc-backref" href="#id71" role="doc-backlink"><span class="section-number">5.7.2.2. </span>例外ハンドリングのパターン</a><a class="headerlink" href="#exception-handling-pattern-label" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">例外ハンドリングは、目的に応じて、以下6種類のパターンに分類される。</div>
<div class="line">(1)-(2)はユースケース毎、(3)-(6)はシステム(アプリケーション)全体でハンドリングを行う。</div>
</div>
<table class="docutils align-default" id="id45">
<caption><span class="caption-text"><strong>表-例外ハンドリングのパターン</strong></span><a class="headerlink" href="#id45" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 10%" />
<col style="width: 40%" />
<col style="width: 25%" />
<col style="width: 10%" />
<col style="width: 15%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>ハンドリングの目的</p></th>
<th class="head"><p>ハンドリング対象となり得る例外</p></th>
<th class="head"><p>ハンドリング方法</p></th>
<th class="head"><p>ハンドリング単位</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference internal" href="#exception-handling-class-from-middle-label"><span class="std std-ref">ユースケースの一部やり直し(途中からのやり直し)を促す場合</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-businessexception-label"><span class="std std-ref">ビジネス例外</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">アプリケーションコード</div>
<div class="line">(try-catch)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">リクエスト</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference internal" href="#exception-handling-class-from-first-label"><span class="std std-ref">ユースケースのやり直し(先頭からのやり直し)を促す場合</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-businessexception-label"><span class="std std-ref">ビジネス例外</span></a></div>
<div class="line">2. <a class="reference internal" href="#exception-handling-exception-type-libraryexception-label"><span class="std std-ref">正常稼働時に発生するライブラリ例外</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">アプリケーションコード</div>
<div class="line">(&#64;ExceptionHandler)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ユースケース</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference internal" href="#exception-handling-class-systemerror-label"><span class="std std-ref">システム、またはアプリケーションが、正常な状態でない事を通知する場合</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-systemexception-label"><span class="std std-ref">システム例外</span></a></div>
<div class="line">2. <a class="reference internal" href="#exception-handling-exception-type-unexpectedexception-label"><span class="std std-ref">予期しないシステム例外</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">フレームワーク</div>
<div class="line">(ハンドリングルールを、<code class="docutils literal notranslate"><span class="pre">spring-mvc.xml</span></code>に指定する)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">サーブレット</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference internal" href="#exception-handling-class-requesterror-label"><span class="std std-ref">リクエスト内容が、不正であることを通知する場合</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-request-label"><span class="std std-ref">リクエスト不正時に発生するフレームワーク例外</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">フレームワーク</div>
</div>
</td>
<td><div class="line-block">
<div class="line">サーブレット</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference internal" href="#exception-handling-class-fatalerror-label"><span class="std std-ref">致命的なエラーが発生したことを検知する場合</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">1. <a class="reference internal" href="#exception-handling-exception-type-error-label"><span class="std std-ref">致命的なエラー</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">サーブレットコンテナ</div>
<div class="line">(ハンドリングルールを、<code class="docutils literal notranslate"><span class="pre">web.xml</span></code>に指定する)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Webアプリケーション</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><a class="reference internal" href="#exception-handling-class-viewerror-label"><span class="std std-ref">プレゼンテーション層(JSPなど)で、例外が発生したことを通知する場合</span></a></div>
</div>
</td>
<td><div class="line-block">
<div class="line">1. プレゼンテーション層で発生する全ての例外及びエラー</div>
</div>
</td>
<td><div class="line-block">
<div class="line">サーブレットコンテナ</div>
<div class="line">(ハンドリングルールを、<code class="docutils literal notranslate"><span class="pre">web.xml</span></code>に指定する)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Webアプリケーション</div>
</div>
</td>
</tr>
</tbody>
</table>
<section id="exception-handling-class-from-middle-label">
<span id="id14"></span><h4><a class="toc-backref" href="#id72" role="doc-backlink"><span class="section-number">5.7.2.2.1. </span>ユースケースの一部やり直し(途中からのやり直し)を促す場合</a><a class="headerlink" href="#exception-handling-class-from-middle-label" title="Permalink to this heading">¶</a></h4>
<p>ユースケースの一部やり直し(途中からのやり直し)を促す場合は、Controllerクラスのアプリケーションコードで捕捉(try-catch)し、リクエスト単位で例外処理を行う。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ユースケースの一部やり直しを促す場合の例</strong></p>
<ul>
<li><div class="line-block">
<div class="line">ショッピングサイトで注文処理を行った際に、在庫不足を通知するビジネス例外が発生する場合。</div>
<div class="line">このケースの場合、個数を減らせば注文処理が行えるため、個数が変更できる画面に遷移し、個数変更を促すメッセージを表示する。</div>
</div>
</li>
<li><p>etc …</p></li>
</ul>
</div>
<figure class="align-center" id="id46">
<a class="reference internal image-reference" href="../_images/exception-handling-class-again-from-middle.png"><img alt="class of exception handling for again from middle" src="../_images/exception-handling-class-again-from-middle.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>図-ユースケースの一部やり直し(途中からのやり直し)を促す場合のハンドリング方法</strong></span><a class="headerlink" href="#id46" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="exception-handling-class-from-first-label">
<span id="id15"></span><h4><a class="toc-backref" href="#id73" role="doc-backlink"><span class="section-number">5.7.2.2.2. </span>ユースケースのやり直し(先頭からのやり直し)を促す場合</a><a class="headerlink" href="#exception-handling-class-from-first-label" title="Permalink to this heading">¶</a></h4>
<p>ユースケースのやり直し(先頭からのやり直し)を促す場合は、<code class="docutils literal notranslate"><span class="pre">&#64;ExceptionHandler</span></code>を使って捕捉し、ユースケース単位で例外処理を行う。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ユースケースのやり直し（先頭からのやり直し）を促す場合の例</strong></p>
<ul>
<li><div class="line-block">
<div class="line">ショッピングサイト(管理者向けサイト)で商品マスタの変更を行った際に、変更対象の商品マスタが他のオペレータによって変更されていた場合（楽観排他例外が発生した場合）。</div>
<div class="line">このケースの場合、他のユーザが行った変更内容を確認してから操作してもらう必要があるため、ユースケースの先頭画面（例えば商品マスタの検索画面）に遷移し、再操作を促すメッセージを表示する。</div>
</div>
</li>
<li><p>etc …</p></li>
</ul>
</div>
<figure class="align-center" id="id47">
<a class="reference internal image-reference" href="../_images/exception-handling-class-again-from-first.png"><img alt="class of exception handling for again from first" src="../_images/exception-handling-class-again-from-first.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>図-ユースケースのやり直し(先頭からのやり直し)を促す場合のハンドリング方法</strong></span><a class="headerlink" href="#id47" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="exception-handling-class-systemerror-label">
<span id="id16"></span><h4><a class="toc-backref" href="#id74" role="doc-backlink"><span class="section-number">5.7.2.2.3. </span>システム、またはアプリケーションが、正常な状態でない事を通知する場合</a><a class="headerlink" href="#exception-handling-class-systemerror-label" title="Permalink to this heading">¶</a></h4>
<p>システム、またはアプリケーションが、正常な状態でないことを通知する例外を検知する場合は、SystemExceptionResolverで捕捉し、サーブレット単位で例外処理を行う。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>システム、またはアプリケーションが正常な状態でないことを通知する場合の例</strong></p>
<ul>
<li><div class="line-block">
<div class="line">外部システムとの接続を行うユースケースにて、外部システムが、閉塞中であることを通知する例外が発生した場合。</div>
<div class="line">このケースの場合、外部システムが開局するまで実行できないため、エラー画面に遷移し、外部システムが開局するまでユースケースが実行できない旨を通知する。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">アプリケーションで指定した値を、条件にマスタ情報の検索を行った際に、該当するマスタ情報が存在しない場合。</div>
<div class="line">このケースの場合、マスタメンテナンス機能のバグ又はシステム運用者によるデータ投入ミス(リリースミス)の可能性があるため、システムエラー画面に遷移し、システム異常が発生した旨を通知する。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">ファイル操作時にAPIからIOExceptionが発生した場合。</div>
<div class="line">このケースの場合、ディスク異常などが考えられるため、システムエラー画面に遷移し、システム異常が発生した旨を通知する。</div>
</div>
</li>
<li><p>etc …</p></li>
</ul>
</div>
<figure class="align-center" id="id48">
<a class="reference internal image-reference" href="../_images/exception-handling-class-systemerror.png"><img alt="class of exception handling for system error" src="../_images/exception-handling-class-systemerror.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>図-システム、またはアプリケーションが、正常な状態でないことを通知する例外を検知する場合のハンドリング方法</strong></span><a class="headerlink" href="#id48" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="exception-handling-class-requesterror-label">
<span id="id17"></span><h4><a class="toc-backref" href="#id75" role="doc-backlink"><span class="section-number">5.7.2.2.4. </span>リクエスト内容が、不正であることを通知する場合</a><a class="headerlink" href="#exception-handling-class-requesterror-label" title="Permalink to this heading">¶</a></h4>
<p>フレームワークによって、検知されたリクエスト不正を通知する場合は、DefaultHandlerExceptionResolverで捕捉し、サーブレット単位で例外処理を行う。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>リクエスト内容が不正であることを通知する場合の例</strong></p>
<ul>
<li><div class="line-block">
<div class="line">POSTメソッドのみ許可されているURIで、GETメソッドを使ってアクセスした場合。</div>
<div class="line">このケースの場合、ブラウザのお気に入り機能などを使って直接アクセスしている事が考えられるため、エラー画面に遷移し、リクエスト内容が不正であることを通知する。</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&#64;PathVariable</span></code> アノテーションを使ってURIから値を抽出する際に、URIから値を抽出できなかった場合。</div>
<div class="line">このケースの場合、ブラウザのアドレスバーの値を書き換えて、直接アクセスしている事が考えられるため、エラー画面に遷移し、リクエスト内容が不正であることを通知する。</div>
</div>
</li>
<li><p>etc …</p></li>
</ul>
</div>
<figure class="align-center" id="id49">
<a class="reference internal image-reference" href="../_images/exception-handling-class-requesterror.png"><img alt="class of exception handling for request error" src="../_images/exception-handling-class-requesterror.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>図-リクエスト内容が不正であることを通知する場合のハンドリング方法</strong></span><a class="headerlink" href="#id49" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="exception-handling-class-fatalerror-label">
<span id="id18"></span><h4><a class="toc-backref" href="#id76" role="doc-backlink"><span class="section-number">5.7.2.2.5. </span>致命的なエラーが発生したことを検知する場合</a><a class="headerlink" href="#exception-handling-class-fatalerror-label" title="Permalink to this heading">¶</a></h4>
<p>致命的なエラーが発生したことを検知する場合、サーブレットコンテナで捕捉し、Webアプリケーション単位で例外処理を行う。</p>
<figure class="align-center" id="id50">
<a class="reference internal image-reference" href="../_images/exception-handling-class-fatalerror.png"><img alt="class of exception handling for fatal error" src="../_images/exception-handling-class-fatalerror.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>図-致命的なエラーが発生したことを検知する場合のハンドリング方法</strong></span><a class="headerlink" href="#id50" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="jsp">
<span id="exception-handling-class-viewerror-label"></span><h4><a class="toc-backref" href="#id77" role="doc-backlink"><span class="section-number">5.7.2.2.6. </span>プレゼンテーション層(JSPなど)で、例外が発生したことを通知する場合</a><a class="headerlink" href="#jsp" title="Permalink to this heading">¶</a></h4>
<p>プレゼンテーション層(JSPなど)で、例外が発生したことを通知する場合、サーブレットコンテナで捕捉し、Webアプリケーション単位で例外処理を行う。</p>
<figure class="align-center" id="id51">
<a class="reference internal image-reference" href="../_images/exception-handling-class-jsperror.png"><img alt="class of exception handling for fatal error" src="../_images/exception-handling-class-jsperror.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>図-プレゼンテーション層(JSPなど)で例外が発生した事を通知する場合のハンドリング方法</strong></span><a class="headerlink" href="#id51" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="exception-handling-basic-flow-label">
<span id="id19"></span><h3><a class="toc-backref" href="#id78" role="doc-backlink"><span class="section-number">5.7.2.3. </span>例外ハンドリングの基本フロー</a><a class="headerlink" href="#exception-handling-basic-flow-label" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">例外処理の基本フローを示す。</div>
<div class="line">共通ライブラリから提供しているクラスの概要については、<a class="reference internal" href="#exception-handling-about-classes-of-library-label"><span class="std std-ref">共通ライブラリから提供している例外ハンドリング用のクラスについて</span></a>を参照されたい。</div>
<div class="line"><strong>アプリケーションコードで行う処理(実装が必要な処理)についての説明は、太字で表現している。</strong></div>
<div class="line">例外メッセージ、およびスタックトレースのログ出力は、共通ライブラリから提供しているクラス（FilterやInterceptorクラス）で行う。</div>
<div class="line">例外メッセージ、およびスタックトレース以外の情報を、ログ出力する必要がある場合は、各ロジックで個別にログを出力すること。</div>
<div class="line">例外ハンドリングのフロー説明であるため、Serviceクラスを呼び出すまでのフローに関する説明は、省略する。</div>
</div>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#exception-handling-basic-flow-catch-label"><span class="std std-ref">リクエスト単位でControllerクラスがハンドリングする場合の基本フロー</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-basic-flow-annotation-label"><span class="std std-ref">ユースケース単位でControllerクラスがハンドリングする場合の基本フロー</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-basic-flow-resolver-label"><span class="std std-ref">サーブレット単位でフレームワークがハンドリングする場合の基本フロー</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-basic-flow-container-label"><span class="std std-ref">Webアプリケーション単位でサーブレットコンテナがハンドリングする場合の基本フロー</span></a></p></li>
</ol>
<section id="controller">
<span id="exception-handling-basic-flow-catch-label"></span><h4><a class="toc-backref" href="#id79" role="doc-backlink"><span class="section-number">5.7.2.3.1. </span>リクエスト単位でControllerクラスがハンドリングする場合の基本フロー</a><a class="headerlink" href="#controller" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">例外をリクエスト単位でハンドリングする場合、Controllerクラスのアプリケーションコードで捕捉(try-catch)し、例外処理を行う。</div>
<div class="line">基本フローは、以下の通りである。</div>
<div class="line">下記の図は、 共通ライブラリから提供しているビジネス例外(<code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.common.exception.BusinessException</span></code>)をハンドリングする場合の基本フローである。</div>
<div class="line">ログは、結果メッセージを保持している例外が発生したことを記録するインタセプタ(<code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.common.exception.ResultMessagesLoggingInterceptor</span></code>)を使用して、出力する。</div>
</div>
<figure class="align-center" id="id52">
<a class="reference internal image-reference" href="../_images/exception-handling-flow-catch.png"><img alt="flow of exception handling using catch" src="../_images/exception-handling-flow-catch.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>図-リクエスト単位でControllerクラスがハンドリングする場合の基本フロー</strong></span><a class="headerlink" href="#id52" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<ol class="arabic simple" start="4">
<li><p>Serviceクラスにて、 BusinessExceptionを生成し、スローする。</p></li>
<li><p>ResultMessagesLoggingInterceptorは、 ExceptionLoggerを呼び出し、warnレベルのログ(監視ログとアプリケーションログ)を出力する。
ResultMessagesLoggingInterceptorはResultMessagesNotificationExceptionのサブ例外(BusinessException/ResourceNotFoundException)が発生した場合のみ、ログを出力するクラスである。</p></li>
<li><p><strong>Controllerクラスは、 BusinessExceptionを捕捉し、 BusinessExceptionに設定されているメッセージ情報(ResultMessage)を画面表示用にModelに設定する(6’)。</strong></p></li>
<li><p><strong>Controllerクラスは、遷移先のView名を返却する。</strong></p></li>
<li><p>DispatcherServletは、返却されたView名に対応するJSPを呼び出す。</p></li>
<li><p><strong>JSPは、MessagesPanelTagを使用して、メッセージ情報(ResultMessage)を取得し、メッセージ表示用のHTMLコードを生成する。</strong></p></li>
<li><p>JSPで生成されたレスポンスが表示される。</p></li>
</ol>
</section>
<section id="exception-handling-basic-flow-annotation-label">
<span id="id20"></span><h4><a class="toc-backref" href="#id80" role="doc-backlink"><span class="section-number">5.7.2.3.2. </span>ユースケース単位でControllerクラスがハンドリングする場合の基本フロー</a><a class="headerlink" href="#exception-handling-basic-flow-annotation-label" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">例外をユースケース単位でハンドリングする場合、Controllerクラスの<code class="docutils literal notranslate"><span class="pre">&#64;ExceptionHandler</span></code>を使って捕捉し、例外処理を行う。</div>
<div class="line">基本フローは、以下の通りである。</div>
<div class="line">下記の図は、 任意の例外(<code class="docutils literal notranslate"><span class="pre">XxxException</span></code>)をハンドリングする場合の、基本フローである。</div>
<div class="line">ログは、HandlerExceptionResolverによって、例外ハンドリングすることを記録するインタセプタ(<code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.web.exception.HandlerExceptionResolverLoggingInterceptor</span></code>)を使用して、出力する。</div>
</div>
<figure class="align-center" id="id53">
<a class="reference internal image-reference" href="../_images/exception-handling-flow-annotation.png"><img alt="flow of exception handling using annotation" src="../_images/exception-handling-flow-annotation.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>図-ユースケース単位で、Controllerクラスがハンドリングする場合の基本フロー</strong></span><a class="headerlink" href="#id53" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<ol class="arabic simple" start="3">
<li><p>Controllerクラスから呼び出されたServiceクラスにて、例外(XxxException)が発生する。</p></li>
<li><p>DispatcherServletは、XxxExceptionを捕捉し、ExceptionHandlerExceptionResolverを呼び出す。</p></li>
<li><p>ExceptionHandlerExceptionResolverは、Controllerクラスに用意されている例外ハンドリングメソッドを呼び出す。</p></li>
<li><p><strong>Controllerクラスは、メッセージ情報(ResultMessage)を生成し、画面表示用としてModelに設定する。</strong></p></li>
<li><p><strong>Controllerクラスは、遷移先のView名を返却する。</strong></p></li>
<li><p>ExceptionHandlerExceptionResolverは、Controllerより返却されたView名を返却する。</p></li>
<li><p>HandlerExceptionResolverLoggingInterceptorは、ExceptionLoggerを呼び出し、例外コードに対応するレベル(info, warn, error)のログ(監視ログとアプリケーションログ)を出力する。</p></li>
<li><p>HandlerExceptionResolverLoggingInterceptorは、ExceptionHandlerExceptionResolverより返却されたView名を返却する。</p></li>
<li><p>DispatcherServletは、返却されたView名に対応するJSPを呼び出す。</p></li>
<li><p><strong>JSPは、MessagesPanelTagを使用して、メッセージ情報(ResultMessage)を取得し、メッセージ表示用のHTMLコードを生成する。</strong></p></li>
<li><p>JSPで生成されたレスポンスが表示される。</p></li>
</ol>
</section>
<section id="exception-handling-basic-flow-resolver-label">
<span id="id21"></span><h4><a class="toc-backref" href="#id81" role="doc-backlink"><span class="section-number">5.7.2.3.3. </span>サーブレット単位でフレームワークがハンドリングする場合の基本フロー</a><a class="headerlink" href="#exception-handling-basic-flow-resolver-label" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">例外をフレームワーク(サーブレット単位)でハンドリングする場合、SystemExceptionResolverで捕捉し例外処理を行う。</div>
<div class="line">基本フローは、以下の通りである。</div>
<div class="line">下記の図は、 共通ライブラリから提供しているシステム例外(<code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.common.exception.SystemException</span></code>)を、<code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.web.exception.SystemExceptionResolver</span></code>を使ってハンドリングする場合の基本フローである。</div>
<div class="line">ログは、例外ハンドリングメソッドの引数に指定された例外を記録するインタセプタ(<code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.web.exception.HandlerExceptionResolverLoggingInterceptor</span></code>)を使用して、出力する。</div>
</div>
<figure class="align-center" id="id54">
<a class="reference internal image-reference" href="../_images/exception-handling-flow-resolver.png"><img alt="flow of exception handling using resolver" src="../_images/exception-handling-flow-resolver.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>図-サーブレット単位でフレームワークがハンドリングする場合の基本フロー</strong></span><a class="headerlink" href="#id54" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<ol class="arabic simple" start="4">
<li><p>Serviceクラスにて、システム例外に該当する状態を検知したため、SystemExceptionを発生させる。</p></li>
<li><p>DispatcherServletは、SystemExceptionを捕捉し、SystemExceptionResolverを呼び出す。</p></li>
<li><p>SystemExceptionResolverは、SystemExceptionから例外コードを取得し、画面表示用にHttpServletRequestに設定する(6’)。</p></li>
<li><p>SystemExceptionResolverは、SystemException発生時の遷移先のView名を返却する。</p></li>
<li><p>HandlerExceptionResolverLoggingInterceptorは、ExceptionLoggerを呼び出し、例外コードに対応するレベル(info, warn, error)のログ(監視ログとアプリケーションログ)を出力する。</p></li>
<li><p>HandlerExceptionResolverLoggingInterceptorは、SystemExceptionResolverより返却されたView名を返却する。</p></li>
<li><p>DispatcherServletは、返却されたView名に対応するJSPを呼び出す。</p></li>
<li><p><strong>JSPは、HttpServletRequestより例外コードを取得し、メッセージ表示用のHTMLコードに埋め込む。</strong></p></li>
<li><p>JSPで生成されたレスポンスが表示される。</p></li>
</ol>
</section>
<section id="web">
<span id="exception-handling-basic-flow-container-label"></span><h4><a class="toc-backref" href="#id82" role="doc-backlink"><span class="section-number">5.7.2.3.4. </span>Webアプリケーション単位でサーブレットコンテナがハンドリングする場合の基本フロー</a><a class="headerlink" href="#web" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">例外をWebアプリケーション単位でハンドリングする場合、サーブレットコンテナで捕捉し、例外処理を行う。</div>
<div class="line">致命的なエラー、フレームワークでハンドリング対象となっていない例外(JSP内で発生した例外など)、Filterで発生した例外をハンドリングする。</div>
<div class="line">基本フローは以下の通りである。</div>
<div class="line">下記フローは、java.lang.Exceptionを、”error page”でハンドリングする場合のフローである。</div>
<div class="line">ログ出力は、ハンドリングされていない例外が発生したことを記録するサーブレットフィルタ(<code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.web.exception.ExceptionLoggingFilter</span></code>)を使用して、出力する。</div>
</div>
<figure class="align-center" id="id55">
<a class="reference internal image-reference" href="../_images/exception-handling-flow-container.png"><img alt="flow of exception handling using container" src="../_images/exception-handling-flow-container.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-text"><strong>図-Webアプリケーション単位でサーブレットコンテナがハンドリングする場合の基本フロー</strong></span><a class="headerlink" href="#id55" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<ol class="arabic simple" start="4">
<li><p>DispatcherServletは、XxxErrorを捕捉し、ServletExceptionにラップしてスローする。</p></li>
<li><p>ExceptionLoggingFilterは、ServletExceptionを捕捉し、ExceptionLoggerを呼び出す。ExceptionLoggerは、例外コードに対応するレベル(info, warn, error)のログ(監視ログとアプリケーションログ)を出力する。ExceptionLoggingFilterは、ServletExceptionを再スローする。</p></li>
<li><p>ServletContainerは、ServletExceptionを捕捉し、サーバログにログを出力する。ログのレベルは、アプリケーションサーバによって異なる。</p></li>
<li><p>ServletContainerは、<code class="docutils literal notranslate"><span class="pre">web.xml</span></code> に定義されている遷移先(HTMLなど)を呼び出す。</p></li>
<li><p>呼び出された遷移先で生成されたレスポンスが表示される。</p></li>
</ol>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
<section id="how-to-use">
<span id="exception-handling-how-to-use-label"></span><h2><a class="toc-backref" href="#id83" role="doc-backlink"><span class="section-number">5.7.3. </span>How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this heading">¶</a></h2>
<p>例外ハンドリング機能の使用方法について説明する。</p>
<p>共通ライブラリから提供している例外ハンドリング用のクラスについては、<a class="reference internal" href="#exception-handling-about-classes-of-library-label"><span class="std std-ref">共通ライブラリから提供している例外ハンドリング用のクラスについて</span></a>を参照されたい。</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-label"><span class="std std-ref">アプリケーションの設定</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-label"><span class="std std-ref">コーディングポイント（Service編）</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-contoller-label"><span class="std std-ref">コーディングポイント（Controller編）</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-jsp-label"><span class="std std-ref">コーディングポイント（JSP編）</span></a></p></li>
</ol>
<section id="exception-handling-how-to-use-application-configuration-label">
<span id="id22"></span><h3><a class="toc-backref" href="#id84" role="doc-backlink"><span class="section-number">5.7.3.1. </span>アプリケーションの設定</a><a class="headerlink" href="#exception-handling-how-to-use-application-configuration-label" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">例外ハンドリングを使用する際に、必要なアプリケーション設定を、以下に示す。</div>
<div class="line">なお、ブランクプロジェクトは、既に設定済みの状態になっているので、<strong>【プロジェクト毎にカスタマイズする箇所】</strong>の部分を変更すればよい。</div>
</div>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-common-label"><span class="std std-ref">共通設定</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-domain-label"><span class="std std-ref">ドメイン層の設定</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-app-label"><span class="std std-ref">アプリケーション層の設定</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-application-configuration-container-label"><span class="std std-ref">サーブレットコンテナの設定</span></a></p></li>
</ol>
<section id="exception-handling-how-to-use-application-configuration-common-label">
<span id="id23"></span><h4><a class="toc-backref" href="#id85" role="doc-backlink"><span class="section-number">5.7.3.1.1. </span>共通設定</a><a class="headerlink" href="#exception-handling-how-to-use-application-configuration-common-label" title="Permalink to this heading">¶</a></h4>
<p>１． 例外のログ出力を行うロガークラス（<code class="docutils literal notranslate"><span class="pre">ExceptionLogger</span></code>）を、bean定義に追加する。</p>
<ul class="simple">
<li><p><strong>applicationContext.xml</strong></p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- Exception Code Resolver. --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;exceptionCodeResolver&quot;</span>
<span class="hll"><span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.common.exception.SimpleMappingExceptionCodeResolver&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
</span><span class="w">    </span><span class="cm">&lt;!-- Setting and Customization by project. --&gt;</span>
<span class="hll"><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;exceptionMappings&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
</span><span class="w">        </span><span class="nt">&lt;map&gt;</span>
<span class="w">            </span><span class="nt">&lt;entry</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;ResourceNotFoundException&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;e.xx.fw.5001&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;entry</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;BusinessException&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;e.xx.fw.8001&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/map&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="hll"><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;defaultExceptionCode&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;e.xx.fw.9001&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
</span><span class="nt">&lt;/bean&gt;</span>

<span class="cm">&lt;!-- Exception Logger. --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;exceptionLogger&quot;</span>
<span class="hll"><span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.common.exception.ExceptionLogger&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (4) --&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;exceptionCodeResolver&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;exceptionCodeResolver&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (5) --&gt;</span>
</span><span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ExceptionCodeResolver</span></code>を、bean定義に追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ハンドリング対象とする例外名と、適用する「例外コード(メッセージID)」のマッピングを指定する。</div>
<div class="line">上記の設定例では、例外クラス(又は親クラス)のクラス名に、”BusinessException”が含まれている場合は、”w.xx.fw.8001”、 “ResourceNotFoundException”が含まれている場合は、”w.xx.fw.5001”が「例外コード(メッセージID)」となる。</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>例外コード(メッセージID)について</strong></p>
<p>ここでは、”BusinessException”に、メッセージIDが指定されなかった場合の対応で定義をしているが、
後述の”BusinessException”を発生させる実装側で、「例外コード(メッセージID)」を指定することを推奨する。
“BusinessException”に対する「例外コード(メッセージID)」の指定は、”BusinessException”発生時に指定されなかった場合の救済策である。</p>
</div>
<div class="line-block">
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">デフォルトの「例外コード(メッセージID)」を指定する。</div>
<div class="line">上記の設定例では、例外クラス(または親クラス)のクラス名に”BusinessException”、または”ResourceNotFoundException”が含まれない場合、”e.xx.fw.9001”が例外コード(メッセージID)」となる。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>例外コード(メッセージID)について</strong></p>
<p>例外コードは、ログに出力するのみ。（画面での取得もできる。JSPへのリンク）
プロパティに定義している形式でなくとも、運用上でわかるIDにすることが可能である。
例えば、MA7001等</p>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ExceptionLogger</span></code>を、bean定義に追加する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ExceptionCodeResolver</span></code>をDIする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>２． ログ定義を追加する。</p>
<ul class="simple">
<li><p><strong>logback.xml</strong></p></li>
</ul>
<blockquote>
<div><p>監視ログ用のログ定義を追加する。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">&lt;appender</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;MONITORING_LOG_FILE&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
</span><span class="w">    </span><span class="nt">&lt;file&gt;</span>log/projectName-monitoring.log<span class="nt">&lt;/file&gt;</span>
<span class="w">    </span><span class="nt">&lt;rollingPolicy</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;fileNamePattern&gt;</span>log/projectName-monitoring-%d{yyyyMMdd}.log<span class="nt">&lt;/fileNamePattern&gt;</span>
<span class="w">        </span><span class="nt">&lt;maxHistory&gt;</span>7<span class="nt">&lt;/maxHistory&gt;</span>
<span class="w">    </span><span class="nt">&lt;/rollingPolicy&gt;</span>
<span class="w">    </span><span class="nt">&lt;encoder&gt;</span>
<span class="w">        </span><span class="nt">&lt;charset&gt;</span>UTF-8<span class="nt">&lt;/charset&gt;</span>
<span class="w">        </span><span class="nt">&lt;pattern&gt;</span><span class="cp">&lt;![CDATA[date:%d{yyyy-MM-dd HH:mm:ss}\tX-Track:%X{X-Track}\tlevel:%-5level\tmessage:%msg%n]]&gt;</span><span class="nt">&lt;/pattern&gt;</span>
<span class="w">    </span><span class="nt">&lt;/encoder&gt;</span>
<span class="nt">&lt;/appender&gt;</span>

<span class="hll"><span class="nt">&lt;logger</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;org.terasoluna.gfw.common.exception.ExceptionLogger.Monitoring&quot;</span><span class="w"> </span><span class="na">additivity=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;level</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;error&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;appender-ref</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;MONITORING_LOG_FILE&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (4) --&gt;</span>
</span><span class="nt">&lt;/logger&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">監視ログを出力するための、appender定義を指定する。上記の設定例では、ファイルに出力するappenderとしているが、システム要件に一致するappenderを使うこと。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">監視ログ用の、ロガー定義を指定する。ExceptionLoggerを作成する際に、任意のロガー名を指定していない場合は、上記設定のままでよい。</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>additivityの設定値について</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">false</span></code>を指定すること。<code class="docutils literal notranslate"><span class="pre">true</span></code>を指定すると、上位のロガー(例えば、root)によって、同じログが出力されてしまう。</p>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">出力レベルを指定する。ExceptionLoggerではinfo, warn, errorの3種類のログを出力しているが、システム要件にあったレベルを指定すること。errorレベルを推奨する。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">出力先となるappenderを指定する。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
<p>アプリケーションログ用のログ定義を追加する。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">&lt;appender</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;APPLICATION_LOG_FILE&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
</span><span class="w">    </span><span class="nt">&lt;file&gt;</span>log/projectName-application.log<span class="nt">&lt;/file&gt;</span>
<span class="w">    </span><span class="nt">&lt;rollingPolicy</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;fileNamePattern&gt;</span>log/projectName-application-%d{yyyyMMdd}.log<span class="nt">&lt;/fileNamePattern&gt;</span>
<span class="w">        </span><span class="nt">&lt;maxHistory&gt;</span>7<span class="nt">&lt;/maxHistory&gt;</span>
<span class="w">    </span><span class="nt">&lt;/rollingPolicy&gt;</span>
<span class="w">    </span><span class="nt">&lt;encoder&gt;</span>
<span class="w">        </span><span class="nt">&lt;charset&gt;</span>UTF-8<span class="nt">&lt;/charset&gt;</span>
<span class="w">        </span><span class="nt">&lt;pattern&gt;</span><span class="cp">&lt;![CDATA[date:%d{yyyy-MM-dd HH:mm:ss}\tthread:%thread\tX-Track:%X{X-Track}\tlevel:%-5level\tlogger:%-48logger{48}\tmessage:%msg%n]]&gt;</span><span class="nt">&lt;/pattern&gt;</span>
<span class="w">    </span><span class="nt">&lt;/encoder&gt;</span>
<span class="nt">&lt;/appender&gt;</span>

<span class="hll"><span class="nt">&lt;logger</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;org.terasoluna.gfw.common.exception.ExceptionLogger&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
</span><span class="w">    </span><span class="nt">&lt;level</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;info&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/logger&gt;</span>

<span class="nt">&lt;root</span><span class="w"> </span><span class="na">level=</span><span class="s">&quot;warn&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;appender-ref</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;STDOUT&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;appender-ref</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;APPLICATION_LOG_FILE&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/root&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">アプリケーションログを出力するための、appender定義を指定する。上記の設定例では、ファイルに出力するappenderとしているが、システム要件に一致するappenderを使うこと。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">アプリケーションログ用の、ロガー定義を指定する。ExceptionLoggerを作成する際に、任意のロガー名を指定していない場合は、上記設定のままでよい。</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>アプリケーションログ出力用のappender定義について</strong></p>
<p>アプリケーションログ用のappenderは、例外出力用に個別に定義するのではなく、フレームワークや、アプリケーションコードで出力するログ用のappenderと、同じものを使うことを推奨する。
同じ出力先にすることで、例外の発生するまでの過程が追いやすくなる。</p>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">出力レベルを指定する。ExceptionLoggerでは、info, warn, errorの3種類のログを出力しているが、システム要件にあったレベルを指定すること。本ガイドラインでは、infoレベルを推奨する。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(2)で設定したロガーは、appenderを指定していないので、rootに流れる。そのため、出力先となるappenderを指定する。ここでは、”STDOUT”と”APPLICATION_LOG_FILE”に出力される。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="exception-handling-how-to-use-application-configuration-domain-label">
<span id="id24"></span><h4><a class="toc-backref" href="#id86" role="doc-backlink"><span class="section-number">5.7.3.1.2. </span>ドメイン層の設定</a><a class="headerlink" href="#exception-handling-how-to-use-application-configuration-domain-label" title="Permalink to this heading">¶</a></h4>
<p>ResultMessagesを保持する例外(BisinessException,ResourceNotFoundException)が発生した際に、ログを出力するためのインタセプタクラス（<code class="docutils literal notranslate"><span class="pre">ResultMessagesLoggingInterceptor</span></code>）と、AOPの設定を、bean定義に追加する。</p>
<ul class="simple">
<li><p><strong>xxx-domain.xml</strong></p></li>
</ul>
<blockquote id="exception-handling-how-to-use-service-pointcut-aop-label">
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- interceptor bean. --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;resultMessagesLoggingInterceptor&quot;</span>
<span class="hll"><span class="w">      </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.common.exception.ResultMessagesLoggingInterceptor&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="w">      </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;exceptionLogger&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;exceptionLogger&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
</span><span class="nt">&lt;/bean&gt;</span>

<span class="cm">&lt;!-- setting AOP. --&gt;</span>
<span class="nt">&lt;aop:config&gt;</span>
<span class="w">    </span><span class="nt">&lt;aop:advisor</span><span class="w"> </span><span class="na">advice-ref=</span><span class="s">&quot;resultMessagesLoggingInterceptor&quot;</span>
<span class="hll"><span class="w">                 </span><span class="na">pointcut=</span><span class="s">&quot;@within(org.springframework.stereotype.Service)&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
</span><span class="nt">&lt;/aop:config&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ResultMessagesLoggingInterceptor</span></code>を、bean定義に追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外のログ出力を行うロガーオブジェクトをDIする。<code class="docutils literal notranslate"><span class="pre">applicationContext.xml</span></code>に定義している “exceptionLogger” を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Serviceクラス(<code class="docutils literal notranslate"><span class="pre">&#64;Service</span></code>アノテーションが付いているクラス)のメソッドに対して、ResultMessagesLoggingInterceptorを適用する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="exception-handling-how-to-use-application-configuration-app-label">
<span id="id25"></span><h4><a class="toc-backref" href="#id87" role="doc-backlink"><span class="section-number">5.7.3.1.3. </span>アプリケーション層の設定</a><a class="headerlink" href="#exception-handling-how-to-use-application-configuration-app-label" title="Permalink to this heading">¶</a></h4>
<p>&lt;mvc:annotation-driven&gt; を指定した際に、自動的に登録されるHanlderExceptionResolverによって、ハンドリングされない例外をハンドリングするためのクラス（<code class="docutils literal notranslate"><span class="pre">SystemExceptionResolver</span></code>）を、bean定義に追加する。</p>
<ul class="simple">
<li><p><strong>spring-mvc.xml</strong></p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- Setting Exception Handling. --&gt;</span>
<span class="cm">&lt;!-- Exception Resolver. --&gt;</span>
<span class="hll"><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;exceptionCodeResolver&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;exceptionCodeResolver&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
</span><span class="w">    </span><span class="cm">&lt;!-- Setting and Customization by project. --&gt;</span>
<span class="hll"><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;order&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;3&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;exceptionMappings&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (4) --&gt;</span>
</span><span class="w">        </span><span class="nt">&lt;map&gt;</span>
<span class="w">            </span><span class="nt">&lt;entry</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;ResourceNotFoundException&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;common/error/resourceNotFoundError&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;entry</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;BusinessException&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;common/error/businessError&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;entry</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;InvalidTransactionTokenException&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;common/error/transactionTokenError&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;entry</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;.DataAccessException&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;common/error/dataAccessError&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/map&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="hll"><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;statusCodes&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (5) --&gt;</span>
</span><span class="w">        </span><span class="nt">&lt;map&gt;</span>
<span class="w">            </span><span class="nt">&lt;entry</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;common/error/resourceNotFoundError&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;404&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;entry</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;common/error/businessError&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;409&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;entry</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;common/error/transactionTokenError&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;409&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;entry</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;common/error/dataAccessError&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;500&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/map&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="hll"><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;defaultErrorView&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;common/error/systemError&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (6) --&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;defaultStatusCode&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;500&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (7) --&gt;</span>
</span><span class="nt">&lt;/bean&gt;</span>

<span class="cm">&lt;!-- Settings View Resolver. --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;viewResolver&quot;</span>
<span class="hll"><span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (8) --&gt;</span>
</span><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;prefix&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;/WEB-INF/views/&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;suffix&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;.jsp&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">SystemExceptionResolver</span></code>を、bean定義に追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外コード(メッセージID)を解決するオブジェクトをDIする。<code class="docutils literal notranslate"><span class="pre">applicationContext.xml</span></code>に定義している、“exceptionCodeResolver”を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ハンドリングの優先順位を指定する。値は、基本的に「3」で良い。<code class="docutils literal notranslate"><span class="pre">&lt;mvc:annotation-driven&gt;</span></code>を指定した際に、自動的に、<span class="xref std std-ref">登録されるクラス</span>の方が、優先順位が上となる。</div>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p><strong>DefaultHandlerExceptionResolverで行われる例外ハンドリングを無効化する方法</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">DefaultHandlerExceptionResolver</span></code>で例外ハンドリングされた場合、HTTPレスポンスコードは設定されるが、Viewの解決がされないため、Viewの解決は、<code class="docutils literal notranslate"><span class="pre">web.xml</span></code>のError Pageで行う必要がある。
Viewの解決を<code class="docutils literal notranslate"><span class="pre">web.xml</span></code>ではなく、<code class="docutils literal notranslate"><span class="pre">HanlderExceptionResolver</span></code>で行いたい場合は、<code class="docutils literal notranslate"><span class="pre">SystemExceptionResolver</span></code>の優先順位を「1」にすると、<code class="docutils literal notranslate"><span class="pre">DefaultHandlerExceptionResolver</span></code>より前にハンドリング処理を実行することができる。
<code class="docutils literal notranslate"><span class="pre">DefaultHandlerExceptionResolver</span></code>でハンドリングされた場合の、HTTPレスポンスコードのマッピングについては、<a class="reference internal" href="#exception-handling-appendix-defaulthandlerexceptionresolver-label"><span class="std std-ref">DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</span></a>を参照されたい。</p>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ハンドリング対象とする例外名と、遷移先となるView名のマッピングを指定する。</div>
<div class="line">上記の設定では、例外クラス(または親クラス)のクラス名に”.DataAccessException”が含まれている場合、”common/error/dataAccessError”が、遷移先のView名となる。</div>
<div class="line">例外クラスが”ResourceNotFoundException”の場合、”common/error/resourceNotFoundError”が、遷移先のView名となる。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">遷移先となるView名と、HTTPステータスコードのマッピングを指定する。</div>
<div class="line">上記の設定では、View名が”common/error/resourceNotFoundError”の場合に、”404(Not Found)”がHTTPステータスコードとなる。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">遷移するデフォルトのView名を、指定する。</div>
<div class="line">上記の設定では、例外クラスに”ResourceNotFoundException”、”BusinessException”、”InvalidTransactionTokenException”や例外クラス(または親クラス)のクラス名に、”.DataAccessException”が含まれない場合、”common/error/systemError”が、遷移先のView名となる。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">レスポンスヘッダに設定するHTTPステータスコードのデフォルト値を指定する。 <strong>“500”(Internal Server Error)</strong> を設定することを推奨する。</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>指定を省略した場合の挙動</strong></p>
<p><strong>“200”(OK)</strong>扱いになるので、注意すること。</p>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">実際に遷移するViewは、ViewResolverの設定に依存する。</div>
<div class="line">上記の設定では、”/WEB-INF/views/common/error/systemError.jsp”、”/WEB-INF/views/common/error/resourceNotFoundError.jsp”、”/WEB-INF/views/common/error/businessError.jsp”、”/WEB-INF/views/common/error/transactionTokenError.jsp”、”/WEB-INF/views/common/error/dataAccessError.jsp”が遷移先となる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">HandlerExceptionResolver</span></code>でハンドリングされた例外を、ログに出力するためのインタセプタクラス（<code class="docutils literal notranslate"><span class="pre">HandlerExceptionResolverLoggingInterceptor</span></code>）と、AOPの設定を、bean定義に追加する。</p>
<ul class="simple">
<li><p><strong>spring-mvc.xml</strong></p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- Setting AOP. --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
<span class="hll"><span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.HandlerExceptionResolverLoggingInterceptor&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;exceptionLogger&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;exceptionLogger&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
</span><span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;aop:config&gt;</span>
<span class="w">    </span><span class="nt">&lt;aop:advisor</span><span class="w"> </span><span class="na">advice-ref=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
<span class="hll"><span class="w">        </span><span class="na">pointcut=</span><span class="s">&quot;execution(* org.springframework.web.servlet.HandlerExceptionResolver.resolveException(..))&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
</span><span class="nt">&lt;/aop:config&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ExceptionHandlerLoggingInterceptor</span></code>を、bean定義に追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外のログ出力を行うロガーオブジェクトを、DIする。<code class="docutils literal notranslate"><span class="pre">applicationContext.xml</span></code>に定義している“exceptionLogger”を指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HandlerExceptionResolver</span></code>インタフェースのresolveExceptionメソッドに対して、<code class="docutils literal notranslate"><span class="pre">HandlerExceptionResolverLoggingInterceptor</span></code>を適用する。</div>
<div class="line"><br /></div>
<div class="line">デフォルトの設定では、共通ライブラリから提供している <code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.common.exception.ResultMessagesNotificationException</span></code> のサブクラスの例外は、このクラスで行われるログ出力の対象外となっている。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ResultMessagesNotificationException</span></code> のサブクラスの例外をログ出力対象外としている理由は、 <code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.common.exception.ResultMessagesLoggingInterceptor</span></code> によってログ出力されるためである。</div>
<div class="line">デフォルトの設定を変更する必要がある場合は、 <a class="reference internal" href="#exception-handling-about-handlerexceptionresolverlogginginterceptor"><span class="std std-ref">HandlerExceptionResolverLoggingInterceptorの設定項目について</span></a> を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>致命的なエラー、Spring MVC管理外で発生する例外を、ログに出力するためのFilterクラス（<code class="docutils literal notranslate"><span class="pre">ExceptionLoggingFilter</span></code>）を、bean定義と<code class="docutils literal notranslate"><span class="pre">web.xml</span></code>に追加する。</p>
<ul class="simple">
<li><p><strong>applicationContext.xml</strong></p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- Filter. --&gt;</span>
<span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;exceptionLoggingFilter&quot;</span>
<span class="hll"><span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.ExceptionLoggingFilter&quot;</span><span class="w"> </span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;exceptionLogger&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;exceptionLogger&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
</span><span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ExceptionLoggingFilter</span></code>を、bean定義に追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外のログ出力を行うロガーオブジェクトを、DIする。<code class="docutils literal notranslate"><span class="pre">applicationContext.xml</span></code>に定義している“exceptionLogger”を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><p><strong>web.xml</strong></p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;filter&gt;</span>
<span class="hll"><span class="w">    </span><span class="nt">&lt;filter-name&gt;</span>exceptionLoggingFilter<span class="nt">&lt;/filter-name&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="nt">&lt;/filter-class&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
</span><span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
<span class="hll"><span class="w">    </span><span class="nt">&lt;filter-name&gt;</span>exceptionLoggingFilter<span class="nt">&lt;/filter-name&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (4) --&gt;</span>
</span><span class="nt">&lt;/filter-mapping&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">フィルター名を指定する。<code class="docutils literal notranslate"><span class="pre">applicationContext.xml</span></code>に定義した<code class="docutils literal notranslate"><span class="pre">ExceptionLoggingFilter</span></code>のbean名と、一致させる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">フィルタークラスを指定する。<code class="docutils literal notranslate"><span class="pre">org.springframework.web.filter.DelegatingFilterProxy</span></code>固定。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">マッピングするフィルターのフィルター名を指定する。(1)で指定した値。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">フィルターを適用するURLパターンを指定する。致命的なエラー、Spring MVC管理外をログ出力するため、<code class="docutils literal notranslate"><span class="pre">/*</span></code>を推奨する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><p>出力ログ</p></li>
</ul>
<blockquote>
<div><div class="highlight-guess notranslate"><div class="highlight"><pre><span></span><span class="n">date</span><span class="o">:</span><span class="mi">2013</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">25</span><span class="w"> </span><span class="mi">19</span><span class="o">:</span><span class="mi">51</span><span class="o">:</span><span class="mi">52</span><span class="w">    </span><span class="n">thread</span><span class="o">:</span><span class="n">tomcat</span><span class="o">-</span><span class="n">http</span><span class="o">--</span><span class="mi">3</span><span class="w">   </span><span class="n">X</span><span class="o">-</span><span class="n">Track</span><span class="o">:</span><span class="n">f94de92148f1489b9ceeac3b2f17c969</span><span class="w">        </span><span class="n">level</span><span class="o">:</span><span class="n">ERROR</span><span class="w">     </span><span class="n">logger</span><span class="o">:</span><span class="n">o</span><span class="o">.</span><span class="na">t</span><span class="o">.</span><span class="na">gfw</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">exception</span><span class="o">.</span><span class="na">ExceptionLogger</span><span class="w">         </span><span class="n">message</span><span class="o">:[</span><span class="n">e</span><span class="o">.</span><span class="na">xx</span><span class="o">.</span><span class="na">fw</span><span class="o">.</span><span class="mi">9001</span><span class="o">]</span><span class="w"> </span><span class="n">An</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">occurred</span><span class="w"> </span><span class="n">processing</span><span class="w"> </span><span class="n">JSP</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="sr">/WEB-INF/views/</span><span class="n">exampleJSPException</span><span class="o">.</span><span class="na">jsp</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mi">13</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="exception-handling-how-to-use-application-configuration-container-label">
<span id="id26"></span><h4><a class="toc-backref" href="#id88" role="doc-backlink"><span class="section-number">5.7.3.1.4. </span>サーブレットコンテナの設定</a><a class="headerlink" href="#exception-handling-how-to-use-application-configuration-container-label" title="Permalink to this heading">¶</a></h4>
<p>Spring MVCの、デフォルトの例外ハンドリング機能によって行われるエラー応答（HttpServletResponse#sendError）、致命的なエラー、Spring MVC管理外で発生する例外をハンドリングするために、サーブレットコンテナのError Page定義を追加する。</p>
<ul class="simple">
<li><p><strong>web.xml</strong></p></li>
</ul>
<blockquote>
<div><p>Spring MVCの、デフォルトの例外ハンドリング機能によって行われるエラー応答（HttpServletResponse#sendError）を、ハンドリングするための定義を追加する。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;error-page&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;error-code&gt;</span>404<span class="nt">&lt;/error-code&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/resourceNotFoundError.jsp<span class="nt">&lt;/location&gt;</span>
<span class="nt">&lt;/error-page&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ハンドリング対象とする <strong>HTTPレスポンスコード</strong> を指定する。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
<div class="line">Spring MVCの、デフォルトの例外ハンドリング機能で応答されるHTTPレスポンスコードについては、<a class="reference internal" href="#exception-handling-appendix-defaulthandlerexceptionresolver-label"><span class="std std-ref">DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">遷移するファイル名を指定する。Webアプリケーションルートからのパスで、指定する。上記の設定では、”${WebAppRoot}/WEB-INF/views/common/error/resourceNotFoundError.jsp”が、遷移先のファイルとなる。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
<p>致命的なエラー、Spring MVC管理外で発生する例外をハンドリングするための定義を追加する。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;error-page&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/unhandledSystemError.html<span class="nt">&lt;/location&gt;</span>
<span class="nt">&lt;/error-page&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">遷移するファイル名を指定する。Webアプリケーションルートからのパスで指定する。上記の設定では、”${WebAppRoot}/WEB-INF/views/common/error/unhandledSystemError.html”が、遷移先のファイルとなる。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>locationに指定するパスについて</strong></p>
<p>動的コンテンツのパスを指定した場合、致命的なエラーが発生していた場合に、別のエラーが発生する可能性が高くなるため、
locationには、JSPなどの動的コンテンツでなく、 <strong>HTMLなどの静的コンテンツへのパスを指定することを推奨する。</strong></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>開発中に原因が特定できないエラーが発生した場合</strong></p>
<p>上記の設定が行われている状態で想定外のエラー応答（HttpServletResponse#sendError）が発生した場合、どのようなエラー応答が発生したのか特定できないケースがある。</p>
<p>locationタグに指定したエラー画面が表示されるが、ログなどからエラーの原因を特定できない場合は、
上記設定をコメントアウトして動かすことで、発生したエラー応答(HTTPレスポンスコード)を、画面で確認することできる。</p>
<p>Spring MVC管理外で発生する例外を、個別にハンドリングする必要がある場合は、例外毎の定義を追加する。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;error-page&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (4) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;exception-type&gt;</span>java.io.IOException<span class="nt">&lt;/exception-type&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (5) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;location&gt;</span>/WEB-INF/views/common/error/systemError.jsp<span class="nt">&lt;/location&gt;</span>
<span class="nt">&lt;/error-page&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ハンドリング対象とする <strong>例外クラス名(FQCN)</strong> を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">遷移するファイル名を指定する。Webアプリケーションルートからのパスで指定する。上記の設定では、”${WebAppRoot}/WEB-INF/views/common/error/systemError.jsp”が遷移先のファイルとなる。</div>
<div class="line"><strong>【プロジェクト毎にカスタマイズする箇所】</strong></div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</section>
</section>
<section id="service">
<span id="exception-handling-how-to-use-codingpoint-service-label"></span><h3><a class="toc-backref" href="#id89" role="doc-backlink"><span class="section-number">5.7.3.2. </span>コーディングポイント（Service編）</a><a class="headerlink" href="#service" title="Permalink to this heading">¶</a></h3>
<p>例外ハンドリングを行う際の、Serviceでのコーディングポイントを、以下に示す。</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-business-label"><span class="std std-ref">ビジネス例外を発生させる</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-system-label"><span class="std std-ref">システム例外を発生させる</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-service-continue-label"><span class="std std-ref">例外をキャッチして、処理を継続させる</span></a></p></li>
</ol>
<section id="exception-handling-how-to-use-codingpoint-service-business-label">
<span id="id27"></span><h4><a class="toc-backref" href="#id90" role="doc-backlink"><span class="section-number">5.7.3.2.1. </span>ビジネス例外を発生させる</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-service-business-label" title="Permalink to this heading">¶</a></h4>
<p>ビジネス例外(BusinessException)の発生方法を、以下に示す。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>ビジネス例外の発生方法に関する注意事項</strong></p>
<ul>
<li><div class="line-block">
<div class="line">基本的には、ロジックでビジネスルールの違反を検知して、ビジネス例外を発生させる方法を推奨する。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">既存資材や、基盤機能(FWや共通機能)のAPI仕様として、ビジネスルールの違反が、例外によって通知される場合のみ、例外を捕捉してビジネス例外を発生させてもよい。</div>
<div class="line">例外を、処理フローを制御するために使用すると、処理全体の見通しが悪くなり、保守性を低下させる可能性がある。</div>
</div>
</li>
</ul>
</div>
<div class="line-block">
<div class="line">ロジックでビジネスルールの違反を検知して、ビジネス例外を発生させる。</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<ul class="simple">
<li><p>デフォルトでは、ビジネス例外は、Serviceで発生させることを想定している。<a class="reference internal" href="#exception-handling-how-to-use-service-pointcut-aop-label"><span class="std std-ref">AOPの設定</span></a>で、
<code class="docutils literal notranslate"><span class="pre">&#64;Service</span></code>アノテーションを付与したクラスで発生したビジネス例外のログを出力としている。
Controllerなどでビジネス例外は、ログを出力しない。プロジェクトでの考えがある場合は変更すること。</p></li>
</ul>
</div>
<ul class="simple">
<li><p>xxxService.java</p></li>
</ul>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="nd">@Service</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ExampleExceptionServiceImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ExampleExceptionService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">throwBisinessException</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">test</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span>
<span class="w">        </span><span class="c1">// int stockQuantity = 5;</span>
<span class="w">        </span><span class="c1">// int orderQuantity = 6;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stockQuantity</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">orderQuantity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">                  </span><span class="c1">// (1)</span>
<span class="w">            </span><span class="n">ResultMessages</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">();</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">            </span><span class="n">messages</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;e.ad.od.5001&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">stockQuantity</span><span class="p">);</span><span class="w">      </span><span class="c1">// (3)</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">messages</span><span class="p">);</span><span class="w">            </span><span class="c1">// (4)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">...</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ビジネスルールの違反がないか、チェックを行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">違反している場合、ResultMessagesを生成する。上記の実装例では、errorレベルのResultMessagesを生成している。</div>
<div class="line">ResultMessagesの生成方法の詳細については、<a class="reference internal" href="MessageManagement.html"><span class="doc">メッセージ管理</span></a>を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ResultMessagesに、ResultMessageを追加する。第1引数(必須)にメッセージIDを、第2引数(任意)にメッセージ埋め込み値を指定する。</div>
<div class="line">メッセージ埋め込み値は、可変長パラメータなので、複数指定することができる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ResultMessagesを指定して、BusinessExceptionを発生させる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>上記の <code class="docutils literal notranslate"><span class="pre">xxxService.java</span></code> は説明用に(2)-(4)に分けて処理をしているが、1ステップで実装することができる。</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">().</span><span class="na">add</span><span class="p">(</span>
<span class="w">     </span><span class="s">&quot;e.ad.od.5001&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">stockQuantity</span><span class="p">));</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
<ul>
<li><p>xxx.properties</p>
<p>参考としてプロパティの設定を記述する。</p>
<div class="highlight-properties notranslate"><div class="highlight"><pre><span></span><span class="na">e.ad.od.5001</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Order number is higher than the stock quantity={0}. Change the order number.</span>
</pre></div>
</div>
</li>
</ul>
<p>下記のようなアプリケーションログが出力される。</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">date:2013-09-17 22:25:55    thread:tomcat-http--8   X-Track:6cfb0b378c124b918e40ac0c32a1fac7        level:WARN      logger:o.t.gfw.common.exception.ExceptionLogger         message:[e.xx.fw.8001] ResultMessages [type=error, list=[ResultMessage [code=e.ad.od.5001, args=[5], text=null]]]</span>
<span class="go">org.terasoluna.gfw.common.exception.BusinessException: ResultMessages [type=error, list=[ResultMessage [code=e.ad.od.5001, args=[5], text=null]]]</span>

<span class="go">// stackTarace ommited</span>
<span class="go">...</span>

<span class="go">date:2013-09-17 22:25:55    thread:tomcat-http--8   X-Track:6cfb0b378c124b918e40ac0c32a1fac7        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Resolving exception from handler [public java.lang.String org.terasoluna.exception.app.example.ExampleExceptionController.home(java.util.Locale,org.springframework.ui.Model)]: org.terasoluna.gfw.common.exception.BusinessException: ResultMessages [type=error, list=[ResultMessage [code=e.ad.od.5001, args=[5], text=null]]]</span>
<span class="go">date:2013-09-17 22:25:55    thread:tomcat-http--8   X-Track:6cfb0b378c124b918e40ac0c32a1fac7        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Resolving to view &#39;common/error/businessError&#39; for exception of type [org.terasoluna.gfw.common.exception.BusinessException], based on exception mapping [BusinessException]</span>
<span class="go">date:2013-09-17 22:25:55    thread:tomcat-http--8   X-Track:6cfb0b378c124b918e40ac0c32a1fac7        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Applying HTTP status code 409</span>
<span class="go">date:2013-09-17 22:25:55    thread:tomcat-http--8   X-Track:6cfb0b378c124b918e40ac0c32a1fac7        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Exposing Exception as model attribute &#39;exception&#39;</span>
</pre></div>
</div>
</div></blockquote>
<p>表示される画面</p>
<blockquote>
<div><figure class="align-default">
<a class="reference internal image-reference" href="../_images/exception-handling-screen-businessexception.png"><img alt="screen business exception" src="../_images/exception-handling-screen-businessexception.png" style="width: 50%;" /></a>
</figure>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>ビジネス例外は、Controllerでハンドリングし、各業務画面でメッセージを表示させることを推奨する。
上記例は、Controllerでハンドリングしなかった場合に、表示される画面となる。</p>
</div>
</div></blockquote>
<p>例外を捕捉して、ビジネス例外を発生させる</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">order</span><span class="p">(</span><span class="n">orderQuantity</span><span class="p">,</span><span class="w"> </span><span class="n">itemId</span><span class="w"> </span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">StockNotEnoughException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">                  </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResultMessages</span><span class="p">.</span><span class="na">error</span><span class="p">().</span><span class="na">add</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;e.ad.od.5001&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getStockQuantity</span><span class="p">()),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ビジネスルールに違反した際に、発生する例外を捕捉する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ResultMessagesと、<strong>原因例外(e)</strong>を指定して、BusinessExceptionを発生させる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="exception-handling-how-to-use-codingpoint-service-system-label">
<span id="id28"></span><h4><a class="toc-backref" href="#id91" role="doc-backlink"><span class="section-number">5.7.3.2.2. </span>システム例外を発生させる</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-service-system-label" title="Permalink to this heading">¶</a></h4>
<p>システム例外(SystemException)の発生方法を、以下に示す。</p>
<p>ロジックで、システム異常を検知し、システム例外を発生させる。</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">itemEntity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">                                      </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SystemException</span><span class="p">(</span><span class="s">&quot;e.ad.od.9012&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;not found item entity. item code [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">itemId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;].&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">システムが、正常な状態であることをチェックする。</div>
<div class="line">ここでは、例として、リクエストされた商品コード（itemId）が、商品マスタ（Item Mastar）上に存在するかチェックし、</div>
<div class="line">存在しない場合、システムで用意するべきリソースがないと判断して、システムエラーにしている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">システムが異常な状態の場合、第1引数に例外コード(メッセージID)を指定する。第2引数に例外メッセージを指定して、SystemExceptionを発生させる。</div>
<div class="line">上記の実装例では、メッセージ本文に、変数”itemId”の値を埋め込んでいる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>下記のような、アプリケーションログが出力される。</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">date:2013-09-19 21:03:06      thread:tomcat-http--3   X-Track:c19eec546b054d54a13658f94292b24f        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Resolving exception from handler [public java.lang.String org.terasoluna.exception.app.example.ExampleExceptionController.home(java.util.Locale,org.springframework.ui.Model)]: org.terasoluna.gfw.common.exception.SystemException: not found item entity. item code [10-123456].</span>
<span class="go">date:2013-09-19 21:03:06      thread:tomcat-http--3   X-Track:c19eec546b054d54a13658f94292b24f        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Resolving to default view &#39;common/error/systemError&#39; for exception of type [org.terasoluna.gfw.common.exception.SystemException]</span>
<span class="go">date:2013-09-19 21:03:06      thread:tomcat-http--3   X-Track:c19eec546b054d54a13658f94292b24f        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Applying HTTP status code 500</span>
<span class="go">date:2013-09-19 21:03:06      thread:tomcat-http--3   X-Track:c19eec546b054d54a13658f94292b24f        level:DEBUG     logger:o.t.gfw.web.exception.SystemExceptionResolver    message:Exposing Exception as model attribute &#39;exception&#39;</span>
<span class="go">date:2013-09-19 21:03:06      thread:tomcat-http--3   X-Track:c19eec546b054d54a13658f94292b24f        level:ERROR     logger:o.t.gfw.common.exception.ExceptionLogger         message:[e.ad.od.9012] not found item entity. item code [10-123456].</span>
<span class="go">org.terasoluna.gfw.common.exception.SystemException: not found item entity. item code [10-123456].</span>
<span class="go">      at org.terasoluna.exception.domain.service.ExampleExceptionServiceImpl.throwSystemException(ExampleExceptionServiceImpl.java:14) ~[ExampleExceptionServiceImpl.class:na]</span>
<span class="go">...</span>
<span class="go">// stackTarace ommited</span>
</pre></div>
</div>
</div></blockquote>
<p>表示される画面</p>
<blockquote>
<div><figure class="align-default">
<a class="reference internal image-reference" href="../_images/exception-handling-screen-systemexception.png"><img alt="screen system exception" src="../_images/exception-handling-screen-systemexception.png" style="width: 60%;" /></a>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>システムエラー画面は、個別に用意せず、共通的に決めることを推奨する。</p>
<p>本ガイドラインの画面では、システムエラーのためのメッセージID（業務毎）を表示し、文言は固定にしている。
その理由は、オペレータに対して、エラーの細かい内容を知らせる必要がなく、システムに異常があることだけを伝えればよいためである。
そこで、開発側では、解析を簡易にするために、キーとなるメッセージIDを画面に表示して、システム異常の問い合わせに対するレスポンスを向上しようとしている。
表示される画面については、各プロジェクトでUI規約に従い、用意すること。</p>
</div>
</div></blockquote>
<p>例外を捕捉して、システム例外を発生させる</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">preUploadDir</span><span class="p">.</span><span class="na">getFile</span><span class="p">(),</span><span class="w"> </span><span class="n">key</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">FileNotFoundException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SystemException</span><span class="p">(</span><span class="s">&quot;e.ad.od.9007&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;not found upload file. file is [&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">preUploadDir</span><span class="p">.</span><span class="na">getDescription</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;].&quot;</span>
<span class="w">        </span><span class="n">e</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">システム異常に分類される検査例外を捕捉する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外コード(メッセージID)、メッセージ、<strong>原因例外(e)</strong>を指定して、SystemExceptionを発生させる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="exception-handling-how-to-use-codingpoint-service-continue-label">
<span id="id29"></span><h4><a class="toc-backref" href="#id92" role="doc-backlink"><span class="section-number">5.7.3.2.3. </span>例外をキャッチして、処理を継続させる</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-service-continue-label" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">例外をキャッチして、処理を継続させる必要がある場合、発生した例外をログに出力してから、処理を継続するようにする。</div>
</div>
<div class="line-block">
<div class="line">下記は、外部システムから、顧客対応履歴の取得に失敗した場合に、顧客対応履歴以外の情報を取得する処理を、継続する場合の例である。</div>
<div class="line">この例では、顧客対応履歴の情報が取得できなくても、業務は継続できるため、処理を継続している。</div>
</div>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Inject</span>
<span class="n">ExceptionLogger</span><span class="w"> </span><span class="n">exceptionLogger</span><span class="p">;</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="c1">// ...</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">InteractionHistory</span><span class="w"> </span><span class="n">interactionHistory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">interactionHistory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplete</span><span class="p">.</span><span class="na">getForObject</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span><span class="w"> </span><span class="n">InteractionHistory</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">customerId</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RestClientException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="n">exceptionLogger</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="p">}</span>

<span class="c1">// (4)</span>
<span class="n">Customer</span><span class="w"> </span><span class="n">customer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">customerRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">customerId</span><span class="p">);</span>

<span class="c1">// ...</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">共通ライブラリで提供している<code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.common.exception.ExceptionLogger</span></code>をログ出力するため、オブジェクトをDIする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ハンドリング対象の例外を、キャッチする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ハンドリングした例外を、ログに出力する。例では、logメソッドを呼び出しているが、出力レベルが決まっており、</div>
<div class="line">後に変更する可能性がない場合は、info、warn、errorメソッドを直接呼び出してもよい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(3)でログを出力したのみで、処理を継続する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>下記のような、アプリケーションログが出力される。</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">date:2013-09-19 21:31:47      thread:tomcat-http--3   X-Track:df5271ece2304b12a2c59ff494806397        level:ERROR     logger:o.t.gfw.common.exception.ExceptionLogger         message:[e.xx.fw.9001] Test example exception</span>
<span class="go">org.springframework.web.client.RestClientException: Test example exception</span>
<span class="go">...</span>
<span class="go">// stackTarace ommited</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code class="docutils literal notranslate"><span class="pre">exceptionLogger</span></code>で、log()を使用した場合には、errorレベルで出力されるため、デフォルトで監視ログにも出力される。</p>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">date:2013-09-19 21:31:47  X-Track:df5271ece2304b12a2c59ff494806397        level:ERROR     message:[e.xx.fw.9001] Test example exception</span>
</pre></div>
</div>
</div></blockquote>
<p>次の例のように、処理を継続させて問題ない場合に、運用監視で監視ログを監視している場合は、出力レベルで監視されないレベルにするか、メッセージから監視されないよう定義が必要である。</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RestClientException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">exceptionLogger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">デフォルトの設定では、errorレベル以外の監視ログは出力されない。アプリケーションログには、以下のように出力される。</div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">date:2013-09-19 22:17:53    thread:tomcat-http--3   X-Track:999725b111b4445b8d10b4ea44639c61        level:INFO      logger:o.t.gfw.common.exception.ExceptionLogger         message:[e.xx.fw.9001] Test example exception</span>
<span class="go">org.springframework.web.client.RestClientException: Test example exception</span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>
<section id="exception-handling-how-to-use-codingpoint-contoller-label">
<span id="id30"></span><h3><a class="toc-backref" href="#id93" role="doc-backlink"><span class="section-number">5.7.3.3. </span>コーディングポイント（Controller編）</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-contoller-label" title="Permalink to this heading">¶</a></h3>
<p>例外ハンドリングを行う際の、Controllerでのコーディングポイントを、以下に示す。</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-contoller-request-label"><span class="std std-ref">リクエスト単位で例外をハンドリングする方法</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-contoller-usecase-label"><span class="std std-ref">ユースケース単位で例外をハンドリングする方法</span></a></p></li>
</ol>
<section id="exception-handling-how-to-use-codingpoint-contoller-request-label">
<span id="id31"></span><h4><a class="toc-backref" href="#id94" role="doc-backlink"><span class="section-number">5.7.3.3.1. </span>リクエスト単位で例外をハンドリングする方法</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-contoller-request-label" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">例外をリクエスト単位でハンドリングし、引き継ぎ情報（メッセージ情報）を、Modelに設定する。</div>
<div class="line">その後、遷移する画面を表示するためのメソッドを呼び出すことで、遷移先で必要なモデルを生成し、View名を決定する。</div>
</div>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;change&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">change</span><span class="p">(</span><span class="nd">@Validated</span><span class="w"> </span><span class="n">UserForm</span><span class="w"> </span><span class="n">userForm</span><span class="p">,</span>
<span class="w">                     </span><span class="n">BindingResult</span><span class="w"> </span><span class="n">result</span><span class="p">,</span>
<span class="w">                     </span><span class="n">RedirectAttributes</span><span class="w"> </span><span class="n">redirectAttributes</span><span class="p">,</span>
<span class="w">                     </span><span class="n">Model</span><span class="w"> </span><span class="n">model</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">         </span><span class="c1">// (1)</span>

<span class="w">    </span><span class="c1">// omitted</span>

<span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userHelper</span><span class="p">.</span><span class="na">convertToUser</span><span class="p">(</span><span class="n">userForm</span><span class="p">);</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">userService</span><span class="p">.</span><span class="na">change</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">BusinessException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">                                   </span><span class="c1">// (2)</span>
<span class="w">        </span><span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getResultMessages</span><span class="p">());</span><span class="w">                    </span><span class="c1">// (3)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">viewChangeForm</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">model</span><span class="p">);</span><span class="w">               </span><span class="c1">// (4)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">エラー情報を、Viewと連携するためのオブジェクトとして、Modelを引数に定義する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ハンドリング対象となる例外を、アプリケーションコードで捕捉する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ResultMessagesオブジェクトを、Modelに追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">エラー時の遷移先を表示するためのメソッドを呼び出し、View表示に必要なモデルと、View名を取得した後に、表示するView名を返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="exception-handling-how-to-use-codingpoint-contoller-usecase-label">
<span id="id32"></span><h4><a class="toc-backref" href="#id95" role="doc-backlink"><span class="section-number">5.7.3.3.2. </span>ユースケース単位で例外をハンドリングする方法</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-contoller-usecase-label" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">例外を、ユースケース単位でハンドリングし、引き継ぎ情報（メッセージ情報など）が格納されたModelMap（ExtendedModelMap）を生成する。</div>
<div class="line">その後、遷移する画面を表示するためのメソッドを呼び出すことで、遷移先で必要なモデルを生成し、View名を決定する。</div>
</div>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">BusinessException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">)</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">ModelAndView</span><span class="w"> </span><span class="nf">handdleBusinessException</span><span class="p">(</span><span class="n">BusinessException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ExtendedModelMap</span><span class="w"> </span><span class="n">modelMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ExtendedModelMap</span><span class="p">();</span><span class="w">                 </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="n">modelMap</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getResultMessages</span><span class="p">());</span><span class="w">                       </span><span class="c1">// (4)</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">viewName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top</span><span class="p">(</span><span class="n">modelMap</span><span class="p">);</span><span class="w">                                    </span><span class="c1">// (5)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ModelAndView</span><span class="p">(</span><span class="n">viewName</span><span class="p">,</span><span class="w"> </span><span class="n">modelMap</span><span class="p">);</span><span class="w">                        </span><span class="c1">// (6)</span>
<span class="p">}</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&#64;ExceptionHandler</span></code>アノテーションのvalue属性に、ハンドリング対象とする例外クラスを指定する。ハンドリング対象とする例外は、複数指定することもできる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&#64;ResponseStatus</span></code>アノテーションの、value属性に返却するHTTPステータスコードを指定する。例では、「409:Conflict」を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">エラー情報と、モデル情報を、Viewと連携するためのオブジェクトとして、ExtendedModelMapを生成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ResultMessagesオブジェクトを、ExtendedModelMapに追加する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">エラー時の遷移先を表示するためのメソッドを呼び出し、View表示に必要なモデルと、View名を取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">(3)-(5)の処理で取得したView名と、Modelが格納されているModelAndViewを生成し、返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
</section>
<section id="exception-handling-how-to-use-codingpoint-jsp-label">
<span id="id33"></span><h3><a class="toc-backref" href="#id96" role="doc-backlink"><span class="section-number">5.7.3.4. </span>コーディングポイント（JSP編）</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-jsp-label" title="Permalink to this heading">¶</a></h3>
<p>例外ハンドリングを行う際の、JSPでのコーディングポイントを、以下に示す。</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-jsp-panel-label"><span class="std std-ref">MessagesPanelTagを使用して、メッセージを画面表示する方法</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-how-to-use-codingpoint-jsp-exceptioncode-label"><span class="std std-ref">システム例外の例外コードを、画面表示する方法</span></a></p></li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Internet Explorerがサポートブラウザとなっている場合は、
エラー画面として応答するHTMLのサイズが513バイト以上になるように実装する必要がある。</p>
<p>Internet Explorerでは、</p>
<ul class="simple">
<li><p>応答されたステータスコードがエラー系(4xxと5xx)</p></li>
<li><p>応答されたHTMLが512バイト以下</p></li>
<li><p>ブラウザの設定が「HTTP簡易メッセージを表示する」が有効な状態</p></li>
</ul>
<p>という３つの条件を充たした際に、Internet Explorerが用意している簡易メッセージが表示される仕組みになっているためである。</p>
</div>
<section id="messagespaneltag">
<span id="exception-handling-how-to-use-codingpoint-jsp-panel-label"></span><h4><a class="toc-backref" href="#id97" role="doc-backlink"><span class="section-number">5.7.3.4.1. </span>MessagesPanelTagを使用して、メッセージを画面表示する方法</a><a class="headerlink" href="#messagespaneltag" title="Permalink to this heading">¶</a></h4>
<p>任意の場所に、ResultMessagesを出力する際の実装例を、以下に示す。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;t:messagesPanel</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p>メッセージを出力したい場所に、&lt;t:messagesPanel&gt;タグを指定する。 &lt;t:messagesPanel&gt;タグの使用方法の詳細については、<a class="reference internal" href="MessageManagement.html"><span class="doc">メッセージ管理</span></a>を参照されたい。</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="exception-handling-how-to-use-codingpoint-jsp-exceptioncode-label">
<span id="id34"></span><h4><a class="toc-backref" href="#id98" role="doc-backlink"><span class="section-number">5.7.3.4.2. </span>システム例外の例外コードを、画面表示する方法</a><a class="headerlink" href="#exception-handling-how-to-use-codingpoint-jsp-exceptioncode-label" title="Permalink to this heading">¶</a></h4>
<p>任意の場所に、例外コード(メッセージID)と、固定メッセージを表示する際の実装例を、以下に示す。</p>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;p&gt;</span>
<span class="w">    </span><span class="nt">&lt;c:if</span><span class="w"> </span><span class="na">test=</span><span class="s">&quot;${!empty exceptionCode}&quot;</span><span class="nt">&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">        </span>[${f:h(exceptionCode)}]<span class="w">            </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;/c:if&gt;</span>
<span class="w">    </span><span class="nt">&lt;spring:message</span><span class="w"> </span><span class="na">code=</span><span class="s">&quot;e.cm.fw.9999&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外コード(メッセージID)の存在チェックを行う。上記の実装例のように、記号などで例外コード(メッセージID)を囲む場合は、存在チェックを行うこと。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外コード(メッセージID)を出力する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">メッセージ定義より取得した、固定メッセージを出力する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><p>出力画面（exceptionCode有り）</p></li>
</ul>
<blockquote>
<div><figure class="align-default">
<a class="reference internal image-reference" href="../_images/exception-handling-screen-systemexception-messagecode.png"><img alt="screen system exception messagecode" src="../_images/exception-handling-screen-systemexception-messagecode.png" style="width: 40%;" /></a>
</figure>
</div></blockquote>
<ul class="simple">
<li><p>出力画面（exceptionCode無し）</p></li>
</ul>
<blockquote>
<div><figure class="align-default">
<a class="reference internal image-reference" href="../_images/exception-handling-screen-systemexceptionbyjspexception.png"><img alt="screen system exception no messagecode" src="../_images/exception-handling-screen-systemexceptionbyjspexception.png" style="width: 40%;" /></a>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>システム例外時に出力するメッセージについて</strong></p>
<ul class="simple">
<li><p>システム例外が発生した場合、エラー原因が特定できる、または推測できる詳細メッセージを出力せず、システム例外が発生したことだけを伝えるメッセージを表示することを推奨する。</p></li>
<li><p>エラー原因が特定できる、または推測できる詳細メッセージを表示した場合、システムの脆弱性を公開してしまう可能性がある。</p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>例外コード(メッセージID)について</strong></p>
<ul class="simple">
<li><p>システム例外が発生した場合、詳細メッセージの代わりに、例外コード(メッセージID)を出力することを推奨する。</p></li>
<li><p>例外コード(メッセージID)を出力することで、システム利用者からの問い合わせに、素早く対応することができる。</p></li>
<li><p>例外コード(メッセージID)からエラー原因を特定できるのは、システム管理者だけなので、システムの脆弱性を公開する危険性は少なくなる。</p></li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
</section>
</section>
<section id="how-to-use-ajax">
<h2><a class="toc-backref" href="#id99" role="doc-backlink"><span class="section-number">5.7.4. </span>How to use (Ajax)</a><a class="headerlink" href="#how-to-use-ajax" title="Permalink to this heading">¶</a></h2>
<p>Ajaxの例外ハンドリングについては、<a class="reference internal" href="Ajax.html"><span class="doc">Ajax</span></a>を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="appendix">
<h2><a class="toc-backref" href="#id100" role="doc-backlink"><span class="section-number">5.7.5. </span>Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#exception-handling-about-classes-of-library-label"><span class="std std-ref">共通ライブラリから提供している例外ハンドリング用のクラスについて</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-about-systemexceptionresolver-label"><span class="std std-ref">SystemExceptionResolverの設定項目について</span></a></p></li>
<li><p><a class="reference internal" href="#exception-handling-appendix-defaulthandlerexceptionresolver-label"><span class="std std-ref">DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</span></a></p></li>
</ol>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="exception-handling-about-classes-of-library-label">
<span id="id35"></span><h3><a class="toc-backref" href="#id101" role="doc-backlink"><span class="section-number">5.7.5.1. </span>共通ライブラリから提供している例外ハンドリング用のクラスについて</a><a class="headerlink" href="#exception-handling-about-classes-of-library-label" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line">Spring MVCが提供しているクラスとは別に、共通ライブラリより例外ハンドリングを行うためのクラスを提供している。</div>
<div class="line">クラスの役割は、以下の通りである。</div>
</div>
<table class="docutils align-default" id="id56">
<caption><span class="caption-text"><strong>表- org.terasoluna.gfw.common.exception パッケージ配下のクラス</strong></span><a class="headerlink" href="#id56" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 11%" />
<col style="width: 21%" />
<col style="width: 68%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>クラス</p></th>
<th class="head"><p>役割</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ExceptionCode</div>
<div class="line">Resolver</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外クラスに対応する例外コード（メッセージID）を解決するためのインタフェース。</div>
<div class="line">例外コードとは、どのような例外が発生したのかを識別するためのコードで、システムエラー画面や、ログに出力することを想定している。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ExceptionLogger</span></code>、<code class="docutils literal notranslate"><span class="pre">SystemExceptionResolver</span></code>などから参照される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">SimpleMapping</div>
<div class="line">ExceptionCode</div>
<div class="line">Resolver</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ExceptionCodeResolver</span></code>の実装クラスで、例外クラスの名前と、例外コードのマッピングを保持することで、例外コードの解決を実現する。</div>
<div class="line">例外クラスの名前は、FQCNではなく、FQCNの一部や、親クラスの名前でもよい。</div>
</div>
<blockquote>
<div><div class="admonition warning">
<p class="admonition-title">Warning</p>
<ul class="simple">
<li><p>FQCNの一部を指定した場合、場合によっては想定していなかったクラスとマッチしてしまうことがあるので注意が必要である。</p></li>
<li><p>親クラスの名前を指定した場合、全ての子クラスがマッチするので注意が必要である。</p></li>
</ul>
</div>
</div></blockquote>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">enums.</div>
<div class="line">ExceptionLevel</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外クラスに対応する例外レベルを表現するenum。</div>
<div class="line">INFO, WARN, ERRORが定義されている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ExceptionLevel</div>
<div class="line">Resolver</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外クラスに対応する例外レベル（ログレベル）を解決するためのインタフェース。</div>
<div class="line">例外レベルとは、どのようなレベルの例外が発生したのかを識別するためのコードで、ログの出力レベルを切り替えるために使われる。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ExceptionLogger</span></code> から参照される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">DefaultException</div>
<div class="line">LevelResolver</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ExceptionLevelResolver</span></code> の実装クラスで、例外コードの先頭１文字で、例外レベルを解決している。</div>
<div class="line">先頭の１文字目（case insensitive）が、</div>
<div class="line-block">
<div class="line">1. “i”の場合は <code class="docutils literal notranslate"><span class="pre">ExceptionLevel.INFO</span></code></div>
<div class="line">2. “w”の場合は <code class="docutils literal notranslate"><span class="pre">ExceptionLevel.WARN</span></code></div>
<div class="line">3. “e”の場合は <code class="docutils literal notranslate"><span class="pre">ExceptionLevel.ERROR</span></code></div>
<div class="line">4. 上記以外の場合は <code class="docutils literal notranslate"><span class="pre">ExceptionLevel.ERROR</span></code></div>
</div>
<div class="line">レベルとして扱う。</div>
<div class="line">本クラスは、<a class="reference internal" href="MessageManagement.html"><span class="doc">メッセージ</span></a>のガイドラインに記載されている、メッセージIDのルールに則った実装となっている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ExceptionLogger</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外をログ出力するためのクラス。</div>
<div class="line">監視ログ(メッセージのみ)と、アプリケーションログ(メッセージと、スタックトレースの両方)を出力することができる。</div>
<div class="line">本クラスは、フレームワークより提供しているFilterや、Interceptorクラスから使用されている。</div>
<div class="line">アプリケーションコードで、例外をハンドリングして処理を継続する場合、本クラスを用いて、ログを出力すること。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ResultMessages</div>
<div class="line">LoggingInterceptor</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ResultMessages</span></code>を保持している例外(<code class="docutils literal notranslate"><span class="pre">ResultMessagesNotificationException</span></code>のサブ例外 )が発生した事をログに出力するためのInterceptorクラス。</div>
<div class="line">ログは全てWARNレベルで出力する。</div>
<div class="line">本Interceptorは、 <code class="docutils literal notranslate"><span class="pre">&#64;Service</span></code> アノテーションが付与されているクラスのメソッドに対して適用することを想定している。</div>
<div class="line">ログは、<code class="docutils literal notranslate"><span class="pre">ExceptionLogger</span></code>を使用して出力している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">BusinessException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ビジネスルールの違反を検知したことを通知するための例外クラスで、ドメイン層のロジックで発生させる例外である。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">java.lang.RumtimeException</span></code>を継承しているため、デフォルトの動作として、トランザクションは、ロールバックされる。</div>
<div class="line">トランザクションをコミットしたい場合は、<code class="docutils literal notranslate"><span class="pre">&#64;Transactional</span></code>アノテーションの noRollbackFor 、または noRollbackForClassName に、本例外クラスを指定する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">Resource</div>
<div class="line">NotFoundException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">指定されたリソース（データ）が、システム内に存在しないことを通知するための例外クラスで、主に、ドメイン層のロジックで発生させる例外である。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">java.lang.RumtimeException</span></code> を継承しているため、デフォルトの動作として、トランザクションは、ロールバックされる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ResultMessages</div>
<div class="line">Notification</div>
<div class="line">Exception</div>
</div>
</td>
<td><div class="line-block">
<div class="line">結果メッセージ（<code class="docutils literal notranslate"><span class="pre">ResultMessages</span></code>）を保持している例外であることを通知するための抽象例外クラスで、共通ライブラリでは、<code class="docutils literal notranslate"><span class="pre">BusinessException</span></code>と、<code class="docutils literal notranslate"><span class="pre">ResourceNotFoundException</span></code>が継承している。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">java.lang.RumtimeException</span></code>を継承しているため、デフォルトの動作としてはトランザクションはロールバックされる。</div>
<div class="line">本例外クラスを継承すると、<code class="docutils literal notranslate"><span class="pre">ResultMessagesLoggingInterceptor</span></code>によって、warnレベルのログが出力される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">SystemException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">システム又はアプリケーションの異常を検知した事を通知するための例外クラスで、アプリケーション層又はドメイン層のロジックで発生させる例外である。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">java.lang.RumtimeException</span></code>を継承しているため、デフォルトの動作として、トランザクションは、ロールバックされる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ExceptionCodeProvider</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外コードを保持する役割があることを示すインタフェースで、共通ライブラリでは、<code class="docutils literal notranslate"><span class="pre">SystemException</span></code>が実装している。</div>
<div class="line">本インタフェースを実装した例外クラスを作成すると、共通ライブラリから提供している例外ハンドリング処理にて、例外で保持している例外コードで、そのまま使われる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="id57">
<caption><span class="caption-text"><strong>表- org.terasoluna.gfw.web.exception パッケージ配下のクラス</strong></span><a class="headerlink" href="#id57" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 11%" />
<col style="width: 21%" />
<col style="width: 68%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>クラス</p></th>
<th class="head"><p>役割</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">SystemException</div>
<div class="line">Resolver</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;mvc:annotation-driven&gt;</span></code>を指定した際に、自動的に登録される<code class="docutils literal notranslate"><span class="pre">HanlderExceptionResolver</span></code>によって、ハンドリングされない例外をハンドリングするためのクラス。</div>
<div class="line">Spring MVCより提供されている<code class="docutils literal notranslate"><span class="pre">SimpleMappingExceptionResolver</span></code>を継承し、例外コードのResultMessagesを、Viewから参照できるように機能追加を行っている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">HandlerException</div>
<div class="line">ResolverLogging</div>
<div class="line">Interceptor</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HandlerExceptionResolver</span></code>でハンドリングされた例外を、ログに出力するためのInterceptorクラス。</div>
<div class="line">本Interceptorクラスでは、<code class="docutils literal notranslate"><span class="pre">HandlerExceptionResolver</span></code>で解決されたHTTPレスポンスコードの分類に応じて、ログの出力レベルを切り替えている。</div>
<div class="line-block">
<div class="line">1. “100-399”の場合は、 INFOレベルで出力する。</div>
<div class="line">2. “400-499”の場合は、 WARNレベルで出力する。</div>
<div class="line">3. “500-“の場合は ERRORレベルで出力する。</div>
<div class="line">4. “-99”の場合は ログ出力しない。</div>
</div>
<div class="line">本Interceptorを使用することで、Spring MVC管理下で発生する全ての例外を、ログに出力することができる。</div>
<div class="line">ログは、<code class="docutils literal notranslate"><span class="pre">ExceptionLogger</span></code>を使用して出力している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ExceptionLogging</div>
<div class="line">Filter</div>
</div>
</td>
<td><div class="line-block">
<div class="line">致命的なエラー、Spring MVC管理外で発生する例外を、ログに出力するためのFilterクラス。</div>
<div class="line">ログは、すべてERRORレベルで出力する。</div>
<div class="line">本Filterを使用した場合、致命的なエラー、およびSpring MVC管理外で発生するすべての例外を、ログに出力することができる。</div>
<div class="line">ログは、<code class="docutils literal notranslate"><span class="pre">ExceptionLogger</span></code>を使用して出力している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="systemexceptionresolver">
<span id="exception-handling-about-systemexceptionresolver-label"></span><h3><a class="toc-backref" href="#id102" role="doc-backlink"><span class="section-number">5.7.5.2. </span>SystemExceptionResolverの設定項目について</a><a class="headerlink" href="#systemexceptionresolver" title="Permalink to this heading">¶</a></h3>
<p>本編で説明していない設定項目について、説明する。
要件に応じて、設定を行うこと。</p>
<table class="docutils align-default" id="id58">
<caption><span class="caption-text"><strong>本編で説明していない設定項目一覧</strong></span><a class="headerlink" href="#id58" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 5%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 45%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>項目名</p></th>
<th class="head"><p>プロパティ名</p></th>
<th class="head"><p>説明</p></th>
<th class="head"><p>デフォルト値</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">結果メッセージの属性名</div>
</div>
</td>
<td><div class="line-block">
<div class="line">resultMessagesAttribute</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ビジネス例外に設定されているメッセージ情報として、モデルに設定する際の属性名(String)を指定する。</div>
<div class="line">View(JSP)から結果メッセージにアクセスする際の、属性名となる。</div>
</div>
</td>
<td><p>resultMessages</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外コード(メッセージID)の属性名</div>
</div>
</td>
<td><div class="line-block">
<div class="line">exceptionCode</div>
<div class="line">Attribute</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外コード(メッセージID)として、HttpServletRequestに設定する際の属性名(String)を指定する。</div>
<div class="line">View(JSP)から例外コード(メッセージID)にアクセスする際の属性名となる。</div>
</div>
</td>
<td><p>exceptionCode</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外コード(メッセージID)のヘッダー名</div>
</div>
</td>
<td><div class="line-block">
<div class="line">exceptionCode</div>
<div class="line">Header</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外コード(メッセージID)として、HttpServletResponseのレスポンスヘッダーに設定する際のヘッダー名(String)を指定する。</div>
</div>
</td>
<td><p>X-Exception-Code</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外オブジェクトの属性名</div>
</div>
</td>
<td><div class="line-block">
<div class="line">exceptionAttribute</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ハンドリングした例外オブジェクトとして、モデルに設定する際の属性名(String)を指定する。</div>
<div class="line">View(JSP)から例外オブジェクトにアクセスする際の属性名となる。</div>
</div>
</td>
<td><p>exception</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">本ExceptionResolverとして、使用するハンドラー(Controller)のオブジェクト一覧</div>
</div>
</td>
<td><div class="line-block">
<div class="line">mappedHandlers</div>
</div>
</td>
<td><div class="line-block">
<div class="line">本ExceptionResolverを使用するハンドラーの、オブジェクト一覧(Set)を指定する。</div>
<div class="line">指定したハンドラーオブジェクトで発生した例外のみ、ハンドリングが行われる。</div>
<div class="line"><strong>この設定項目は指定してはいけない。</strong></div>
</div>
</td>
<td><div class="line-block">
<div class="line">指定なし</div>
<div class="line"><br /></div>
<div class="line"><strong>指定した場合の動作は、保証しない。</strong></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">本ExceptionResolverを使用するハンドラー(Controller)のクラス一覧</div>
</div>
</td>
<td><div class="line-block">
<div class="line">mappedHandlerClasses</div>
</div>
</td>
<td><div class="line-block">
<div class="line">本ExceptionResolverを使用するハンドラーのクラス一覧(Class[])を指定する。</div>
<div class="line">指定したハンドラークラスで発生した例外のみハンドリングが行われる。</div>
<div class="line"><strong>この設定項目は指定してはいけない。</strong></div>
</div>
</td>
<td><div class="line-block">
<div class="line">指定なし</div>
<div class="line"><br /></div>
<div class="line"><strong>指定した場合の動作は、保証しない。</strong></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">HTTPレスポンスのキャッシュ制御有無</div>
</div>
</td>
<td><div class="line-block">
<div class="line">preventResponseCaching</div>
</div>
</td>
<td><div class="line-block">
<div class="line">HTTPレスポンス時のキャッシュ制御の有無(true:有 false:無)を指定する。</div>
<div class="line">true:有を指定すると、キャッシュを無効にするためのHTTPレスポンスヘッダーが追加される。</div>
</div>
</td>
<td><div class="line-block">
<div class="line">false:無</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line">(1)-(3)は、<code class="docutils literal notranslate"><span class="pre">org.terasoluna.gfw.web.exception.SystemExceptionResolver</span></code>の設定項目。</div>
<div class="line">(4)は、<code class="docutils literal notranslate"><span class="pre">org.springframework.web.servlet.handler.SimpleMappingExceptionResolver</span></code>の設定項目。</div>
<div class="line">(5)-(7)は、<code class="docutils literal notranslate"><span class="pre">org.springframework.web.servlet.handler.AbstractHandlerExceptionResolver</span></code>の設定項目。</div>
</div>
<section id="id36">
<h4><a class="toc-backref" href="#id103" role="doc-backlink"><span class="section-number">5.7.5.2.1. </span>結果メッセージの属性名</a><a class="headerlink" href="#id36" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">SystemExceptionResolverでハンドリングして設定したメッセージと、アプリケーションコードでハンドリングして設定したメッセージを、View(JSP)で別のmessagesPanelとして出力したい場合は、SystemExceptionResolver専用の属性名を指定する。</div>
<div class="line">下記に示す例は、デフォルト値から「resultMessagesForExceptionResolver」に変更する場合の、設定&amp;実装例である。</div>
</div>
<ul>
<li><p><strong>spring-mvc.xml</strong></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>

<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;resultMessagesAttribute&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;resultMessagesForExceptionResolver&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</li>
<li><p><strong>jsp</strong></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;t:messagesPanel</span><span class="w"> </span><span class="na">messagesAttributeName=</span><span class="s">&quot;resultMessagesForExceptionResolver&quot;</span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">結果メッセージの属性名(resultMessagesAttribute)に、”resultMessagesForExceptionResolver”を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">メッセージ属性名(messagesAttributeName)に、SystemExceptionResolverで設定した属性名を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id">
<h4><a class="toc-backref" href="#id104" role="doc-backlink"><span class="section-number">5.7.5.2.2. </span>例外コード(メッセージID)の属性名</a><a class="headerlink" href="#id" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">デフォルトの属性名をアプリケーションコードで使用している場合は、重複を避けるために、別の値を設定すること。重複がない場合は、デフォルト値を変更する必要はない。</div>
<div class="line">下記は、デフォルト値から、「exceptionCodeForExceptionResolver」に変更する場合の、設定&amp;実装例である。</div>
</div>
<ul>
<li><p><strong>spring-mvc.xml</strong></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>

<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;exceptionCodeAttribute&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;exceptionCodeForExceptionResolver&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</li>
<li><p><strong>jsp</strong></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;p&gt;</span>
<span class="w">    </span><span class="nt">&lt;c:if</span><span class="w"> </span><span class="na">test=</span><span class="s">&quot;${!empty exceptionCodeForExceptionResolver}&quot;</span><span class="nt">&gt;</span><span class="w">  </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">        </span>[${f:h(exceptionCodeForExceptionResolver)}]<span class="w">            </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;/c:if&gt;</span>
<span class="w">    </span><span class="nt">&lt;spring:message</span><span class="w"> </span><span class="na">code=</span><span class="s">&quot;e.cm.fw.9999&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外コード(メッセージID)の属性名(exceptionCodeAttribute)に、”exceptionCodeForExceptionResolver”を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">SystemExceptionResolverに設定した値(exceptionCodeForExceptionResolver)を、テスト対象(空チェック対応)の変数名として指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">SystemExceptionResolverに設定した値(exceptionCodeForExceptionResolver)を、出力対象の変数名として指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id37">
<h4><a class="toc-backref" href="#id105" role="doc-backlink"><span class="section-number">5.7.5.2.3. </span>例外コード(メッセージID)のヘッダー名</a><a class="headerlink" href="#id37" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">デフォルトのヘッダー名が使用されている場合、重複を避けるために、別の値を設定すること。重複がない場合は、デフォルト値を変更する必要はない。</div>
<div class="line">下記は、デフォルト値から「X-Exception-Code-ForExceptionResolver」に変更する場合の、設定&amp;実装例である。</div>
</div>
<ul>
<li><p><strong>spring-mvc.xml</strong></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>

<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;exceptionCodeHeader&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;X-Exception-Code-ForExceptionResolver&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外コード(メッセージID)のヘッダー名(exceptionCodeHeader)に、”X-Exception-Code-ForExceptionResolver”を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="id38">
<h4><a class="toc-backref" href="#id106" role="doc-backlink"><span class="section-number">5.7.5.2.4. </span>例外オブジェクトの属性名</a><a class="headerlink" href="#id38" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">デフォルトの属性名をアプリケーションコードで使用している場合は、重複を避けるために、別の値を設定すること。重複がない場合は、デフォルト値を変更する必要はない。</div>
<div class="line">下記は、デフォルト値から「exceptionForExceptionResolver」に変更する場合の、設定&amp;実装例である。</div>
</div>
<ul>
<li><p><strong>spring-mvc.xml</strong></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>

<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;exceptionAttribute&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;exceptionForExceptionResolver&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</li>
<li><p><strong>jsp</strong></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;p&gt;</span>[Exception<span class="w"> </span>Message]<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;p&gt;</span>${f:h(exceptionForExceptionResolver.message)}<span class="nt">&lt;/p&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">例外オブジェクトの属性名(exceptionAttribute)に、”exceptionForExceptionResolver”を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">SystemExceptionResolverに設定した値(exceptionForExceptionResolver)を、例外オブジェクトからメッセージを取得するための変数名として、指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
<section id="http">
<h4><a class="toc-backref" href="#id107" role="doc-backlink"><span class="section-number">5.7.5.2.5. </span>HTTPレスポンスのキャッシュ制御有無</a><a class="headerlink" href="#http" title="Permalink to this heading">¶</a></h4>
<div class="line-block">
<div class="line">HTTPレスポンスに、キャッシュ制御用のヘッダーを追加したい場合は、true:有を指定する。</div>
</div>
<ul>
<li><p><strong>spring-mvc.xml</strong></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.SystemExceptionResolver&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>

<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;preventResponseCaching&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="nt">/&gt;</span><span class="w"> </span><span class="cm">&lt;!-- (1) --&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">HTTPレスポンスのキャッシュ制御有無(preventResponseCaching)に、true:有を指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>有を指定した場合のHTTPレスポンスヘッダー</strong></p>
<p>HTTPレスポンスのキャッシュ制御有無を有にすると、以下のHTTPレスポンスヘッダーが出力される。</p>
<blockquote>
<div><div class="line-block">
<div class="line">Cache-Control:no-store</div>
<div class="line">Cache-Control:no-cache</div>
<div class="line">Expires:Thu, 01 Jan 1970 00:00:00 GMT</div>
<div class="line">Pragma:no-cache</div>
</div>
</div></blockquote>
</div>
</div></blockquote>
</section>
</section>
<section id="handlerexceptionresolverlogginginterceptor">
<span id="exception-handling-about-handlerexceptionresolverlogginginterceptor"></span><h3><a class="toc-backref" href="#id108" role="doc-backlink"><span class="section-number">5.7.5.3. </span>HandlerExceptionResolverLoggingInterceptorの設定項目について</a><a class="headerlink" href="#handlerexceptionresolverlogginginterceptor" title="Permalink to this heading">¶</a></h3>
<p>本編で説明していない設定項目について、説明する。
要件に応じて、設定を行うこと。</p>
<table class="docutils align-default" id="id59">
<caption><span class="caption-text"><strong>本編で説明していない設定項目一覧</strong></span><a class="headerlink" href="#id59" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 5%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 45%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>項目名</p></th>
<th class="head"><p>プロパティ名</p></th>
<th class="head"><p>説明</p></th>
<th class="head"><p>デフォルト値</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ログ出力対象から除外する例外クラスの一覧</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ignoreExceptions</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">HandlerExceptionResolver</span></code> によってハンドリングされた例外のうち、ログ出力しない例外クラスをリスト形式で指定する。</div>
<div class="line">指定した例外クラス及びサブクラスの例外が発生した場合、 本クラスでログの出力は行われない。</div>
<div class="line">本項目に指定する例外クラスは、別の場所(別の仕組み)でログ出力さえっる例外のみ指定すること。</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ResultMessagesNotificationException.class</span></code></div>
<div class="line"><br /></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ResultMessagesNotificationException.class</span></code> 及びサブクラスの例外は、 <code class="docutils literal notranslate"><span class="pre">ResultMessagesLoggingInterceptor</span></code> でログ出力されるため、デフォルト設定として除外している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<section id="id39">
<h4><a class="toc-backref" href="#id109" role="doc-backlink"><span class="section-number">5.7.5.3.1. </span>ログ出力対象から除外する例外クラスの一覧</a><a class="headerlink" href="#id39" title="Permalink to this heading">¶</a></h4>
<p>プロジェクトで用意した例外クラスをログ出力対象から除外したい場合は、以下のような設定となる。</p>
<ul class="simple">
<li><p><strong>spring-mvc.xml</strong></p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.HandlerExceptionResolverLoggingInterceptor&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;exceptionLogger&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;exceptionLogger&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ignoreExceptions&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;set&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- (1) --&gt;</span>
<span class="w">            </span><span class="nt">&lt;value&gt;</span>org.terasoluna.gfw.common.exception.ResultMessagesNotificationException<span class="nt">&lt;/value&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- (2) --&gt;</span>
<span class="w">            </span><span class="nt">&lt;value&gt;</span>com.example.common.XxxException<span class="nt">&lt;/value&gt;</span>
<span class="w">        </span><span class="nt">&lt;/set&gt;</span>
<span class="w">    </span><span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">共通ライブラリのデフォルト設定で指定されている <code class="docutils literal notranslate"><span class="pre">ResultMessagesNotificationException</span></code> を除外対象に指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">プロジェクトで用意した例外クラスを除外対象に指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>全ての例外クラスをログ出力対象とする場合は、以下のような設定となる。</p>
<ul class="simple">
<li><p><strong>spring-mvc.xml</strong></p></li>
</ul>
<blockquote>
<div><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;handlerExceptionResolverLoggingInterceptor&quot;</span>
<span class="w">    </span><span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.exception.HandlerExceptionResolverLoggingInterceptor&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;exceptionLogger&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;exceptionLogger&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- (3) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ignoreExceptions&quot;</span><span class="nt">&gt;&lt;null</span><span class="w"> </span><span class="nt">/&gt;&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>説明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ignoreExceptionsプロパティに <code class="docutils literal notranslate"><span class="pre">null</span></code> を指定する。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">null</span></code> を指定すると、全ての例外クラスがログ出力対象となる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</section>
</section>
<section id="defaulthandlerexceptionresolverhttp">
<span id="exception-handling-appendix-defaulthandlerexceptionresolver-label"></span><h3><a class="toc-backref" href="#id110" role="doc-backlink"><span class="section-number">5.7.5.4. </span>DefaultHandlerExceptionResolverで設定されるHTTPレスポンスコードについて</a><a class="headerlink" href="#defaulthandlerexceptionresolverhttp" title="Permalink to this heading">¶</a></h3>
<p>DefaultHandlerExceptionResolverでハンドリングされるフレームワーク例外と、HTTPステータスコードのマッピングを、以下に記載する。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 67%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>項番</p></th>
<th class="head"><p>ハンドリングされるフレームワーク例外</p></th>
<th class="head"><p>HTTPステータスコード</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">org.springframework.web.servlet.mvc.multiaction.NoSuchRequestHandlingMethodException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">404</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">org.springframework.web.HttpRequestMethodNotSupportedException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">405</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">org.springframework.web.HttpMediaTypeNotSupportedException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">415</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">org.springframework.web.HttpMediaTypeNotAcceptableException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">406</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">org.springframework.web.bind.MissingServletRequestParameterException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">400</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">org.springframework.web.bind.ServletRequestBindingException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">400</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">org.springframework.beans.ConversionNotSupportedException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">500</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">org.springframework.beans.TypeMismatchException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">400</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">org.springframework.http.converter.HttpMessageNotReadableException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">400</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">org.springframework.http.converter.HttpMessageNotWritableException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">500</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(11).</div>
</div>
</td>
<td><div class="line-block">
<div class="line">org.springframework.web.bind.MethodArgumentNotValidException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">400</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">org.springframework.web.multipart.support.MissingServletRequestPartException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">400</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="line-block">
<div class="line">org.springframework.validation.BindException</div>
</div>
</td>
<td><div class="line-block">
<div class="line">400</div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="SessionManagement.html" title="5.8. セッション管理"
             >next</a> |</li>
        <li class="right" >
          <a href="Logging.html" title="5.6. ロギング"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.3.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">5. </span>TERASOLUNA Global Frameworkの機能詳細</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">5.7. </span>例外ハンドリング</a></li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2015, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 5.3.0.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
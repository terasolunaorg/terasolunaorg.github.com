<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>5.15. Ajax &#8212; TERASOLUNA Global Framework Development Guideline 1.0.3.RELEASE documentation</title>
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.3.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5.16. RESTful Web Service" href="REST.html" />
    <link rel="prev" title="5.14. コードリスト" href="Codelist.html" /><script async src="https://www.googletagmanager.com/gtag/js?id=G-847V2Q99G8"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'G-847V2Q99G8');
</script>
<script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="REST.html" title="5.16. RESTful Web Service"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Codelist.html" title="5.14. コードリスト"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.3.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">5. TERASOLUNA Global Frameworkの機能詳細</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">5.15. Ajax</a><ul>
<li><a class="reference internal" href="#overview">5.15.1. Overview</a></li>
<li><a class="reference internal" href="#how-to-use">5.15.2. How to use</a><ul>
<li><a class="reference internal" href="#id2">5.15.2.1. アプリケーションの設定</a><ul>
<li><a class="reference internal" href="#spring-mvcajax">5.15.2.1.1. Spring MVCのAjax関連の機能を有効化するための設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#controller">5.15.2.2. Controllerの実装</a><ul>
<li><a class="reference internal" href="#id3">5.15.2.2.1. データを取得する</a></li>
<li><a class="reference internal" href="#post">5.15.2.2.2. フォームデータをPOSTする</a></li>
<li><a class="reference internal" href="#jsonpost">5.15.2.2.3. フォームデータをJSONとしてPOSTする</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ajax-how-to-use-input-error">5.15.2.3. 入力エラーのハンドリング</a><ul>
<li><a class="reference internal" href="#bindexception">5.15.2.3.1. BindException のハンドリング</a></li>
<li><a class="reference internal" href="#methodargumentnotvalidexception">5.15.2.3.2. MethodArgumentNotValidException のハンドリング</a></li>
<li><a class="reference internal" href="#httpmessagenotreadableexception">5.15.2.3.3. HttpMessageNotReadableException のハンドリング</a></li>
<li><a class="reference internal" href="#bindingresult">5.15.2.3.4. BindingResult を使用したハンドリング</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5">5.15.2.4. 業務エラーのハンドリング</a><ul>
<li><a class="reference internal" href="#id6">5.15.2.4.1. 例外ハンドリング用のメソッドで業務例外をハンドリング</a></li>
<li><a class="reference internal" href="#id7">5.15.2.4.2. 処理メソッド内で業務例外をハンドリング</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="Codelist.html"
                        title="previous chapter">5.14. コードリスト</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="REST.html"
                        title="next chapter">5.16. RESTful Web Service</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/ArchitectureInDetail/Ajax.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ajax">
<h1>5.15. Ajax<a class="headerlink" href="#ajax" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id1">
<p class="topic-title">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id8">Overview</a></li>
<li><a class="reference internal" href="#how-to-use" id="id9">How to use</a><ul>
<li><a class="reference internal" href="#id2" id="id10">アプリケーションの設定</a><ul>
<li><a class="reference internal" href="#spring-mvcajax" id="id11">Spring MVCのAjax関連の機能を有効化するための設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#controller" id="id12">Controllerの実装</a><ul>
<li><a class="reference internal" href="#id3" id="id13">データを取得する</a></li>
<li><a class="reference internal" href="#post" id="id14">フォームデータをPOSTする</a></li>
<li><a class="reference internal" href="#jsonpost" id="id15">フォームデータをJSONとしてPOSTする</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ajax-how-to-use-input-error" id="id16">入力エラーのハンドリング</a><ul>
<li><a class="reference internal" href="#bindexception" id="id17">BindException のハンドリング</a></li>
<li><a class="reference internal" href="#methodargumentnotvalidexception" id="id18">MethodArgumentNotValidException のハンドリング</a></li>
<li><a class="reference internal" href="#httpmessagenotreadableexception" id="id19">HttpMessageNotReadableException のハンドリング</a></li>
<li><a class="reference internal" href="#bindingresult" id="id20">BindingResult を使用したハンドリング</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5" id="id21">業務エラーのハンドリング</a><ul>
<li><a class="reference internal" href="#id6" id="id22">例外ハンドリング用のメソッドで業務例外をハンドリング</a></li>
<li><a class="reference internal" href="#id7" id="id23">処理メソッド内で業務例外をハンドリング</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id8">5.15.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>本章では、Ajaxを利用するアプリケーションの実装方法について説明する。</p>
<blockquote>
<div><div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<blockquote class="last">
<div>クライアント側の実装方法などについては、次版以降で詳細化する予定である。</div></blockquote>
</div>
</div></blockquote>
<p>Ajaxとは、以下の処理を非同期に行うための技術の総称である。</p>
<ul class="simple">
<li>ブラウザ上で行われる画面操作</li>
<li>画面操作をトリガーとしたサーバへのHTTP通信、及び通信結果のユーザインタフェースへの反映</li>
</ul>
<div class="line-block">
<div class="line">Ajaxを使うことで、HTTP通信中に画面の操作を継続できるため、ユーザビリティの向上を目的として使用されることが多い。</div>
<div class="line">この技術の代表的な適用例としては、検索サイトにおける検索ワードのSuggestion機能やリアルタイム検索などがあげられる。</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="how-to-use">
<span id="ajax-how-to-use"></span><h2><a class="toc-backref" href="#id9">5.15.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id10">5.15.2.1. アプリケーションの設定</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Ajax向けのアプリケーションの設定について説明する。</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>StAX(Streaming API for XML)使用時のDOS攻撃対策について</strong></p>
<p class="last">XML形式のデータをStAXを使用して解析する場合は、DTDを使ったDOS攻撃を受けないように対応する必要がある。
詳細は、<a class="reference external" href="http://pivotal.io/security/cve-2015-3192">CVE-2015-3192 - DoS Attack with XML Input</a>を参照されたい。</p>
</div>
<div class="section" id="spring-mvcajax">
<h4><a class="toc-backref" href="#id11">5.15.2.1.1. Spring MVCのAjax関連の機能を有効化するための設定</a><a class="headerlink" href="#spring-mvcajax" title="Permalink to this headline">¶</a></h4>
<p>Ajax通信時で使用されるContent-Type(<code class="docutils literal"><span class="pre">&quot;application/xml&quot;</span></code> や <code class="docutils literal"><span class="pre">&quot;application/json&quot;</span></code> など)を、Controllerの処理メソッドでハンドリングできるようにする。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">spring-mvc.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;mvc:annotation-driven</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;mvc:annotation-driven&gt;</span></code> 要素が指定されていると、Ajax通信時で必要となる機能が有効化されている。</div>
<div class="line">そのため、Ajax通信用に特別な設定を行う必要はない。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Ajax通信時で必要となる機能とは、具体的には <code class="docutils literal"><span class="pre">org.springframework.http.converter.HttpMessageConverter</span></code> クラスで提供される機能の事をさす。</p>
<p><code class="docutils literal"><span class="pre">HttpMessageConverter</span></code> は、以下の役割をもつ。</p>
<ul class="last simple">
<li>リクエストBodyに格納されているデータからJavaオブジェクトを生成する。</li>
<li>JavaオブジェクトからレスポンスBodyに書き込むデータを生成する。</li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><code class="docutils literal"><span class="pre">&lt;mvc:annotation-driven&gt;</span></code> 指定時にデフォルトで有効化される <code class="docutils literal"><span class="pre">HttpMessageConverter</span></code> は以下の通りである。</p>
<blockquote>
<div><table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="30%" />
<col width="15%" />
<col width="45%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">クラス名</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">対象</div>
<div class="line">フォーマット</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.http.converter.json.</div>
<div class="line">MappingJacksonHttpMessageConverter</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JSON</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストBody又はレスポンスBodyとしてJSONを扱うための <code class="docutils literal"><span class="pre">HttpMessageConverter</span></code> 。</div>
<div class="line">ブランクプロジェクトでは、 <a class="reference external" href="http://jackson.codehaus.org/">Jackson 1.x</a> 系を同封しているため、デフォルトの状態で使用することができる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><div class="first last line-block">
<div class="line">org.springframework.http.converter.xml.</div>
<div class="line">Jaxb2RootElementHttpMessageConverter</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">XML</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストBody又はレスポンスBodyとしてXMLを扱うための <code class="docutils literal"><span class="pre">HttpMessageConverter</span></code> 。</div>
<div class="line">JavaSE6からJAXB2.0が標準で同封されているため、デフォルトの状態で使用することができる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>XXE(XML External Entity) Injection 対策について</strong></p>
<p>Ajax通信でXML形式のデータを扱う場合は、<a class="reference external" href="https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing">XXE(XML External Entity) Injection</a>対策を行う必要がある。
terasoluna-gfw-web 1.0.1.RELEASE以上では、XXE Injection 対策が行われているSpring MVC(3.2.10.RELEASE以上)に依存しているため、個別に対策を行う必要はない。</p>
<p>terasoluna-gfw-web 1.0.0.RELEASEを使用している場合は、XXE Injection対策が行われていないSpring MVC(3.2.4.RELEASE)に依存しているため、Spring-oxmから提供されているクラスを使用すること。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">spring-mvc.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;xmlMarshaller&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.oxm.jaxb.Jaxb2Marshaller&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;packagesToScan&quot;</span> <span class="na">value=</span><span class="s">&quot;com.examples.app&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;mvc:annotation-driven&gt;</span>

    <span class="nt">&lt;mvc:message-converters&gt;</span>
        <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.http.converter.xml.MarshallingHttpMessageConverter&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;marshaller&quot;</span> <span class="na">ref=</span><span class="s">&quot;xmlMarshaller&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;unmarshaller&quot;</span> <span class="na">ref=</span><span class="s">&quot;xmlMarshaller&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/mvc:message-converters&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;/mvc:annotation-driven&gt;</span>

<span class="c">&lt;!-- ... --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring-oxmから提供されている<code class="docutils literal"><span class="pre">Jaxb2Marshaller</span></code>のbean定義を行う。</div>
<div class="line"><code class="docutils literal"><span class="pre">Jaxb2Marshaller</span></code>はデフォルトの状態で XXE Injection対策が行われている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">packagesToScan</span></code> プロパティに JAXB用のJavaBean( <code class="docutils literal"><span class="pre">javax.xml.bind.annotation.XmlRootElement</span></code> アノテーションなどが付与されているJavaBean)が格納されているパッケージ名を指定する。</div>
<div class="line">指定したパッケージ配下に格納されているJAXB用のJavaBeanがスキャンされ、marshal、unmarshal対象のJavaBeanとして登録される。</div>
<div class="line"><code class="docutils literal"><span class="pre">&lt;context:component-scan&gt;</span></code> の base-package属性と同じ仕組みでスキャンされる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&lt;mvc:annotation-driven&gt;</span></code> の子要素である <code class="docutils literal"><span class="pre">&lt;mvc:message-converters&gt;</span></code> 要素に、 <code class="docutils literal"><span class="pre">MarshallingHttpMessageConverter</span></code> のbean定義を追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">marshaller</span></code> プロパティに (1)で定義した <code class="docutils literal"><span class="pre">Jaxb2Marshaller</span></code> のbeanを指定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">unmarshaller</span></code> プロパティに (1)で定義した <code class="docutils literal"><span class="pre">Jaxb2Marshaller</span></code> のbeanを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Spring-oxmを依存するアーティファクトとして追加する。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">pom.xml</span></code></li>
</ul>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-oxm<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${org.springframework-version}<span class="nt">&lt;/version&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Spring-oxm を依存アーティファクトとして追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Springのバージョンは、terasoluna-gfw-parent の <code class="file docutils literal"><span class="pre">pom.xml</span></code> に定義されているSpringのバージョン番号を管理するためのプレースフォルダ(${org.springframework-version})から取得すること。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="controller">
<h3><a class="toc-backref" href="#id12">5.15.2.2. Controllerの実装</a><a class="headerlink" href="#controller" title="Permalink to this headline">¶</a></h3>
<p>以降で説明するサンプルコードの前提は以下の通りである。</p>
<ul class="simple">
<li>応答データの形式にはJSONを使用する。</li>
<li>クライアント側には、JQueryを使用する。バージョンは執筆時点の1.x系の最新バージョン(1.10.2)を使用する。</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id3">
<h4><a class="toc-backref" href="#id13">5.15.2.2.1. データを取得する</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>Ajaxを使ってデータを取得する方法について説明する。</p>
<p>下記例は、検索ワードに一致する情報を一覧として返却するAjax通信となっている。</p>
<ul class="simple">
<li>リクエストデータを受け取るためのJavaBean</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SearchCriteria</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">freeWord</span><span class="p">;</span> <span class="c1">// (2)</span>

    <span class="c1">// omitted setter/getter</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストデータを受け取るためのJavaBeanを作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">プロパティ名は、リクエストパラメータのパラメータ名と一致させる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>返却するデータを格納するJavaBean</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (3)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SearchResult</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">XxxEntity</span><span class="o">&gt;</span> <span class="n">list</span><span class="p">;</span>

    <span class="c1">// omitted setter/getter</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">返却するデータを格納するためのJavaBeanを作成する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Controller</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;search&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">)</span> <span class="c1">// (4)</span>
<span class="nd">@ResponseBody</span> <span class="c1">// (5)</span>
<span class="kd">public</span> <span class="n">SearchResult</span> <span class="nf">search</span><span class="p">(</span><span class="nd">@Validated</span> <span class="n">SearchCriteria</span> <span class="n">criteria</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (6)</span>

    <span class="n">SearchResult</span> <span class="n">searchResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SearchResult</span><span class="p">();</span> <span class="c1">// (7)</span>

    <span class="c1">// (8)</span>
    <span class="c1">// omitted</span>

    <span class="k">return</span> <span class="n">searchResult</span><span class="p">;</span> <span class="c1">// (9)</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code> アノテーションの method属性に <code class="docutils literal"><span class="pre">RequestMethod.GET</span></code> を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;org.springframework.web.bind.annotation.ResponseBody</span></code> アノテーションを付与する。</div>
<div class="line">このアノテーションを付与することで、返却したオブジェクトがJSON形式にmarshalされ、レスポンスBodyに設定される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストデータを受け取るためのJavaBeanを引数に指定する。</div>
<div class="line">入力チェックが必要な場合は、 <code class="docutils literal"><span class="pre">&#64;Validated</span></code> を指定する。入力チェックのエラーハンドリングについては、「 <a class="reference internal" href="#ajax-how-to-use-input-error"><span class="std std-ref">入力エラーのハンドリング</span></a> 」を参照されたい。</div>
<div class="line">入力チェックの詳細については、「 <a class="reference internal" href="Validation.html"><span class="doc">入力チェック</span></a> 」を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">返却するデータを格納するJavaBeanのオブジェクトを生成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">データを検索し、(7)で生成したオブジェクトに検索結果を格納する。</div>
<div class="line">上記例では、実装は省略している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンスBodyにmarshalするためのオブジェクトを返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>HTML(JSP)</li>
</ul>
<blockquote>
<div><div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;contextPath&quot;</span> <span class="na">content=</span><span class="s">&quot;${pageContext.request.contextPath}&quot;</span> <span class="nt">/&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>

<span class="c">&lt;!-- (10)  --&gt;</span>
<span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">&quot;searchForm&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;freeWord&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">&quot;return searchByFreeWord()&quot;</span><span class="nt">&gt;</span>Search<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">検索条件を入力するためのフォーム。</div>
<div class="line">上記例では、検索条件を入力するためのテキストボックスと検索ボタンをもっている。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (11) --&gt;</span>
<span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
    <span class="na">src=</span><span class="s">&quot;${pageContext.request.contextPath}/resources/vendor/jquery/jquery-1.10.2.js&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">JQueryのJavaScriptファイルを読み込む。</div>
<div class="line">上記例では、JQueryのJavaScriptファイルを読み込むために、 <code class="docutils literal"><span class="pre">/resources/vendor/jquery/jquery-1.10.2.js</span></code> というパスに対してリクエストが送信される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>JQueryのJavaScriptファイルを読み込みための設定は、以下の通り。
以下はブランクプロジェクトで提供されている設定値である。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">spring-mvc.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- (12) --&gt;</span>
<span class="nt">&lt;mvc:resources</span> <span class="na">mapping=</span><span class="s">&quot;/resources/**&quot;</span>
    <span class="na">location=</span><span class="s">&quot;/resources/,classpath:META-INF/resources/&quot;</span>
    <span class="na">cache-period=</span><span class="s">&quot;#{60 * 60}&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リソースファイル(JavaScriptファイル, Stylesheetファイル, 画像ファイルなど)を公開するための設定。</div>
<div class="line">上記設定例では、 <code class="docutils literal"><span class="pre">/resources/</span></code> から始まるパスに対してリクエストがあった場合に、warファイル内の <code class="docutils literal"><span class="pre">/resources/</span></code> ディレクトリ又はクラスパス内の <code class="docutils literal"><span class="pre">/META-INF/resources/</span></code> ディレクトリに格納されているファイルが応答される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>上記設定の場合、JQueryのJavaScriptファイルは以下の何れかのパスに配置する必要がある。</p>
<ul class="last">
<li><div class="first line-block">
<div class="line">warファイル内の <code class="docutils literal"><span class="pre">/resources/vendor/jquery/jquery-1.10.2.js</span></code></div>
<div class="line">プロジェクト内のパスで表現すると、 <code class="docutils literal"><span class="pre">src/main/webapp/resources/vendor/jquery/jquery-1.10.2.js</span></code> となる。</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">クラスパス内の <code class="docutils literal"><span class="pre">/META-INF/resources/vendor/jquery/jquery-1.10.2.js</span></code></div>
<div class="line">プロジェクト内のパスで表現すると、 <code class="docutils literal"><span class="pre">src/main/resources/META-INF/resources/vendor/jquery/jquery-1.10.2.js</span></code> となる。</div>
</div>
</li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>JavaScript</li>
</ul>
<blockquote>
<div><div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">contextPath</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;meta[name=&#39;contextPath&#39;]&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">);</span>

<span class="c1">// (13)</span>
<span class="kd">function</span> <span class="nx">searchByFreeWord</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">contextPath</span> <span class="o">+</span> <span class="s2">&quot;/ajax/search&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
        <span class="nx">data</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#searchForm&quot;</span><span class="p">).</span><span class="nx">serialize</span><span class="p">(),</span>
        <span class="nx">dataType</span> <span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="c1">// (14)</span>

    <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// (15)</span>
        <span class="c1">// render search result</span>
        <span class="c1">// omitted</span>

    <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// (16)</span>
        <span class="c1">// render error message</span>
        <span class="c1">// omitted</span>

    <span class="p">});</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォームに指定された検索条件をリクエストパラメータに変換し、GETメソッドで <code class="docutils literal"><span class="pre">/ajax/search</span></code> に対してリクエストを送信するAjax関数。</div>
<div class="line">上記例では、ボタンの押下をAjax通信のトリガーとしているが、テキストボックスのキーダウンやキーアップをトリガーとすることでリアルタイム検索などを実現することができる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンスとして受け取るデータ形式を指定する。</div>
<div class="line">上記例では <code class="docutils literal"><span class="pre">&quot;json&quot;</span></code> を指定しているため、Acceptヘッダーに <code class="docutils literal"><span class="pre">&quot;application/json&quot;</span></code> が設定される。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Ajax通信が正常終了した時(Httpステータスコードが <code class="docutils literal"><span class="pre">&quot;200&quot;</span></code> の時)の処理を実装する。</div>
<div class="line">上記例では、実装は省略している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(16)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Ajax通信が正常終了しなかった時(Httpステータスコードが <code class="docutils literal"><span class="pre">&quot;4xx&quot;</span></code> や <code class="docutils literal"><span class="pre">&quot;5xx&quot;</span></code> の時)の処理を実装する。</div>
<div class="line">上記例では、実装は省略している。</div>
<div class="line">エラー処理の実装例は、 <a class="reference internal" href="#ajax-post-formdata"><span class="std std-ref">フォームデータをPOSTする</span></a> を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">上記例ではWebアプリケーションのコンテキストパス( <code class="docutils literal"><span class="pre">${pageContext.request.contextPath}</span></code> ) をHTMLの <code class="docutils literal"><span class="pre">&lt;meta&gt;</span></code> 要素に設定しておくことで、
JavaScriptのコードからJSPのコードを排除している。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">上記検索フォームの「Search」ボタンを押下した際には、以下のような通信が発生する。</div>
<div class="line">ポイントとなる部分にハイライトを設けている。</div>
</div>
<ul class="simple">
<li>リクエストデータ</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nf">GET</span> <span class="nn">/terasoluna-gfw-web-blank/ajax/search?freeWord=</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="na">Host</span><span class="o">:</span> <span class="l">localhost:9999</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
<span class="hll"><span class="na">Accept</span><span class="o">:</span> <span class="l">application/json, text/javascript, */*; q=0.01</span>
</span><span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/30.0.1599.101 Safari/537.36</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">http://localhost:9999/terasoluna-gfw-web-blank/ajax/xxe</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip,deflate,sdch</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">en-US,en;q=0.8,ja;q=0.6</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">JSESSIONID=3A486604D7DEE62032BA6C073FC6BE9F</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>レスポンスデータ</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span> <span class="nt">200</span> <span class="nt">OK</span>
<span class="nt">Server</span><span class="o">:</span> <span class="nt">Apache-Coyote</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span>
<span class="nt">X-Track</span><span class="o">:</span> <span class="nt">a8fb8fefaaf64ee2bffc2b0f77050226</span>
<span class="hll"><span class="nt">Content-Type</span><span class="o">:</span> <span class="nt">application</span><span class="o">/</span><span class="nt">json</span><span class="o">;</span><span class="nt">charset</span><span class="o">=</span><span class="nt">UTF-8</span>
</span><span class="nt">Transfer-Encoding</span><span class="o">:</span> <span class="nt">chunked</span>
<span class="nt">Date</span><span class="o">:</span> <span class="nt">Fri</span><span class="o">,</span> <span class="nt">25</span> <span class="nt">Oct</span> <span class="nt">2013</span> <span class="nt">13</span><span class="p">:</span><span class="nd">52</span><span class="p">:</span><span class="nd">55</span> <span class="nt">GMT</span>

<span class="hll"><span class="p">{</span><span class="err">&quot;list&quot;:</span><span class="cp">[]</span><span class="p">}</span>
</span></pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="post">
<span id="ajax-post-formdata"></span><h4><a class="toc-backref" href="#id14">5.15.2.2.2. フォームデータをPOSTする</a><a class="headerlink" href="#post" title="Permalink to this headline">¶</a></h4>
<p>Ajaxを使ってフォームのデータをPOSTし、処理結果を取得する方法について説明する。</p>
<p>下記例は、2つの数値を受け取り、加算結果を返却するAjax通信となっている。</p>
<ul class="simple">
<li>フォームデータを受け取るためのJavaBean</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CalculationParameters</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">number1</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">number2</span><span class="p">;</span>

    <span class="c1">// omitted setter/getter</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォームデータを受け取るためのJavaBeanを作成する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>処理結果を格納するJavaBean</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (2)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CalculationResult</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">resultNumber</span><span class="p">;</span>

    <span class="c1">// omitted setter/getter</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">処理結果を格納するためのJavaBeanを作成する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Controller</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;xxx&quot;</span><span class="p">)</span>
<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">XxxController</span> <span class="p">{</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;plusForForm&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span> <span class="c1">// (3)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="n">CalculationResult</span> <span class="nf">plusForForm</span><span class="p">(</span>
        <span class="nd">@Validated</span> <span class="n">CalculationParameters</span> <span class="n">params</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (4)</span>
        <span class="n">CalculationResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CalculationResult</span><span class="p">();</span>
        <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="na">getNumber1</span><span class="p">()</span> <span class="o">+</span> <span class="n">params</span><span class="p">.</span><span class="na">getNumber2</span><span class="p">();</span>
        <span class="n">result</span><span class="p">.</span><span class="na">setResultNumber</span><span class="p">(</span><span class="n">sum</span><span class="p">);</span> <span class="c1">// (5)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// (6)</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;RequestMapping</span></code> アノテーションの method属性に <code class="docutils literal"><span class="pre">RequestMethod.POST</span></code> を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォームデータを受け取るためのJavaBeanを引数に指定する。</div>
<div class="line">入力チェックが必要な場合は、 <code class="docutils literal"><span class="pre">&#64;Validated</span></code> を指定する。入力チェックのエラーハンドリングについては、「 <a class="reference internal" href="#ajax-how-to-use-input-error"><span class="std std-ref">入力エラーのハンドリング</span></a> 」を参照されたい。</div>
<div class="line">入力チェックの詳細については、「 <a class="reference internal" href="Validation.html"><span class="doc">入力チェック</span></a> 」を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">処理結果を格納するオブジェクトに処理結果を格納する。</div>
<div class="line">上記例では、フォームオブジェクトから取得した２つの数値を加算した結果を格納している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンスBodyにmarshalするためのオブジェクトを返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>HTML(JSP)</li>
</ul>
<blockquote>
<div><div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;contextPath&quot;</span> <span class="na">content=</span><span class="s">&quot;${pageContext.request.contextPath}&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;_csrf&quot;</span> <span class="na">content=</span><span class="s">&quot;${_csrf.token}&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;_csrf_header&quot;</span> <span class="na">content=</span><span class="s">&quot;${_csrf.headerName}&quot;</span> <span class="nt">/&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>

<span class="c">&lt;!-- (7)  --&gt;</span>
<span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">&quot;calculationForm&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;number1&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="nt">&gt;</span>+
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;number2&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">&quot;return plus()&quot;</span><span class="nt">&gt;</span>=<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;calculationResult&quot;</span><span class="nt">&gt;&lt;/span&gt;</span> <span class="c">&lt;!-- (8) --&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">計算対象の数値を入力するためのフォーム。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">計算結果を表示するための領域。</div>
<div class="line">上記例では、通信成功時には計算結果が表示され、通信失敗時には計算結果がクリアされる。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>JavaScript</li>
</ul>
<blockquote>
<div><div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">contextPath</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;meta[name=&#39;contextPath&#39;]&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">);</span>

<span class="c1">// (9)</span>
<span class="kd">var</span> <span class="nx">csrfToken</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;meta[name=&#39;_csrf&#39;]&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">csrfHeaderName</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;meta[name=&#39;_csrf_header&#39;]&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ajaxSend</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="nx">csrfHeaderName</span><span class="p">,</span> <span class="nx">csrfToken</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// (10)</span>
<span class="kd">function</span> <span class="nx">plus</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">contextPath</span> <span class="o">+</span> <span class="s2">&quot;/ajax/plusForForm&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
        <span class="nx">data</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#calculationForm&quot;</span><span class="p">).</span><span class="nx">serialize</span><span class="p">(),</span>
        <span class="nx">dataType</span> <span class="o">:</span> <span class="s2">&quot;json&quot;</span>
    <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#calculationResult&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">resultNumber</span><span class="p">);</span>

    <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// (11)</span>
        <span class="kd">var</span> <span class="nx">messages</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="c1">// (12)</span>
        <span class="k">if</span><span class="p">(</span><span class="mi">400</span> <span class="o">&lt;=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">&amp;&amp;</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">&lt;=</span> <span class="mi">499</span><span class="p">){</span>
            <span class="c1">// (13)</span>
            <span class="kd">var</span> <span class="nx">contentType</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">contentType</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">contentType</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// (14)</span>
                <span class="nx">json</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
                <span class="nx">$</span><span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">errorResults</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">errorResult</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">messages</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span> <span class="o">+</span> <span class="nx">errorResult</span><span class="p">.</span><span class="nx">message</span> <span class="o">+</span> <span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">);</span>
                <span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// (15)</span>
                <span class="nx">messages</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span> <span class="o">+</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">statusText</span> <span class="o">+</span> <span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="c1">// (16)</span>
            <span class="nx">messages</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;System error occurred.&quot;</span> <span class="o">+</span> <span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// (17)</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#calculationResult&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">messages</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">POSTメソッドでリクエストを行う場合、CSRFトークンをHTTPヘッダに設定して送信する必要がある。</div>
<div class="line">上記例では、ヘッダ名とトークン値はHTMLの <code class="docutils literal"><span class="pre">&lt;meta&gt;</span></code> 要素に設定し、JavaScriptで値を取得するようにしている。</div>
<div class="line">CSRF対策の詳細については、 「 <a class="reference internal" href="../Security/CSRF.html"><span class="doc">CSRF対策</span></a> 」を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォームに指定された数値をリクエストパラメータに変換し、POSTメソッドで <code class="docutils literal"><span class="pre">/ajax/plusForForm</span></code> に対してリクエストを送信するAjax関数。</div>
<div class="line">上記例では、ボタンの押下をAjax通信のトリガーとしているが、テキストボックスのロストフォーカスをトリガーとすることでリアルタイム計算を実現することができる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー処理の実装例を以下に示す。</div>
<div class="line">サーバ側のエラーハンドリング処理の実装例については、 <a class="reference internal" href="#ajax-how-to-use-input-error"><span class="std std-ref">入力エラーのハンドリング</span></a> を参照されたい。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">HTTPのステータスコードを判定し、どのようなエラーが発生したか判定する。</div>
<div class="line">HTTPのステータスコードは、 XMLHttpRequestオブジェクトの <code class="docutils literal"><span class="pre">status</span></code> フィールドに格納されている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンスされたデータがJSON形式か判定を行う。</div>
<div class="line">上記例では、レスポンスヘッダの Content-Typeに設定されている値を参照して、レスポンスされたデータの形式をチェックしている。</div>
<div class="line">形式をチェックしておかないと、JSON以外の形式で応答された際に、JSONオブジェクトにデシリアライズする処理でエラーが発生することになる。</div>
<div class="line">サーバ側のエラーハンドリングを簡易的に行っていると、HTML形式のページが返却されることがある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンスデータをJSONオブジェクトにデシリアライズする。</div>
<div class="line">レスポンスデータは、 XMLHttpRequestオブジェクトの <code class="docutils literal"><span class="pre">responseText</span></code> フィールドに格納されている。</div>
<div class="line">上記例では、デシリアライズしたJSONオブジェクトからエラー情報を取得し、エラーメッセージを組み立てている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">レスポンスされたデータがJSON形式以外だった場合の処理を行う。</div>
<div class="line">上記例では、HTTPのステータステキストをエラーメッセージに格納している。</div>
<div class="line">HTTPのステータステキストは、 XMLHttpRequestオブジェクトの <code class="docutils literal"><span class="pre">statusText</span></code> フィールドに格納されている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(16)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">サーバエラー時の処理を行う。</div>
<div class="line">上記例では、システムエラーが発生したことを通知するメッセージをエラーメッセージに格納している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(17)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー時の描画処理を行う。</div>
<div class="line">上記例では、計算結果を表示するための領域に、エラーメッセージを表示している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">上記例では、Ajaxの通信処理、DOM操作処理(描画処理)、エラー処理を同じfunction内で行っているが、これらの処理は分離して実装することを推奨する。</p>
</div>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p><strong>TBD</strong></p>
<p class="last">クライアント側の実装方法については、次版以降で詳細化する予定である。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">上記例ではCSRFトークン値( <code class="docutils literal"><span class="pre">${_csrf.token}</span></code> )とCSRFトークンヘッダー名( <code class="docutils literal"><span class="pre">${_csrf.headerName}</span></code> ) をHTMLの <code class="docutils literal"><span class="pre">&lt;meta&gt;</span></code> 要素に設定しておくことで、
JavaScriptのコードからJSPのコードを排除している。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">上記検索フォームの「=」ボタンを押下した際には、以下のような通信が発生する。</div>
<div class="line">ポイントとなる部分にハイライトを設けている。</div>
</div>
<ul class="simple">
<li>リクエストデータ</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nf">POST</span> <span class="nn">/terasoluna-gfw-web-blank/ajax/plusForForm</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="na">Host</span><span class="o">:</span> <span class="l">localhost:9999</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">19</span>
<span class="hll"><span class="na">Accept</span><span class="o">:</span> <span class="l">application/json, text/javascript, */*; q=0.01</span>
</span><span class="na">Origin</span><span class="o">:</span> <span class="l">http://localhost:9999</span>
<span class="hll"><span class="na">X-CSRF-TOKEN</span><span class="o">:</span> <span class="l">a5dd1858-8a4f-4ecc-88bd-a326388ab5c9</span>
</span><span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/30.0.1599.101 Safari/537.36</span>
<span class="hll"><span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded; charset=UTF-8</span>
</span><span class="na">Referer</span><span class="o">:</span> <span class="l">http://localhost:9999/terasoluna-gfw-web-blank/ajax/xxe</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip,deflate,sdch</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">en-US,en;q=0.8,ja;q=0.6</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">JSESSIONID=3A486604D7DEE62032BA6C073FC6BE9F</span>

<span class="hll">number1=1&amp;number2=2
</span></pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>レスポンスデータ</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span> <span class="nt">200</span> <span class="nt">OK</span>
<span class="nt">Server</span><span class="o">:</span> <span class="nt">Apache-Coyote</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span>
<span class="nt">X-Track</span><span class="o">:</span> <span class="nt">c2d5066d0fa946f584536775f07d1900</span>
<span class="hll"><span class="nt">Content-Type</span><span class="o">:</span> <span class="nt">application</span><span class="o">/</span><span class="nt">json</span><span class="o">;</span><span class="nt">charset</span><span class="o">=</span><span class="nt">UTF-8</span>
</span><span class="nt">Transfer-Encoding</span><span class="o">:</span> <span class="nt">chunked</span>
<span class="nt">Date</span><span class="o">:</span> <span class="nt">Fri</span><span class="o">,</span> <span class="nt">25</span> <span class="nt">Oct</span> <span class="nt">2013</span> <span class="nt">14</span><span class="p">:</span><span class="nd">27</span><span class="p">:</span><span class="nd">55</span> <span class="nt">GMT</span>

<span class="hll"><span class="p">{</span><span class="err">&quot;resultNumber&quot;:3</span><span class="p">}</span>
</span></pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>エラー時のレスポンスデータ
下記のレスポンスデータは、入力エラーが発生時のものである。</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">HTTP</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span> <span class="nt">400</span> <span class="nt">Bad</span> <span class="nt">Request</span>
</span><span class="nt">Server</span><span class="o">:</span> <span class="nt">Apache-Coyote</span><span class="o">/</span><span class="nt">1</span><span class="p">.</span><span class="nc">1</span>
<span class="nt">X-Track</span><span class="o">:</span> <span class="nt">cecd7b4d746249178643b7110b0eaa74</span>
<span class="hll"><span class="nt">Content-Type</span><span class="o">:</span> <span class="nt">application</span><span class="o">/</span><span class="nt">json</span><span class="o">;</span><span class="nt">charset</span><span class="o">=</span><span class="nt">UTF-8</span>
</span><span class="nt">Transfer-Encoding</span><span class="o">:</span> <span class="nt">chunked</span>
<span class="nt">Date</span><span class="o">:</span> <span class="nt">Wed</span><span class="o">,</span> <span class="nt">04</span> <span class="nt">Dec</span> <span class="nt">2013</span> <span class="nt">15</span><span class="p">:</span><span class="nd">06</span><span class="p">:</span><span class="nd">01</span> <span class="nt">GMT</span>
<span class="nt">Connection</span><span class="o">:</span> <span class="nt">close</span>

<span class="hll"><span class="p">{</span><span class="err">&quot;errorResults&quot;:</span><span class="cp">[</span><span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span><span class="s2">&quot;NotNull&quot;</span><span class="p">,</span><span class="s2">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">number2</span><span class="se">\&quot;</span><span class="s2">maynotbenull.&quot;</span><span class="p">,</span><span class="s2">&quot;itemPath&quot;</span><span class="p">:</span><span class="s2">&quot;number2&quot;</span><span class="p">},{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span><span class="s2">&quot;NotNull&quot;</span><span class="p">,</span><span class="s2">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">number1</span><span class="se">\&quot;</span><span class="s2">maynotbenull.&quot;</span><span class="p">,</span><span class="s2">&quot;itemPath&quot;</span><span class="p">:</span><span class="s2">&quot;number1&quot;</span><span class="p">}</span><span class="cp">]</span><span class="p">}</span>
</span></pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="jsonpost">
<h4><a class="toc-backref" href="#id15">5.15.2.2.3. フォームデータをJSONとしてPOSTする</a><a class="headerlink" href="#jsonpost" title="Permalink to this headline">¶</a></h4>
<p>Ajaxを使ってフォームのデータをJSON形式に変換してからPOSTし、処理結果を取得する方法について説明する。</p>
<p>「フォームデータをPOSTする」方法との差分部分について説明する。</p>
<ul class="simple">
<li>Controller</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;xxx&quot;</span><span class="p">)</span>
<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">XxxController</span> <span class="p">{</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;plusForJson&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="n">CalculationResult</span> <span class="nf">plusForJson</span><span class="p">(</span>
            <span class="nd">@Validated</span> <span class="nd">@RequestBody</span> <span class="n">CalculationParameters</span> <span class="n">params</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>
        <span class="n">CalculationResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CalculationResult</span><span class="p">();</span>
        <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="na">getNumber1</span><span class="p">()</span> <span class="o">+</span> <span class="n">params</span><span class="p">.</span><span class="na">getNumber2</span><span class="p">();</span>
        <span class="n">result</span><span class="p">.</span><span class="na">setResultNumber</span><span class="p">(</span><span class="n">sum</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォームデータを受け取るためのJavaBeanの引数アノテーションとして、 <code class="docutils literal"><span class="pre">&#64;org.springframework.web.bind.annotation.RequestBody</span></code> アノテーションを付与する。</div>
<div class="line">このアノテーションを付与することで、リクエストBodyに格納されているJSON形式のデータがunmarshalされ、オブジェクトに変換される。</div>
<div class="line">入力チェックが必要な場合は、 <code class="docutils literal"><span class="pre">&#64;Validated</span></code> を指定する。入力チェックのエラーハンドリングについては、「 <a class="reference internal" href="#ajax-how-to-use-input-error"><span class="std std-ref">入力エラーのハンドリング</span></a> 」を参照されたい。</div>
<div class="line">入力チェックの詳細については、「 <a class="reference internal" href="Validation.html"><span class="doc">入力チェック</span></a> 」を参照されたい。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>JavaScript/HTML(JSP)</li>
</ul>
<blockquote>
<div><div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="c1">// (2)</span>
<span class="kd">function</span> <span class="nx">toJson</span><span class="p">(</span><span class="nx">$form</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">$form</span><span class="p">.</span><span class="nx">serializeArray</span><span class="p">()).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">[</span><span class="nx">v</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">plus</span><span class="p">()</span> <span class="p">{</span>

    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">contextPath</span> <span class="o">+</span> <span class="s2">&quot;/ajax/plusForJson&quot;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
        <span class="nx">contentType</span> <span class="o">:</span> <span class="s2">&quot;application/json;charset=utf-8&quot;</span><span class="p">,</span> <span class="c1">// (3)</span>
        <span class="nx">data</span> <span class="o">:</span> <span class="nx">toJson</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#calculationForm&quot;</span><span class="p">)),</span> <span class="c1">// (2)</span>
        <span class="nx">dataType</span> <span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
        <span class="nx">beforeSend</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="nx">csrfHeaderName</span><span class="p">,</span> <span class="nx">csrfToken</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#calculationResult&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">resultNumber</span><span class="p">);</span>

    <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#calculationResult&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>

    <span class="p">});</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">フォーム内のinput項目をJSON形式の文字列にするための関数。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">リクエストBodyにJSONを格納するので、Content-Typeのメディアタイプを <code class="docutils literal"><span class="pre">&quot;application/json&quot;</span></code> にする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">上記検索フォームの「=」ボタンを押下した際には、以下のような通信が発生する。</div>
<div class="line">ポイントとなる部分にハイライトを設けている。</div>
</div>
<ul class="simple">
<li>リクエストデータ</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/terasoluna-gfw-web-blank/ajax/plusForJson</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:9999</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">31</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json, text/javascript, */*; q=0.01</span>
<span class="na">Origin</span><span class="o">:</span> <span class="l">http://localhost:9999</span>
<span class="na">X-CSRF-TOKEN</span><span class="o">:</span> <span class="l">9d4f1e0c-c500-43f3-9125-a7a131ff88fa</span>
<span class="na">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/30.0.1599.101 Safari/537.36</span>
<span class="hll"><span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json;charset=UTF-8</span>
</span><span class="na">Referer</span><span class="o">:</span> <span class="l">http://localhost:9999/terasoluna-gfw-web-blank/ajax/xxe?</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip,deflate,sdch</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">en-US,en;q=0.8,ja;q=0.6</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">JSESSIONID=CECD7A6CB0431266B8D1173CCFA66B95</span>

<span class="hll"><span class="p">{</span><span class="nt">&quot;number1&quot;</span><span class="p">:</span><span class="s2">&quot;34&quot;</span><span class="p">,</span><span class="nt">&quot;number2&quot;</span><span class="p">:</span><span class="s2">&quot;56&quot;</span><span class="p">}</span>
</span></pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="ajax-how-to-use-input-error">
<span id="id4"></span><h3><a class="toc-backref" href="#id16">5.15.2.3. 入力エラーのハンドリング</a><a class="headerlink" href="#ajax-how-to-use-input-error" title="Permalink to this headline">¶</a></h3>
<p>入力値に不正な値が指定された場合のエラーハンドリング方法について説明する。</p>
<p>入力エラーのハンドリング方法は、大きく分けて以下の２つに分類される。</p>
<ul class="simple">
<li>例外ハンドリング用のメソッドを用意してエラー処理を行う。</li>
<li>Controllerの処理メソッドの引数として <code class="docutils literal"><span class="pre">org.springframework.validation.BindingResult</span></code> を受け取り、エラー処理を行う。</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="bindexception">
<h4><a class="toc-backref" href="#id17">5.15.2.3.1. BindException のハンドリング</a><a class="headerlink" href="#bindexception" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.validation.BindException</span></code> は、 リクエストパラメータとして送信したデータをJavaBeanにバインドする際に、入力値に不正な値が指定された場合に発生する例外クラスである。</div>
<div class="line">GET時のリクエストパラメータや、フォームデータを <code class="docutils literal"><span class="pre">&quot;application/x-www-form-urlencoded&quot;</span></code> の形式として受け取る場合は、 <code class="docutils literal"><span class="pre">BindException</span></code> の例外ハンドリングが必要となる。</div>
</div>
<ul class="simple">
<li>Controller</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;xxx&quot;</span><span class="p">)</span>
<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">XxxController</span> <span class="p">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">BindException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="c1">// (1)</span>
    <span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="na">BAD_REQUEST</span><span class="p">)</span> <span class="c1">// (2)</span>
    <span class="nd">@ResponseBody</span> <span class="c1">// (3)</span>
    <span class="kd">public</span> <span class="n">ErrorResults</span> <span class="nf">handleBindException</span><span class="p">(</span><span class="n">BindException</span> <span class="n">e</span><span class="p">,</span> <span class="n">Locale</span> <span class="n">locale</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (4)</span>
        <span class="c1">// (5)</span>
        <span class="n">ErrorResults</span> <span class="n">errorResults</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErrorResults</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">FieldError</span> <span class="n">fieldError</span> <span class="p">:</span> <span class="n">e</span><span class="p">.</span><span class="na">getBindingResult</span><span class="p">().</span><span class="na">getFieldErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">errorResults</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">fieldError</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span>
                    <span class="n">messageSource</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="n">fieldError</span><span class="p">,</span> <span class="n">locale</span><span class="p">),</span>
                        <span class="n">fieldError</span><span class="p">.</span><span class="na">getField</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ObjectError</span> <span class="n">objectError</span> <span class="p">:</span> <span class="n">e</span><span class="p">.</span><span class="na">getBindingResult</span><span class="p">().</span><span class="na">getGlobalErrors</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">errorResults</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">objectError</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span>
                    <span class="n">messageSource</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="n">objectError</span><span class="p">,</span> <span class="n">locale</span><span class="p">),</span>
                        <span class="n">objectError</span><span class="p">.</span><span class="na">getObjectName</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">errorResults</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Controllerにエラーハンドリング用メソッドを定義する。</div>
<div class="line">エラーハンドリング用のメソッドには、<code class="docutils literal"><span class="pre">&#64;org.springframework.web.bind.annotation.ExceptionHandler</span></code> アノテーションを付与し、 value属性にハンドリングする例外の型を指定する。</div>
<div class="line">上記例では、 ハンドリング対象の例外として <code class="docutils literal"><span class="pre">BindException.class</span></code> を指定している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">応答するHTTPステータス情報を指定する。</div>
<div class="line">上記例では、 <code class="docutils literal"><span class="pre">400</span></code> (Bad Request) を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">返却したオブジェクトをレスポンスBodyに書き込むため、 <code class="docutils literal"><span class="pre">&#64;ResponseBody</span></code> アノテーションを付与する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーハンドリング用のメソッドの引数として、ハンドリング対象の例外クラスを宣言する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー処理を実装する。</div>
<div class="line">上記例では、エラー情報を返却するためのJavaBeanを生成し、返却している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">エラー処理としてメッセージを生成する際に国際化を意識する必要がある場合は、<code class="docutils literal"><span class="pre">Locale</span></code> オブジェクトを引数として受け取ることができる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>エラー情報を保持するJavaBean</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (6)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ErrorResult</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">message</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">itemPath</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCode</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">code</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCode</span><span class="p">(</span><span class="n">String</span> <span class="n">code</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">code</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMessage</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">message</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMessage</span><span class="p">(</span><span class="n">String</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getItemPath</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">itemPath</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setItemPath</span><span class="p">(</span><span class="n">String</span> <span class="n">itemPath</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">itemPath</span> <span class="o">=</span> <span class="n">itemPath</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (7)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ErrorResults</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ErrorResult</span><span class="o">&gt;</span> <span class="n">errorResults</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ErrorResult</span><span class="o">&gt;</span><span class="p">();</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ErrorResult</span><span class="o">&gt;</span> <span class="nf">getErrorResults</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">errorResults</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setErrorResults</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ErrorResult</span><span class="o">&gt;</span> <span class="n">errorResults</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">errorResults</span> <span class="o">=</span> <span class="n">errorResults</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">ErrorResults</span> <span class="nf">add</span><span class="p">(</span><span class="n">String</span> <span class="n">code</span><span class="p">,</span> <span class="n">String</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ErrorResult</span> <span class="n">errorResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErrorResult</span><span class="p">();</span>
        <span class="n">errorResult</span><span class="p">.</span><span class="na">setCode</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
        <span class="n">errorResult</span><span class="p">.</span><span class="na">setMessage</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
        <span class="n">errorResults</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">errorResult</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">ErrorResults</span> <span class="nf">add</span><span class="p">(</span><span class="n">String</span> <span class="n">code</span><span class="p">,</span> <span class="n">String</span> <span class="n">message</span><span class="p">,</span> <span class="n">String</span> <span class="n">itemPath</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ErrorResult</span> <span class="n">errorResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErrorResult</span><span class="p">();</span>
        <span class="n">errorResult</span><span class="p">.</span><span class="na">setCode</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
        <span class="n">errorResult</span><span class="p">.</span><span class="na">setMessage</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
        <span class="n">errorResult</span><span class="p">.</span><span class="na">setItemPath</span><span class="p">(</span><span class="n">itemPath</span><span class="p">);</span>
        <span class="n">errorResults</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">errorResult</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー情報を１件保持するためのJavaBean。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラー情報を１件保持するJavaBeanを複数件保持するためのJavaBean。</div>
<div class="line">(6)のJavaBeanをリストとして保持している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="methodargumentnotvalidexception">
<h4><a class="toc-backref" href="#id18">5.15.2.3.2. MethodArgumentNotValidException のハンドリング</a><a class="headerlink" href="#methodargumentnotvalidexception" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.web.bind.MethodArgumentNotValidException</span></code> は、 <code class="docutils literal"><span class="pre">&#64;RequestBody</span></code> アノテーションを使用してリクエストBodyに格納されているデータをJavaBeanにバインドする際に、入力値に不正な値が指定された場合に発生する例外クラスである。</div>
<div class="line"><code class="docutils literal"><span class="pre">&quot;application/json&quot;</span></code> や <code class="docutils literal"><span class="pre">&quot;application/xml&quot;</span></code> などの形式として受け取る場合は、 <code class="docutils literal"><span class="pre">MethodArgumentNotValidException</span></code> の例外ハンドリングが必要となる。</div>
</div>
<ul class="simple">
<li>Controller</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">MethodArgumentNotValidException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="c1">// (1)</span>
<span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="na">BAD_REQUEST</span><span class="p">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">ErrorResults</span> <span class="nf">handleMethodArgumentNotValidException</span><span class="p">(</span>
        <span class="n">MethodArgumentNotValidException</span> <span class="n">e</span><span class="p">,</span> <span class="n">Locale</span> <span class="n">locale</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>
    <span class="n">ErrorResults</span> <span class="n">errorResults</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErrorResults</span><span class="p">();</span>

    <span class="c1">// implement error handling.</span>
    <span class="c1">// omitted</span>

    <span class="k">return</span> <span class="n">errorResults</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーハンドリング対象の例外として <code class="docutils literal"><span class="pre">MethodArgumentNotValidException.class</span></code> を指定する。</div>
<div class="line">上記以外は <code class="docutils literal"><span class="pre">BindException</span></code> と同様。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="httpmessagenotreadableexception">
<h4><a class="toc-backref" href="#id19">5.15.2.3.3. HttpMessageNotReadableException のハンドリング</a><a class="headerlink" href="#httpmessagenotreadableexception" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.http.converter.HttpMessageNotReadableException</span></code> は、 <code class="docutils literal"><span class="pre">&#64;RequestBody</span></code> アノテーションを使用してリクエストBodyに格納されているデータをJavaBeanにバインドする際に、Bodyに格納されているデータからJavaBeanを生成できなかった場合に発生する例外クラスである。</div>
<div class="line"><code class="docutils literal"><span class="pre">&quot;application/json&quot;</span></code> や <code class="docutils literal"><span class="pre">&quot;application/xml&quot;</span></code> などの形式として受け取る場合は、 <code class="docutils literal"><span class="pre">MethodArgumentNotValidException</span></code> の例外ハンドリングが必要となる。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>具体的なエラー原因は、使用する <code class="docutils literal"><span class="pre">HttpMessageConverter</span></code> や利用するライブラリの実装によって異なる。</p>
<p class="last">JSON形式のデータをJacksonを使ってJavaBeanに変換する <code class="docutils literal"><span class="pre">MappingJacksonHttpMessageConverter</span></code> の実装では、Integer項目に数値以外の文字列を指定すると、 <code class="docutils literal"><span class="pre">HttpMessageNotReadableException</span></code> が発生する。</p>
</div>
</div></blockquote>
<ul class="simple">
<li>Controller</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">HttpMessageNotReadableException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="c1">// (1)</span>
<span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="na">BAD_REQUEST</span><span class="p">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">ErrorResults</span> <span class="nf">handleHttpMessageNotReadableException</span><span class="p">(</span>
        <span class="n">HttpMessageNotReadableException</span> <span class="n">e</span><span class="p">,</span> <span class="n">Locale</span> <span class="n">locale</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// (1)</span>
    <span class="n">ErrorResults</span> <span class="n">errorResults</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErrorResults</span><span class="p">();</span>

    <span class="c1">// implement error handling.</span>
    <span class="c1">// omitted</span>

    <span class="k">return</span> <span class="n">errorResults</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーハンドリング対象の例外として <code class="docutils literal"><span class="pre">HttpMessageNotReadableException.class</span></code> を指定する。</div>
<div class="line">上記以外は <code class="docutils literal"><span class="pre">BindException</span></code> と同様。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="bindingresult">
<h4><a class="toc-backref" href="#id20">5.15.2.3.4. BindingResult を使用したハンドリング</a><a class="headerlink" href="#bindingresult" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">正常終了時に返却するJavaBeanと入力エラー時に返却するJavaBeanの型が同じ場合は、<code class="docutils literal"><span class="pre">BindingResult</span></code> を処理メソッドの引数として受け取ることでエラーハンドリングすることができる。</div>
<div class="line">この方法は、リクエストデータの形式に関係なく使用することができる。</div>
<div class="line">処理メソッドの引数として <code class="docutils literal"><span class="pre">BindingResult</span></code> を指定しない場合は、前述した例外をハンドリングする方法でエラー処理を実装する必要がある。</div>
</div>
<ul class="simple">
<li>Controller</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;plus&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">CalculationResult</span> <span class="nf">plus</span><span class="p">(</span>
        <span class="nd">@Validated</span> <span class="nd">@RequestBody</span> <span class="n">CalculationParameters</span> <span class="n">params</span><span class="p">,</span>
        <span class="n">BindingResult</span> <span class="n">bResult</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>
    <span class="n">CalculationResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CalculationResult</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bResult</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span> <span class="c1">// (2)</span>

        <span class="c1">// (3)</span>
        <span class="c1">// implement error handling.</span>
        <span class="c1">// omitted</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// (4)</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="na">getNumber1</span><span class="p">()</span> <span class="o">+</span> <span class="n">params</span><span class="p">.</span><span class="na">getNumber2</span><span class="p">();</span>
    <span class="n">result</span><span class="p">.</span><span class="na">setResultNumber</span><span class="p">(</span><span class="n">sum</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">処理メソッドの引数として <code class="docutils literal"><span class="pre">BindingResult</span></code> を宣言する。</div>
<div class="line"><code class="docutils literal"><span class="pre">BindingResult</span></code> は入力チェック対象のJavaBeanの直後に宣言する必要がある。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力値のエラー有無を判定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力値にエラーがある場合は、入力エラー時のエラー処理を行う。</div>
<div class="line">上記例ではエラー処理は省略しているが、エラーメッセージの設定などが行われる想定である。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">処理結果を返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>上記例では、正常時及びエラー時共にレスポンスのHTTPステータスコードは <code class="docutils literal"><span class="pre">200</span></code> (OK) が返却される。
HTTPステータスコードを処理結果によってわける必要がある場合は、 <code class="docutils literal"><span class="pre">org.springframework.http.ResponseEntity</span></code> を返却値とすることで実現可能である。
別のアプローチとしては、処理メソッドの引数として <code class="docutils literal"><span class="pre">BindingResult</span></code> を指定せず、前述した例外をハンドリングする方法でエラー処理を実装する方法がある。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;plus&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">CalculationResult</span><span class="o">&gt;</span> <span class="nf">plus</span><span class="p">(</span>
        <span class="nd">@Validated</span> <span class="nd">@RequestBody</span> <span class="n">CalculationParameters</span> <span class="n">params</span><span class="p">,</span>
        <span class="n">BindingResult</span> <span class="n">bResult</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">CalculationResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CalculationResult</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bResult</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>

        <span class="c1">// implement error handling.</span>
        <span class="c1">// omitted</span>

        <span class="c1">// (1)</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">CalculationResult</span><span class="o">&gt;</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="na">BAD_REQUEST</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// omitted</span>

    <span class="c1">// (2)</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">CalculationResult</span><span class="o">&gt;</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力エラー時の応答データとHTTPステータスを返却する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">正常終了時の応答データとHTTPステータスを返却する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id21">5.15.2.4. 業務エラーのハンドリング</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>業務エラーのエラーハンドリング方法について説明する。</p>
<p>業務エラーのハンドリング方法は大きく分けて以下の２つに分類される。</p>
<ul class="simple">
<li>業務例外ハンドリング用のメソッドを用意してエラー処理を行う。</li>
<li>Controllerの処理メソッド内で業務例外をcatchしてエラー処理を行う。</li>
</ul>
<div class="section" id="id6">
<h4><a class="toc-backref" href="#id22">5.15.2.4.1. 例外ハンドリング用のメソッドで業務例外をハンドリング</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">入力エラーと同様、例外ハンドリング用のメソッドを用意して業務例外をハンドリングする。</div>
<div class="line">複数の処理メソッドに対するリクエストで同じエラー処理を実装する必要がある場合、この方法でエラーハンドリングすることを推奨する。</div>
</div>
<ul class="simple">
<li>Controller</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">BusinessException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span> <span class="c1">// (1)</span>
<span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">)</span> <span class="c1">// (2)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">ErrorResults</span> <span class="nf">handleHttpBusinessException</span><span class="p">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="p">,</span> <span class="c1">// (1)</span>
        <span class="n">Locale</span> <span class="n">locale</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ErrorResults</span> <span class="n">errorResults</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErrorResults</span><span class="p">();</span>

    <span class="c1">// implement error handling.</span>
    <span class="c1">// omitted</span>

    <span class="k">return</span> <span class="n">errorResults</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">エラーハンドリング対象の例外として <code class="docutils literal"><span class="pre">BusinessException.class</span></code> を指定する。</div>
<div class="line">上記以外は入力エラーの <code class="docutils literal"><span class="pre">BindException</span></code> のハンドリング方法と同様。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">応答するHTTPステータス情報を指定する。</div>
<div class="line">上記例では、 <code class="docutils literal"><span class="pre">409</span></code> (Conflict) を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id7">
<h4><a class="toc-backref" href="#id23">5.15.2.4.2. 処理メソッド内で業務例外をハンドリング</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">業務エラーが発生する処理を try句で囲み、業務例外をcatchする。</div>
<div class="line">エラー処理がリクエスト毎に異なる場合は、この方法でエラーハンドリングすることになる。</div>
</div>
<ul class="simple">
<li>Controller</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;plus&quot;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="na">POST</span><span class="p">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">CalculationResult</span><span class="o">&gt;</span> <span class="nf">plusForJson</span><span class="p">(</span>
        <span class="nd">@Validated</span> <span class="nd">@RequestBody</span> <span class="n">CalculationParameters</span> <span class="n">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">CalculationResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CalculationResult</span><span class="p">();</span>

    <span class="c1">// omitted</span>

    <span class="c1">// (1)</span>
    <span class="k">try</span> <span class="p">{</span>

        <span class="c1">// call service method.</span>
        <span class="c1">// omitted</span>

     <span class="c1">// (2)</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// (3)</span>
        <span class="c1">// implement error handling.</span>
        <span class="c1">// omitted</span>

        <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">CalculationResult</span><span class="o">&gt;</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// omitted</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">CalculationResult</span><span class="o">&gt;</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">説明</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">業務例外が発生するメソッド呼び出しを try句で囲む。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">業務例外をcatchする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">業務例外エラー時のエラー処理を行う。</div>
<div class="line">上記例ではエラー処理は省略しているが、エラーメッセージの設定などが行われる想定である。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="REST.html" title="5.16. RESTful Web Service"
             >next</a> |</li>
        <li class="right" >
          <a href="Codelist.html" title="5.14. コードリスト"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.0.3.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >5. TERASOLUNA Global Frameworkの機能詳細</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2015, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>
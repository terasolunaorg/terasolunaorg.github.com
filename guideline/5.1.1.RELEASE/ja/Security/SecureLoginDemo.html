<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>6.10. 代表的なセキュリティ要件の実装例 &mdash; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.1.1.RELEASE documentation</title>
    
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.1.1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.1.1.RELEASE documentation" href="../index.html" />
    <link rel="up" title="6. TERASOLUNA Server Framework for Java (5.x)によるセキュリティ対策" href="index.html" />
    <link rel="next" title="7. Appendix" href="../Appendix/index.html" />
    <link rel="prev" title="6.9. 暗号化" href="Encryption.html" /><script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../Appendix/index.html" title="7. Appendix"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Encryption.html" title="6.9. 暗号化"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.1.1.RELEASE documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">6. TERASOLUNA Server Framework for Java (5.x)によるセキュリティ対策</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">6.10. 代表的なセキュリティ要件の実装例</a><ul>
<li><a class="reference internal" href="#id3">6.10.1. はじめに</a><ul>
<li><a class="reference internal" href="#id4">6.10.1.1. この章で説明すること</a></li>
<li><a class="reference internal" href="#id5">6.10.1.2. 対象読者</a></li>
</ul>
</li>
<li><a class="reference internal" href="#app-description-sec">6.10.2. アプリケーションの説明</a><ul>
<li><a class="reference internal" href="#sec-requirements">6.10.2.1. セキュリティ要件</a></li>
<li><a class="reference internal" href="#id8">6.10.2.2. 機能</a></li>
<li><a class="reference internal" href="#id9">6.10.2.3. 認証・認可に関する仕様</a><ul>
<li><a class="reference internal" href="#id10">6.10.2.3.1. 認証</a></li>
<li><a class="reference internal" href="#id11">6.10.2.3.2. 認可</a></li>
<li><a class="reference internal" href="#id12">6.10.2.3.3. パスワード再発行時の認証</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id13">6.10.2.4. 設計情報</a><ul>
<li><a class="reference internal" href="#id14">6.10.2.4.1. 画面遷移</a></li>
<li><a class="reference internal" href="#url">6.10.2.4.2. URL一覧</a></li>
<li><a class="reference internal" href="#er">6.10.2.4.3. ER図</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implement-description">6.10.3. 実装方法とコード解説</a><ul>
<li><a class="reference internal" href="#password-change">6.10.3.1. パスワード変更の強制・促進</a><ul>
<li><a class="reference internal" href="#id18">6.10.3.1.1. 実装する要件一覧</a></li>
<li><a class="reference internal" href="#id19">6.10.3.1.2. 動作イメージ</a></li>
<li><a class="reference internal" href="#id20">6.10.3.1.3. 実装方法</a></li>
<li><a class="reference internal" href="#id21">6.10.3.1.4. コード解説</a></li>
</ul>
</li>
<li><a class="reference internal" href="#password-strength">6.10.3.2. パスワードの品質チェック</a><ul>
<li><a class="reference internal" href="#id24">6.10.3.2.1. 実装する要件一覧</a></li>
<li><a class="reference internal" href="#id25">6.10.3.2.2. 動作イメージ</a></li>
<li><a class="reference internal" href="#id26">6.10.3.2.3. 実装方法</a></li>
<li><a class="reference internal" href="#id27">6.10.3.2.4. コード解説</a></li>
</ul>
</li>
<li><a class="reference internal" href="#account-lock">6.10.3.3. アカウントのロックアウト</a><ul>
<li><a class="reference internal" href="#id29">6.10.3.3.1. 実装する要件一覧</a></li>
<li><a class="reference internal" href="#id30">6.10.3.3.2. 動作イメージ</a></li>
<li><a class="reference internal" href="#id31">6.10.3.3.3. 実装方法</a></li>
<li><a class="reference internal" href="#id32">6.10.3.3.4. コード解説</a></li>
</ul>
</li>
<li><a class="reference internal" href="#last-login">6.10.3.4. 最終ログイン日時の表示</a><ul>
<li><a class="reference internal" href="#id34">6.10.3.4.1. 実装する要件一覧</a></li>
<li><a class="reference internal" href="#id35">6.10.3.4.2. 動作イメージ</a></li>
<li><a class="reference internal" href="#id36">6.10.3.4.3. 実装方法</a></li>
<li><a class="reference internal" href="#id37">6.10.3.4.4. コード解説</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reissue-info-create">6.10.3.5. パスワード再発行のための認証情報の生成</a><ul>
<li><a class="reference internal" href="#id39">6.10.3.5.1. 実装する要件一覧</a></li>
<li><a class="reference internal" href="#id40">6.10.3.5.2. 動作イメージ</a></li>
<li><a class="reference internal" href="#id41">6.10.3.5.3. 実装方法</a></li>
<li><a class="reference internal" href="#id42">6.10.3.5.4. コード解説</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reissue-info-delivery">6.10.3.6. パスワード再発行のための認証情報の配布</a><ul>
<li><a class="reference internal" href="#id44">6.10.3.6.1. 実装する要件一覧</a></li>
<li><a class="reference internal" href="#id45">6.10.3.6.2. 動作イメージ</a></li>
<li><a class="reference internal" href="#id46">6.10.3.6.3. 実装方法</a></li>
<li><a class="reference internal" href="#id47">6.10.3.6.4. コード解説</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reissue-info-validate">6.10.3.7. パスワード再発行実行時の検査</a><ul>
<li><a class="reference internal" href="#id49">6.10.3.7.1. 実装する要件一覧</a></li>
<li><a class="reference internal" href="#id50">6.10.3.7.2. 動作イメージ</a></li>
<li><a class="reference internal" href="#id51">6.10.3.7.3. 実装方法</a></li>
<li><a class="reference internal" href="#id52">6.10.3.7.4. コード解説</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reissue-info-invalidate">6.10.3.8. パスワード再発行の失敗上限回数の設定</a><ul>
<li><a class="reference internal" href="#id54">6.10.3.8.1. 実装する要件一覧</a></li>
<li><a class="reference internal" href="#id55">6.10.3.8.2. 動作イメージ</a></li>
<li><a class="reference internal" href="#id56">6.10.3.8.3. 実装方法</a></li>
<li><a class="reference internal" href="#id57">6.10.3.8.4. コード解説</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id58">6.10.4. おわりに</a></li>
<li><a class="reference internal" href="#appendix">6.10.5. Appendix</a><ul>
<li><a class="reference internal" href="#passay-overview">6.10.5.1. Passay</a><ul>
<li><a class="reference internal" href="#password-validation">6.10.5.1.1. パスワード入力チェック</a><ul>
<li><a class="reference internal" href="#overview">6.10.5.1.1.1. Overview</a></li>
<li><a class="reference internal" href="#how-to-use">6.10.5.1.1.2. How to use</a></li>
</ul>
</li>
<li><a class="reference internal" href="#password-generation">6.10.5.1.2. パスワード生成</a><ul>
<li><a class="reference internal" href="#id62">6.10.5.1.2.1. Overview</a></li>
<li><a class="reference internal" href="#id63">6.10.5.1.2.2. How to use</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="Encryption.html"
                        title="previous chapter">6.9. 暗号化</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../Appendix/index.html"
                        title="next chapter">7. Appendix</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Security/SecureLoginDemo.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>6.10. 代表的なセキュリティ要件の実装例<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id2">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#id3" id="id64">はじめに</a><ul>
<li><a class="reference internal" href="#id4" id="id65">この章で説明すること</a></li>
<li><a class="reference internal" href="#id5" id="id66">対象読者</a></li>
</ul>
</li>
<li><a class="reference internal" href="#app-description-sec" id="id67">アプリケーションの説明</a><ul>
<li><a class="reference internal" href="#sec-requirements" id="id68">セキュリティ要件</a></li>
<li><a class="reference internal" href="#id8" id="id69">機能</a></li>
<li><a class="reference internal" href="#id9" id="id70">認証・認可に関する仕様</a><ul>
<li><a class="reference internal" href="#id10" id="id71">認証</a></li>
<li><a class="reference internal" href="#id11" id="id72">認可</a></li>
<li><a class="reference internal" href="#id12" id="id73">パスワード再発行時の認証</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id13" id="id74">設計情報</a><ul>
<li><a class="reference internal" href="#id14" id="id75">画面遷移</a></li>
<li><a class="reference internal" href="#url" id="id76">URL一覧</a></li>
<li><a class="reference internal" href="#er" id="id77">ER図</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implement-description" id="id78">実装方法とコード解説</a><ul>
<li><a class="reference internal" href="#password-change" id="id79">パスワード変更の強制・促進</a><ul>
<li><a class="reference internal" href="#id18" id="id80">実装する要件一覧</a></li>
<li><a class="reference internal" href="#id19" id="id81">動作イメージ</a></li>
<li><a class="reference internal" href="#id20" id="id82">実装方法</a></li>
<li><a class="reference internal" href="#id21" id="id83">コード解説</a></li>
</ul>
</li>
<li><a class="reference internal" href="#password-strength" id="id84">パスワードの品質チェック</a><ul>
<li><a class="reference internal" href="#id24" id="id85">実装する要件一覧</a></li>
<li><a class="reference internal" href="#id25" id="id86">動作イメージ</a></li>
<li><a class="reference internal" href="#id26" id="id87">実装方法</a></li>
<li><a class="reference internal" href="#id27" id="id88">コード解説</a></li>
</ul>
</li>
<li><a class="reference internal" href="#account-lock" id="id89">アカウントのロックアウト</a><ul>
<li><a class="reference internal" href="#id29" id="id90">実装する要件一覧</a></li>
<li><a class="reference internal" href="#id30" id="id91">動作イメージ</a></li>
<li><a class="reference internal" href="#id31" id="id92">実装方法</a></li>
<li><a class="reference internal" href="#id32" id="id93">コード解説</a></li>
</ul>
</li>
<li><a class="reference internal" href="#last-login" id="id94">最終ログイン日時の表示</a><ul>
<li><a class="reference internal" href="#id34" id="id95">実装する要件一覧</a></li>
<li><a class="reference internal" href="#id35" id="id96">動作イメージ</a></li>
<li><a class="reference internal" href="#id36" id="id97">実装方法</a></li>
<li><a class="reference internal" href="#id37" id="id98">コード解説</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reissue-info-create" id="id99">パスワード再発行のための認証情報の生成</a><ul>
<li><a class="reference internal" href="#id39" id="id100">実装する要件一覧</a></li>
<li><a class="reference internal" href="#id40" id="id101">動作イメージ</a></li>
<li><a class="reference internal" href="#id41" id="id102">実装方法</a></li>
<li><a class="reference internal" href="#id42" id="id103">コード解説</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reissue-info-delivery" id="id104">パスワード再発行のための認証情報の配布</a><ul>
<li><a class="reference internal" href="#id44" id="id105">実装する要件一覧</a></li>
<li><a class="reference internal" href="#id45" id="id106">動作イメージ</a></li>
<li><a class="reference internal" href="#id46" id="id107">実装方法</a></li>
<li><a class="reference internal" href="#id47" id="id108">コード解説</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reissue-info-validate" id="id109">パスワード再発行実行時の検査</a><ul>
<li><a class="reference internal" href="#id49" id="id110">実装する要件一覧</a></li>
<li><a class="reference internal" href="#id50" id="id111">動作イメージ</a></li>
<li><a class="reference internal" href="#id51" id="id112">実装方法</a></li>
<li><a class="reference internal" href="#id52" id="id113">コード解説</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reissue-info-invalidate" id="id114">パスワード再発行の失敗上限回数の設定</a><ul>
<li><a class="reference internal" href="#id54" id="id115">実装する要件一覧</a></li>
<li><a class="reference internal" href="#id55" id="id116">動作イメージ</a></li>
<li><a class="reference internal" href="#id56" id="id117">実装方法</a></li>
<li><a class="reference internal" href="#id57" id="id118">コード解説</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id58" id="id119">おわりに</a></li>
<li><a class="reference internal" href="#appendix" id="id120">Appendix</a><ul>
<li><a class="reference internal" href="#passay-overview" id="id121">Passay</a><ul>
<li><a class="reference internal" href="#password-validation" id="id122">パスワード入力チェック</a></li>
<li><a class="reference internal" href="#password-generation" id="id123">パスワード生成</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id64">6.10.1. はじめに</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id65">6.10.1.1. この章で説明すること</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>TERASOLUNA Server Framework for Java (5.x)を利用して代表的なセキュリティ要件を満たすための実装方法の例</li>
<li><a class="reference internal" href="#app-description-sec"><span>アプリケーションの説明</span></a> に示すサンプルアプリケーションを題材として、実装方法とソースコードの説明を行う</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<ul class="last simple">
<li>この章で説明している実装方法はあくまでも一例であり、実際の開発においては個別の要件を考慮して実装する必要がある</li>
<li>セキュリティ対策の網羅的な実施を保証するものではないため、必要に応じて追加の対策を検討すること</li>
</ul>
</div>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id66">6.10.1.2. 対象読者</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference internal" href="../ImplementationAtEachLayer/index.html"><em>TERASOLUNA Server Framework for Java (5.x)によるアプリケーション開発</em></a> の内容を理解していること</li>
<li><a class="reference internal" href="SpringSecurity.html"><em>Spring Security概要</em></a>, <a class="reference internal" href="Authentication.html"><em>認証</em></a>, <a class="reference internal" href="Authorization.html"><em>認可</em></a> の内容を理解していること</li>
<li><a class="reference internal" href="Tutorial.html"><em>Spring Securityチュートリアル</em></a> を実施済みのこと</li>
</ul>
</div>
</div>
<div class="section" id="app-description-sec">
<span id="id6"></span><h2><a class="toc-backref" href="#id67">6.10.2. アプリケーションの説明</a><a class="headerlink" href="#app-description-sec" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">本章では、代表的なセキュリティ要件を満たすサンプルアプリケーションを題材として、セキュリティ対策の具体的な実装方法の例について説明する。</div>
<div class="line">以下に本章で実装例を解説するセキュリティ要件の一覧を示し、題材となるサンプルアプリケーションの機能、認証・認可に関する仕様を示す。</div>
<div class="line">以降、このサンプルアプリケーションを本アプリケーションと呼ぶ。</div>
</div>
<div class="section" id="sec-requirements">
<span id="id7"></span><h3><a class="toc-backref" href="#id68">6.10.2.1. セキュリティ要件</a><a class="headerlink" href="#sec-requirements" title="Permalink to this headline">¶</a></h3>
<p>本アプリケーションが満たすセキュリティ要件の一覧を以下に示す。各分類ごとに、<a class="reference internal" href="#implement-description"><span>実装方法とコード解説</span></a> にて実装例の解説を行う。</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="30%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">分類</th>
<th class="head">要件</th>
<th class="head">概説</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><a class="reference internal" href="#password-change"><span>パスワード変更の強制・促進</span></a></td>
<td>初期パスワード使用時のパスワード変更の強制</td>
<td>初期パスワードを使用して認証成功した際に、パスワードの変更を強制する</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>&nbsp;</td>
<td>期限切れパスワードの変更の強制</td>
<td><div class="first last line-block">
<div class="line">一定期間パスワードを変更していないユーザに対して、認証成功時にパスワードの変更を強制する</div>
<div class="line">本アプリケーションでは、管理ユーザのみを対象とする</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>&nbsp;</td>
<td>パスワード変更を促すメッセージの表示</td>
<td>一定期間パスワードを変更していないユーザに対して、認証成功時にパスワードの変更を促すメッセージを表示する</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><a class="reference internal" href="#password-strength"><span>パスワードの品質チェック</span></a></td>
<td>パスワードの最小文字数指定</td>
<td>パスワードとして設定できる文字数の最小値を指定する</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>&nbsp;</td>
<td>パスワードの文字種別指定</td>
<td>パスワード中に含めなければならない文字種別（英大文字、英小文字、数字、記号）を指定する</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td>&nbsp;</td>
<td>ユーザ名を含むパスワードの禁止</td>
<td>パスワード中にアカウントのユーザ名を含めることを禁止する</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td>&nbsp;</td>
<td>管理ユーザパスワードの再使用禁止</td>
<td>管理ユーザが、以前使用したパスワードを短期間のうちに再使用することを禁止する</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><a class="reference internal" href="#account-lock"><span>アカウントのロックアウト</span></a></td>
<td>アカウントロックアウト</td>
<td>あるアカウントが短期間の間に一定回数以上認証に失敗した場合、そのアカウントを認証不能な状態（ロックアウト状態）にする</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td>&nbsp;</td>
<td>アカウントロックアウト期間の指定</td>
<td>アカウントのロックアウト状態の継続時間を指定する</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td>&nbsp;</td>
<td>管理ユーザによるロックアウトの解除</td>
<td>管理ユーザは任意のアカウントのロックアウト状態を解除できる</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><a class="reference internal" href="#last-login"><span>最終ログイン日時の表示</span></a></td>
<td>前回ログイン日時の表示</td>
<td>あるアカウントで認証成功した後、トップ画面にそのアカウントが前回認証に成功した日時を表示する</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><a class="reference internal" href="#reissue-info-create"><span>パスワード再発行のための認証情報の生成</span></a></td>
<td>パスワード再発行用URLへのランダム文字列の付与</td>
<td>不正なアクセスを防ぐため、パスワード再発行画面にアクセスするためのURLに十分に推測困難な文字列を付与する</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td>&nbsp;</td>
<td>パスワード再発行用秘密情報の発行</td>
<td>パスワード再発行時のユーザ確認に用いるために、事前に十分に推測困難な秘密情報（ランダム文字列）を生成する</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(14)</div>
</div>
</td>
<td><a class="reference internal" href="#reissue-info-delivery"><span>パスワード再発行のための認証情報の配布</span></a></td>
<td>パスワード再発行画面URLのメール送付</td>
<td>パスワード再発行ページにアクセスするためのURLは、アカウントの登録済みメールアドレスへ送付する</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(15)</div>
</div>
</td>
<td>&nbsp;</td>
<td>パスワード再発行画面のURLと秘密情報の別配布</td>
<td>パスワード再発行画面のURLの漏えいに備え、秘密情報はメール以外の方法でユーザに配布する</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(16)</div>
</div>
</td>
<td><a class="reference internal" href="#reissue-info-validate"><span>パスワード再発行実行時の検査</span></a></td>
<td>パスワード再発行用の認証情報の有効期限の設定</td>
<td>パスワード再発行画面のURLと秘密情報に有効期限を設定し、有効期限が切れた場合はパスワード再発行画面のURLと秘密情報を使用不能にする</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(17)</div>
</div>
</td>
<td><a class="reference internal" href="#reissue-info-invalidate"><span>パスワード再発行の失敗上限回数の設定</span></a></td>
<td>パスワード再発行の失敗上限回数の設定</td>
<td>パスワード再発行時の認証に一定回数失敗した場合、パスワード再発行画面のURLと秘密情報を使用不能にする</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id69">6.10.2.2. 機能</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>本アプリケーションは、<a class="reference internal" href="Tutorial.html"><em>Spring Securityチュートリアル</em></a> で作成したアプリケーションに加え、以下の機能を持つ。</p>
<table border="1" class="docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">機能名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>パスワード変更機能</td>
<td>ログイン済みのユーザが、自分のアカウントのパスワードを変更する機能</td>
</tr>
<tr class="row-odd"><td>アカウントロックアウト機能</td>
<td>短期間に一定回数以上認証に失敗したアカウントを認証不能な状態にする機能</td>
</tr>
<tr class="row-even"><td>ロックアウト解除機能</td>
<td>アカウントロックアウト機能により認証不能な状態になったアカウントを再び認証可能な状態に戻す機能</td>
</tr>
<tr class="row-odd"><td>パスワード再発行機能</td>
<td>ユーザがパスワードを忘れてしまった場合に、ユーザ確認を行った後、新しいパスワードを設定できる機能</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">本アプリケーションはセキュリティ対策に関するサンプルであるため、本来は当然必要となる
ユーザ登録の機能やパスワード以外の登録情報の更新機能を作成していない。</p>
</div>
</div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id70">6.10.2.3. 認証・認可に関する仕様</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>本アプリケーションにおける、認証・認可に関する仕様についてそれぞれ以下に示す。</p>
<div class="section" id="id10">
<h4><a class="toc-backref" href="#id71">6.10.2.3.1. 認証</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>認証に使用するための初期パスワードはアプリケーション側から払い出されるものとする</li>
</ul>
</div>
<div class="section" id="id11">
<h4><a class="toc-backref" href="#id72">6.10.2.3.2. 認可</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">ログイン画面とパスワード再発行に使用する画面以外の画面へのアクセスには、認証が必要</p>
</li>
<li><dl class="first docutils">
<dt>「一般ユーザ」と「管理ユーザ」の二種類のロールが存在する</dt>
<dd><ul class="first last simple">
<li>一つのアカウントが複数のロールを持つことができる</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">アカウントロックアウト解除機能は、管理ユーザの権限を持つアカウントのみが使用できる</p>
</li>
</ul>
</div>
<div class="section" id="id12">
<h4><a class="toc-backref" href="#id73">6.10.2.3.3. パスワード再発行時の認証</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<ul>
<li><dl class="first docutils">
<dt>パスワード再発行の認証にはアプリケーションが生成する次の二つの情報を用いる</dt>
<dd><ul class="first last simple">
<li>パスワード再発行画面のURL</li>
<li>認証用の秘密情報</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>アプリケーションが生成するパスワード再発行画面のURLは以下の形式である</dt>
<dd><ul class="first last">
<li><dl class="first docutils">
<dt>{baseUrl}/reissue/resetpassword?form&amp;token={token}</dt>
<dd><ul class="first last simple">
<li>{baseUrl} : アプリケーションのベースURL</li>
<li>{token} : UUID version4形式の文字列（ハイフン込みで36文字、128bit）</li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">パスワード再発行画面のURLには30分の有効期限を設け、有効期限内のみ認証可能</p>
</li>
</ul>
</div>
</div>
<div class="section" id="id13">
<h3><a class="toc-backref" href="#id74">6.10.2.4. 設計情報</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id14">
<h4><a class="toc-backref" href="#id75">6.10.2.4.1. 画面遷移</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<p>画面遷移図を以下に示す。エラー時の画面遷移は省略している。</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_page_transition.png"><img alt="Page Transition" src="../_images/SecureLogin_page_transition.png" style="width: 80%;" /></a>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="50%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><div class="first last line-block">
<div class="line">項番</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">画面名</div>
</div>
</th>
<th class="head"><div class="first last line-block">
<div class="line">アクセスコントロール</div>
</div>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ログイン画面</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">トップ画面</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証済みユーザのみ</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報表示画面</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証済みユーザのみ</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード変更画面</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証済みユーザのみ</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード変更完了画面</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証済みユーザのみ</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ロックアウト解除画面</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">管理ユーザのみ</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ロックアウト解除完了画面</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">管理ユーザのみ</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行のための認証情報生成画面</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行のための認証情報生成完了画面</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行画面</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行完了画面</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">-</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="url">
<h4><a class="toc-backref" href="#id76">6.10.2.4.2. URL一覧</a><a class="headerlink" href="#url" title="Permalink to this headline">¶</a></h4>
<p>URL一覧を以下に示す。</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="15%" />
<col width="15%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">プロセス名</th>
<th class="head">HTTPメソッド</th>
<th class="head">URL</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>ログイン画面表示</td>
<td>GET</td>
<td>/login</td>
<td>ログイン画面を表示する</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>ログイン</td>
<td>POST</td>
<td>/login</td>
<td>ログイン画面から入力されたユーザー名、パスワードを使って認証する(Spring Securityが行う)</td>
</tr>
<tr class="row-even"><td>3</td>
<td>ログアウト</td>
<td>POST</td>
<td>/logout</td>
<td>ログアウトする(Spring Securityが行う)</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>トップ画面表示</td>
<td>GET</td>
<td>/</td>
<td>トップ画面を表示する</td>
</tr>
<tr class="row-even"><td>5</td>
<td>アカウント情報表示</td>
<td>GET</td>
<td>/account</td>
<td>ログインユーザーのアカウント情報を表示する</td>
</tr>
<tr class="row-odd"><td>6</td>
<td>パスワード変更画面表示</td>
<td>GET</td>
<td>/password?form</td>
<td>パスワード変更画面を表示する</td>
</tr>
<tr class="row-even"><td>7</td>
<td>パスワード変更</td>
<td>POST</td>
<td>/password</td>
<td>パスワード変更画面で入力された情報を使用して、アカウントのパスワードを変更する</td>
</tr>
<tr class="row-odd"><td>8</td>
<td>パスワード変更完了画面表示</td>
<td>GET</td>
<td>/password?complete</td>
<td>パスワード変更完了画面を表示する</td>
</tr>
<tr class="row-even"><td>9</td>
<td>ロックアウト解除画面表示</td>
<td>GET</td>
<td>/unlock?form</td>
<td>ロックアウト解除画面を表示する</td>
</tr>
<tr class="row-odd"><td>10</td>
<td>ロックアウト解除</td>
<td>POST</td>
<td>/unlock</td>
<td>ロック解除画面に入力された情報を使用してアカウントのロックアウトを解除する</td>
</tr>
<tr class="row-even"><td>11</td>
<td>ロックアウト解除完了画面表示</td>
<td>GET</td>
<td>/unlock?complete</td>
<td>ロックアウト解除完了画面を表示する</td>
</tr>
<tr class="row-odd"><td>12</td>
<td>パスワード再発行のための認証情報生成画面表示</td>
<td>GET</td>
<td>/reissue/create?form</td>
<td>パスワード再発行のための認証情報生成画面を表示する</td>
</tr>
<tr class="row-even"><td>13</td>
<td>パスワード再発行のための認証情報生成</td>
<td>POST</td>
<td>/reissue/create</td>
<td>パスワード再発行のための認証情報を生成する</td>
</tr>
<tr class="row-odd"><td>14</td>
<td>パスワード再発行のための認証情報生成完了画面表示</td>
<td>GET</td>
<td>/reissue/create?complete</td>
<td>パスワード再発行のための認証情報生成完了画面を表示する</td>
</tr>
<tr class="row-even"><td>15</td>
<td>パスワード再発行画面表示</td>
<td>GET</td>
<td>/reissue/resetpassword?form&amp;token={token}</td>
<td>二つのリクエストパラメータを使用して、ユーザ専用のパスワード再発行画面表示を表示する</td>
</tr>
<tr class="row-odd"><td>16</td>
<td>パスワード再発行</td>
<td>POST</td>
<td>/reissue/resetpassword</td>
<td>パスワード再発行画面に入力された情報を使用してパスワードを再発行する</td>
</tr>
<tr class="row-even"><td>17</td>
<td>パスワード再発行完了画面表示</td>
<td>GET</td>
<td>/reissue/resetpassword?complete</td>
<td>パスワード再発行完了画面を表示する</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="er">
<h4><a class="toc-backref" href="#id77">6.10.2.4.3. ER図</a><a class="headerlink" href="#er" title="Permalink to this headline">¶</a></h4>
<p>本アプリケーションにおけるER図を以下に示す。</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_ER.png"><img alt="Entity-Relation Diagram" src="../_images/SecureLogin_ER.png" style="width: 80%;" /></a>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="20%" />
<col width="40%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">エンティティ名</th>
<th class="head">説明</th>
<th class="head">属性</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザの登録済みアカウント情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">username : ユーザ名</div>
<div class="line">password : パスワード（ハッシュ化済み）</div>
<div class="line">firstName : 名</div>
<div class="line">lastName : 姓</div>
<div class="line">email : E-mailアドレス</div>
<div class="line">roles : ロール(複数可)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ロール</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認可に使用する権限</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">roleValue : ロールの識別子</div>
<div class="line">roleLabel : ロールの表示名</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証成功イベント</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウントの最終ログイン日時を取得するために、認証成功時に残す情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">username : ユーザ名</div>
<div class="line">authenticationTimestamp : 認証成功日時</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証失敗イベント</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウントのロックアウト機能で用いるために、認証失敗時に残す情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">username : ユーザ名</div>
<div class="line">authenticationTimestamp : 認証失敗日時</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード変更履歴</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードの有効期限の判定等に用いるために、パスワード変更時に残す情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">username : ユーザ名</div>
<div class="line">useFrom : 変更後のパスワードの使用開始日時</div>
<div class="line">password : 変更後のパスワード</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行用の認証情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行時に、ユーザの確認に用いる情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">token : パスワード再発行画面のURLを一意かつ推測不能にするために用いる文字列</div>
<div class="line">username : ユーザ名</div>
<div class="line">secret : ユーザの確認に用いる文字列</div>
<div class="line">experyDate : パスワード再発行用の認証情報の有効期限</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行失敗イベント</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行用の試行回数を制限するために、パスワード再発行失敗に残す情報</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">token : パスワード再発行に失敗した際に使用したtoken</div>
<div class="line">attemptDate : パスワード再発行を試行した日時</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>初期パスワードやパスワード有効期限切れの判定を行うために、アカウントエンティティにフィールドを追加してパスワードの最終変更日時等の情報を持たせるといった設計も可能である。
そのような方法で実装を行う場合、アカウントのテーブルに様々な状態を判定するためのカラムが追加され、エントリが頻繁に更新されるという状況に繋がりがちである。</p>
<p class="last">本アプリケーションでは、テーブルをシンプルな状態に保ち、エントリの不要な更新を避けて単純に挿入と削除を使用することで要件を実現するために、認証成功イベントエンティティ等のイベントエンティティを用いた設計を採用している。</p>
</div>
</div>
</div>
</div>
<div class="section" id="implement-description">
<span id="id15"></span><h2><a class="toc-backref" href="#id78">6.10.3. 実装方法とコード解説</a><a class="headerlink" href="#implement-description" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">セキュリティ要件の分類ごとに、本アプリケーションにおける実装の方法とコードの説明を行う。</div>
<div class="line">ここでは各分類ごとに要件の実現のために必要最小限のコード片のみを掲載している。コード全体を確認したい場合は <a class="reference external" href="https://github.com/terasolunaorg/tutorial-apps/tree/release/5.1.1.RELEASE/secure-login-demo">GitHub</a> を参照すること。</div>
<div class="line">本アプリケーションを動作させるための初期データ登録用SQLは <a class="reference external" href="https://github.com/terasolunaorg/tutorial-apps/tree/release/5.1.1.RELEASE/secure-login-demo/secure-login-env/src/main/resources/database">ここ</a> に配置されている。</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">本アプリケーションでは、ボイラープレートコードの排除のために、Lombokを使用している。Lombokについては、<a class="reference internal" href="../Appendix/Lombok.html"><em>ボイラープレートコードの排除(Lombok)</em></a> を参照。</p>
</div>
<div class="section" id="password-change">
<span id="id17"></span><h3><a class="toc-backref" href="#id79">6.10.3.1. パスワード変更の強制・促進</a><a class="headerlink" href="#password-change" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id18">
<h4><a class="toc-backref" href="#id80">6.10.3.1.1. 実装する要件一覧</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span>初期パスワード使用時のパスワード変更の強制</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span>期限切れ管理ユーザパスワードの変更の強制</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span>パスワード変更を促すメッセージの表示</span></a></li>
</ul>
</div>
<div class="section" id="id19">
<h4><a class="toc-backref" href="#id81">6.10.3.1.2. 動作イメージ</a><a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_change_password.png"><img alt="Change Password" src="../_images/SecureLogin_change_password.png" style="width: 80%;" /></a>
</div>
</div>
<div class="section" id="id20">
<h4><a class="toc-backref" href="#id82">6.10.3.1.3. 実装方法</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">本アプリケーションでは、パスワードを変更した際の履歴を「パスワード変更履歴」エンティティとしてデータベースに保存し、このパスワード変更履歴エンティティを使用して、初期パスワードの判定およびパスワードの有効期限切れの判定を行う。</div>
<div class="line">また、その判定結果に基づいてパスワード変更画面へのリダイレクトや、画面へのメッセージの表示を制御する。</div>
<div class="line">具体的には以下の処理を実装して用いることで、要件を実現する。</div>
</div>
<ul>
<li><p class="first">パスワード変更履歴エンティティの保存</p>
<p>パスワードを変更した際に、以下の情報を持ったパスワード変更履歴エンティティをデータベースに登録する。</p>
<ul class="simple">
<li>パスワードを変更したアカウントのユーザ名</li>
<li>変更後のパスワードの使用開始日時</li>
</ul>
</li>
<li><p class="first">初期パスワード、パスワード有効期限切れの判定</p>
<div class="line-block">
<div class="line">認証後、認証されたアカウントのパスワード変更履歴エンティティをデータベースから検索し、一件も見つからなければ初期パスワードを使用していると判断する。</div>
<div class="line">そうでない場合には、最新のパスワード変更履歴エンティティを取得し、現在日時とパスワードの使用開始日時の差分を計算して、パスワードの有効期限が切れているかどうかの判定を行う。</div>
</div>
</li>
<li><p class="first">パスワード変更画面への強制リダイレクト</p>
<p>パスワードの変更を強制するために、以下のいずれかに該当する場合には、パスワード変更画面以外へのリクエストが要求された際に、パスワード変更画面へリダイレクトさせる。</p>
<ul class="simple">
<li>認証済みのユーザが初回パスワードを使用している場合</li>
<li>認証済みのユーザが管理ユーザであり、かつパスワードの有効期限が切れている場合</li>
</ul>
<p><code class="docutils literal"><span class="pre">org.springframework.web.servlet.handler.HandlerInterceptor</span></code> を利用して、Controllerのハンドラメソッド実行前に上記の条件に該当するかどうかの判定を行う。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">認証後にパスワード変更画面へリダイレクトさせる方法は他にもあるが、方法によってはリダイレクト後にURLを直打ちすることでパスワード変更を避けて別画面にアクセスできてしまう可能性がある。
<code class="docutils literal"><span class="pre">HandlerInterceptor</span></code> を使用する方法ではハンドラメソッド実行前に処理を行うため、URLを直打ちするなどの方法で回避することはできない。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last"><code class="docutils literal"><span class="pre">HandlerInterceptor</span></code> の代わりにServlet Filterを用いることもできる。両者の説明については <a class="reference internal" href="../ImplementationAtEachLayer/ApplicationLayer.html#controller-common-process"><span>Controllerの呼び出し前後で行う共通処理の実装</span></a> を参照すること。
ここでは、アプリケーションが許可したリクエストのみに対して処理を行うために、<code class="docutils literal"><span class="pre">HandlerInterceptor</span></code> を用いている。</p>
</div>
</li>
<li><p class="first">パスワード変更を促すメッセージの表示</p>
<p>Controllerの中で前述のパスワード有効期限切れ判定処理を呼び出す。判定結果をViewに渡し、Viewでメッセージの表示・非表示を切り替える。</p>
</li>
</ul>
</div>
<div class="section" id="id21">
<h4><a class="toc-backref" href="#id83">6.10.3.1.4. コード解説</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h4>
<p>上記の実装方法に従って実装されたコードについて順に解説する。</p>
<ul>
<li><p class="first">パスワード変更履歴エンティティの保存</p>
<p>パスワード変更時にパスワード変更履歴エンティティをデータベースに登録するための一連の実装を示す。</p>
<ul>
<li><p class="first">Entityの実装</p>
<p>パスワード変更履歴エンティティの実装は以下の通り。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.model</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordHistory</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">useFrom</span><span class="o">;</span> <span class="c1">// (3)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードを変更したアカウントのユーザ名</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">変更後のパスワード</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">変更後のパスワードの使用開始日時</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Repositoryの実装</p>
<p>データベースに対するパスワード変更履歴エンティティの登録、検索を行うためのRepositoryを以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.repository.passwordhistory</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PasswordHistoryRepository</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="nf">create</span><span class="o">(</span><span class="n">PasswordHistory</span> <span class="n">history</span><span class="o">);</span> <span class="c1">// (1)</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="nf">findByUseFrom</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;username&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">,</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;useFrom&quot;</span><span class="o">)</span> <span class="n">LocalDateTime</span> <span class="n">useFrom</span><span class="o">);</span> <span class="c1">// (2)</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="nf">findLatest</span><span class="o">(</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;username&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;limit&quot;</span><span class="o">)</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">);</span> <span class="c1">// (3)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられた<code class="docutils literal"><span class="pre">PasswordHistory</span></code> オブジェクトをデータベースのレコードとして登録するメソッド</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられたユーザ名をキーとして、パスワードの使用開始日時が指定された日付よりも新しい<code class="docutils literal"><span class="pre">PasswordHistory</span></code> オブジェクトを降順(新しい順)に取得するメソッド</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられたユーザ名をキーとして、指定された個数の<code class="docutils literal"><span class="pre">PasswordHistory</span></code> オブジェクトを新しい順に取得するメソッド</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>マッピングファイルは以下の通り。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="nt">&lt;mapper</span>
    <span class="na">namespace=</span><span class="s">&quot;org.terasoluna.securelogin.domain.repository.passwordhistory.PasswordHistoryRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;PasswordHistoryResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;PasswordHistory&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;username&quot;</span> <span class="na">column=</span><span class="s">&quot;username&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;password&quot;</span> <span class="na">column=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;useFrom&quot;</span> <span class="na">column=</span><span class="s">&quot;use_from&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findByUseFrom&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;PasswordHistoryResultMap&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            username,</span>
<span class="cp">            password,</span>
<span class="cp">            use_from</span>
<span class="cp">        FROM</span>
<span class="cp">            password_history</span>
<span class="cp">        WHERE</span>
<span class="cp">            username = #{username} AND</span>
<span class="cp">            use_from &gt;= #{useFrom}</span>
<span class="cp">        ORDER BY use_from DESC</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findLatest&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;PasswordHistoryResultMap&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            username,</span>
<span class="cp">            password,</span>
<span class="cp">            use_from</span>
<span class="cp">        FROM</span>
<span class="cp">            password_history</span>
<span class="cp">        WHERE</span>
<span class="cp">            username = #{username}</span>
<span class="cp">        ORDER BY use_from DESC</span>
<span class="cp">        LIMIT #{limit}</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;PasswordHistory&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        INSERT INTO password_history (</span>
<span class="cp">            username,</span>
<span class="cp">            password,</span>
<span class="cp">            use_from</span>
<span class="cp">        ) VALUES (</span>
<span class="cp">            #{username},</span>
<span class="cp">            #{password},</span>
<span class="cp">            #{useFrom}</span>
<span class="cp">        )</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/insert&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Serviceの実装</p>
<p>パスワード変更履歴エンティティの操作は <a class="reference internal" href="#password-strength"><span>パスワードの品質チェック</span></a> においても使用する。
そのため、以下のようにSharedServiceからRepositoryのメソッドを呼び出す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordhistory</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordHistorySharedServiceImpl</span> <span class="kd">implements</span>
        <span class="n">PasswordHistorySharedService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordHistoryRepository</span> <span class="n">passwordHistoryRepository</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">insert</span><span class="o">(</span><span class="n">PasswordHistory</span> <span class="n">history</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">passwordHistoryRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">history</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="nf">findHistoriesByUseFrom</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span>
            <span class="n">LocalDateTime</span> <span class="n">useFrom</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">passwordHistoryRepository</span><span class="o">.</span><span class="na">findByUseFrom</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">useFrom</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="nf">findLatest</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">passwordHistoryRepository</span><span class="o">.</span><span class="na">findLatest</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">limit</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>パスワード変更時にパスワード変更履歴エンティティをデータベースに保存する処理の実装を以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.account</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountSharedServiceImpl</span> <span class="kd">implements</span> <span class="n">AccountSharedService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordHistorySharedService</span> <span class="n">passwordHistorySharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountRepository</span> <span class="n">accountRepository</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">updatePassword</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">rawPassword</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>
        <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">rawPassword</span><span class="o">);</span>
        <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="n">accountRepository</span><span class="o">.</span><span class="na">updatePassword</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span> <span class="c1">// (2)</span>

        <span class="n">LocalDateTime</span> <span class="n">passwordChangeDate</span> <span class="o">=</span> <span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">();</span>

        <span class="n">PasswordHistory</span> <span class="n">passwordHistory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PasswordHistory</span><span class="o">();</span> <span class="c1">// (3)</span>
        <span class="n">passwordHistory</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="n">passwordHistory</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
        <span class="n">passwordHistory</span><span class="o">.</span><span class="na">setUseFrom</span><span class="o">(</span><span class="n">passwordChangeDate</span><span class="o">);</span>
        <span class="n">passwordHistorySharedService</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">passwordHistory</span><span class="o">);</span> <span class="c1">// (4)</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードを変更する際に呼び出されるメソッド</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">データベース上のパスワードを更新する処理を呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード変更履歴エンティティを作成し、ユーザ名、変更後のパスワード、変更後のパスワードの使用開始日時を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">作成したパスワード変更履歴エンティティをデータベースに登録する処理を呼び出す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
<li><p class="first">初期パスワード、パスワード有効期限切れの判定</p>
<p>データベースに登録されたパスワード変更履歴エンティティを用いて、初期パスワードを使用しているかどうかの判定と、パスワードの有効期限が切れているかどうかを判定する処理の実装を以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.account</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountSharedServiceImpl</span> <span class="kd">implements</span> <span class="n">AccountSharedService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordHistorySharedService</span> <span class="n">passwordHistorySharedService</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.passwordLifeTimeSeconds}&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="kt">int</span> <span class="n">passwordLifeTimeSeconds</span><span class="o">;</span>

    <span class="c1">// omitted</span>

   <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
   <span class="nd">@Override</span>
   <span class="nd">@Cacheable</span><span class="o">(</span><span class="s">&quot;isInitialPassword&quot;</span><span class="o">)</span>
   <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isInitialPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (2)</span>
       <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="n">passwordHistories</span> <span class="o">=</span> <span class="n">passwordHistorySharedService</span>
               <span class="o">.</span><span class="na">findLatest</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span> <span class="c1">// (3)</span>
       <span class="k">return</span> <span class="n">passwordHistories</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span> <span class="c1">// (4)</span>
   <span class="o">}</span>

   <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
   <span class="nd">@Override</span>
   <span class="nd">@Cacheable</span><span class="o">(</span><span class="s">&quot;isCurrentPasswordExpired&quot;</span><span class="o">)</span>
   <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isCurrentPasswordExpired</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (5)</span>
       <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="n">passwordHistories</span> <span class="o">=</span> <span class="n">passwordHistorySharedService</span>
               <span class="o">.</span><span class="na">findLatest</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span> <span class="c1">// (6)</span>

       <span class="k">if</span> <span class="o">(</span><span class="n">passwordHistories</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (7)</span>
           <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
       <span class="o">}</span>

       <span class="k">if</span> <span class="o">(</span><span class="n">passwordHistories</span>
               <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
               <span class="o">.</span><span class="na">getUseFrom</span><span class="o">()</span>
               <span class="o">.</span><span class="na">isBefore</span><span class="o">(</span>
                       <span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">()</span>
                               <span class="o">.</span><span class="na">minusSeconds</span><span class="o">(</span><span class="n">passwordLifeTimeSeconds</span><span class="o">)))</span> <span class="o">{</span> <span class="c1">// (8)</span>
           <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
       <span class="o">}</span>

       <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
   <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">プロパティファイルからパスワードが有効である期間の長さ（秒単位）を取得し、設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">初期パスワードを使用しているかどうかを判定し、使用している場合はtrue、そうでなければfalseを返すメソッド</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">データベースから最新のパスワード変更履歴エンティティを一件取得する処理を呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">データベースからパスワード変更履歴エンティティが取得できなかった場合に、初期パスワードを使用していると判定し、trueを返す。そうでなければfalseを返す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">現在使用中のパスワードの有効期限が切れているかどうかを判定し、切れている場合はtrue、そうでなければfalseを返すメソッド</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">データベースから最新のパスワード変更履歴エンティティを一件取得する処理を呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">データベースからパスワード変更履歴エンティティが取得できなかった場合には、パスワードの有効期限が切れていると判定し、trueを返す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード変更履歴エンティティから取得したパスワードの使用開始日時と現在日時の差分が、(1)で設定したパスワード有効期間よりも大きい場合、パスワードの有効期限が切れていると判定し、trueを返す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(7), (8)のいずれの条件にも該当しない場合、パスワード有効期限内であると判定し、falseを返す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>isInitialPassword および isCurrentPasswordExpired に付与されている <code class="docutils literal"><span class="pre">&#64;Cacheable</span></code>は Spring の Cache Abstraction 機能を使用するためのアノテーションである。
<code class="docutils literal"><span class="pre">&#64;Cacheable</span></code> アノテーションを付与することで、メソッドの引数に対する結果をキャッシュすることができる。
ここでは、キャッシュの使用により初期パスワード判定、パスワード期限切れ判定のたびにデータベースへのアクセスが発生することを防止し、パフォーマンスの低下を防いでいる。
Cache Abstraction については <a class="reference external" href="http://docs.spring.io/spring/docs/4.2.4.RELEASE/spring-framework-reference/html/cache.html">公式ドキュメント</a> を参照すること。</p>
<p>尚、キャッシュを使用する際には、必要なタイミングでキャッシュをクリアする必要があることに注意すること。
本アプリケーションではパスワード変更時や、ログアウト時には再度初期パスワード判定、パスワード期限切れ判定を行うためにキャッシュをクリアする。</p>
<p class="last">また、必要に応じてキャッシュのTTL(生存時間)を設定すること。TTLは使用するキャッシュの実装によっては設定不能であることに注意。</p>
</div>
</li>
<li><p class="first">パスワード変更画面への強制リダイレクト</p>
<p>パスワードの変更を強制するために、パスワード変更画面へリダイレクトさせる処理の実装を以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.interceptor</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordExpirationCheckInterceptor</span> <span class="kd">extends</span>
        <span class="n">HandlerInterceptorAdapter</span> <span class="o">{</span> <span class="c1">// (1)</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">preHandle</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
            <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Object</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span> <span class="c1">// (2)</span>
        <span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="o">(</span><span class="n">Authentication</span><span class="o">)</span> <span class="n">request</span>
                <span class="o">.</span><span class="na">getUserPrincipal</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Object</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">principal</span> <span class="k">instanceof</span> <span class="n">UserDetails</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
                <span class="n">LoggedInUser</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="o">(</span><span class="n">LoggedInUser</span><span class="o">)</span> <span class="n">principal</span><span class="o">;</span> <span class="c1">// (4)</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">userDetails</span><span class="o">.</span><span class="na">getAccount</span><span class="o">().</span><span class="na">getRoles</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">Role</span><span class="o">.</span><span class="na">ADMIN</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">accountSharedService</span>
                        <span class="o">.</span><span class="na">isCurrentPasswordExpired</span><span class="o">(</span><span class="n">userDetails</span><span class="o">.</span><span class="na">getUsername</span><span class="o">()))</span> <span class="c1">// (5)</span>
                        <span class="o">||</span> <span class="n">accountSharedService</span><span class="o">.</span><span class="na">isInitialPassword</span><span class="o">(</span><span class="n">userDetails</span>
                                <span class="o">.</span><span class="na">getUsername</span><span class="o">()))</span> <span class="o">{</span> <span class="c1">// (6)</span>
                    <span class="n">response</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">()</span>
                            <span class="o">+</span> <span class="s">&quot;/password?form&quot;</span><span class="o">);</span> <span class="c1">// (7)</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// (8)</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Controllerのハンドラメソッド実行前に処理を挟み込むために、<code class="docutils literal"><span class="pre">org.springframework.web.servlet.handler.HandlerInterceptorAdapter</span></code> を継承する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Controllerのハンドラメソッド実行前に実行されるメソッド</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したユーザ情報が<code class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.UserDetails</span></code> のオブジェクトであるかどうかを確認する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserDetails</span></code> のオブジェクトを取得する。本アプリケーションでは、<code class="docutils literal"><span class="pre">UserDetails</span></code> の実装として<code class="docutils literal"><span class="pre">LoggedInUser</span></code> というクラスを作成して用いている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserDetails</span></code> オブジェクトからロールを取得してユーザが管理ユーザであるかどうかを判定する。その後、パスワード有効期限が切れているかどうかを判定する処理を呼び出す。二つの判定結果の論理積(And)をとる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">初回パスワードを使用しているかどうかを判定する処理を呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(5)または(6)のいずれかが真である場合、<code class="docutils literal"><span class="pre">javax.servlet.http.HttpServletResponse</span></code> の<code class="docutils literal"><span class="pre">sendRedirect</span></code> メソッドを使用して、パスワード変更画面へリダイレクトさせる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">続けてControllerのハンドラメソッドが実行されることを防ぐために、falseを返す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>上記のリダイレクト処理を有効にするための設定は以下の通り。</p>
<p><strong>spring-mvc.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;mvc:interceptors&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;mvc:interceptor&gt;</span>
        <span class="nt">&lt;mvc:mapping</span> <span class="na">path=</span><span class="s">&quot;/**&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/password/**&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/reissue/**&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/resources/**&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;mvc:exclude-mapping</span> <span class="na">path=</span><span class="s">&quot;/**/*.html&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;bean</span>
            <span class="na">class=</span><span class="s">&quot;org.terasoluna.securelogin.app.common.interceptor.PasswordExpirationCheckInterceptor&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;/mvc:interceptor&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/mvc:interceptors&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">&#8220;/&#8221;以下のすべてのパスに対するアクセスに<code class="docutils literal"><span class="pre">HandlerInterceptor</span></code> を適用する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード変更画面からパスワード変更画面へのリダイレクトを防ぐため、 &#8220;/password&#8221; 以下のパスは適用対象外とする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行時にはパスワード有効期限のチェックを行う必要はないため、 &#8220;/reissue&#8221; 以下のパスは適用対象外とする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HandlerInterceptor</span></code> のクラスを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">パスワード変更を促すメッセージの表示</p>
<p>トップ画面にパスワード変更を促すメッセージを表示するための、Controllerの実装を以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.welcome</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="o">{</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span>
            <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span> <span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">home</span><span class="o">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">LoggedInUser</span> <span class="n">userDetails</span><span class="o">,</span> <span class="c1">// (1)</span>
            <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getAccount</span><span class="o">();</span> <span class="c1">// (2)</span>

        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;account&quot;</span><span class="o">,</span> <span class="n">account</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(</span><span class="n">accountSharedService</span><span class="o">.</span><span class="na">isCurrentPasswordExpired</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getUsername</span><span class="o">())){</span> <span class="c1">// (3)</span>
            <span class="n">ResultMessages</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">ResultMessages</span><span class="o">.</span><span class="na">warning</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;w.sl.pe.0001&quot;</span><span class="o">);</span>
            <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">messages</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// omitted</span>

        <span class="k">return</span> <span class="s">&quot;welcome/home&quot;</span><span class="o">;</span>

    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationPrincipal</span></code> アノテーションを指定して、<code class="docutils literal"><span class="pre">UserDetails</span></code> を実装した<code class="docutils literal"><span class="pre">LoggedInUser</span></code> のオブジェクトを取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">LoggedInUser</span></code> が保持しているアカウント情報を取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アカウント情報から取得したユーザ名を引数として、パスワードの有効期限切れ判定処理を呼び出す。判定結果がtrueの場合、プロパティファイルからメッセージを取得してModelに設定し、Viewに渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Viewの実装は以下の通り。</p>
<p><strong>トップ画面(home.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;body&gt;</span>
   <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
       <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;expiredMessage&quot;</span><span class="nt">&gt;</span>
           <span class="nt">&lt;t:messagesPanel</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
       <span class="nt">&lt;/span&gt;</span>

       <span class="c">&lt;!-- omitted --&gt;</span>

   <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">messagesPanelタグを用いて、Controllerから渡されたパスワード有効期限切れメッセージを表示する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>
<div class="section" id="password-strength">
<span id="id23"></span><h3><a class="toc-backref" href="#id84">6.10.3.2. パスワードの品質チェック</a><a class="headerlink" href="#password-strength" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id24">
<h4><a class="toc-backref" href="#id85">6.10.3.2.1. 実装する要件一覧</a><a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span>パスワードの最小文字数指定</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span>パスワードの文字種別指定</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span>ユーザ名を含むパスワードの禁止</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span>管理ユーザパスワードの再使用禁止</span></a></li>
</ul>
</div>
<div class="section" id="id25">
<h4><a class="toc-backref" href="#id86">6.10.3.2.2. 動作イメージ</a><a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h4>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_password_validation.png"><img alt="Password Validation" src="../_images/SecureLogin_password_validation.png" style="width: 80%;" /></a>
</div>
</div>
<div class="section" id="id26">
<h4><a class="toc-backref" href="#id87">6.10.3.2.3. 実装方法</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">パスワード変更時等にユーザが指定したパスワードの品質を検査するためには、 <a class="reference internal" href="../ArchitectureInDetail/Validation.html"><em>入力チェック</em></a> の機能を利用することができる。本アプリケーションではBean Validationを用いてパスワードの品質を検査する。</div>
<div class="line">パスワードの品質として求められる要件はアプリケーションによって異なり、多岐に渡る。</div>
<div class="line">そこで、パスワード入力チェック用のライブラリとして <a class="reference external" href="http://www.passay.org/">Passay</a> を利用し、必要なBean Validationのアノテーションを作成する。</div>
<div class="line">Passayではパスワード入力チェックで一般的に使用される機能の多くを提供しており、提供されていない機能についても標準機能を拡張することで容易に実装することができる。</div>
<div class="line">Passayの概要については <a class="reference internal" href="#passay-overview"><span>Appendix</span></a> を参照。</div>
<div class="line">具体的には以下の設定、処理を記述し、使用することで要件を実現する。</div>
</div>
<ul>
<li><p class="first">Passayの検証規則の作成</p>
<p>要件の実現に用いるために、以下の検証規則を作成する。</p>
<blockquote>
<div><ul class="simple">
<li>パスワード長の最小値を設定した検証規則</li>
<li>パスワードに含めなければならない文字種別を設定した検証規則</li>
<li>パスワードがユーザ名を含まないことをチェックするための検証規則</li>
<li>同一のパスワードを過去に使用していないことをチェックするための検証規則</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Passayの検証器の作成</p>
<p>上記で作成した検証規則を設定した、Passayの検証器を作成する。</p>
</li>
<li><p class="first">Bean Validationのアノテーションの作成</p>
<p>Passayの検証器を使用してパスワードの入力チェックを行うためのアノテーションを作成する。
一つのアノテーションですべての検証規則を検査することもできるが、多種の規則の検査を行うことで処理が複雑になり視認性が下がることを避けるため、以下の二つに分けて実装する。</p>
<blockquote>
<div><ul>
<li><p class="first">パスワード自体の性質を検証するアノテーション</p>
<p>「パスワードが最小文字列長よりも長いこと」、「指定した文字種別の文字を含むこと」、「ユーザ名を含まないこと」の三つの検証規則をチェックする</p>
</li>
<li><p class="first">過去のパスワードとの比較を行うアノテーション</p>
<p>管理ユーザが、以前使用したパスワードを短期間のうちに再使用していないことをチェックする</p>
</li>
</ul>
</div></blockquote>
<p>いずれのアノテーションも、ユーザ名と新しいパスワードを用いる相関入力チェックルールとなる。
両方のルールに違反した入力を行った場合、それぞれのエラーメッセージが表示される。</p>
</li>
<li><p class="first">パスワードの入力チェック</p>
<p>作成したBean Validationアノテーションを用いて、パスワードの入力チェックを行う。</p>
</li>
</ul>
</div>
<div class="section" id="id27">
<h4><a class="toc-backref" href="#id88">6.10.3.2.4. コード解説</a><a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h4>
<p>上記の実装方法に従って実装されたコードについて順に解説する。Passayを用いたパスワード入力チェックについては <a class="reference internal" href="#password-validation"><span>パスワード入力チェック</span></a> にて説明する。</p>
<ul>
<li><p class="first">Passayの検証規則の作成</p>
<div class="line-block">
<div class="line">本アプリケーションで使用するほとんどの検証規則は、Passayにデフォルトで用意されたクラスを利用することで定義できる。</div>
<div class="line">しかしながら、Passayが提供するクラスでは、<code class="docutils literal"><span class="pre">org.springframework.security.crypto.password.PasswordEncoder</span></code> でハッシュ化された過去のパスワードと比較する検証規則を定義することができない。</div>
<div class="line">そのため、Passayが提供するクラスを拡張し、独自の検証規則のクラスを以下のように作成する必要がある。</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation.rule</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EncodedPasswordHistoryRule</span> <span class="kd">extends</span> <span class="n">HistoryRule</span> <span class="o">{</span> <span class="c1">// (1)</span>

    <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="kd">public</span> <span class="nf">EncodedPasswordHistoryRule</span><span class="o">(</span><span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">passwordEncoder</span> <span class="o">=</span> <span class="n">passwordEncoder</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">clearText</span><span class="o">,</span>
            <span class="kd">final</span> <span class="n">PasswordData</span><span class="o">.</span><span class="na">Reference</span> <span class="n">reference</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
        <span class="k">return</span> <span class="n">passwordEncoder</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">clearText</span><span class="o">,</span> <span class="n">reference</span><span class="o">.</span><span class="na">getPassword</span><span class="o">());</span> <span class="c1">// (4)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードが過去に使用したパスワードに含まれないをチェックするための<code class="docutils literal"><span class="pre">org.passay.HistoryRule</span></code> を拡張する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードのハッシュ化に用いている<code class="docutils literal"><span class="pre">PasswordEncoder</span></code> をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">過去のパスワードとの比較を行うメソッドをオーバーライドする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">PasswordEncoder</span></code> の <code class="docutils literal"><span class="pre">matches</span></code> メソッドを使用してハッシュ化されたパスワードとの比較を行う。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Passayの検証規則を以下に示す通りBean定義する。</p>
<p><strong>applicationContext.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;lengthRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.LengthRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;minimumLength&quot;</span> <span class="na">value=</span><span class="s">&quot;${security.passwordMinimumLength}&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;upperCaseRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.UpperCase&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;lowerCaseRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.LowerCase&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;digitRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.Digit&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;specialCharacterRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.Special&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;characterCharacteristicsRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterCharacteristicsRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;rules&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;upperCaseRule&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;lowerCaseRule&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;digitRule&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;specialCharacterRule&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;numberOfCharacteristics&quot;</span> <span class="na">value=</span><span class="s">&quot;3&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;usernameRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.UsernameRule&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (7) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;encodedPasswordHistoryRule&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.terasoluna.securelogin.app.common.validation.rule.EncodedPasswordHistoryRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (8) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードの長さをチェックするための<code class="docutils literal"><span class="pre">org.passay.LengthRule</span></code> のプロパティに、プロパティファイルから取得したパスワードの最短長を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">半角英大文字を一文字以上含むことをチェックする検証規則。パスワードに含まれる文字種別に関するチェックを行うための<code class="docutils literal"><span class="pre">org.passay.CharacterRule</span></code> のコンストラクタに、<code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.UpperCase</span></code> と数値の1を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">半角英小文字を一文字以上含むことをチェックする検証規則。パスワードに含まれる文字種別に関するチェックを行うための<code class="docutils literal"><span class="pre">org.passay.CharacterRule</span></code> のコンストラクタに、<code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.LowerCase</span></code> と数値の1を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">半角数字を一文字以上含むことをチェックする検証規則。パスワードに含まれる文字種別に関するチェックを行うための<code class="docutils literal"><span class="pre">org.passay.CharacterRule</span></code> のコンストラクタに、<code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.Digit</span></code> と数値の1を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">半角記号を一文字以上含むことをチェックする検証規則。パスワードに含まれる文字種別に関するチェックを行うための<code class="docutils literal"><span class="pre">org.passay.CharacterRule</span></code> のコンストラクタに、<code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.Special</span></code> と数値の1を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(2)-(5)の4つの検証規則のうち、3つを満たすことをチェックするための検証規則。<code class="docutils literal"><span class="pre">org.passay.CharacterCharacteristicsRule</span></code> のプロパティに、(2)-(5)で定義したBeanのリストと、数値の3を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードにユーザ名が含まれていないことをチェックするための検証規則</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードが過去に使用したものの中に含まれていないことをチェックするための検証規則</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Passayの検証器の作成</p>
<p>前述したPassayの検証規則を用いて、実際に検証を行う検証器のBean定義を以下に示す。</p>
<p><strong>applicationContext.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;characteristicPasswordValidator&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.PasswordValidator&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;rules&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;lengthRule&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;characterCharacteristicsRule&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;usernameRule&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;encodedPasswordHistoryValidator&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.PasswordValidator&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;rules&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;encodedPasswordHistoryRule&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード自体の性質を検証するための検証器。プロパティとして、<code class="docutils literal"><span class="pre">LengthRule</span></code> , <code class="docutils literal"><span class="pre">CharacterCharacteristicsRule</span></code> , <code class="docutils literal"><span class="pre">UsernameRule</span></code> のBeanを設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">過去に使用したパスワードの履歴を使用したチェックを行うための検証器。プロパティとして<code class="docutils literal"><span class="pre">EncodedPasswordHistoryRule</span></code> のBeanを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Bean Validationのアノテーションの作成</p>
<p>要件を実現するために、前述した検証器を使用する2つのアノテーションを作成する。</p>
<ul>
<li><p class="first">パスワード自体の性質を検証するアノテーション</p>
<p>パスワードが最小文字列長よりも長いこと、指定した文字種別の文字を含むこと、ユーザ名を含まないことという三つの検証規則をチェックするアノテーションの実装を以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">StrongPasswordValidator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="c1">// (1)</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">TYPE</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">StrongPassword</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{org.terasoluna.securelogin.app.common.validation.StrongPassword.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">String</span> <span class="nf">usernamePropertyName</span><span class="o">();</span> <span class="c1">// (2)</span>

    <span class="n">String</span> <span class="nf">newPasswordPropertyName</span><span class="o">();</span> <span class="c1">// (3)</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">TYPE</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">StrongPassword</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アノテーション付与時に使用する<code class="docutils literal"><span class="pre">ConstraintValidator</span></code> を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザ名のプロパティ名を指定するためのプロパティ。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードのプロパティ名を指定するためのプロパティ。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StrongPasswordValidator</span> <span class="kd">implements</span>
        <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">StrongPassword</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;characteristicPasswordValidator&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="n">PasswordValidator</span> <span class="n">characteristicPasswordValidator</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">usernamePropertyName</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">newPasswordPropertyName</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">StrongPassword</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">usernamePropertyName</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">usernamePropertyName</span><span class="o">();</span>
        <span class="n">newPasswordPropertyName</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">newPasswordPropertyName</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">BeanWrapper</span> <span class="n">beanWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanWrapperImpl</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">beanWrapper</span><span class="o">.</span><span class="na">getPropertyValue</span><span class="o">(</span><span class="n">usernamePropertyName</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">newPassword</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">beanWrapper</span>
                <span class="o">.</span><span class="na">getPropertyValue</span><span class="o">(</span><span class="n">newPasswordPropertyName</span><span class="o">);</span>

        <span class="n">RuleResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">characteristicPasswordValidator</span>
                <span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">PasswordData</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">newPassword</span><span class="o">,</span> <span class="n">username</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span> <span class="c1">// (2)</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (3)</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">disableDefaultConstraintViolation</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">message</span> <span class="o">:</span> <span class="n">characteristicPasswordValidator</span>
                    <span class="o">.</span><span class="na">getMessages</span><span class="o">(</span><span class="n">result</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// (4)</span>
                <span class="n">context</span><span class="o">.</span><span class="na">buildConstraintViolationWithTemplate</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">addPropertyNode</span><span class="o">(</span><span class="n">newPasswordPropertyName</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">addConstraintViolation</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Passayの検証器をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードとユーザ名を指定した<code class="docutils literal"><span class="pre">org.passay.PasswordData</span></code> のインスタンスを作成し、検証器で入力チェックを行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">チェックの結果を確認し、OKならばtrueを返し、そうでなければfalseを返す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード入力チェックエラーメッセージをすべて取得し、設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">過去のパスワードとの比較を行うアノテーション</p>
<div class="line-block">
<div class="line">管理ユーザが、以前使用したパスワードを短期間のうちに再使用していないことをチェックするアノテーションの実装を以下に示す。</div>
<div class="line">過去に使用したパスワードを取得するために、パスワード変更履歴エンティティを用いる。パスワード変更履歴エンティティについては <a class="reference internal" href="#password-change"><span>パスワード変更の強制・促進</span></a> を参照。</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">「いくつ前までのパスワードの再使用を禁止するか」のみの設定では、短時間の間にパスワード変更を繰り返すことでパスワードを再使用することが可能となってしまう。
これを防ぐために、本アプリケーションでは「いつ以降使用したパスワードの再使用を禁止するか」を設定して検査を行う。</p>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="n">NotReusedPasswordValidator</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span> <span class="c1">// (1)</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">TYPE</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">NotReusedPassword</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;{org.terasoluna.securelogin.app.common.validation.NotReusedPassword.message}&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="n">String</span> <span class="nf">usernamePropertyName</span><span class="o">();</span> <span class="c1">// (2)</span>

    <span class="n">String</span> <span class="nf">newPasswordPropertyName</span><span class="o">();</span> <span class="c1">// (3)</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">TYPE</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">NotReusedPassword</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">アノテーション付与時に使用する<code class="docutils literal"><span class="pre">ConstraintValidator</span></code> を指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザ名のプロパティ名を指定するためのプロパティ。データベースから過去に使用したパスワードを検索するために必要となる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードのプロパティ名を指定するためのプロパティ。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.common.validation</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NotReusedPasswordValidator</span> <span class="kd">implements</span>
        <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">NotReusedPassword</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordHistorySharedService</span> <span class="n">passwordHistorySharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;encodedPasswordHistoryValidator&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="n">PasswordValidator</span> <span class="n">encodedPasswordHistoryValidator</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.passwordHistoricalCheckingCount}&quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
    <span class="kt">int</span> <span class="n">passwordHistoricalCheckingCount</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.passwordHistoricalCheckingPeriod}&quot;</span><span class="o">)</span> <span class="c1">// (3)</span>
    <span class="kt">int</span> <span class="n">passwordHistoricalCheckingPeriod</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">usernamePropertyName</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">newPasswordPropertyName</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">message</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">NotReusedPassword</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">usernamePropertyName</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">usernamePropertyName</span><span class="o">();</span>
        <span class="n">newPasswordPropertyName</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">newPasswordPropertyName</span><span class="o">();</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">message</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">BeanWrapper</span> <span class="n">beanWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanWrapperImpl</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">beanWrapper</span><span class="o">.</span><span class="na">getPropertyValue</span><span class="o">(</span><span class="n">usernamePropertyName</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">newPassword</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">beanWrapper</span>
                <span class="o">.</span><span class="na">getPropertyValue</span><span class="o">(</span><span class="n">newPasswordPropertyName</span><span class="o">);</span>

        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountSharedService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">currentPassword</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>

        <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="n">checkNewPasswordDifferentFromCurrentPassword</span><span class="o">(</span>
                <span class="n">newPassword</span><span class="o">,</span> <span class="n">currentPassword</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span> <span class="c1">// (4)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">account</span><span class="o">.</span><span class="na">getRoles</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">Role</span><span class="o">.</span><span class="na">ADMIN</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// (5)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">checkHistoricalPassword</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">newPassword</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">checkNewPasswordDifferentFromCurrentPassword</span><span class="o">(</span>
            <span class="n">String</span> <span class="n">newPassword</span><span class="o">,</span> <span class="n">String</span> <span class="n">currentPassword</span><span class="o">,</span>
            <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">newPassword</span><span class="o">,</span> <span class="n">currentPassword</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">disableDefaultConstraintViolation</span><span class="o">();</span>
            <span class="n">context</span><span class="o">.</span><span class="na">buildConstraintViolationWithTemplate</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">addPropertyNode</span><span class="o">(</span><span class="n">newPasswordPropertyName</span><span class="o">).</span><span class="na">addConstraintViolation</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">checkHistoricalPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span>
            <span class="n">String</span> <span class="n">newPassword</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">LocalDateTime</span> <span class="n">useFrom</span> <span class="o">=</span> <span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">()</span>
                <span class="o">.</span><span class="na">minusMinutes</span><span class="o">(</span><span class="n">passwordHistoricalCheckingPeriod</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="n">historyByTime</span> <span class="o">=</span> <span class="n">passwordHistorySharedService</span>
                <span class="o">.</span><span class="na">findHistoriesByUseFrom</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">useFrom</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="n">historyByCount</span> <span class="o">=</span> <span class="n">passwordHistorySharedService</span>
                <span class="o">.</span><span class="na">findLatest</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">passwordHistoricalCheckingCount</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordHistory</span><span class="o">&gt;</span> <span class="n">history</span> <span class="o">=</span> <span class="n">historyByCount</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">historyByTime</span>
                <span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">?</span> <span class="n">historyByCount</span> <span class="o">:</span> <span class="n">historyByTime</span><span class="o">;</span> <span class="c1">// (6)</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">PasswordData</span><span class="o">.</span><span class="na">Reference</span><span class="o">&gt;</span> <span class="n">historyData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">PasswordHistory</span> <span class="n">h</span> <span class="o">:</span> <span class="n">history</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">historyData</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PasswordData</span><span class="o">.</span><span class="na">HistoricalReference</span><span class="o">(</span><span class="n">h</span>
                    <span class="o">.</span><span class="na">getPassword</span><span class="o">()));</span> <span class="c1">// (7)</span>
        <span class="o">}</span>

        <span class="n">PasswordData</span> <span class="n">passwordData</span> <span class="o">=</span> <span class="n">PasswordData</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">newPassword</span><span class="o">,</span>
                <span class="n">username</span><span class="o">,</span> <span class="n">historyData</span><span class="o">);</span> <span class="c1">// (8)</span>
        <span class="n">RuleResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">encodedPasswordHistoryValidator</span>
                <span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">passwordData</span><span class="o">);</span> <span class="c1">// (9)</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (10)</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">disableDefaultConstraintViolation</span><span class="o">();</span>
            <span class="n">context</span><span class="o">.</span><span class="na">buildConstraintViolationWithTemplate</span><span class="o">(</span>
                    <span class="n">encodedPasswordHistoryValidator</span><span class="o">.</span><span class="na">getMessages</span><span class="o">(</span><span class="n">result</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="c1">// (11)</span>
                    <span class="o">.</span><span class="na">addPropertyNode</span><span class="o">(</span><span class="n">newPasswordPropertyName</span><span class="o">).</span><span class="na">addConstraintViolation</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Passayの検証器をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">いくつ前までのパスワードの再使用を禁止するかの閾値をプロパティファイルから取得し、インジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">いつ以降使用したパスワードの再使用を禁止するかの閾値（秒数）をプロパティファイルから取得し、インジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">新しいパスワードが現在使用しているものと異なるかどうかをチェックする処理を呼び出す。このチェックは一般ユーザ・管理ユーザにかかわらず行う。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">管理ユーザの場合は、新しいパスワードが過去に使用したパスワードに含まれていないかをチェックする処理を呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(2)で指定した個数分のパスワード変更履歴エンティティと、(3)で指定した期間分のパスワード変更履歴エンティティを取得し、どちらか数の多い方を以降のチェックに用いる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Passayの検証器で過去のパスワードとの比較を行うために、パスワード変更履歴エンティティからパスワードを取得し、<code class="docutils literal"><span class="pre">org.passay.PasswordData.HistoricalReference</span></code> のリストを作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード、ユーザ名、過去のパスワードのリストを指定した<code class="docutils literal"><span class="pre">org.passay.PasswordData</span></code> のインスタンスを作成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">検証器で入力チェックを行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">チェック結果を確認し、OKならばtrueを返し、そうでなければfalseを返す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード入力チェックエラーメッセージを取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
<li><p class="first">パスワードの入力チェック</p>
<p>Bean Validationアノテーションを使用してアプリケーション層で、パスワード入力チェックを行う。
Formクラスに付与されたアノテーションによってNullチェック以外の入力チェックが網羅されていることから、単項目チェックとしては<code class="docutils literal"><span class="pre">&#64;NotNull</span></code> のみを付与している。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordchange</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@Data</span>
<span class="nd">@Compare</span><span class="o">(</span><span class="n">source</span> <span class="o">=</span> <span class="s">&quot;newPasssword&quot;</span><span class="o">,</span> <span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;confirmNewPassword&quot;</span><span class="o">,</span> <span class="n">operator</span> <span class="o">=</span> <span class="n">Compare</span><span class="o">.</span><span class="na">Operator</span><span class="o">.</span><span class="na">EQUAL</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="nd">@StrongPassword</span><span class="o">(</span><span class="n">usernamePropertyName</span> <span class="o">=</span> <span class="s">&quot;username&quot;</span><span class="o">,</span> <span class="n">newPasswordPropertyName</span> <span class="o">=</span> <span class="s">&quot;newPassword&quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
<span class="nd">@NotReusedPassword</span><span class="o">(</span><span class="n">usernamePropertyName</span> <span class="o">=</span> <span class="s">&quot;username&quot;</span><span class="o">,</span> <span class="n">newPasswordPropertyName</span> <span class="o">=</span> <span class="s">&quot;newPassword&quot;</span><span class="o">)</span> <span class="c1">// (3)</span>
<span class="nd">@ConfirmOldPassword</span><span class="o">(</span><span class="n">usernamePropertyName</span> <span class="o">=</span> <span class="s">&quot;username&quot;</span><span class="o">,</span> <span class="n">oldPasswordPropertyName</span> <span class="o">=</span> <span class="s">&quot;oldPassword&quot;</span><span class="o">)</span> <span class="c1">// (4)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordChangeForm</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">oldPassword</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">newPassword</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">confirmNewPassword</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">新しいパスワードの二回の入力が一致しているかをチェックするためのアノテーション。詳細は <a class="reference internal" href="../ArchitectureInDetail/Validation.html#validation-terasoluna-gfw-list"><span>terasoluna-gfw-commonのチェックルール</span></a> を参照すること。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">上述した、パスワード自体の性質を検証するアノテーション</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">過去のパスワードとの比較を行うアノテーション</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">入力された現在のパスワードが正しいことをチェックするアノテーション。定義は割愛する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordchange</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;password&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordChangeController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordChangeService</span> <span class="n">passwordService</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">change</span><span class="o">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">LoggedInUser</span> <span class="n">userDetails</span><span class="o">,</span>
            <span class="nd">@Validated</span> <span class="n">PasswordChangeForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="c1">// (1)</span>
            <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getAccount</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">()</span> <span class="o">||</span>
                <span class="o">!</span><span class="n">account</span><span class="o">.</span><span class="na">getUsername</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getUsername</span><span class="o">()))</span> <span class="o">{</span> <span class="c1">// (2)</span>
            <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
            <span class="k">return</span> <span class="s">&quot;passwordchange/changeForm&quot;</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">passwordService</span><span class="o">.</span><span class="na">updatePassword</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span>
                <span class="n">form</span><span class="o">.</span><span class="na">getNewPassword</span><span class="o">());</span>

        <span class="k">return</span> <span class="s">&quot;redirect:/password?complete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード変更時に呼び出されるハンドラメソッド。パラメータ中のFormに<code class="docutils literal"><span class="pre">&#64;Validated</span></code> アノテーションを付与して、入力チェックを行う。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード変更対象のユーザ名がログイン中のアカウントのユーザ名と一致していることを確認する。両者が異なる場合には、再度パスワード変更画面へ遷移させる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">本アプリケーションではBean Valiidationでユーザ名を用いたパスワード入力チェックを行うために、ユーザ名をFormから取得している。
Viewでは<code class="docutils literal"><span class="pre">Model</span></code> に設定したユーザ名をhiddenで保持することを想定しているが、改ざんされる恐れがあるため、パスワード変更前にFormから取得したユーザ名の確認を行っている。</p>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="account-lock">
<span id="id28"></span><h3><a class="toc-backref" href="#id89">6.10.3.3. アカウントのロックアウト</a><a class="headerlink" href="#account-lock" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id29">
<h4><a class="toc-backref" href="#id90">6.10.3.3.1. 実装する要件一覧</a><a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span>アカウントロックアウト</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span>アカウントロックアウト期間の指定</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span>管理ユーザによるロックアウトの解除</span></a></li>
</ul>
</div>
<div class="section" id="id30">
<h4><a class="toc-backref" href="#id91">6.10.3.3.2. 動作イメージ</a><a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>アカウントロックアウト</li>
</ul>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_lockout_ss.png"><img alt="Lockout" src="../_images/SecureLogin_lockout_ss.png" style="width: 80%;" /></a>
</div>
<div class="line-block">
<div class="line">ログインフォームにて、あるユーザ名に対して短時間に一定回数連続して誤ったパスワードで認証を試行すると、そのユーザのアカウントはロックアウト状態となる。
ロックアウト状態のアカウントは、正しいユーザ名とパスワードの組を入力した場合であっても認証されない。</div>
<div class="line">ロックアウト状態は一定期間経過するか、ロックアウト解除を行うことで解消される。</div>
</div>
<ul class="simple">
<li>ロックアウト解除</li>
</ul>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_unlock_ss.png"><img alt="Unlock" src="../_images/SecureLogin_unlock_ss.png" style="width: 80%;" /></a>
</div>
<p>管理権限を持つユーザでログインした場合にのみ、ロックアウト解除機能を使用することができる。
ロックアウト状態を解消したいユーザ名を入力してロックアウト解除を実行すると、そのユーザのアカウントは再び認証可能な状態に戻る。</p>
</div>
<div class="section" id="id31">
<h4><a class="toc-backref" href="#id92">6.10.3.3.3. 実装方法</a><a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Spring Securityでは、<code class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.UserDetails</span></code> に対してアカウントのロックアウト状態を設定することができる。</div>
<div class="line">「ロックアウト状態である」と設定した場合、Spring Securityがその設定を読み取って<code class="docutils literal"><span class="pre">org.springframework.security.authentication.LockedException</span></code> をthrowする。</div>
<div class="line">この機能を用いることにより、アカウントがロックアウト状態であるか否かを判定して<code class="docutils literal"><span class="pre">UserDetails</span></code> に設定する処理のみを実装すれば、ロックアウト機能が実現できる。</div>
</div>
<div class="line-block">
<div class="line">本アプリケーションでは、認証に失敗した履歴を「認証失敗イベント」エンティティとしてデータベースに保存し、この認証失敗イベントエンティティを使用してアカウントのロックアウト状態の判定を行う。</div>
<div class="line">具体的には以下の三つの処理を実装して用いることにより、アカウントのロックアウトに関する各要件を実現する。</div>
</div>
<ul>
<li><p class="first">認証失敗イベントエンティティの保存</p>
<p>不正な認証情報の入力によって認証に失敗した際に、Spring Securityが発生させるイベントをハンドリングし、認証に使用したユーザ名と認証を試みた日時を認証失敗イベントエンティティとしてデータベースに登録する。</p>
</li>
<li><p class="first">ロックアウト状態の判定</p>
<p>あるアカウントについて、現在時刻から一定以上新しい認証失敗イベントエンティティが一定個数以上存在する場合、該当アカウントはロックアウト状態であると判定する。
認証時にこの判定処理を呼び出し、判定結果を<code class="docutils literal"><span class="pre">UserDetails</span></code> の実装クラスに設定する。</p>
</li>
<li><p class="first">認証失敗イベントエンティティの削除</p>
<div class="line-block">
<div class="line">あるアカウントについて、認証失敗イベントエンティティをすべて削除する。</div>
<div class="line">ロックアウトの対象となるのは連続して認証に失敗した場合のみであるため、認証に成功した際には認証失敗イベントエンティティを削除する。</div>
<div class="line">また、アカウントのロックアウト状態は認証失敗イベントエンティティを用いて判定されるため、認証失敗イベントエンティティを消去することでロックアウト解除機能が実現できる。
アカウントのロックアウトは認可機能を用いて、管理ユーザ以外実行できないようにする。</div>
</div>
</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">認証失敗イベントエンティティはロックアウトの判定のみを目的としているため、不要になったタイミングで消去する。
認証ログが必要な場合は必ず別途ログを保存しておくこと。</p>
</div>
<p>認証失敗イベントエンティティを用いたロックアウト機能の動作例を以下の図を用いて説明する。
例として3回の認証失敗でロックアウトされるものとし、ロックアウト継続時間は10分とする。</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_lockout.png"><img alt="Account Lockout" src="../_images/SecureLogin_lockout.png" style="width: 60%;" /></a>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">過去10分以内に、誤ったパスワードでの認証が3回試行されており、データベースには3回分の認証失敗イベントエンティティが保存されている。</div>
<div class="line">そのため、アカウントはロックアウト状態であると判定される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">データベースには3回分の認証失敗イベントエンティティが保存されている。</div>
<div class="line">しかしながら、過去10分以内の認証失敗イベントエンティティは2回分のみであるため、ロックアウト状態ではないと判定される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>同様に、ロックアウトを解除する場合の動作例を以下の図で説明する。</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_unlock.png"><img alt="Account Lockout" src="../_images/SecureLogin_unlock.png" style="width: 60%;" /></a>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">過去10分以内に、誤ったパスワードでの認証が3回試行されている。</div>
<div class="line">その後、認証失敗イベントエンティティが消去されているため、データベースには認証失敗イベントエンティティが保存されておらず、ロックアウト状態ではないと判定される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id32">
<h4><a class="toc-backref" href="#id93">6.10.3.3.4. コード解説</a><a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">共通部分</p>
<p>本アプリケーションにおいて、アカウントのロックアウトに関する機能を実現するためには、データベースに対する認証失敗イベントエンティティの登録、検索、削除が共通的に必要となる。
そのため、まずは認証失敗イベントエンティティに関するドメイン層・インフラストラクチャ層の実装を示す。</p>
<ul>
<li><p class="first">Entityの実装</p>
<p>ユーザ名と認証試行日時を持つ認証失敗イベントエンティティの実装を以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.model</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FailedAuthentication</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

  <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span> <span class="c1">// (1)</span>

  <span class="kd">private</span> <span class="n">LocalDateTime</span> <span class="n">authenticationTimestamp</span><span class="o">;</span> <span class="c1">// (2)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証に使用したユーザ名</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証を試行した日時</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Repositoryの実装</p>
<p>認証失敗イベントエンティティの検索、登録、削除のためのRepositoryを以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.repository.authenticationevent</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">FailedAuthenticationRepository</span> <span class="o">{</span>

  <span class="kt">int</span> <span class="nf">create</span><span class="o">(</span><span class="n">FailedAuthentication</span> <span class="n">event</span><span class="o">);</span> <span class="c1">// (1)</span>

  <span class="n">List</span><span class="o">&lt;</span><span class="n">FailedAuthentication</span><span class="o">&gt;</span> <span class="nf">findLatest</span><span class="o">(</span>
                  <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;username&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">)</span> <span class="kt">long</span> <span class="n">count</span><span class="o">);</span> <span class="c1">// (2)</span>

  <span class="kt">int</span> <span class="nf">deleteByUsername</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;username&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">);</span> <span class="c1">// (3)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられた<code class="docutils literal"><span class="pre">FailedAuthentication</span></code>オブジェクトをデータベースのレコードとして登録するメソッド</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられたユーザ名をキーとして、指定された個数の<code class="docutils literal"><span class="pre">FailedAuthentication</span></code>オブジェクトを新しい順に取得するメソッド</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられたユーザ名をキーとして、認証失敗イベントエンティティのレコードを一括削除するメソッド</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>マッピングファイルは以下の通り。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="nt">&lt;mapper</span>
  <span class="na">namespace=</span><span class="s">&quot;org.terasoluna.securelogin.domain.repository.authenticationevent.FailedAuthenticationRepository&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;failedAuthenticationResultMap&quot;</span>
          <span class="na">type=</span><span class="s">&quot;FailedAuthentication&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;username&quot;</span> <span class="na">column=</span><span class="s">&quot;username&quot;</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;authenticationTimestamp&quot;</span> <span class="na">column=</span><span class="s">&quot;authentication_timestamp&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/resultMap&gt;</span>

  <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;FailedAuthentication&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        INSERT INTO failed_authentication (</span>
<span class="cp">            username,</span>
<span class="cp">            authentication_timestamp</span>
<span class="cp">        ) VALUES (</span>
<span class="cp">          #{username},</span>
<span class="cp">            #{authenticationTimestamp}</span>
<span class="cp">        )</span>
<span class="cp">    ]]&gt;</span>
  <span class="nt">&lt;/insert&gt;</span>

  <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findLatest&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;failedAuthenticationResultMap&quot;</span><span class="nt">&gt;</span>
       <span class="cp">&lt;![CDATA[</span>
<span class="cp">            SELECT</span>
<span class="cp">                username,</span>
<span class="cp">                authentication_timestamp</span>
<span class="cp">            FROM</span>
<span class="cp">                failed_authentication</span>
<span class="cp">            WHERE</span>
<span class="cp">                username = #{username}</span>
<span class="cp">            ORDER BY authentication_timestamp DESC</span>
<span class="cp">            LIMIT #{count}</span>
<span class="cp">       ]]&gt;</span>
  <span class="nt">&lt;/select&gt;</span>

  <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&quot;deleteByUsername&quot;</span><span class="nt">&gt;</span>
     <span class="cp">&lt;![CDATA[</span>
<span class="cp">          DELETE FROM</span>
<span class="cp">              failed_authentication</span>
<span class="cp">          WHERE</span>
<span class="cp">              username = #{username}</span>
<span class="cp">     ]]&gt;</span>
  <span class="nt">&lt;/delete&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Serviceの実装</p>
<p>作成したRepositoryのメソッドを呼び出すServiceを以下の通り定義する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.authenticationevent</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthenticationEventSharedServiceImpl</span> <span class="kd">implements</span>
                <span class="n">AuthenticationEventSharedService</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">FailedAuthenticationRepository</span> <span class="n">failedAuthenticationRepository</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">FailedAuthentication</span><span class="o">&gt;</span> <span class="nf">findLatestFailureEvents</span><span class="o">(</span>
                    <span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">failedAuthenticationRepository</span><span class="o">.</span><span class="na">findLatestEvents</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">authenticationFailure</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">accountSharedService</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">username</span><span class="o">)){</span>
             <span class="n">FailedAuthentication</span> <span class="n">failureEvents</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FailedAuthentication</span><span class="o">();</span>
             <span class="n">failureEvents</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
             <span class="n">failureEvents</span><span class="o">.</span><span class="na">setAuthenticationTimestamp</span><span class="o">(</span><span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">()</span>
                     <span class="o">.</span><span class="na">toLocalDateTime</span><span class="o">());</span>

             <span class="n">failedAuthenticationRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">failureEvents</span><span class="o">);</span>
         <span class="o">}</span>
     <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">deleteFailureEventByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">failedAuthenticationRepository</span><span class="o">.</span><span class="na">deleteByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証失敗イベントエンティティを作成してデータベースに登録するメソッド。</div>
<div class="line">引数として受け取ったユーザ名のアカウントが存在しない場合、データベースの外部キー制約に違反するため、データベースへの登録処理をスキップする。</div>
<div class="line">本メソッド実行後の例外により認証失敗イベントエンティティが登録されない可能性を考慮し、トランザクションの伝搬方法に<code class="docutils literal"><span class="pre">REQUIRES_NEW</span></code> を指定している。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
</ul>
<p>以下、実装方法に従って実装されたコードについて順に解説する。</p>
<ul>
<li><p class="first">認証失敗イベントエンティティの保存</p>
<p>認証失敗時に発生するイベントをハンドリングして処理を行うために、<code class="docutils literal"><span class="pre">&#64;EventListener</span></code> アノテーションを使用する。
<code class="docutils literal"><span class="pre">&#64;EventListener</span></code> アノテーションによるイベントのハンドリングについては <a class="reference internal" href="Authentication.html#springsecurityauthenticationevent"><span>認証イベントのハンドリング</span></a> を参照すること。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.account</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountAuthenticationFailureBadCredentialsEventListener</span><span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AuthenticationEventSharedService</span> <span class="n">authenticationEventSharedService</span><span class="o">;</span>

    <span class="nd">@EventListener</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span>
                    <span class="n">AuthenticationFailureBadCredentialsEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">event</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">().</span><span class="na">getPrincipal</span><span class="o">();</span> <span class="c1">// (2)</span>

        <span class="n">authenticationEventSharedService</span><span class="o">.</span><span class="na">authenticationFailure</span><span class="o">(</span><span class="n">username</span><span class="o">);</span> <span class="c1">// (3)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;EventListener</span></code> アノテーションを付与することで、誤ったパスワード等の不正な認証情報によって認証が失敗した際に、<code class="docutils literal"><span class="pre">onApplicationEvent</span></code> メソッドが実行される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationFailureBadCredentialsEvent</span></code> オブジェクトから、認証に使用したユーザ名を取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証失敗イベントエンティティを作成してデータベースに登録する処理を呼び出す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">ロックアウト状態の判定</p>
<p>認証失敗イベントエンティティを用いてアカウントのロックアウト状態を判定する処理を記述する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.account</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountSharedServiceImpl</span> <span class="kd">implements</span> <span class="n">AccountSharedService</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AuthenticationEventSharedService</span> <span class="n">authenticationEventSharedService</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.lockingDurationSeconds}&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="kt">int</span> <span class="n">lockingDurationSeconds</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.lockingThreshold}&quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
    <span class="kt">int</span> <span class="n">lockingThreshold</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isLocked</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">FailedAuthentication</span><span class="o">&gt;</span> <span class="n">failureEvents</span> <span class="o">=</span> <span class="n">authenticationEventSharedService</span>
                        <span class="o">.</span><span class="na">findLatestFailureEvents</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">lockingThreshold</span><span class="o">);</span> <span class="c1">// (3)</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">failureEvents</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">lockingThreshold</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (4)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">failureEvents</span>
                <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">lockingThreshold</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="c1">// (5)</span>
                <span class="o">.</span><span class="na">getAuthenticationTimestamp</span><span class="o">()</span>
                <span class="o">.</span><span class="na">isBefore</span><span class="o">(</span>
                        <span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">minusSeconds</span><span class="o">(</span><span class="n">lockingDurationSeconds</span><span class="o">)))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ロックアウトの継続時間を秒単位で指定する。プロパティファイルに定義された値をインジェクションしている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ロックアウトの閾値を指定する。ここで指定した回数だけ認証に失敗すると、アカウントがロックアウトされる。プロパティファイルに定義された値をインジェクションしている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証失敗イベントエンティティを、ロックアウトの閾値と同じ数だけ新しい順に取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得した認証失敗イベントエンティティの個数がロックアウトの閾値より小さい場合、ロックアウト状態ではないと判定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得した認証失敗イベントエンティティのうち最も古い認証失敗時刻と現在時刻の差分が、ロックアウト継続時間よりも大きい場合には、ロックアウト状態ではないと判定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserDetails</span></code> の実装クラスである<code class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.User</span></code> では、コンストラクタにロックアウト状態を渡すことができる。</div>
<div class="line">本アプリケーションでは以下のように<code class="docutils literal"><span class="pre">User</span></code> を継承したクラスと、<code class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.UserDetailsService</span></code> を実装したクラスを用いる。</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.userdetails</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggedInUser</span> <span class="kd">extends</span> <span class="n">User</span> <span class="o">{</span>

   <span class="c1">// omitted</span>

   <span class="kd">private</span> <span class="kd">final</span> <span class="n">Account</span> <span class="n">account</span><span class="o">;</span>

   <span class="kd">public</span> <span class="nf">LoggedInUser</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isLocked</span><span class="o">,</span>
                   <span class="n">LocalDateTime</span> <span class="n">lastLoginDate</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">SimpleGrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="o">)</span> <span class="o">{</span>
       <span class="kd">super</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">account</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
                   <span class="o">!</span><span class="n">isLocked</span><span class="o">,</span> <span class="n">authorities</span><span class="o">);</span> <span class="c1">// (1)</span>
       <span class="k">this</span><span class="o">.</span><span class="na">account</span> <span class="o">=</span> <span class="n">account</span><span class="o">;</span>

       <span class="c1">// omitted</span>
   <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Account</span> <span class="nf">getAccount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">account</span><span class="o">;</span>
    <span class="o">}</span>

   <span class="c1">// omitted</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">親クラスである<code class="docutils literal"><span class="pre">User</span></code> のコンストラクタに <strong>ロックアウト状態でないかどうか</strong> を真理値で渡す。ロックアウト状態でない場合にtrueを渡す必要があることに注意する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.userdetails</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggedInUserDetailsService</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
           <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountSharedService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
           <span class="n">List</span><span class="o">&lt;</span><span class="n">SimpleGrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
           <span class="k">for</span> <span class="o">(</span><span class="n">Role</span> <span class="n">role</span> <span class="o">:</span> <span class="n">account</span><span class="o">.</span><span class="na">getRoles</span><span class="o">())</span> <span class="o">{</span>
               <span class="n">authorities</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">SimpleGrantedAuthority</span><span class="o">(</span><span class="s">&quot;ROLE_&quot;</span>
                       <span class="o">+</span> <span class="n">role</span><span class="o">.</span><span class="na">getRoleValue</span><span class="o">()));</span>
           <span class="o">}</span>
           <span class="k">return</span> <span class="k">new</span> <span class="n">LoggedInUser</span><span class="o">(</span><span class="n">account</span><span class="o">,</span>
                   <span class="n">accountSharedService</span><span class="o">.</span><span class="na">isLocked</span><span class="o">(</span><span class="n">username</span><span class="o">),</span> <span class="c1">// (1)</span>
                   <span class="n">accountSharedService</span><span class="o">.</span><span class="na">getLastLoginDate</span><span class="o">(</span><span class="n">username</span><span class="o">),</span>
                   <span class="n">authorities</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ResourceNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UsernameNotFoundException</span><span class="o">(</span><span class="s">&quot;user not found&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">LoggedInUser</span></code> のコンストラクタに、<code class="docutils literal"><span class="pre">isLocked</span></code> メソッドによるロックアウト状態の判定結果を渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>作成した<code class="docutils literal"><span class="pre">UserDetailsService</span></code> を使用するための設定は以下の通り。</p>
<p><strong>spring-security.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;sec:authentication-manager&gt;</span>
    <span class="nt">&lt;sec:authentication-provider</span>
        <span class="na">user-service-ref=</span><span class="s">&quot;loggedInUserDetailsService&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;sec:password-encoder</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:authentication-provider&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UserDetailsService</span></code> のBeanのidを指定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">認証失敗イベントエンティティの削除</p>
<ul>
<li><p class="first">認証成功時の認証失敗イベントエンティティの削除</p>
<p>連続した認証失敗のみをロックアウトの判定に使用するため、認証に成功した際にはアカウントの認証失敗イベントエンティティを削除する。
共通部分として作成したServiceに、認証成功時に実行するメソッドを作成する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.authenticationevent</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthenticationEventSharedServiceImpl</span> <span class="kd">implements</span>
                <span class="n">AuthenticationEventSharedService</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">authenticationSuccess</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// omitted</span>

        <span class="n">deleteFailureEventByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span> <span class="c1">// (1)</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として渡されたユーザ名のアカウントに関する認証失敗イベントエンティティを削除する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>認証成功時に発生するイベントをハンドリングして処理を行うために、 <code class="docutils literal"><span class="pre">&#64;EventListener</span></code> アノテーションを使用する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.account</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountAuthenticationSuccessEventListener</span><span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AuthenticationEventSharedService</span> <span class="n">authenticationEventSharedService</span><span class="o">;</span>

    <span class="nd">@EventListener</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span>
                    <span class="n">AuthenticationSuccessEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">LoggedInUser</span> <span class="n">details</span> <span class="o">=</span> <span class="o">(</span><span class="n">LoggedInUser</span><span class="o">)</span> <span class="n">event</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">()</span>
                <span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>

        <span class="n">authenticationEventSharedService</span><span class="o">.</span><span class="na">authenticationSuccess</span><span class="o">(</span><span class="n">details</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span> <span class="c1">// (2)</span>

    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;EventListener</span></code> アノテーションを付与することで、認証が成功した際に<code class="docutils literal"><span class="pre">onApplicationEvent</span></code> メソッドが実行される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationSuccessEvent</span></code> からユーザ名を取得し、認証失敗イベントエンティティを削除する処理を呼び出す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">ロックアウト状態の解除</p>
<p>ロックアウト状態の判定に認証失敗イベントエンティティを使用しているため、認証失敗イベントエンティティを削除することでロックアウト状態を解除することができる。
ロックアウト解除機能の使用を管理権限を持つユーザに限定するための認可の設定と、ドメイン層・アプリケーション層の実装を行う。</p>
<ul>
<li><p class="first">認可の設定</p>
<p>ロックアウトの解除を行うことができるユーザの権限を以下の通りに設定する。</p>
<p><strong>spring-security.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- omitted --&gt;</span>

  <span class="nt">&lt;sec:http</span> <span class="na">pattern=</span><span class="s">&quot;/resources/**&quot;</span> <span class="na">security=</span><span class="s">&quot;none&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;sec:http&gt;</span>

      <span class="c">&lt;!-- omitted --&gt;</span>

      <span class="nt">&lt;sec:intercept-url</span> <span class="na">pattern=</span><span class="s">&quot;/unlock/**&quot;</span> <span class="na">access=</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

      <span class="c">&lt;!-- omitted --&gt;</span>

  <span class="nt">&lt;/sec:http&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/unlock 以下のURLへのアクセス権限を管理ユーザに限定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Serviceの実装</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.unlock</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnlockServiceImpl</span> <span class="kd">implements</span> <span class="n">UnlockService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AuthenticationEventSharedService</span> <span class="n">authenticationEventSharedService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unlock</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">authenticationEventSharedService</span>
               <span class="o">.</span><span class="na">deleteFailureEventByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span> <span class="c1">// (1)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証失敗イベントエンティティを消去することによりロックアウト状態を解除する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Formの実装</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.unlock</span><span class="o">;</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnlockForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotEmpty</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Viewの実装</p>
<p><strong>トップ画面(home.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>

        <span class="c">&lt;!-- omitted --&gt;</span>

        <span class="nt">&lt;sec:authorize</span> <span class="na">url=</span><span class="s">&quot;/unlock&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">&quot;unlock&quot;</span> <span class="na">href=</span><span class="s">&quot;${f:h(pageContext.request.contextPath)}/unlock?form&quot;</span><span class="nt">&gt;</span>
                Unlock Account
            <span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/sec:authorize&gt;</span>

        <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/unlock 以下のアクセス権限を持つユーザに対してのみ表示する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>ロックアウト解除フォーム(unlokcForm.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Unlock Account<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;t:messagesPanel</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${f:h(pageContext.request.contextPath)}/unlock&quot;</span>
            <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">modelAttribute=</span><span class="s">&quot;unlockForm&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;table&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;th&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;username&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Username<span class="nt">&lt;/form:label&gt;</span>
                    <span class="nt">&lt;/th&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;username&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;username&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;/table&gt;</span>

            <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;submit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Unlock&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/form:form&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${f:h(pageContext.request.contextPath)}/&quot;</span><span class="nt">&gt;</span>go to Top<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<p><strong>ロックアウト解除完了画面(unlockComplete.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;h1&gt;</span>${f:h(username)}&#39;s account was successfully unlocked.<span class="nt">&lt;/h1&gt;</span>
          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${f:h(pageContext.request.contextPath)}/&quot;</span><span class="nt">&gt;</span>go to Top<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Controllerの実装</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.unlock</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/unlock&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnlockController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">UnlockService</span> <span class="n">unlockService</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">showForm</span><span class="o">(</span><span class="n">UnlockForm</span> <span class="n">form</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;unlock/unlockForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">unlock</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">UnlockForm</span> <span class="n">form</span><span class="o">,</span>
            <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span>
            <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">showForm</span><span class="o">(</span><span class="n">form</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">unlockService</span><span class="o">.</span><span class="na">unlock</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span> <span class="c1">// (2)</span>
            <span class="n">attributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="s">&quot;username&quot;</span><span class="o">,</span> <span class="n">form</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
            <span class="k">return</span> <span class="s">&quot;redirect:/unlock?complete&quot;</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getResultMessages</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">showForm</span><span class="o">(</span><span class="n">form</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">unlockComplete</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;unlock/unlockComplete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">/unlock 以下のURLにマッピングする。認可の設定によって、管理ユーザのみがアクセス可能となる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Formから取得したユーザ名を引数として、アカウントのロックアウトを解除する処理を呼び出す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="last-login">
<span id="id33"></span><h3><a class="toc-backref" href="#id94">6.10.3.4. 最終ログイン日時の表示</a><a class="headerlink" href="#last-login" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id34">
<h4><a class="toc-backref" href="#id95">6.10.3.4.1. 実装する要件一覧</a><a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span>前回ログイン日時の表示</span></a></li>
</ul>
</div>
<div class="section" id="id35">
<h4><a class="toc-backref" href="#id96">6.10.3.4.2. 動作イメージ</a><a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h4>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_last_login.png"><img alt="Last Login Date" src="../_images/SecureLogin_last_login.png" style="width: 80%;" /></a>
</div>
</div>
<div class="section" id="id36">
<h4><a class="toc-backref" href="#id97">6.10.3.4.3. 実装方法</a><a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">本アプリケーションでは、認証に成功した履歴を「認証成功イベント」エンティティとしてデータベースに保存し、この認証成功イベントエンティティを用いて、トップ画面にアカウントの前回ログイン日時を表示する。</div>
<div class="line">具体的には以下の二つの処理を実装することで、要件を実現する。</div>
</div>
<ul>
<li><p class="first">認証成功イベントエンティティの保存</p>
<p>認証に成功した際にSpring Securityが発生させるイベントをハンドリングし、認証に使用したユーザ名と認証に成功した日時を認証成功イベントエンティティとしてデータベースに登録する。</p>
</li>
<li><p class="first">前回ログイン日時の取得と表示</p>
<p>認証時に、アカウントにおける最新の認証成功イベントエンティティをデータベースから取得し、イベントエンティティから認証成功日時を取得して<code class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.UserDetails</span></code> に設定する。
jspに<code class="docutils literal"><span class="pre">UserDetails</span></code> が保持している認証成功日時をフォーマットして渡し、表示する。</p>
</li>
</ul>
</div>
<div class="section" id="id37">
<h4><a class="toc-backref" href="#id98">6.10.3.4.4. コード解説</a><a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">共通部分</p>
<p>本アプリケーションにおいて、前回ログイン日時を表示するためには、データベースに対する認証成功イベントエンティティの登録、検索が必要となる。
そのため、まずは認証成功イベントエンティティに関するドメイン層・インフラストラクチャ層の実装から解説を行う。</p>
<ul>
<li><p class="first">Entityの実装</p>
<p>ユーザ名と認証成功日時を持つ認証成功イベントエンティティの実装は以下の通り。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.model</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SuccessfulAuthentication</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="n">LocalDateTime</span> <span class="n">authenticationTimestamp</span><span class="o">;</span> <span class="c1">// (2)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証に使用したユーザ名</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証を試行した日時</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Repositoryの実装</p>
<p>認証成功イベントエンティティの検索、登録を行うためのRepositoryを以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.repository.authenticationevent</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SuccessfulAuthenticationRepository</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="nf">create</span><span class="o">(</span><span class="n">SuccessfulAuthentication</span> <span class="n">event</span><span class="o">);</span> <span class="c1">// (1)</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">SuccessfulAuthentication</span><span class="o">&gt;</span> <span class="nf">findLatestEvents</span><span class="o">(</span>
           <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;username&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">)</span> <span class="kt">long</span> <span class="n">count</span><span class="o">);</span> <span class="c1">// (2)</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられた<code class="docutils literal"><span class="pre">SuccessfulAuthentication</span></code>オブジェクトをデータベースのレコードとして登録するメソッド</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられたユーザ名をキーとして、指定された個数の<code class="docutils literal"><span class="pre">SuccessfulAuthentication</span></code>オブジェクトを新しい順に取得するメソッド</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>マッピングファイルは以下の通り。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="nt">&lt;mapper</span>
    <span class="na">namespace=</span><span class="s">&quot;org.terasoluna.securelogin.domain.repository.authenticationevent.SuccessfulAuthenticationRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;successfulAuthenticationResultMap&quot;</span>
            <span class="na">type=</span><span class="s">&quot;SuccessfulAuthentication&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;username&quot;</span> <span class="na">column=</span><span class="s">&quot;username&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;authenticationTimestamp&quot;</span> <span class="na">column=</span><span class="s">&quot;authentication_timestamp&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;SuccessfulAuthentication&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        INSERT INTO successful_authentication (</span>
<span class="cp">            username,</span>
<span class="cp">            authentication_timestamp</span>
<span class="cp">        ) VALUES (</span>
<span class="cp">            #{username},</span>
<span class="cp">            #{authenticationTimestamp}</span>
<span class="cp">        )</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/insert&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findLatestEvents&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;successfulAuthenticationResultMap&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            username,</span>
<span class="cp">            authentication_timestamp</span>
<span class="cp">        FROM</span>
<span class="cp">            successful_authentication</span>
<span class="cp">        WHERE</span>
<span class="cp">            username = #{username}</span>
<span class="cp">        ORDER BY authentication_timestamp DESC</span>
<span class="cp">        LIMIT #{count}</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/select&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Serviceの実装</p>
<p>作成したRepositoryのメソッドを呼び出すServiceを以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.authenticationevent</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthenticationEventSharedServiceImpl</span> <span class="kd">implements</span>
         <span class="n">AuthenticationEventSharedService</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">SuccessfulAuthenticationRepository</span> <span class="n">successAuthenticationRepository</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">SuccessfulAuthentication</span><span class="o">&gt;</span> <span class="nf">findLatestSuccessEvents</span><span class="o">(</span>
                    <span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">successAuthenticationRepository</span><span class="o">.</span><span class="na">findLatestEvents</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span>
    <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">authenticationSuccess</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">SuccessfulAuthentication</span> <span class="n">successEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SuccessfulAuthentication</span><span class="o">();</span>
          <span class="n">successEvent</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
          <span class="n">successEvent</span><span class="o">.</span><span class="na">setAuthenticationTimestamp</span><span class="o">(</span><span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">());</span>

          <span class="n">successAuthenticationRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">successEvent</span><span class="o">);</span>
          <span class="n">deleteFailureEventByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
      <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
<p>以下、実装方法に従って実装されたコードについて順に解説する。</p>
<ul>
<li><p class="first">認証成功イベントエンティティの保存</p>
<p>認証成功時に発生するイベントをハンドリングして処理を行うために、<code class="docutils literal"><span class="pre">&#64;EventListener</span></code> アノテーションを使用する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.account</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountAuthenticationSuccessEventListener</span><span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AuthenticationEventSharedService</span> <span class="n">authenticationEventSharedService</span><span class="o">;</span>

    <span class="nd">@EventListener</span> <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="n">AuthenticationSuccessEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">LoggedInUser</span> <span class="n">details</span> <span class="o">=</span> <span class="o">(</span><span class="n">LoggedInUser</span><span class="o">)</span> <span class="n">event</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span> <span class="c1">// (2)</span>

        <span class="n">authenticationEventSharedService</span><span class="o">.</span><span class="na">authenticationSuccess</span><span class="o">(</span><span class="n">details</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span> <span class="c1">// (3)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;EventListener</span></code> アノテーションを付与することで、認証が成功した際に、<code class="docutils literal"><span class="pre">onApplicationEvent</span></code> メソッドが実行される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">AuthenticationSuccessEvent</span></code> オブジェクトから、<code class="docutils literal"><span class="pre">UserDetails</span></code> の実装クラスを取得する。このクラスについては以降で説明する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証成功イベントエンティティを作成し、データベースに登録する処理を呼び出す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">前回ログイン日時の取得と表示</p>
<p>認証成功イベントエンティティから前回ログイン日時を取得するためのServiceを以下に示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.account</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountSharedServiceImpl</span> <span class="kd">implements</span> <span class="n">AccountSharedService</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Inject</span>
    <span class="n">AuthenticationEventSharedService</span> <span class="n">authenticationEventSharedService</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">LocalDateTime</span> <span class="nf">getLastLoginDate</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">SuccessfulAuthentication</span><span class="o">&gt;</span> <span class="n">events</span> <span class="o">=</span> <span class="n">authenticationEventSharedService</span>
                    <span class="o">.</span><span class="na">findLatestSuccessEvents</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span> <span class="c1">// (1)</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">events</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// (2)</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">events</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getAuthenticationTimestamp</span><span class="o">();</span> <span class="c1">// (3)</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられたユーザ名をキーとして、最新の認証成功イベントエンティティを一件取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">初回ログイン時等、認証成功イベントエンティティが一件も取得できない場合にはnullを返す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">認証成功イベントエンティティから、認証日時を取得して返す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>ログイン時に前回ログイン日時を取得して<code class="docutils literal"><span class="pre">UserDetails</span></code> に保持させるために、以下のように<code class="docutils literal"><span class="pre">User</span></code> を継承したクラスと、<code class="docutils literal"><span class="pre">UserDetailsService</span></code> を実装したクラスを作成する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.userdetails</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggedInUser</span> <span class="kd">extends</span> <span class="n">User</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Account</span> <span class="n">account</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">LocalDateTime</span> <span class="n">lastLoginDate</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="kd">public</span> <span class="nf">LoggedInUser</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isLocked</span><span class="o">,</span>
                    <span class="n">LocalDateTime</span> <span class="n">lastLoginDate</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">SimpleGrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="o">)</span> <span class="o">{</span>

        <span class="kd">super</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">account</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
                        <span class="o">!</span><span class="n">isLocked</span><span class="o">,</span> <span class="n">authorities</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">account</span> <span class="o">=</span> <span class="n">account</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lastLoginDate</span> <span class="o">=</span> <span class="n">lastLoginDate</span><span class="o">;</span> <span class="c1">// (2)</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

    <span class="kd">public</span> <span class="n">LocalDateTime</span> <span class="nf">getLastLoginDate</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// (3)</span>
        <span class="k">return</span> <span class="n">lastLoginDate</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">前回ログイン日時を保持するためのフィールドを宣言する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられた前回ログイン日時をフィールドに設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">保持している前回ログイン日時を返すメソッド</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.userdetails</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggedInUserDetailsService</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span>
                <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">accountSharedService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">SimpleGrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Role</span> <span class="n">role</span> <span class="o">:</span> <span class="n">account</span><span class="o">.</span><span class="na">getRoles</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">authorities</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">SimpleGrantedAuthority</span><span class="o">(</span><span class="s">&quot;ROLE_&quot;</span>
                                    <span class="o">+</span> <span class="n">role</span><span class="o">.</span><span class="na">getRoleValue</span><span class="o">()));</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">LoggedInUser</span><span class="o">(</span><span class="n">account</span><span class="o">,</span>
                            <span class="n">accountSharedService</span><span class="o">.</span><span class="na">isLocked</span><span class="o">(</span><span class="n">username</span><span class="o">),</span>
                            <span class="n">accountSharedService</span><span class="o">.</span><span class="na">getLastLoginDate</span><span class="o">(</span><span class="n">username</span><span class="o">),</span> <span class="c1">// (1)</span>
                            <span class="n">authorities</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ResourceNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UsernameNotFoundException</span><span class="o">(</span><span class="s">&quot;user not found&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Serviceのメソッドを呼び出して前回ログイン日時を取得し、<code class="docutils literal"><span class="pre">LoggedInUser</span></code> のコンストラクタに渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>トップ画面に前回ログイン日時を表示するためのアプリケーション層の実装を行う。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.welcome</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeController</span> <span class="o">{</span>

   <span class="nd">@Inject</span>
   <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

   <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="o">{</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span>
                   <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span> <span class="o">})</span>
   <span class="kd">public</span> <span class="n">String</span> <span class="nf">home</span><span class="o">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">LoggedInUser</span> <span class="n">userDetails</span><span class="o">,</span> <span class="c1">// (1)</span>
                   <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>

       <span class="c1">// omitted</span>

           <span class="n">LocalDateTime</span> <span class="n">lastLoginDate</span> <span class="o">=</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getLastLoginDate</span><span class="o">();</span> <span class="c1">// (2)</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">lastLoginDate</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                   <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;lastLoginDate&quot;</span><span class="o">,</span> <span class="n">lastLoginDate</span>
                                   <span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">DateTimeFormatter</span><span class="o">.</span><span class="na">ofPattern</span><span class="o">(</span><span class="s">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="o">)));</span> <span class="c1">// (3)</span>
           <span class="o">}</span>

           <span class="k">return</span> <span class="s">&quot;welcome/home&quot;</span><span class="o">;</span>

   <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></code> を使用してUserDetailsオブジェクトを取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">LoggedInUserDetails</span></code> から最終ログイン日時を取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">最終ログイン日時をフォーマットしてModelに設定し、Viewに渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>トップ画面(home.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>

      <span class="c">&lt;!-- omitted --&gt;</span>

      <span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">&quot;${!empty lastLoginDate}&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
          <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;lastLogin&quot;</span><span class="nt">&gt;</span>
              Last login date is ${f:h(lastLoginDate)}. <span class="c">&lt;!-- (2) --&gt;</span>
          <span class="nt">&lt;/p&gt;</span>
      <span class="nt">&lt;/c:if&gt;</span>

      <span class="c">&lt;!-- omitted --&gt;</span>

  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">前回ログイン日時がnullの場合は表示しない。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Controllerから渡された前回ログイン日時を表示する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>
<div class="section" id="reissue-info-create">
<span id="id38"></span><h3><a class="toc-backref" href="#id99">6.10.3.5. パスワード再発行のための認証情報の生成</a><a class="headerlink" href="#reissue-info-create" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id39">
<h4><a class="toc-backref" href="#id100">6.10.3.5.1. 実装する要件一覧</a><a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span>パスワード再発行用URLへのランダム文字列の付与</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span>パスワード再発行用秘密情報の発行</span></a></li>
</ul>
</div>
<div class="section" id="id40">
<h4><a class="toc-backref" href="#id101">6.10.3.5.2. 動作イメージ</a><a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h4>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_password_reissue_generate.png"><img alt="Generate Password Reissue Information" src="../_images/SecureLogin_password_reissue_generate.png" style="width: 80%;" /></a>
</div>
<p>パスワード再発行のための認証情報生成画面で、パスワードを再発行するユーザ名を入力する。このとき、パスワード再発行時の認証に使用する秘密情報と、トークンが生成される。
秘密情報は画面に表示され、トークンを含んだパスワード再発行画面のURLはユーザの登録済みメールアドレスに送付される。</p>
<p>メール送付されたURLには有効期限があり、有効期限内にアクセスして秘密情報と新しいパスワードを入力することで、パスワードを変更することができる。
有効期限が切れた後にメール送付されたURLにアクセスした場合、エラー画面に遷移する。</p>
<p>ここでは、上記の流れのうち、秘密情報とトークンの生成について説明を行う。</p>
</div>
<div class="section" id="id41">
<h4><a class="toc-backref" href="#id102">6.10.3.5.3. 実装方法</a><a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">パスワードの再発行を行う際には、ユーザがアカウントの所有者であることを確認するためのパスワードに代わる手段が必要である。</div>
<div class="line">本アプリケーションでは、ユーザを確認するための情報として、パスワード再発行画面のURLと秘密情報の二つを用いる。</div>
<div class="line">パスワード再発行画面のURLを一意かつ推測困難にするために、ランダムな文字列を生成しURLに付加する。万が一URLが漏えいした場合に備え、ランダムな文字列である秘密情報を生成し、これを用いて認証を行う。</div>
<div class="line">二つのランダムな文字列は、片方からもう一方を推測することが不可能となるように、それぞれ異なる方法で生成する。</div>
<div class="line">具体的には以下の処理を実装することで要件を実現する。</div>
</div>
<ul>
<li><p class="first">パスワード再発行のための認証情報の生成と保存</p>
<p>以下の4つの情報を、パスワード再発行のための認証情報としてデータベースに保存する。</p>
<ul class="simple">
<li>ユーザ名：パスワードを再発行するアカウントのユーザ名</li>
<li>トークン：パスワード再発行画面のURLを、一意かつ推測不能にするために生成するランダムな文字列</li>
<li>秘密情報：パスワード再発行時にユーザに入力させるために生成するランダムな文字列</li>
<li>有効期限：パスワード再発行のための認証情報の有効期限</li>
</ul>
<p>トークンの生成には<code class="docutils literal"><span class="pre">java.util.UUID</span></code> クラスの<code class="docutils literal"><span class="pre">randomUUID</span></code> メソッドを用い、秘密情報の生成にはPassayのパスワード生成機能を用いる。</p>
<p>秘密情報については、パスワードと同様にハッシュ化してデータベースへ保存する。
有効期限の設定と確認処理については、<a class="reference internal" href="#reissue-info-validate"><span>パスワード再発行実行時の検査</span></a> に記す。
パスワード再発行のための認証情報をユーザに配布する方法については、<a class="reference internal" href="#reissue-info-delivery"><span>パスワード再発行のための認証情報の配布</span></a> を参照。</p>
</li>
</ul>
</div>
<div class="section" id="id42">
<h4><a class="toc-backref" href="#id103">6.10.3.5.4. コード解説</a><a class="headerlink" href="#id42" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">共通部分</p>
<p>上記の実装方法に従って実装を進める上で、パスワード再発行のための認証情報をデータベースに登録、検索する処理が共通的に必要となる。
そのため、まずはパスワード再発行のための認証情報に関連するEntityとRepositoryの実装から解説する。</p>
<ul>
<li><p class="first">Entityの作成</p>
<p>パスワード再発行のための認証情報のEntityを作成する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.model</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueInfo</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">token</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">secret</span><span class="o">;</span> <span class="c1">// (3)</span>

    <span class="kd">private</span> <span class="n">LocalDateTime</span> <span class="n">expiryDate</span><span class="o">;</span> <span class="c1">// (4)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行対象のユーザ名</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行用URLに含めるために生成される文字列（トークン）</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行時にユーザを確認するための文字列（秘密情報）</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行のための認証情報の有効期限</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Repositoryの実装</p>
<p>パスワード再発行のための認証情報の検索、登録、削除を行うためのRepositoryを以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.repository.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PasswordReissueInfoRepository</span> <span class="o">{</span>

    <span class="kt">void</span> <span class="nf">create</span><span class="o">(</span><span class="n">PasswordReissueInfo</span> <span class="n">info</span><span class="o">);</span> <span class="c1">// (1)</span>

    <span class="n">PasswordReissueInfo</span> <span class="nf">findOne</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">token</span><span class="o">);</span> <span class="c1">// (2)</span>

    <span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">token</span><span class="o">);</span> <span class="c1">// (3)</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられた<code class="docutils literal"><span class="pre">PasswordReissueInfo</span></code>オブジェクトをデータベースのレコードとして登録するメソッド</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられたトークンをキーとして、<code class="docutils literal"><span class="pre">PasswordReissueInfo</span></code>オブジェクトを検索し、取得するメソッド</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられたトークンをキーとして、<code class="docutils literal"><span class="pre">PasswordReissueInfo</span></code>オブジェクトを削除するメソッド</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>マッピングファイルは以下の通り。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="nt">&lt;mapper</span>
    <span class="na">namespace=</span><span class="s">&quot;org.terasoluna.securelogin.domain.repository.passwordreissue.PasswordReissueInfoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;PasswordReissueInfoResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;PasswordReissueInfo&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;username&quot;</span> <span class="na">column=</span><span class="s">&quot;username&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;token&quot;</span> <span class="na">column=</span><span class="s">&quot;token&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;secret&quot;</span> <span class="na">column=</span><span class="s">&quot;secret&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;expiryDate&quot;</span> <span class="na">column=</span><span class="s">&quot;expiry_date&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;PasswordReissueInfoResultMap&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            username,</span>
<span class="cp">            token,</span>
<span class="cp">            secret,</span>
<span class="cp">            expiry_date</span>
<span class="cp">        FROM</span>
<span class="cp">            password_reissue_info</span>
<span class="cp">        WHERE</span>
<span class="cp">            token = #{token}</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;PasswordReissueInfo&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        INSERT INTO password_reissue_info (</span>
<span class="cp">            username,</span>
<span class="cp">            token,</span>
<span class="cp">            secret,</span>
<span class="cp">            expiry_date</span>
<span class="cp">        ) VALUES (</span>
<span class="cp">            #{username},</span>
<span class="cp">            #{token},</span>
<span class="cp">            #{secret},</span>
<span class="cp">            #{expiryDate}</span>
<span class="cp">        )</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/insert&gt;</span>

    <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&quot;delete&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        DELETE FROM</span>
<span class="cp">            password_reissue_info</span>
<span class="cp">        WHERE</span>
<span class="cp">            token = #{token}</span>
<span class="cp">    ]]&gt;</span>
    <span class="nt">&lt;/delete&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>以下、実装方法に従って実装されたコードについて順に解説する。</p>
<ul>
<li><p class="first">パスワード再発行のための認証情報の生成と保存</p>
<ul>
<li><p class="first">パスワード生成器の定義</p>
<p>Passayのパスワード生成機能を使用するための、パスワード生成器と生成規則の定義を以下に示す。
パスワード生成器や生成規則に関しては <a class="reference internal" href="#password-generation"><span>パスワード生成</span></a> を参照。</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Passayのパスワード生成機能で用いるパスワード生成器のBean定義</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Passayのパスワード生成機能で用いるパスワード生成規則のBean定義。 <a class="reference internal" href="#password-strength"><span>パスワードの品質チェック</span></a> で使用した検証規則を使用し、半角英大文字、半角英小文字、半角数字をそれぞれ一文字以上含むパスワードの生成規則を定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>applicationContext.xml</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;passwordGenerator&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.PasswordGenerator&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;util:list</span> <span class="na">id=</span><span class="s">&quot;passwordGenerationRules&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;upperCaseRule&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;lowerCaseRule&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;digitRule&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/util:list&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Serviceの実装</p>
<p>パスワード再発行のための認証情報を作成し、データベースへ保存するための処理の実装を以下に示す。この処理中で生成した認証情報をメール送信する。メール送信については後述するため、ここでは省略する。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueServiceImpl</span> <span class="kd">implements</span> <span class="n">PasswordReissueService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueInfoRepository</span> <span class="n">passwordReissueInfoRepository</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordGenerator</span> <span class="n">passwordGenerator</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Resource</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;passwordGenerationRules&quot;</span><span class="o">)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">CharacterRule</span><span class="o">&gt;</span> <span class="n">passwordGenerationRules</span><span class="o">;</span> <span class="c1">//(2)</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.tokenLifeTimeSeconds}&quot;</span><span class="o">)</span>
    <span class="kt">int</span> <span class="n">tokenLifeTimeSeconds</span><span class="o">;</span> <span class="c1">// (3)</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createAndSendReissueInfo</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">String</span> <span class="n">rowSecret</span> <span class="o">=</span> <span class="n">passwordGenerator</span><span class="o">.</span><span class="na">generatePassword</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">passwordGenerationRules</span><span class="o">);</span> <span class="c1">// (4)</span>

        <span class="k">if</span><span class="o">(!</span><span class="n">accountSharedService</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">username</span><span class="o">)){</span> <span class="c1">// (5)</span>
            <span class="k">return</span> <span class="n">rowSecret</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">Account</span> <span class="n">account</span><span class="o">=</span> <span class="n">accountSharedService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">username</span><span class="o">);</span> <span class="c1">// (6)</span>

        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span> <span class="c1">// (7)</span>

        <span class="n">LocalDateTime</span> <span class="n">expiryDate</span> <span class="o">=</span> <span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">()</span>
                <span class="o">.</span><span class="na">plusSeconds</span><span class="o">(</span><span class="n">tokenLifeTimeSeconds</span><span class="o">);</span> <span class="c1">// (8)</span>

        <span class="n">PasswordReissueInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PasswordReissueInfo</span><span class="o">();</span> <span class="c1">// (9)</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setSecret</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">rowSecret</span><span class="o">));</span> <span class="c1">// (10)</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setExpiryDate</span><span class="o">(</span><span class="n">expiryDate</span><span class="o">);</span>

        <span class="n">passwordReissueInfoRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">info</span><span class="o">);</span> <span class="c1">// (11)</span>

        <span class="c1">// omitted (Send E-Mail)</span>

        <span class="k">return</span> <span class="n">rowSecret</span><span class="o">;</span> <span class="c1">// (12)</span>

    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Passayのパスワード生成機能で用いるパスワード生成器をインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Passayのパスワード生成機能で用いるパスワード生成ルールをインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行用の認証情報が有効である期間の長さを秒単位で指定する。プロパティファイルに定義された値をインジェクションしている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">秘密情報として用いるために、Passayのパスワード生成機能を用いて、パスワード生成規則に従った、長さ10のランダムな文字列を生成する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として渡されてきたユーザ名のアカウントが存在するかどうか確認する。存在しなかった場合、ユーザが存在しないことを知られないためにダミーの秘密情報を返す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行用の認証情報に含まれるユーザ名のアカウント情報を取得する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">トークンとして用いるために、<code class="docutils literal"><span class="pre">java.util.UUID</span></code> クラスの<code class="docutils literal"><span class="pre">randomUUID</span></code> メソッドを用いてランダムな文字列を生成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">現在時刻に(3)の値を加えることにより、パスワード再発行用の認証情報の有効期限を計算する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行用の認証情報を作成し、ユーザ名、トークン、秘密情報、有効期限を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">秘密情報はハッシュ化を行ってから<code class="docutils literal"><span class="pre">PasswordReissueInfo</span></code> に設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行用の認証情報をデータベースに登録する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">生成した秘密情報を返す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Formの実装</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CreateReissueInfoForm</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotEmpty</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Viewの実装</p>
<p><strong>パスワード再発行のための認証情報生成画面(createReissueInfoForm.xml)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Reissue password<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;t:messagesPanel</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:form</span>
            <span class="na">action=</span><span class="s">&quot;${f:h(pageContext.request.contextPath)}/reissue/create&quot;</span>
            <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">modelAttribute=</span><span class="s">&quot;createReissueInfoForm&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;table&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;th&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;username&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Username<span class="nt">&lt;/form:label&gt;</span>
                    <span class="nt">&lt;/th&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:input</span> <span class="na">path=</span><span class="s">&quot;username&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;username&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;/table&gt;</span>

            <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;submit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Reissue password&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Controllerの実装</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/reissue&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueService</span> <span class="n">passwordReissueService</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;form&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">showCreateReissueInfoForm</span><span class="o">(</span><span class="n">CreateReissueInfoForm</span> <span class="n">form</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;passwordreissue/createReissueInfoForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createReissueInfo</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">CreateReissueInfoForm</span> <span class="n">form</span><span class="o">,</span>
            <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span>
            <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">showCreateReissueInfoForm</span><span class="o">(</span><span class="n">form</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">rawSecret</span> <span class="o">=</span> <span class="n">passwordReissueService</span><span class="o">.</span><span class="na">createAndSendReissueInfo</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span> <span class="c1">// (1)</span>
        <span class="n">attributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="s">&quot;secret&quot;</span><span class="o">,</span> <span class="n">rawSecret</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/reissue/create?complete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createReissueInfoComplete</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;passwordreissue/createReissueInfoComplete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Formから取得したユーザ名から、パスワード再発行のための認証情報を生成し、データベースに登録する処理を呼び出す。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="reissue-info-delivery">
<span id="id43"></span><h3><a class="toc-backref" href="#id104">6.10.3.6. パスワード再発行のための認証情報の配布</a><a class="headerlink" href="#reissue-info-delivery" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id44">
<h4><a class="toc-backref" href="#id105">6.10.3.6.1. 実装する要件一覧</a><a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span>パスワード再発行画面のURLと秘密情報の別配布</span></a></li>
<li><a class="reference internal" href="#sec-requirements"><span>パスワード再発行画面のURLのメール送付</span></a></li>
</ul>
</div>
<div class="section" id="id45">
<h4><a class="toc-backref" href="#id106">6.10.3.6.2. 動作イメージ</a><a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h4>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_password_reissue_give.png"><img alt="Givee Password Reissue Information" src="../_images/SecureLogin_password_reissue_give.png" style="width: 80%;" /></a>
</div>
<p><a class="reference internal" href="#reissue-info-create"><span>パスワード再発行のための認証情報の生成</span></a> では、パスワード再発行のための認証情報の生成について説明した。
ここでは、生成した認証情報の配布について説明する。</p>
<p>パスワード再発行のための認証は、パスワード再発行画面のURLと秘密情報を用いて行う。
この二つの情報が一度に漏れることを防ぐため、それぞれ別の方法でユーザに配布する。
本アプリケーションでは、パスワード再発行画面のURLはユーザの登録済みメールアドレスへ送付し、秘密情報は画面に表示する。</p>
</div>
<div class="section" id="id46">
<h4><a class="toc-backref" href="#id107">6.10.3.6.3. 実装方法</a><a class="headerlink" href="#id46" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><a class="reference internal" href="#reissue-info-create"><span>パスワード再発行のための認証情報の生成</span></a> で生成した認証情報を二つに分け、それぞれ別の方法でユーザに配布する。</div>
<div class="line">以下の二つの処理を実装して用いることで要件を実現する。</div>
</div>
<ul>
<li><p class="first">秘密情報の画面表示</p>
<p><a class="reference internal" href="#reissue-info-create"><span>パスワード再発行のための認証情報の生成</span></a> で生成したハッシュ化前の秘密情報を、画面に表示させることでユーザに配布する。</p>
</li>
<li><p class="first">パスワード再発行画面のURLのメール送付</p>
<p><a class="reference internal" href="#reissue-info-create"><span>パスワード再発行のための認証情報の生成</span></a> で生成したトークンを含むパスワード再発行画面のURLを、Spring FrameworkのMail連携用コンポーネントを用いて、メールで送付する。</p>
</li>
</ul>
</div>
<div class="section" id="id47">
<h4><a class="toc-backref" href="#id108">6.10.3.6.4. コード解説</a><a class="headerlink" href="#id47" title="Permalink to this headline">¶</a></h4>
<p>上記の実装方法に従って実装されたコードについて順に解説する。</p>
<ul>
<li><p class="first">秘密情報の画面表示</p>
<p>Controllerから秘密情報の生成処理を呼び出し、Viewに表示するための一連の実装を以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/reissue&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueService</span> <span class="n">passwordReissueService</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createReissueInfo</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">CreateReissueInfoForm</span> <span class="n">form</span><span class="o">,</span>
            <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span>
            <span class="n">RedirectAttributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">showCreateReissueInfoForm</span><span class="o">(</span><span class="n">form</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">rawSecret</span> <span class="o">=</span> <span class="n">passwordReissueService</span><span class="o">.</span><span class="na">createAndSendReissueInfo</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span> <span class="c1">// (1)</span>
        <span class="n">attributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="s">&quot;secret&quot;</span><span class="o">,</span> <span class="n">rawSecret</span><span class="o">);</span> <span class="c1">// (2)</span>
        <span class="k">return</span> <span class="s">&quot;redirect:/reissue/create?complete&quot;</span><span class="o">;</span> <span class="c1">// (3)</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;create&quot;</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createReissueInfoComplete</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;passwordreissue/createReissueInfoComplete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">秘密情報を生成する処理を呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">RedirectAttributesを利用して、リダイレクト先に秘密情報を渡す。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行用の認証情報完了画面にリダイレクトする。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>パスワード再発行用の認証情報生成完了画面(createReissueInfoComplete.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Your Password Reissue URL was successfully generated.<span class="nt">&lt;/h1&gt;</span>
        The URL was sent to your registered E-mail address.<span class="nt">&lt;br</span> <span class="nt">/&gt;</span> Please
        access the URL and enter the secret shown below.
        <span class="nt">&lt;h3&gt;</span>Secret : <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">secret</span><span class="nt">&gt;</span>${f:h(secret)}<span class="nt">&lt;/span&gt;&lt;/h3&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">秘密情報を画面に表示する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">パスワード再発行画面のURLのメール送付</p>
<p>パスワード再発行用の認証情報からパスワード再発行画面のURLを作成し、メール送付する処理の実装を以下に示す。
依存ライブラリの追加方法やメールセッションの取得方法等の詳細については、<a class="reference internal" href="../ArchitectureInDetail/Email.html"><em>E-mail送信(SMTP)</em></a> を参照。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.mail</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueMailSharedServiceImpl</span> <span class="kd">implements</span> <span class="n">PasswordReissueMailSharedService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">JavaMailSender</span> <span class="n">mailSender</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;passwordReissueMessage&quot;</span><span class="o">)</span>
    <span class="n">SimpleMailMessage</span> <span class="n">templateMessage</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">send</span><span class="o">(</span><span class="n">String</span> <span class="n">to</span><span class="o">,</span> <span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SimpleMailMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleMailMessage</span><span class="o">(</span><span class="n">templateMessage</span><span class="o">);</span> <span class="c1">// (3)</span>
        <span class="n">message</span><span class="o">.</span><span class="na">setTo</span><span class="o">(</span><span class="n">to</span><span class="o">);</span>
        <span class="n">message</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
        <span class="n">mailSender</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.springframework.mail.javamail.JavaMailSender</span></code> のBeanをインジェクションする。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">送信元のメールアドレスとメールタイトルが設定された、<code class="docutils literal"><span class="pre">org.springframework.mail.SimpleMailMessage</span></code> のBeanをインジェクションする。</div>
<div class="line">本アプリケーションでは<code class="docutils literal"><span class="pre">SimpleMailMessage</span></code> のBeanは一つしか定義されていないが、一般にはメールのテンプレートとして複数のBeanが定義されるため、 <code class="docutils literal"><span class="pre">&#64;Named</span></code> でBean名を指定している。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">テンプレートから<code class="docutils literal"><span class="pre">SimpleMailMessage</span></code> のインスタンスを生成し、引数として与えられた宛先メールアドレスと本文を設定して送信する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueServiceImpl</span> <span class="kd">implements</span> <span class="n">PasswordReissueService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueMailSharedService</span> <span class="n">mailSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.tokenLifeTimeSeconds}&quot;</span><span class="o">)</span>
    <span class="kt">int</span> <span class="n">tokenLifeTimeSeconds</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${app.applicationBaseUrl}&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="n">String</span> <span class="n">baseUrl</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${app.passwordReissueProtocol}&quot;</span><span class="o">)</span>
    <span class="n">String</span> <span class="n">protocol</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createAndSendReissueInfo</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">String</span> <span class="n">rowSecret</span> <span class="o">=</span> <span class="n">passwordGenerator</span><span class="o">.</span><span class="na">generatePassword</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">passwordGenerationRules</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(!</span><span class="n">accountSharedService</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">username</span><span class="o">)){</span>
            <span class="k">return</span> <span class="n">rowSecret</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">Account</span> <span class="n">account</span><span class="o">=</span> <span class="n">accountSharedService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>

        <span class="n">LocalDateTime</span> <span class="n">expiryDate</span> <span class="o">=</span> <span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">()</span>
                <span class="o">.</span><span class="na">plusSeconds</span><span class="o">(</span><span class="n">tokenLifeTimeSeconds</span><span class="o">);</span>

        <span class="n">PasswordReissueInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PasswordReissueInfo</span><span class="o">();</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setSecret</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">rowSecret</span><span class="o">));</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setExpiryDate</span><span class="o">(</span><span class="n">expiryDate</span><span class="o">);</span>

        <span class="n">passwordReissueInfoRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">info</span><span class="o">);</span>

        <span class="n">UriComponentsBuilder</span> <span class="n">uriBuilder</span> <span class="o">=</span> <span class="n">UriComponentsBuilder</span><span class="o">.</span><span class="na">fromUriString</span><span class="o">(</span><span class="n">baseUrl</span><span class="o">);</span>
        <span class="n">uriBuilder</span><span class="o">.</span><span class="na">pathSegment</span><span class="o">(</span><span class="s">&quot;reissue&quot;</span><span class="o">).</span><span class="na">pathSegment</span><span class="o">(</span><span class="s">&quot;resetpassword&quot;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;form&quot;</span><span class="o">).</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">,</span> <span class="n">info</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>  <span class="c1">// (2)</span>
        <span class="n">String</span> <span class="n">passwordResetUrl</span> <span class="o">=</span> <span class="n">uriBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">().</span><span class="na">encode</span><span class="o">().</span><span class="na">toUriString</span><span class="o">();</span>

        <span class="n">mailSharedService</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getEmail</span><span class="o">(),</span> <span class="n">passwordResetUrl</span><span class="o">);</span> <span class="c1">// (3)</span>

        <span class="k">return</span> <span class="n">rowSecret</span><span class="o">;</span>

    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行画面のURLに使用するベースURLをプロパティファイルから取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(1)で取得した値と、生成したパスワード再発行用の認証情報に含まれるトークンを使用して、ユーザに配布するパスワード再発行画面のURLを作成する。</div>
<div class="line">URLの作成には <code class="docutils literal"><span class="pre">org.springframework.web.util.UriComponentsBuilder</span></code> を利用する。<code class="docutils literal"><span class="pre">UriComponentsBuilder</span></code> については、<a class="reference internal" href="../ArchitectureInDetail/REST.html#restappendixhypermedialink"><span>ハイパーメディアリンクの実装</span></a> の中で説明されている。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザの登録メールアドレス宛てに、パスワード再発行画面のURLを本文に記したメールを送付する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>
<div class="section" id="reissue-info-validate">
<span id="id48"></span><h3><a class="toc-backref" href="#id109">6.10.3.7. パスワード再発行実行時の検査</a><a class="headerlink" href="#reissue-info-validate" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id49">
<h4><a class="toc-backref" href="#id110">6.10.3.7.1. 実装する要件一覧</a><a class="headerlink" href="#id49" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span>パスワード再発行用の認証情報の有効期限の設定</span></a></li>
</ul>
</div>
<div class="section" id="id50">
<h4><a class="toc-backref" href="#id111">6.10.3.7.2. 動作イメージ</a><a class="headerlink" href="#id50" title="Permalink to this headline">¶</a></h4>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_password_reissue_execute.png"><img alt="Use Password Reissue Information" src="../_images/SecureLogin_password_reissue_execute.png" style="width: 80%;" /></a>
</div>
<p><a class="reference internal" href="#reissue-info-delivery"><span>パスワード再発行のための認証情報の配布</span></a> では、パスワード再発行のための認証情報の配布について説明した。
ここでは、配布された認証情報を使用する際の処理について説明する。</p>
<p>パスワード再発行時の認証として、<a class="reference internal" href="#reissue-info-delivery"><span>パスワード再発行のための認証情報の配布</span></a> でそれぞれ別配布したパスワード再発行画面のURLと秘密情報を照合する。
URLに含まれるトークンと秘密情報の組が正しい場合にのみ、パスワードが再発行される。</p>
<p>また、一般的にはパスワードの再発行は認証情報の生成から間を置かずに行われるため、不必要に長期間有効となることが無いように、認証情報に有効期限を設定する。
パスワード再発行画面のURLにアクセスした際に、認証情報が有効期限内であればパスワード再発行画面を表示し、有効期限が切れていればエラー画面に遷移する。</p>
</div>
<div class="section" id="id51">
<h4><a class="toc-backref" href="#id112">6.10.3.7.3. 実装方法</a><a class="headerlink" href="#id51" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">メールで送付されるパスワード再発行画面のURLには、リクエストパラメータとしてトークンが含まれている。パスワード再発行画面へアクセスされた際にトークンを取得し、このトークンをキーとしてデータベースからパスワード再発行のための認証情報を検索する。</div>
<div class="line">認証情報生成時にあらかじめ有効期限を設定しておき、データベースから取得した際に有効期限切れのチェックを行う。有効期限内であればパスワード変更画面を表示して秘密情報と新しいパスワードの入力を受け付ける。</div>
<div class="line">データベースから取得した認証情報中の秘密情報と、ユーザが入力した秘密情報が一致すれば認証成功であり、パスワードを再発行する。</div>
<div class="line">具体的には以下の三つの処理を実装することで要件を実現する。</div>
</div>
<ul>
<li><p class="first">パスワード再発行用の認証情報の有効期限の設定</p>
<p><a class="reference internal" href="#reissue-info-create"><span>パスワード再発行のための認証情報の生成</span></a> で説明した処理の中で、生成した認証情報に有効期限を設定する。</p>
</li>
<li><p class="first">パスワード再発行のための認証情報の有効期限の検査</p>
<p>パスワード再発行画面にアクセスされた際に、リクエストパラメータに含まれるトークンを取得し、トークンをキーとしてデータベースに保存されているパスワード再発行のための認証情報を検索する。
認証情報に含まれる有効期限と現在時刻を比較し、有効期限が切れていればエラー画面に遷移させる。</p>
</li>
<li><p class="first">パスワード再発行のための認証情報を用いたユーザの確認</p>
<p>パスワードの再発行を行う際に、ユーザ名、トークンとユーザが入力した秘密情報の組み合わせがデータベース内の認証情報と一致しているかどうかを確認する。
一致する場合にはパスワードを再発行し、不一致の場合にはエラーメッセージを表示する。</p>
</li>
</ul>
</div>
<div class="section" id="id52">
<h4><a class="toc-backref" href="#id113">6.10.3.7.4. コード解説</a><a class="headerlink" href="#id52" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">パスワード再発行用の認証情報の有効期限の設定</p>
<p>パスワード再発行用の認証情報への有効期限の設定自体は、 <a class="reference internal" href="#reissue-info-create"><span>パスワード再発行のための認証情報の生成</span></a> で説明した処理に含まれている。ここでは、関連する実装箇所のみ再掲する。</p>
<ul>
<li><p class="first">Serviceの実装</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueServiceImpl</span> <span class="kd">implements</span> <span class="n">PasswordReissueService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueInfoRepository</span> <span class="n">passwordReissueInfoRepository</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.tokenLifeTimeSeconds}&quot;</span><span class="o">)</span>
    <span class="kt">int</span> <span class="n">tokenLifeTimeSeconds</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">createAndSendReissueInfo</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// omitted</span>

        <span class="n">LocalDateTime</span> <span class="n">expiryDate</span> <span class="o">=</span> <span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">()</span>
                <span class="o">.</span><span class="na">plusSeconds</span><span class="o">(</span><span class="n">tokenLifeTimeSeconds</span><span class="o">);</span> <span class="c1">// (2)</span>

        <span class="n">PasswordReissueInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PasswordReissueInfo</span><span class="o">();</span> <span class="c1">// (3)</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setSecret</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">rowSecret</span><span class="o">));</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setExpiryDate</span><span class="o">(</span><span class="n">expiryDate</span><span class="o">);</span>

        <span class="n">passwordReissueInfoRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">info</span><span class="o">);</span> <span class="c1">// (4)</span>

        <span class="c1">// omitted (Send E-Mail)</span>

    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行用の認証情報が有効である期間の長さを秒単位で指定する。プロパティファイルに定義された値をインジェクションしている。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">現在時刻に(1)の値を加えることにより、パスワード再発行用の認証情報の有効期限を計算する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行用の認証情報を作成し、ユーザ名、トークン、秘密情報、有効期限を設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行用の認証情報をデータベースに登録する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
<li><p class="first">パスワード再発行のための認証情報の有効期限の検査</p>
<p>パスワード再発行画面にアクセスされた際に、リクエストパラメータとしてURLに含まれるトークンからパスワード再発行のための認証情報を取得し、有効期限内であるかどうかを検査する処理の実装を以下に示す。
この処理中ではパスワード再発行の失敗上限を超過しているかどうかの検査も行うが、後述するため、ここでは省略する。</p>
<ul>
<li><p class="first">Serviceの実装</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueServiceImpl</span> <span class="kd">implements</span> <span class="n">PasswordReissueService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueInfoRepository</span> <span class="n">passwordReissueInfoRepository</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">PasswordReissueInfo</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">PasswordReissueInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="n">passwordReissueInfoRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">token</span><span class="o">);</span> <span class="c1">// (1)</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">info</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ResourceNotFoundException</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
                    <span class="n">MessageKeys</span><span class="o">.</span><span class="na">E_SL_PR_5002</span><span class="o">,</span> <span class="n">token</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">().</span><span class="na">isAfter</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">getExpiryDate</span><span class="o">()))</span> <span class="o">{</span> <span class="c1">// (2)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
                    <span class="n">MessageKeys</span><span class="o">.</span><span class="na">E_SL_PR_2001</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="c1">// omitted (attempts exceeded upper bounds)</span>

        <span class="k">return</span> <span class="n">info</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられたトークンをキーとして、パスワード再発行のための認証情報をデータベースから取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">有効期限が切れている場合は、<code class="docutils literal"><span class="pre">org.terasoluna.gfw.common.exception.BusinessException</span></code> をthrowする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Controllerの実装</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/reissue&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueService</span> <span class="n">passwordReissueService</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">showPasswordResetForm</span><span class="o">(</span><span class="n">PasswordResetForm</span> <span class="n">form</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span>
            <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (1)</span>

        <span class="n">PasswordReissueInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="n">passwordReissueService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">token</span><span class="o">);</span> <span class="c1">// (3)</span>

        <span class="n">form</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
        <span class="n">form</span><span class="o">.</span><span class="na">setToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;passwordResetForm&quot;</span><span class="o">,</span> <span class="n">form</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&quot;passwordreissue/passwordResetForm&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行画面のURLにリクエストパラメータとして含まれるトークンを取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Serviceのメソッドにトークンを渡して呼び出す。データベースから認証情報が取得され、有効期限が検査される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
<li><p class="first">パスワード再発行のための認証情報を用いたユーザの確認</p>
<p>パスワード再発行画面においてユーザが入力した秘密情報と、パスワード再発行画面のURLに含まれるトークンの組が正しいかどうかを確認する処理の実装を以下に示す。
この確認処理はパスワード再発行固有のロジックであり、かつデータベースの内容によって結果が異なるチェックであることから、Bean ValidationやSpring Validatorを用いず、Serviceに実装している。</p>
<ul>
<li><p class="first">Serviceの実装</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PasswordReissueService</span> <span class="o">{</span>

    <span class="c1">// omitted</span>

    <span class="kt">boolean</span> <span class="nf">resetPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">token</span><span class="o">,</span> <span class="n">String</span> <span class="n">secret</span><span class="o">,</span> <span class="c1">// (1)</span>
            <span class="n">String</span> <span class="n">rawPassword</span><span class="o">);</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられたユーザ名、トークン、秘密情報を用いてユーザの確認を行った後、新しいパスワードを設定するメソッド</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueServiceImpl</span> <span class="kd">implements</span> <span class="n">PasswordReissueService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueFailureSharedService</span> <span class="n">passwordReissueFailureSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueInfoRepository</span> <span class="n">passwordReissueInfoRepository</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">resetPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">token</span><span class="o">,</span> <span class="n">String</span> <span class="n">secret</span><span class="o">,</span>
            <span class="n">String</span> <span class="n">rawPassword</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">PasswordReissueInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">token</span><span class="o">);</span> <span class="c1">// (1)</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">secret</span><span class="o">,</span> <span class="n">info</span><span class="o">.</span><span class="na">getSecret</span><span class="o">()))</span> <span class="o">{</span> <span class="c1">// (2)</span>
            <span class="n">passwordReissueFailureSharedService</span><span class="o">.</span><span class="na">resetFailure</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
                <span class="n">MessageKeys</span><span class="o">.</span><span class="na">E_SL_PR_5003</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">failedPasswordReissueRepository</span><span class="o">.</span><span class="na">deleteByToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">passwordReissueInfoRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">token</span><span class="o">);</span> <span class="c1">// (3)</span>

        <span class="k">return</span> <span class="n">accountSharedService</span><span class="o">.</span><span class="na">updatePassword</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">rawPassword</span><span class="o">);</span> <span class="c1">// (4)</span>

    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられたトークンを用いて、データベースからパスワード再発行用の認証情報を取得する。このとき、有効期限が改めて検査される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行用の認証情報に含まれるハッシュ化された秘密情報と、引数として与えられた秘密情報を比較する。異なる場合には<code class="docutils literal"><span class="pre">BusinessException</span></code> をthrowする。この場合、パスワードの再発行は失敗となる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">使用された認証情報を再使用不能にするために、データベースから消去する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として渡されたユーザ名を持つアカウントのパスワードを、指定された新しいパスワードに更新する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Formの実装</p>
<p>クラスに付与されたアノテーションによってNullチェック以外の入力チェックが網羅されていることから、単項目チェックとしては<code class="docutils literal"><span class="pre">&#64;NotNull</span></code> のみを付与している。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Data</span>
<span class="nd">@Compare</span><span class="o">(</span><span class="n">source</span> <span class="o">=</span> <span class="s">&quot;newPasssword&quot;</span><span class="o">,</span> <span class="n">destination</span> <span class="o">=</span> <span class="s">&quot;confirmNewPassword&quot;</span><span class="o">,</span> <span class="n">operator</span> <span class="o">=</span> <span class="n">Compare</span><span class="o">.</span><span class="na">Operator</span><span class="o">.</span><span class="na">EQUAL</span><span class="o">)</span>
<span class="nd">@StrongPassword</span><span class="o">(</span><span class="n">usernamePropertyName</span> <span class="o">=</span> <span class="s">&quot;username&quot;</span><span class="o">,</span> <span class="n">newPasswordPropertyName</span> <span class="o">=</span> <span class="s">&quot;newPassword&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
<span class="nd">@NotReusedPassword</span><span class="o">(</span><span class="n">usernamePropertyName</span> <span class="o">=</span> <span class="s">&quot;username&quot;</span><span class="o">,</span> <span class="n">newPasswordPropertyName</span> <span class="o">=</span> <span class="s">&quot;newPassword&quot;</span><span class="o">)</span> <span class="c1">// (2)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordResetForm</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">token</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">secret</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">newPassword</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">confirmNewPassword</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードの強度を検査するためのアノテーション。詳細は <a class="reference internal" href="#password-strength"><span>パスワードの品質チェック</span></a> を参照。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードの再利用を検査するためのアノテーション。詳細は <a class="reference internal" href="#password-strength"><span>パスワードの品質チェック</span></a> を参照。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Viewの実装</p>
<p><strong>パスワード再発行画面(passwordResetForm.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Reset Password<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;t:messagesPanel</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form:form</span>
            <span class="na">action=</span><span class="s">&quot;${f:h(pageContext.request.contextPath)}/reissue/resetpassword&quot;</span>
            <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">modelAttribute=</span><span class="s">&quot;passwordResetForm&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;table&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;th&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;username&quot;</span><span class="nt">&gt;</span>Username<span class="nt">&lt;/form:label&gt;&lt;/th&gt;</span>
                    <span class="nt">&lt;td&gt;</span>${f:h(passwordResetForm.username)} <span class="nt">&lt;form:hidden</span>
                            <span class="na">path=</span><span class="s">&quot;username&quot;</span> <span class="na">value=</span><span class="s">&quot;${f:h(passwordResetForm.username)}&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
                    <span class="nt">&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
                <span class="nt">&lt;form:hidden</span> <span class="na">path=</span><span class="s">&quot;token&quot;</span> <span class="na">value=</span><span class="s">&quot;${f:h(passwordResetForm.token)}&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;th&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;secret&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>Secret<span class="nt">&lt;/form:label&gt;</span>
                    <span class="nt">&lt;/th&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:password</span> <span class="na">path=</span><span class="s">&quot;secret&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;secret&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;th&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;newPassword&quot;</span> <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>New password<span class="nt">&lt;/form:label&gt;</span>
                    <span class="nt">&lt;/th&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:password</span> <span class="na">path=</span><span class="s">&quot;newPassword&quot;</span>
                            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;newPassword&quot;</span> <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span>
                            <span class="na">htmlEscape=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
                <span class="nt">&lt;tr&gt;</span>
                    <span class="nt">&lt;th&gt;&lt;form:label</span> <span class="na">path=</span><span class="s">&quot;confirmNewPassword&quot;</span>
                            <span class="na">cssErrorClass=</span><span class="s">&quot;error-label&quot;</span><span class="nt">&gt;</span>New password(Confirm)<span class="nt">&lt;/form:label&gt;&lt;/th&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:password</span> <span class="na">path=</span><span class="s">&quot;confirmNewPassword&quot;</span>
                            <span class="na">cssErrorClass=</span><span class="s">&quot;error-input&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                    <span class="nt">&lt;td&gt;&lt;form:errors</span> <span class="na">path=</span><span class="s">&quot;confirmNewPassword&quot;</span>
                            <span class="na">cssClass=</span><span class="s">&quot;error-messages&quot;</span> <span class="nt">/&gt;&lt;/td&gt;</span>
                <span class="nt">&lt;/tr&gt;</span>
            <span class="nt">&lt;/table&gt;</span>

            <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;submit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Reset password&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/form:form&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザ名をhidden項目として保持する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">トークンをhidden項目として保持する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">ユーザの確認のために、秘密情報を入力させる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>パスワード再発行画面(passwordResetComplete.jsp)</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrapper&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Your password was successfully reset.<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${f:h(pageContext.request.contextPath)}/&quot;</span><span class="nt">&gt;</span>go to Top<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Controllerの実装</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.app.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/reissue&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueService</span> <span class="n">passwordReissueService</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;resetpassword&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">resetPassword</span><span class="o">(</span><span class="nd">@Validated</span> <span class="n">PasswordResetForm</span> <span class="n">form</span><span class="o">,</span>
            <span class="n">BindingResult</span> <span class="n">bindingResult</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">showPasswordResetForm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">model</span><span class="o">,</span> <span class="n">form</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span>
                    <span class="n">form</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">passwordReissueService</span><span class="o">.</span><span class="na">resetPassword</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span>
                    <span class="n">form</span><span class="o">.</span><span class="na">getToken</span><span class="o">(),</span> <span class="n">form</span><span class="o">.</span><span class="na">getSecret</span><span class="o">(),</span> <span class="n">form</span><span class="o">.</span><span class="na">getNewPassword</span><span class="o">());</span> <span class="c1">// (1)</span>
            <span class="k">return</span> <span class="s">&quot;redirect:/reissue/resetpassword?complete&quot;</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getResultMessages</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">showPasswordResetForm</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="n">model</span><span class="o">,</span> <span class="n">form</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span>
                    <span class="n">form</span><span class="o">.</span><span class="na">getToken</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;resetpassword&quot;</span><span class="o">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;complete&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">resetPasswordComplete</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;passwordreissue/passwordResetComplete&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Serviceのメソッドにユーザ名、トークン、秘密情報、新しいパスワードを渡す。ユーザ名、トークン、秘密情報の組み合わせが正しい場合、新しいパスワードに更新される。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="reissue-info-invalidate">
<span id="id53"></span><h3><a class="toc-backref" href="#id114">6.10.3.8. パスワード再発行の失敗上限回数の設定</a><a class="headerlink" href="#reissue-info-invalidate" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id54">
<h4><a class="toc-backref" href="#id115">6.10.3.8.1. 実装する要件一覧</a><a class="headerlink" href="#id54" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#sec-requirements"><span>パスワード再発行の失敗上限回数の設定</span></a></li>
</ul>
</div>
<div class="section" id="id55">
<h4><a class="toc-backref" href="#id116">6.10.3.8.2. 動作イメージ</a><a class="headerlink" href="#id55" title="Permalink to this headline">¶</a></h4>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_invalidate_token.png"><img alt="Page Transition" src="../_images/SecureLogin_invalidate_token.png" style="width: 80%;" /></a>
</div>
<p>パスワード再発行画面のURLが何らかの原因で漏えいした場合であっても、秘密情報が漏えいしていなければパスワードが不正に再発行されることはない。
秘密情報には十分に推測困難なランダム値を用いているため簡単に破られる可能性は低いが、ブルートフォース攻撃を阻止する目的で認証失敗の回数に上限値を設定する。
上限値を超えてパスワード再発行のための認証に失敗した場合、そのURL（トークン）でのパスワード再発行が行えないようにする。</p>
</div>
<div class="section" id="id56">
<h4><a class="toc-backref" href="#id117">6.10.3.8.3. 実装方法</a><a class="headerlink" href="#id56" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">本アプリケーションでは、パスワード再発行に失敗した履歴を「パスワード再発行失敗イベント」エンティティとしてデータベースに保存し、このパスワード再発行失敗イベントエンティティを用いて、パスワード再発行の失敗回数をカウントする。</div>
<div class="line">失敗回数があらかじめ設定した上限値以上であれば、パスワード再発行画面へのアクセス時に例外をスローする。</div>
<div class="line">具体的には、以下の二つの処理を実装して用いることにより、要件を実現する。</div>
</div>
<ul>
<li><p class="first">パスワード再発行失敗イベントエンティティの保存</p>
<p><a class="reference internal" href="#reissue-info-validate"><span>パスワード再発行実行時の検査</span></a> における、「パスワード再発行のための認証情報を用いたユーザの確認」処理の中で、ユーザの確認に失敗した場合に、使用したトークンと失敗日時の組をパスワード再発行失敗イベントエンティティとしてデータベースに登録する。</p>
</li>
<li><p class="first">パスワード再発行時の例外のスロー</p>
<p>パスワード再発行のために認証情報をデータベースから取得した際に、パスワード再発行失敗イベントエンティティの数をカウントし、上限値以上であれば例外をスローする。</p>
</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">パスワード再発行失敗イベントエンティティはパスワード再発行の失敗回数のカウントのみを目的としているため、不要になったタイミングで消去する。
パスワード再発行の失敗時のログが必要な場合は必ず別途ログを保存しておくこと。</p>
</div>
</div>
<div class="section" id="id57">
<h4><a class="toc-backref" href="#id118">6.10.3.8.4. コード解説</a><a class="headerlink" href="#id57" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">共通部分</p>
<p>前提として、 <a class="reference internal" href="#reissue-info-validate"><span>パスワード再発行実行時の検査</span></a> に記した各処理が実装されているものとする。
その他に共通的に必要な、データベースに対するパスワード再発行失敗イベントエンティティの登録、検索、削除に関する実装を以下に示す。</p>
<ul>
<li><p class="first">Entityの実装</p>
<p>パスワード再発行失敗イベントエンティティの実装の実装は以下の通り。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.model</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FailedPasswordReissue</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">token</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="kd">private</span> <span class="n">LocalDateTime</span> <span class="n">attemptDate</span><span class="o">;</span> <span class="c1">// (2)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行に使用したトークン</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行を試行した日時</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Repositoryの実装</p>
<p>Entityの検索、登録、削除を行うためのRepositoryを以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.repository.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">FailedPasswordReissueRepository</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="nf">countByToken</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">token</span><span class="o">);</span> <span class="c1">// (1)</span>

    <span class="kt">int</span> <span class="nf">create</span><span class="o">(</span><span class="n">FailedPasswordReissue</span> <span class="n">event</span><span class="o">);</span> <span class="c1">// (2)</span>

    <span class="kt">int</span> <span class="nf">deleteByToken</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;token&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">token</span><span class="o">);</span> <span class="c1">// (3)</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられたトークンをキーとして<code class="docutils literal"><span class="pre">FailedPasswordReissue</span></code>オブジェクトの個数を取得するメソッド</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられた<code class="docutils literal"><span class="pre">FailedPasswordReissue</span></code>オブジェクトをデータベースのレコードとして登録するメソッド</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられたトークンをキーとして<code class="docutils literal"><span class="pre">FailedPasswordReissue</span></code>オブジェクトを削除するメソッド</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>マッピングファイルは以下の通り。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="nt">&lt;mapper</span>
 <span class="na">namespace=</span><span class="s">&quot;org.terasoluna.securelogin.domain.repository.passwordreissue.FailedPasswordReissueRepository&quot;</span><span class="nt">&gt;</span>

 <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;countByToken&quot;</span> <span class="na">resultType=</span><span class="s">&quot;_int&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            COUNT(*)</span>
<span class="cp">        FROM</span>
<span class="cp">            failed_password_reissue</span>
<span class="cp">        WHERE</span>
<span class="cp">            token = #{token}</span>
<span class="cp">    ]]&gt;</span>
 <span class="nt">&lt;/select&gt;</span>

 <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;FailedPasswordReissue&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">        INSERT INTO failed_password_reissue (</span>
<span class="cp">            token,</span>
<span class="cp">            attempt_date</span>
<span class="cp">        ) VALUES (</span>
<span class="cp">         #{token},</span>
<span class="cp">            #{attemptDate}</span>
<span class="cp">        )</span>
<span class="cp">    ]]&gt;</span>
 <span class="nt">&lt;/insert&gt;</span>

 <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&quot;deleteByToken&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;![CDATA[</span>
<span class="cp">         DELETE FROM</span>
<span class="cp">                 failed_password_reissue</span>
<span class="cp">         WHERE</span>
<span class="cp">                 token = #{token}</span>
<span class="cp">    ]]&gt;</span>
 <span class="nt">&lt;/delete&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
<p>以下、実装方法に従って実装されたコードについて順に解説する。</p>
<ul>
<li><p class="first">パスワード再発行失敗イベントエンティティの保存</p>
<p>パスワード再発行失敗時に行う処理を実装したクラスを以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PasswordReissueFailureSharedService</span> <span class="o">{</span>

    <span class="kt">void</span> <span class="nf">resetFailure</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">token</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueFailureSharedServiceImpl</span> <span class="kd">implements</span>
        <span class="n">PasswordReissueFailureSharedService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">ClassicDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">FailedPasswordReissueRepository</span> <span class="n">failedPasswordReissueRepository</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span> <span class="c1">// (1)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">resetFailure</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">FailedPasswordReissue</span> <span class="n">event</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FailedPasswordReissue</span><span class="o">();</span> <span class="c1">// (2)</span>
        <span class="n">event</span><span class="o">.</span><span class="na">setToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">event</span><span class="o">.</span><span class="na">setAttemptDate</span><span class="o">(</span><span class="n">dateFactory</span><span class="o">.</span><span class="na">newTimestamp</span><span class="o">().</span><span class="na">toLocalDateTime</span><span class="o">());</span>
        <span class="n">failedPasswordReissueRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">event</span><span class="o">);</span> <span class="c1">// (3)</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行に失敗した際に呼び出されるメソッドであり、呼び出し元で実行時例外を発生させる設計としている。</div>
<div class="line">そのため、呼び出し元のServiceとは別にトランザクション管理を行うために、伝搬方法を「REQUIRES_NEW」に指定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行失敗イベントエンティティを作成し、トークンと失敗日時を設定する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(2)で作成したパスワード再発行失敗イベントエンティティをデータベースに登録する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><a class="reference internal" href="#reissue-info-validate"><span>パスワード再発行実行時の検査</span></a> の「パスワード再発行のための認証情報を用いたユーザの確認」処理の中から、パスワード再発行失敗時の処理を呼び出す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueServiceImpl</span> <span class="kd">implements</span> <span class="n">PasswordReissueService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueFailureSharedService</span> <span class="n">passwordReissueFailureSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueInfoRepository</span> <span class="n">passwordReissueInfoRepository</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">AccountSharedService</span> <span class="n">accountSharedService</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">resetPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">token</span><span class="o">,</span> <span class="n">String</span> <span class="n">secret</span><span class="o">,</span>
            <span class="n">String</span> <span class="n">rawPassword</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">PasswordReissueInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">token</span><span class="o">);</span> <span class="c1">// (1)</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">secret</span><span class="o">,</span> <span class="n">info</span><span class="o">.</span><span class="na">getSecret</span><span class="o">()))</span> <span class="o">{</span> <span class="c1">// (2)</span>
            <span class="n">passwordReissueFailureSharedService</span><span class="o">.</span><span class="na">resetFailure</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span> <span class="c1">// (3)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>  <span class="c1">// (4)</span>
                <span class="n">MessageKeys</span><span class="o">.</span><span class="na">E_SL_PR_5003</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="c1">//omitted</span>

    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられたトークンを用いて、データベースからパスワード再発行用の認証情報を取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行用の認証情報に含まれるハッシュ化された秘密情報と、引数として与えられた秘密情報を比較する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行失敗時の処理を行うSharedServiceのメソッド呼び出す。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">実行時例外をthrowするが、パスワード再発行失敗時の処理は別のトランザクションで実行されるため、影響を与えることはない。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">パスワード再発行時の例外のスロー</p>
<p>パスワード再発行の失敗回数の取得と、失敗回数が上限に達した際の処理の実装を以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="nn">org.terasoluna.securelogin.domain.service.passwordreissue</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordReissueServiceImpl</span> <span class="kd">implements</span> <span class="n">PasswordReissueService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">FailedPasswordReissueRepository</span> <span class="n">failedPasswordReissueRepository</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">PasswordReissueInfoRepository</span> <span class="n">passwordReissueInfoRepository</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${security.tokenValidityThreshold}&quot;</span><span class="o">)</span>
    <span class="kt">int</span> <span class="n">tokenValidityThreshold</span><span class="o">;</span> <span class="c1">// (1)</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">PasswordReissueInfo</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// omitted</span>

        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">failedPasswordReissueRepository</span> <span class="c1">// (2)</span>
                <span class="o">.</span><span class="na">countByToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">tokenValidityThreshold</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (3)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
                    <span class="n">MessageKeys</span><span class="o">.</span><span class="na">E_SL_PR_5004</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">info</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード再発行の失敗回数の上限値をプロパティファイルから取得して設定する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">引数として与えられたトークンをキーとして、データベースからパスワード再発行失敗イベントエンティティの数を取得。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">取得したパスワード再発行の失敗イベントエンティティの数と失敗回数の上限値を比較し、上限値以上ならば例外をスローする。</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="id58">
<h2><a class="toc-backref" href="#id119">6.10.4. おわりに</a><a class="headerlink" href="#id58" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">本章では、サンプルアプリケーションを題材としてセキュリティ対策の実装方法の例を説明した。</div>
<div class="line">実際の開発においては、本アプリケーションにおける実装方法をそのまま利用できないケースも考えられるため、本章の内容を参考にしつつ要件に合わせてカスタマイズしたり別の方法を考えるようにしてほしい。</div>
</div>
</div>
<div class="section" id="appendix">
<h2><a class="toc-backref" href="#id120">6.10.5. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="passay-overview">
<span id="id59"></span><h3><a class="toc-backref" href="#id121">6.10.5.1. Passay</a><a class="headerlink" href="#passay-overview" title="Permalink to this headline">¶</a></h3>
<p>Passayはパスワード入力チェック機能とパスワード生成機能を提供するライブラリである。
PassayのAPIは以下の三つの主要コンポーネントで構成される。</p>
<ul>
<li><p class="first">検証規則</p>
<p>パスワードが満たすべき条件の定義。パスワードの長さや含まれる文字種別等の一般的によく利用される規則についてはライブラリが提供するクラスを使用して容易に作成することができる。その他、必要な規則を自分で定義することもできる。</p>
</li>
<li><p class="first">検証器</p>
<p>検証規則に基づいて実際にパスワードのチェックを行うコンポーネント。複数の検証規則を一つの検証器に設定することができる。</p>
</li>
<li><p class="first">生成器</p>
<p>与えられた文字種別に関する検証規則に適合するパスワードを生成するコンポーネント。</p>
</li>
</ul>
<p>Passayの機能を使用する場合は、pom.xmlに以下の定義を追加すること。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;dependencies&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.passay<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>passay<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>1.1.0<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependencies&gt;</span>
</pre></div>
</div>
<div class="section" id="password-validation">
<span id="id60"></span><h4><a class="toc-backref" href="#id122">6.10.5.1.1. パスワード入力チェック</a><a class="headerlink" href="#password-validation" title="Permalink to this headline">¶</a></h4>
<div class="section" id="overview">
<h5>6.10.5.1.1.1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">Passayにおけるパスワード入力チェックの流れの概略図を以下に示す。</div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/SecureLogin_passay.png"><img alt="Password Vaildation" src="../_images/SecureLogin_passay.png" style="width: 60%;" /></a>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">org.passay.PasswordData</span></code> のインスタンスを作成し、入力チェック対象のパスワードに関する情報を設定する。</div>
<div class="line"><code class="docutils literal"><span class="pre">PasswordData</span></code> は、パスワード、ユーザ名に加え、過去に使用したパスワードのリスト等をプロパティとして持つことができる。</div>
<div class="line">過去に使用したパスワード等は<code class="docutils literal"><span class="pre">org.passay.PasswordData.Reference</span></code> のインスタンスとして保持する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">検証規則に従い、検証器を用いて<code class="docutils literal"><span class="pre">PasswordData</span></code> に対する入力チェックを行う。</div>
<div class="line">検証規則は<code class="docutils literal"><span class="pre">org.passay.Rule</span></code> の実装クラスのインスタンスとして作成する。検証器は<code class="docutils literal"><span class="pre">org.passay.PasswordValidator</span></code> のインスタンスであり、複数の検証規則をプロパティとして持つことができる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">検証器による入力チェックの結果として<code class="docutils literal"><span class="pre">org.passay.RuleResult</span></code> のインスタンスが作成される。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RuleResult</span></code> からパスワード入力チェックの結果を<code class="docutils literal"><span class="pre">boolean</span></code> として得ることができる。また、検証器を使って<code class="docutils literal"><span class="pre">RuleResult</span></code> からエラーメッセージが取得できる。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Passayが提供している検証規則のクラスの一部を以下の表に示す。</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="40%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">クラス名</th>
<th class="head">説明</th>
<th class="head">主なプロパティ</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">LengthRule</span></code> </div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワード長の最小値、最大値を規定するための検証規則のクラス</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">minimuxLength</span></code> : パスワード長の最小値(<code class="docutils literal"><span class="pre">int</span></code> )。コンストラクタまたはsetterで設定。</div>
<div class="line"><code class="docutils literal"><span class="pre">maximumLength</span></code> : パスワード長の最大値(<code class="docutils literal"><span class="pre">int</span></code> )。コンストラクタまたはsetterで設定。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CharacterRule</span></code> </div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードに含まれるべき文字種別と、その文字種別の最低文字数を規定するための検証規則のクラス</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">characterData</span></code>: 文字種別(<code class="docutils literal"><span class="pre">org.passay.CharacterData</span></code> )。コンストラクタで設定。</div>
<div class="line"><code class="docutils literal"><span class="pre">numberOfCharacters</span></code> : 最低文字数(<code class="docutils literal"><span class="pre">int</span></code> )。コンストラクタまたはsetterで設定。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">CharacterCharacteristicsRule</span></code> </div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">複数の<code class="docutils literal"><span class="pre">CharacterRule</span></code> のうち、いくつ以上の規則を満たす必要があるかを規定するための検証規則のクラス</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">rules</span></code>: 文字種別に関する検証規則のリスト(<code class="docutils literal"><span class="pre">List&lt;CharacterRule&gt;</span></code> )。setterで設定。</div>
<div class="line"><code class="docutils literal"><span class="pre">numberOfCharacteristics</span></code> : 満たすべき検証規則の数の最小値(<code class="docutils literal"><span class="pre">int</span></code> )。setterで設定。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">HistoryRule</span></code> </div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードが以前に使用したパスワードと一致していないことをチェックするための検証規則のクラス</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">なし</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">UsernameRule</span></code> </div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードがユーザ名を含まないことをチェックするための検証規則のクラス</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">matchBackwards</span></code> : ユーザ名を逆にした文字列もチェックする(<code class="docutils literal"><span class="pre">boolean</span></code> )。コンストラクタまたはsetterで設定。</div>
<div class="line"><code class="docutils literal"><span class="pre">ignoreCase</span></code> : 大文字、小文字を区別しない(<code class="docutils literal"><span class="pre">boolean</span></code> )。コンストラクタまたはsetterで設定。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>この他にも、特定の文字を含む/含まないことのチェックや、正規表現によるチェックを行うための検証規則のクラス等が提供されている。
詳細は <a class="reference external" href="http://www.passay.org/">http://www.passay.org/</a> を参照。</p>
</div>
<div class="section" id="how-to-use">
<h5>6.10.5.1.1.2. How to use<a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal"><span class="pre">PasswordValidator</span></code> のコンストラクタに<code class="docutils literal"><span class="pre">org.passay.Rule</span></code> のインスタンスのリストを渡すことによって、検証器を作成することができる。
検証規則を設定した検証器を以下のようにBeanとして定義しておくことでDIが可能となる。
尚、複数の検証規則をBean定義する場合、<code class="docutils literal"><span class="pre">&#64;Inject</span></code> と<code class="docutils literal"><span class="pre">&#64;Named</span></code> を併用することでBean名によるDIを行うこと。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- Password Rules. --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;upperCaseRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.UpperCase&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;lowerCaseRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.LowerCase&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;digitRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.Digit&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- Password Validator. --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;characterPasswordValidator&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.PasswordValidator&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;rules&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;upperCaseRule&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;lowerCaseRule&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;digitRule&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードに含まれるべき文字種別と、その文字種別の最低文字数を規定するための検証規則のBean定義</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">文字種別を指定する。ここでは、<code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.UpperCase</span></code> を渡しているため、半角英大文字に関する検証規則となる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">文字数を指定する。ここでは&#8221;1&#8221;を渡しているため、半角英大文字を一文字以上含むことをチェックする検証規則となる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(1)-(3)と同様だが、文字種別として<code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.UpperCase</span></code> を渡しているため、半角英小文字を一文字以上含むことをチェックする検証規則のBean定義となる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(1)-(3)と同様だが、文字種別として<code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.Digit</span></code> を渡しているため、半角数字を一文字以上含むことをチェックする検証規則のBean定義となる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">検証器のBean定義。コンストラクタに検証規則のリストを渡す。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>作成した検証器を使用してパスワード入力チェックを行う。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@Inject</span>
<span class="n">PasswordValidator</span> <span class="n">characterPasswordValidator</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">validatePassword</span><span class="o">(</span><span class="n">String</span> <span class="n">password</span><span class="o">){</span>

    <span class="n">PasswordData</span> <span class="n">pd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PasswordData</span><span class="o">(</span><span class="n">password</span><span class="o">);</span> <span class="c1">// (1)</span>
    <span class="n">RuleResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">characterPasswordValidator</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">pd</span><span class="o">);</span> <span class="c1">// (2)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// (3)</span>
       <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Password is valid&quot;</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
       <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Invalid password:&quot;</span><span class="o">);</span>
       <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">msg</span> <span class="o">:</span> <span class="n">characterPasswordValidator</span><span class="o">.</span><span class="na">getMessages</span><span class="o">(</span><span class="n">result</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// (4)</span>
           <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
       <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">検証対象のパスワードを <code class="docutils literal"><span class="pre">PasswordData</span></code> のコンストラクタに渡し、インスタンスを作成する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">PasswordValidator</span></code> の <code class="docutils literal"><span class="pre">validate</span></code> メソッドに <code class="docutils literal"><span class="pre">PasswordData</span></code> を引数として渡し、パスワード入力チェックを実行する。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">RuleResult</span></code> の <code class="docutils literal"><span class="pre">isValid</span></code> メソッドを使用して、パスワード入力チェックの結果を真理値で取得する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">PasswordValidator</span></code> の <code class="docutils literal"><span class="pre">getMessages</span></code> メソッドに <code class="docutils literal"><span class="pre">RuleResult</span></code> を引数として渡し、エラーメッセージを取得する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="password-generation">
<span id="id61"></span><h4><a class="toc-backref" href="#id123">6.10.5.1.2. パスワード生成</a><a class="headerlink" href="#password-generation" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id62">
<h5>6.10.5.1.2.1. Overview<a class="headerlink" href="#id62" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">Passayにおけるパスワード生成機能では、パスワードの生成器と生成規則を用いる。生成器は<code class="docutils literal"><span class="pre">org.passay.PasswordGenerator</span></code> のインスタンスであり、生成規則は文字種別に関する検証規則(<code class="docutils literal"><span class="pre">org.passay.CharacterRule</span></code> )のリストである。</div>
<div class="line">生成器のメソッドに生成するパスワードの長さと生成規則を引数として与えることで、生成規則を満たしたパスワードが生成される。</div>
</div>
</div>
<div class="section" id="id63">
<h5>6.10.5.1.2.2. How to use<a class="headerlink" href="#id63" title="Permalink to this headline">¶</a></h5>
<p>生成規則に含まれる、文字種別に関する検証規則の作成方法は、<a class="reference internal" href="#password-validation"><span>パスワード入力チェック</span></a> と同様である。
生成規則と生成器を以下のようにBeanとして定義しておくことでDIが可能となる。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- Password Rules. --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;upperCaseRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.UpperCase&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;lowerCaseRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.LowerCase&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;digitRule&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.CharacterRule&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;util:constant</span> <span class="na">static-field=</span><span class="s">&quot;org.passay.EnglishCharacterData.Digit&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

 <span class="c">&lt;!-- Password Generator. --&gt;</span>
 <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;passwordGenerator&quot;</span> <span class="na">class=</span><span class="s">&quot;org.passay.PasswordGenerator&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (6) --&gt;</span>
 <span class="nt">&lt;util:list</span> <span class="na">id=</span><span class="s">&quot;passwordGenerationRules&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (7) --&gt;</span>
     <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;upperCaseRule&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;lowerCaseRule&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;digitRule&quot;</span> <span class="nt">/&gt;</span>
 <span class="nt">&lt;/util:list&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">パスワードに含まれるべき文字種別と、その文字種別の最低文字数を規定するための検証規則のBean定義</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">文字種別を指定する。ここでは、<code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.UpperCase</span></code> を渡しているため、半角英大文字に関する検証規則となる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">文字数を指定する。ここでは&#8221;1&#8221;を渡しているため、半角英大文字を一文字以上含むことをチェックする検証規則となる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(1)-(3)と同様だが、文字種別として<code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.UpperCase</span></code> を渡しているため、半角英小文字を一文字以上含むことをチェックする検証規則のBean定義となる。</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">(1)-(3)と同様だが、文字種別として<code class="docutils literal"><span class="pre">org.passay.EnglishCharacterData.Digit</span></code> を渡しているため、半角数字を一文字以上含むことをチェックする検証規則のBean定義となる。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">生成器のBean定義</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">生成規則のBean定義。(1)-(5)で定義した、文字種別に関する検証規則のリストとして定義する。</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>作成した生成器と生成規則を使用してパスワード生成を行う。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@Inject</span>
<span class="n">PasswordGenerator</span> <span class="n">passwordGenerator</span><span class="o">;</span>

<span class="nd">@Resource</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;passwordGenerationRules&quot;</span><span class="o">)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">CharacterRule</span><span class="o">&gt;</span> <span class="n">passwordGenerationRules</span><span class="o">;</span>

<span class="c1">// omitted</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">generatePassword</span><span class="o">(){</span>

    <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">passwordGenerator</span><span class="o">.</span><span class="na">generatePassword</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">passwordGenerationRules</span><span class="o">);</span> <span class="c1">// (1)</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">PasswordGenerator</span></code> の<code class="docutils literal"><span class="pre">generatePassword</span></code> メソッドに、生成するパスワードの長さと生成規則を引数として渡すと、生成規則を満たしたパスワードが生成される。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Bean定義したコレクションをDIする際には、<code class="docutils literal"><span class="pre">&#64;Inject</span></code> + <code class="docutils literal"><span class="pre">&#64;Named</span></code> では期待した動作をしない。
そのため、代わりに<code class="docutils literal"><span class="pre">&#64;Resource</span></code> を使用してBean名でDIする。</p>
</div>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../Appendix/index.html" title="7. Appendix"
             >next</a> |</li>
        <li class="right" >
          <a href="Encryption.html" title="6.9. 暗号化"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.1.1.RELEASE documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >6. TERASOLUNA Server Framework for Java (5.x)によるセキュリティ対策</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2016, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.4.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>